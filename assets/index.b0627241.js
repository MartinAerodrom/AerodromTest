var jf=Object.defineProperty,Ff=Object.defineProperties;var Bf=Object.getOwnPropertyDescriptors;var Ga=Object.getOwnPropertySymbols;var Uf=Object.prototype.hasOwnProperty,Nf=Object.prototype.propertyIsEnumerable;var Pr=(i,e,t)=>e in i?jf(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,lt=(i,e)=>{for(var t in e||(e={}))Uf.call(e,t)&&Pr(i,t,e[t]);if(Ga)for(var t of Ga(e))Nf.call(e,t)&&Pr(i,t,e[t]);return i},Or=(i,e)=>Ff(i,Bf(e));var r=(i,e,t)=>(Pr(i,typeof e!="symbol"?e+"":e,t),t);import{Q as O,V as y,P as zf,W as Va,a as Cr,S as qa,b as Xa,U as $f,E as Pe,M as kt,T as Rs,v as Wf,O as S,c as V,d as j,e as Oe,I as Hf,R as Sr,L as Es,f as Gf,B as Jt,g as Vf,h as qf,i as he,j as Lt,k as Xf,l as Yf,m as Ya,C as Qf,n as Rr,o as Jf,p as Zf,q as Qa,r as f,s as Kf,t as Zt,u as Er,A as Ar,w as Ja,x as Ei,y as ep,z as tp,D as Tr,F as ip,G as Za,H as sp,K as np,J as rp,N as kr,X as Ka,Y as op,Z as ap,_ as lp,$ as Lr,a0 as As,a1 as el,a2 as cp,a3 as hp,a4 as Ts,a5 as tl,a6 as il,a7 as Ai,a8 as dp,a9 as up,aa as sl,ab as fp,ac as pp,ad as mp,ae as gp,af as nl,ag as _p,ah as rl,ai as Ti,aj as bp,ak as yp,al as vp,am as wp,an as xp,ao as Pp,ap as Op,aq as Cp,ar as ol,as as Sp,at as Rp,au as Ep,av as Ap,aw as Tp,ax as kp,ay as Lp,az as al,aA as Dp,aB as Mp,aC as ll,aD as Ip,aE as jp,aF as cl,aG as Fp,aH as Bp,aI as Up,aJ as Np,aK as zp,aL as Dr,aM as hl,aN as dl,aO as ul,aP as $p,aQ as Wp,aR as fl,aS as Hp,aT as Gp,aU as Vp,aV as qp,aW as Xp,aX as Yp,aY as Qp,aZ as Jp,a_ as ki,a$ as Zp,b0 as Kp,b1 as em,b2 as tm,b3 as im,b4 as sm}from"./vendor.597e1bea.js";const nm=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}};nm();const Li="__isActiveInHierarchy",Kt="builtin_components";function Dt(i,e){try{e?i(e):i()}catch(t){return console.error(t),!1}return!0}var rm=Object.defineProperty,$=(i,e)=>rm(i,"name",{value:e,configurable:!0});const Mr=$(()=>i=>i,"nameofFactory");function om(i){return Mr()(i)}$(om,"nameof");function am(){return!!w("debug")}$(am,"isDebugMode");let Ir=!1;const jr=[];setTimeout(()=>{Ir&&console.log(jr)},100);function Di(){return new URLSearchParams(window.location.search)}$(Di,"getUrlParams");function w(i){Ir&&!jr.includes(i)&&jr.push(i);const e=Di();if(e.has(i)){const t=e.get(i);return t||!0}return!1}$(w,"getParam");Ir=w("help")===!0;function lm(i,e){const t=Di();t.has(i)?t.set(i,e):t.append(i,e),document.location.search=t.toString()}$(lm,"setParam");function cm(i,e,t=!0){const s=Di();s.has(i)?s.set(i,e):s.append(i,e),t?pl(i,s):Fr(i,s)}$(cm,"setParamWithoutReload");function Mi(i,e,t){i.has(e)?i.set(e,t.toString()):i.append(e,t.toString())}$(Mi,"setOrAddParamsToUrl");function pl(i,e){window.history.pushState(null,i,"?"+e.toString())}$(pl,"pushState");function Fr(i,e){window.history.replaceState(null,i,"?"+e.toString())}$(Fr,"setState");function hm(i){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=t.length,n=0;n<i;n++)e+=t.charAt(Math.floor(Math.random()*s));return e}$(hm,"makeId");function ml(i,e){return Math.floor(Math.random()*(e-i+1))+i}$(ml,"randomNumber");const gl=["smol","tiny","giant","interesting","smart","bright","dull","extreme","beautiful","pretty","dark","epic","salty","silly","funny","lame","lazy","loud","lucky","mad","mean","mighty","mysterious","nasty","odd","old","powerful","quiet","rapid","scary","shiny","shy","silly","smooth","sour","spicy","stupid","sweet","tasty","terrible","ugly","unusual","vast","wet","wild","witty","wrong","zany","zealous","zippy","zombie","zorro"],_l=["cat","dog","mouse","pig","cow","horse","sheep","chicken","duck","goat","panda","tiger","lion","elephant","monkey","bird","fish","snake","frog","turtle","hamster","penguin","kangaroo","whale","dolphin","crocodile","snail","ant","bee","beetle","butterfly","dragon","eagle","fish","giraffe","lizard","panda","penguin","rabbit","snake","spider","tiger","zebra"];function bl(){const i=gl[Math.floor(Math.random()*gl.length)],e=_l[Math.floor(Math.random()*_l.length)];return i+"_"+e}$(bl,"makeIdFromRandomWords");function yl(i){return i=i.replace(/[^a-z0-9áéíóúñü \.,_-]/gim,""),i.trim()}$(yl,"sanitizeString");function Mt(i,e,t=!0,s=!1){var n;if(e==null)return null;if(e.userData&&e.userData.guid===i)return e;if(e.guid==i)return e;if(s&&((n=e.userData)==null?void 0:n.components)){for(const o of e.userData.components)if(o.guid===i)return o}if(t){if(e.scenes)for(const o in e.scenes){const a=e.scenes[o],l=Mt(i,a,t,s);if(l)return l}if(e.children)for(const o in e.children){const a=e.children[o],l=Mt(i,a,t,s);if(l)return l}}}$(Mt,"tryFindObject");function ks(i,e){if(i!=null&&typeof i=="object"){let t;Array.isArray(i)?t=[]:(t=Object.create(i),Object.assign(t,i));for(const s of Object.keys(i)){const n=i[s];e&&!e(i,s,n)?t[s]=n:(n==null?void 0:n.clone)!==void 0&&typeof n.clone=="function"?t[s]=n.clone():t[s]=ks(n,e)}return t}return i}$(ks,"deepClone");function vl(i){return new Promise((e,t)=>{setTimeout(e,i)})}$(vl,"delay");function wl(i,e){if(e&&i&&!e.includes("/")){const t=i.lastIndexOf("/");if(t>=0)return i.substring(0,t+1)+e}return e}$(wl,"getPath");var dm=Object.defineProperty,De=(i,e)=>dm(i,"name",{value:e,configurable:!0});const um=w("debugnewscripts"),L=[];function ei(i){if(!(i.new_scripts.length<=0)){if(um&&console.log("Register new components",i.new_scripts.length,i.alias?"element: "+i.alias:""),i.new_scripts_pre_setup_callbacks.length>0){for(const e of i.new_scripts_pre_setup_callbacks)!e||e();i.new_scripts_pre_setup_callbacks.length=0}L.length=0,i.new_scripts.length>0&&L.push(...i.new_scripts),i.new_scripts.length=0;for(let e=0;e<L.length;e++)try{const t=L[e];if(t.destroyed)continue;if(!t.gameObject){console.error("MISSING GAMEOBJECT - will ignore",t),L.splice(e,1),e--;continue}t.context=i,ti(t.gameObject),Br(t,i)}catch(t){console.error(t),qe(L[e],i),L.splice(e,1),e--}for(let e=0;e<L.length;e++)try{const t=L[e];if(t.destroyed){qe(L[e],i),L.splice(e,1),e--;continue}t.__internalAwake!==void 0&&(t.gameObject||console.error("MISSING GAMEOBJECT",t,t.gameObject),ti(t.gameObject),t.activeAndEnabled&&Dt(t.__internalAwake.bind(t)))}catch(t){console.error(t),qe(L[e],i),L.splice(e,1),e--}for(let e=0;e<L.length;e++)try{const t=L[e];if(t.destroyed||t.enabled===!1||(ti(t.gameObject),t.activeAndEnabled===!1))continue;t.__internalEnable!==void 0&&(t.enabled=!0,Dt(t.__internalEnable.bind(t)))}catch(t){console.error(t),qe(L[e],i),L.splice(e,1),e--}for(let e=0;e<L.length;e++)try{const t=L[e];if(t.destroyed||!t.gameObject)continue;i.new_script_start.push(t)}catch(t){console.error(t),qe(L[e],i),L.splice(e,1),e--}L.length=0;for(const e of i.new_scripts_post_setup_callbacks)e&&e();i.new_scripts_post_setup_callbacks.length=0}}De(ei,"processNewScripts");function xl(i){!i||(i.__internalDisable(),qe(i,i.context))}De(xl,"processRemoveFromScene");function Pl(i){for(let e=0;e<i.new_script_start.length;e++)try{const t=i.new_script_start[e];if(t.destroyed||t.activeAndEnabled===!1)continue;Dt(t.__internalAwake.bind(t)),Dt(t.__internalEnable.bind(t)),Dt(t.__internalStart.bind(t)),i.new_script_start.splice(e,1),e--}catch(t){console.error(t),qe(i.new_script_start[e],i),i.new_script_start.splice(e,1),e--}}De(Pl,"processStart");function Br(i,e){e.scripts.indexOf(i)===-1&&(e.scripts.push(i),i.earlyUpdate&&e.scripts_earlyUpdate.push(i),i.update&&e.scripts_update.push(i),i.lateUpdate&&e.scripts_lateUpdate.push(i),i.onBeforeRender&&e.scripts_onBeforeRender.push(i),i.onAfterRender&&e.scripts_onAfterRender.push(i))}De(Br,"addScriptToArrays");function qe(i,e){Xe(i,e.new_scripts),Xe(i,e.new_script_start),Xe(i,e.scripts),Xe(i,e.scripts_earlyUpdate),Xe(i,e.scripts_update),Xe(i,e.scripts_lateUpdate),Xe(i,e.scripts_onBeforeRender),Xe(i,e.scripts_onAfterRender),e.stopAllCoroutinesFrom(i)}De(qe,"removeScriptFromContext");function Xe(i,e){const t=e.indexOf(i);t>=0&&e.splice(t,1)}De(Xe,"removeFromArray");const fm={},Ol={};function Cl(){if(!E.Current){console.trace("Invalid call - no current context.");return}Ur(E.Current.scene,E.Current.scene.visible,!0)}De(Cl,"updateIsActive");function Ur(i,e,t){const s=p.isActiveSelf(i);fm[i.uuid]=s,e&&(e=p.isActiveSelf(i)),i[Li]=e;{const n=Ol[i.uuid];n!==void 0&&n!==e&&t&&Sl(i,o=>{e?(Dt(o.__internalAwake.bind(o)),o.onEnable()):o.onDisable()})}if(Ol[i.uuid]=e,i.children)for(const n of i.children)Ur(n,e,t)}De(Ur,"updateIsActiveInHierarchyRecursiveRuntime");function ti(i){let e=!0,t=i,s=!1;for(;t&&t;){if(t.type==="Scene"&&(s=!0),!p.isActiveSelf(t)){e=!1;break}t=t.parent}if(!i){console.error("GO is null");return}i[Li]=e&&s}De(ti,"updateActiveInHierarchyWithoutEventCall");function Sl(i,e){var t;if((t=i.userData)==null?void 0:t.components)for(const s of i.userData.components)e(s)}De(Sl,"perComponent");function Rl(i,e){var s;if(!i)return;const t=(s=e==null?void 0:e.new_scripts)!=null?s:E.Current.new_scripts;t.includes(i)||t.push(i)}const pm=function(i,e){if(!i||!i.userData.components)return;const t=i.userData.components.indexOf(e);t<0||(e.gameObject=null,i.userData.components.splice(t,1))},El=function(i,e,t=!0){e.userData||(e.userData={}),e.userData.components||(e.userData.components=[]),e.userData.components.push(i),i.gameObject=e,Rl(i);try{i.__internalAwake&&t&&(ti(e),i.__internalAwake())}catch(s){console.error(s)}},mm=function(i,e){if(i.gameObject!==e){if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}if(!e.userData.components)e.userData.components=[];else if(e.userData.components.includes(i))return;e.userData.components.push(i),i.gameObject=e}},gm=function(i){var e;if(i.gameObject&&i.gameObject.userData.components){const t=i.gameObject.userData.components.indexOf(i);i.gameObject.userData.components.splice(t,1)}i.__internalDisable&&i.__internalDisable(),i.onDestroy&&i.onDestroy(),qe(i,(e=i.context)!=null?e:E.Current),i.__destroyed=!0,i.gameObject=null},Al=function(i,e,t){var s;if(!((s=e==null?void 0:e.userData)==null?void 0:s.components))return null;for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(i===null||o.constructor.name===i.name||o.constructor.name===i)if(t)t.push(o);else return o}for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];let a=Object.getPrototypeOf(o.constructor);do{if(a===i)if(t)t.push(o);else return o;a=Object.getPrototypeOf(a)}while(a)}return t},Nr=function(i,e){return Al(i,e,null)},zr=function(i,e,t){return t||(t=[]),Al(i,e,t)},$r=function(i,e,t){var n;const s=Nr(i,e);if(t===!1&&s.enabled===!1)return null;if(s)return s;for(let o=0;o<((n=e==null?void 0:e.children)==null?void 0:n.length);o++){const a=$r(i,e.children[o]);if(a)return a}return null},Wr=function(i,e,t){var s;t||(t=[]),zr(i,e,t);for(let n=0;n<((s=e==null?void 0:e.children)==null?void 0:s.length);n++)Wr(i,e.children[n],t);return t},Tl=function(i,e){if(!e)return null;const t=Nr(i,e);return t||Tl(i,e.parent)},kl=function(i,e,t){return t||(t=[]),e?(zr(i,e,t),kl(i,e.parent,t)):t},_m=function(i,e,t){if(!i)return null;if(!e&&(e=E.Current,!e))return console.error("Can not search object without any needle context or scene!!!"),null;const s=e.isScene===!0||e.isObject3D===!0?e:e==null?void 0:e.scene;for(const n in s.children){const o=s.children[n];if(t===!1&&o[Li]===!1)continue;if(o.constructor==i)return o;const a=$r(i,o);if(a)return a}return null},bm=function(i,e,t){if(!i)return e;if(!t&&(t=E.Current,!t))return console.error("Can not search object without any needle context or scene!!!"),e;const s=t.isScene===!0||t.isObject3D===!0?t:t==null?void 0:t.scene;if(!s)return e;for(const n in s.children){const o=s.children[n];if(o.constructor==i)return o;Wr(i,o,e)}return e};var ym=Object.defineProperty,vm=(i,e)=>ym(i,"name",{value:e,configurable:!0});class Ll{random(){return Math.random()}clamp(e,t,s){return e<t?t:e>s?s:e}clamp01(e){return this.clamp(e,0,1)}lerp(e,t,s){return s=s<0?0:s,s=s>1?1:s,e+(t-e)*s}moveTowards(e,t,s){return e+=s,(s<0&&e<t||s>0&&e>t)&&(e=t),e}toDegrees(e){return e*180/Math.PI}toRadians(e){return e*Math.PI/180}}vm(Ll,"MathHelper");const A=new Ll;var wm=Object.defineProperty,I=(i,e)=>wm(i,"name",{value:e,configurable:!0});class Dl{constructor(e,t){r(this,"_factory");r(this,"_cache",[]);r(this,"_maxSize");r(this,"_index",0);this._factory=e,this._maxSize=t}get(){let e=this._index++;return e>=this._cache.length&&(e>=this._maxSize?e=this._index=0:this._cache.push(this._factory())),this._cache[e]}}I(Dl,"CircularBuffer");const xm=new O().setFromAxisAngle(new y(0,1,0),Math.PI);function Pm(i,e){i.lookAt(e),i.quaternion.multiply(xm)}I(Pm,"lookAtInverse");const Hr=new Dl(()=>new y,30);y.prototype.slerp=function(i,e){const t=this.length(),s=i.length(),n=A.lerp(t,s,e);return this.lerp(i,e).normalize().multiplyScalar(n)};function C(i,e=null,t=!0){const s=Hr.get();return i?i.parent?(t&&i.updateWorldMatrix(!0,!1),i.matrixWorldNeedsUpdate&&i.updateMatrixWorld(),s.setFromMatrixPosition(i.matrixWorld),e&&e.copy(s),e!=null?e:s):s.copy(i.position):s.set(0,0,0)}I(C,"getWorldPosition");function D(i,e){var n;if(!i)return;const t=Hr.get();e!==t&&t.copy(e),((n=i==null?void 0:i.parent)!=null?n:i).worldToLocal(t),i.position.set(t.x,t.y,t.z)}I(D,"setWorldPosition");function Ls(i,e,t,s){const n=Hr.get();n.set(e,t,s),D(i,n)}I(Ls,"setWorldPositionXYZ");const It=new O,Ii=new O,Gr=new O;function J(i,e=null){if(!i)return Ii.set(0,0,0,1);const t=e!=null?e:Ii;return i.parent?(i.getWorldQuaternion(t),t):t.copy(i.quaternion)}I(J,"getWorldQuaternion");function Z(i,e){if(!i)return;e!==It&&It.copy(e);const t=It,s=i==null?void 0:i.parent;s==null||s.getWorldQuaternion(Gr),Gr.invert();const n=Gr.multiply(t);i.quaternion.set(n.x,n.y,n.z,n.w)}I(Z,"setWorldQuaternion");function Ml(i,e,t,s,n){It.set(e,t,s,n),Z(i,It)}I(Ml,"setWorldQuaternionXYZW");const Ds=new y,Om=new y;function Il(i,e=null){return i?i.parent?(i.getWorldScale(e!=null?e:Ds),e!=null?e:Ds):Ds.copy(i.position):Ds.set(0,0,0)}I(Il,"getWorldScale");function Cm(i,e){if(!i)return;if(!i.parent){i.scale.copy(e);return}const t=Om;i.parent.getWorldScale(t),t.divide(e),i.scale.copy(t)}I(Cm,"setWorldScale");const Sm=new y,jl=new O;function Rm(i){return J(i,jl),Sm.set(0,0,1).applyQuaternion(jl)}I(Rm,"forward");const Fl=new Pe,Bl=new Pe,Em=new y;function Ul(i){return i.getWorldQuaternion(Ii),Bl.setFromQuaternion(Ii),Bl}I(Ul,"getWorldEuler");function Nl(i,e){Z(i,Ii.setFromEuler(e))}I(Nl,"setWorldEuler");function Vr(i){const e=Ul(i),t=Em;return t.set(e.x,e.y,e.z),t.x=A.toDegrees(t.x),t.y=A.toDegrees(t.y),t.z=A.toDegrees(t.z),t}I(Vr,"getWorldRotation");function Am(i,e){Ms(i,e.x,e.y,e.z,!0)}I(Am,"setWorldRotation");function Ms(i,e,t,s,n=!0){n&&(e=A.toRadians(e),t=A.toRadians(t),s=A.toRadians(s)),Fl.set(e,t,s),It.setFromEuler(Fl),Z(i,It)}I(Ms,"setWorldRotationXYZ");function Is(i,e=!0){!i||(e?I(function t(s){console.groupCollapsed((s.name?s.name:"(no name : "+s.type+")")+" %o",s),s.children.forEach(t),console.groupEnd()},"printGraph")(i):i.traverse(function(t){for(var s="|___",n=t;n.parent!==null;)s="	"+s,n=n.parent;console.log(s+t.name+" <"+t.type+">")}))}I(Is,"logHierarchy");const Tm=new zf(2,2,1,1),js=new Va({antialias:!1}),km=new Cr,qr=new qa,zl=new Xa({uniforms:{blitTexture:new $f(null)},vertexShader:`
        varying vec2 vUv;
        void main(){
            vUv = uv;
            gl_Position = vec4(position.xy * 1.0,0.,.999999);
        }`,fragmentShader:`
        uniform sampler2D blitTexture; 
        varying vec2 vUv;
        void main(){ 
            gl_FragColor = vec4(vUv.xy, 0, 1);
            gl_FragColor = texture2D( blitTexture, vUv);
        }`});function $l(i){zl.uniforms.blitTexture.value=i;const e=new kt(Tm,zl);return e.frustumCulled=!1,qr.children.length=0,qr.add(e),js.setSize(i.image.width,i.image.height),js.clear(),js.render(qr,km),new Rs(js.domElement)}I($l,"copyTexture");function Wl(i){return typeof HTMLImageElement!="undefined"&&i instanceof HTMLImageElement||typeof HTMLCanvasElement!="undefined"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas!="undefined"&&i instanceof OffscreenCanvas||typeof ImageBitmap!="undefined"&&i instanceof ImageBitmap}I(Wl,"isImageBitmap");function Lm(i){i.isCompressedTexture===!0&&(i=$l(i));const e=i.image;if(Wl(e)){const t=1024/Math.max(e.width,e.height),s=document.createElement("canvas");s.width=e.width*Math.min(1,t),s.height=e.height*Math.min(1,t);const n=s.getContext("2d");return n?(n.drawImage(e,0,0,s.width,s.height),s):(console.error("Failed getting canvas 2d context"),null)}return null}I(Lm,"textureToCanvas");var Dm=Object.defineProperty,ie=(i,e)=>Dm(i,"name",{value:e,configurable:!0});const Fs=w("debugcomponents"),Mm="eff8ba80-635d-11ec-90d6-0242ac120003";class ye{constructor(e){r(this,"_originalSeed");r(this,"_seed");this._originalSeed=e,this._seed=e}get seed(){return this._seed}generateUUID(){const e=this._seed;return this._seed-=1,Wf(e.toString(),Mm)}static createFromString(e){return new ye(this.hash(e))}static hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}ie(ye,"InstantiateIdProvider");var jt;(function(i){i.NewInstanceCreated="new-instance-created",i.InstanceDestroyed="instance-destroyed"})(jt||(jt={}));class Xr{constructor(e){r(this,"guid");this.guid=e}}ie(Xr,"DestroyInstanceModel");function Bs(i,e,t=!0){if(!i)return;const s=i;if(p.destroy(i,t),!e){console.warn("Can not send destroy: No networking connection provided",i.guid);return}if(!e.isConnected){console.warn("Can not send destroy: not connected",i.guid);return}let n=i.guid;if(!n&&s.uuid&&(n=s.uuid),!n){console.warn("Can not send destroy: failed to find guid",i);return}const o=new Xr(n);e.send(jt.InstanceDestroyed,o)}ie(Bs,"syncDestroy");function Hl(i,e){const t=new Xr(i);e.send(jt.InstanceDestroyed,t)}ie(Hl,"sendDestroyed");function Gl(i){i.connection.beginListen(jt.InstanceDestroyed,e=>{Fs&&console.log("[Remote] Destroyed",i.scene,e);const t=p.findByGuid(e.guid,i.scene);t&&p.destroy(t)})}ie(Gl,"beginListenDestroy");class Im{constructor(e,t,s){r(this,"filename");r(this,"hash");r(this,"size");this.filename=e,this.hash=t,this.size=s}}ie(Im,"HostData");class Vl{constructor(e,t){r(this,"guid");r(this,"originalGuid");r(this,"seed");r(this,"visible");r(this,"hostData");r(this,"dontSave");r(this,"parent");r(this,"position");r(this,"rotation");r(this,"scale");this.originalGuid=e,this.guid=t}}ie(Vl,"NewInstanceModel");function Yr(i,e,t,s){var c;const n=i;if(!n.guid)return console.warn("Can not instantiate: No guid",n),null;if(e.context||(e.context=E.Current),!e.context)return console.error("Missing network instantiate options / reference to network connection in sync instantiate"),null;const o=e?lt({},e):null,{instance:a,seed:l}=Xl(n,e);if(a){const h=a;if(h.guid){Fs&&console.log("[Local] new instance","gameobject:",a==null?void 0:a.guid);const d=new Vl(n.guid,h.guid);d.seed=l,o&&(o.position&&(d.position={x:o.position.x,y:o.position.y,z:o.position.z}),o.rotation&&(d.rotation={x:o.rotation.x,y:o.rotation.y,z:o.rotation.z,w:o.rotation.w}),o.scale&&(d.scale={x:o.scale.x,y:o.scale.y,z:o.scale.z})),d.position||(d.position={x:h.position.x,y:h.position.y,z:h.position.z}),d.rotation||(d.rotation={x:h.quaternion.x,y:h.quaternion.y,z:h.quaternion.z,w:h.quaternion.w}),d.scale||(d.scale={x:h.scale.x,y:h.scale.y,z:h.scale.z}),d.visible=n.visible,(o==null?void 0:o.parent)&&(typeof o.parent=="string"?d.parent=o.parent:d.parent=o.parent.guid),d.hostData=t,s===!1&&(d.dontSave=!0),(c=e==null?void 0:e.context)==null||c.connection.send(jt.NewInstanceCreated,d)}else console.warn("Missing guid, can not send new instance event",h)}return a}ie(Yr,"syncInstantiate");function Us(){return Math.random()*9999999}ie(Us,"generateSeed");function ql(i){i.connection.beginListen(jt.NewInstanceCreated,async e=>{const t=await Jl(e.originalGuid,i.scene);if(!t){console.warn("could not find object that was instantiated: "+e.guid);return}const s=new Ce;e.position&&(s.position=new y(e.position.x,e.position.y,e.position.z)),e.rotation&&(s.rotation=new O(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w)),e.scale&&(s.scale=new y(e.scale.x,e.scale.y,e.scale.z)),s.parent=e.parent,e.seed&&(s.idProvider=new ye(e.seed)),s.visible=e.visible,s.context=i,Fs&&i.alias&&console.log("[Remote] instantiate in: "+i.alias);const n=p.instantiate(t,s);n&&(e.parent==="scene"&&i.scene.add(n),Fs&&console.log("[Remote] new instance","gameobject:",n==null?void 0:n.guid,t))})}ie(ql,"beginListenInstantiate");function Xl(i,e){const t=Us(),s=e!=null?e:new Ce;s.idProvider=new ye(t);const n=p.instantiate(i,s);return{seed:t,instance:n}}ie(Xl,"instantiateSeeded");const Yl={};function Ql(i,e){Yl[i]=e}ie(Ql,"registerPrefabProvider");async function Jl(i,e){const t=Yl[i];if(t!=null){const s=await t(i);if(s)return s}return Qr(i,e)}ie(Jl,"tryResolvePrefab");function Qr(i,e){if(e===null||!i)return null;if(e.guid===i)return e;if(e.children)for(const t of e.children){const s=Qr(i,t);if(s)return s}return null}ie(Qr,"tryFindObjectByGuid");var jm=Object.defineProperty,Ns=(i,e)=>jm(i,"name",{value:e,configurable:!0});const ct=w("debugcomponents");var Zl;(function(i){i[i.None=0]="None",i[i.HideInHierarchy=1]="HideInHierarchy",i[i.HideInInspector=2]="HideInInspector",i[i.DontSaveInEditor=4]="DontSaveInEditor",i[i.NotEditable=8]="NotEditable",i[i.DontSaveInBuild=16]="DontSaveInBuild",i[i.DontUnloadUnusedAsset=32]="DontUnloadUnusedAsset",i[i.DontSave=52]="DontSave",i[i.HideAndDontSave=61]="HideAndDontSave"})(Zl||(Zl={}));class Ce{constructor(){r(this,"idProvider");r(this,"parent");r(this,"keepWorldPosition");r(this,"position");r(this,"rotation");r(this,"scale");r(this,"visible");r(this,"context")}}Ns(Ce,"InstantiateOptions");S.prototype.SetActive=function(i){this.visible=i};class p extends S{constructor(){super(...arguments);r(this,"guid")}static setActive(e,t){!e||(e.visible=t)}static isActiveSelf(e){return e.visible||p.isUsingInstancing(e)}static isActiveInHierarchy(e){return e[Li]||p.isUsingInstancing(e)}static markAsInstancedRendered(e,t){e.__isUsingInstancing=t}static isUsingInstancing(e){return e.__isUsingInstancing===!0}static foreachComponent(e,t,s=!0){if(!!e){if(e.userData.components)for(let n=0;n<e.userData.components.length;n++){const o=e.userData.components[n];if(o instanceof v){const a=t(o);if(a!==void 0)return a}}if(s&&e.children)for(let n=0;n<e.children.length;n++){const o=e.children[n];if(!o)continue;const a=p.foreachComponent(o,t,s);if(a!==void 0)return a}}}static instantiateSynced(e,t){return e?Yr(e,t):null}static instantiate(e,t=null){if(e===null)return null;let s=null;t!==null&&(t.x!==void 0?(s=new Ce,s.position=t):s=t);let n=E.Current;(s==null?void 0:s.context)&&(n=s.context),ct&&n.alias&&console.log("context",n.alias),s&&!s.idProvider&&(s.idProvider=new ye(Date.now()));const o=[],a={},l={},c=this.internalInstantiate(n,e,s,o,a,l);c&&(this.resolveReferences(a),this.resolveAndBindSkinnedMeshBones(l,a)),ct&&(Is(e,!0),Is(c,!0));const h={};for(const d in o){const u=o[d],g=u.guid;s&&s.idProvider&&(u.guid=s.idProvider.generateUUID(),h[g]=u.guid,ct&&console.log(u.name,u.guid)),Rl(u,n),u.__internalNewInstanceCreated&&u.__internalNewInstanceCreated()}for(const d in o){const u=o[d];u.resolveGuids&&u.resolveGuids(h),u.enabled!==!1&&(u.enabled=!0)}return ei(n),c}static internalInstantiate(e,t,s,n,o,a){var u;if(!t)return null;const l=t.userData;t.userData={};const c=t.children;t.children=[];let h;if(h=t.clone(!1),t.userData=l,t.children=c,o[t.uuid]={original:t,clone:h},t.type==="SkinnedMesh"&&(a[t.uuid]={original:t,clone:h}),(s==null?void 0:s.visible)!==void 0&&(h.visible=s.visible),s==null?void 0:s.idProvider){h.uuid=s.idProvider.generateUUID();const g=h;g&&(g.guid=h.uuid)}t.animations&&t.animations.length>0&&(h.animations=[...t.animations]);const d=t.parent;if(d&&d.add(h),(s==null?void 0:s.position)?D(h,s.position):h.position.copy(t.position),(s==null?void 0:s.rotation)?Z(h,s.rotation):h.quaternion.copy(t.quaternion),(s==null?void 0:s.scale)?h.scale.copy(s.scale):h.scale.copy(t.scale),(s==null?void 0:s.parent)&&s.parent!=="scene"){let g=null;if(typeof s.parent=="string"?g=Mt(s.parent,e.scene,!0):g=s.parent,g){const b=s.keepWorldPosition===!0?g.attach:g.add;b?b.call(g,h):console.error("Invalid parent object",g,"received when instantiating:",t)}else console.warn("could not find parent:",s.parent)}for(const[g,b]of Object.entries(t.userData))g!=="components"&&(h.userData[g]=b);if((u=t.userData)==null?void 0:u.components){const g=t.userData.components,b=[];h.userData.components=b;for(let x=0;x<g.length;x++){const P=g[x],R=Object.create(P);Object.assign(R,P),b.push(R),R.gameObject=h,n.push(R)}}s&&(s.position=void 0,s.rotation=void 0,s.scale=void 0,s.parent=void 0);for(const g in t.children){const b=t.children[g],x=p.internalInstantiate(e,b,s,n,o,a);x&&h.add(x)}return h}static resolveAndBindSkinnedMeshBones(e,t){for(const s in e){const n=e[s],o=n.original,a=o.skeleton,l=n.clone;if(!a){console.warn("Skinned mesh has no skeleton?",n);continue}const c=a.bones,h=l.skeleton.clone();l.skeleton=h,l.bindMatrix.clone().copy(o.bindMatrix),l.bindMatrixInverse.copy(o.bindMatrixInverse);const d=[];h.bones=d;for(let u=0;u<c.length;u++){const g=c[u],x=t[g.uuid].clone;d.push(x)}}for(const s in e){const n=e[s].clone;n.skeleton.update(),n.bind(n.skeleton,n.bindMatrix),n.updateMatrixWorld(!0)}}static resolveReferences(e){var t;for(const s in e){const o=e[s].clone;if((t=o.userData)==null?void 0:t.components)for(let a=0;a<o.userData.components.length;a++){const l=o.userData.components[a],c=Object.entries(l);for(const[h,d]of c)if(Array.isArray(d)){const u=[];l[h]=u;for(let g=0;g<d.length;g++){const b=d[g];if(typeof b!="object"){u.push(b);continue}const x=this.postProcessNewInstance(l,h,b,e);x!==void 0?u.push(x):u.push(b)}}else if(typeof d=="object"){const u=this.postProcessNewInstance(l,h,d,e);u!==void 0&&(l[h]=u)}}}}static postProcessNewInstance(e,t,s,n){var o,a;if(s instanceof Se||s instanceof v){const l=s.gameObject;if(l){const c=l.uuid,h=(o=n[c])==null?void 0:o.clone;if(!h){ct&&console.log("reference did not change",t,e,s);return}const d=l.userData.components.indexOf(s);if(d>=0)return ct&&console.log(t,c),h.userData.components[d];console.warn("could not find component",t,s)}}else if(s instanceof S){if(t==="gameObject")return;const l=s;if(l){const c=l.uuid,h=(a=n[c])==null?void 0:a.clone;if(h)return ct&&console.log(t,"old",s,"new",h),h}}}static destroySynced(e,t,s=!0){if(!e)return;const n=e;t=t!=null?t:E.Current,Bs(n,t.connection,s)}static destroy(e,t=!0,s=!0){const n=e;if(n.isComponent){n.destroy();return}const o=e;if(ct&&console.log(o),t&&o.children)for(const l of o.children)p.destroy(l,t,!1);const a=o.userData.components;if(a){let l=a.length;for(let c=0;c<a.length;c++){const h=a[c];h.destroy&&(ct&&console.log("destroying",h),h.destroy()),a.length<l&&(l=a.length,c--)}}s&&o.removeFromParent()}static add(e,t,s){if(!(!e||!t)){if(e===t){console.warn("Can not add object to self",e);return}s||(s=E.Current),t.add(e),ti(e),s?p.foreachComponent(e,n=>{Br(n,s),s.new_script_start.includes(n)===!1&&s.new_script_start.push(n)},!0):console.warn("Missing context")}}static remove(e){var t;!e||((t=e.parent)==null||t.remove(e),p.foreachComponent(e,s=>{xl(s)},!0))}static invokeOnChildren(e,t,...s){this.invoke(e,t,!0,s)}static invoke(e,t,s=!1,...n){!e||this.foreachComponent(e,o=>{const a=o[t];a&&typeof a=="function"&&a.bind(o)(...n)},s)}static addNewComponent(e,t,s=!0){const n=new t;return El(n,e,s),n}static addComponent(e,t){if(t.gameObject==null)throw new Error("Did you mean to create a new component? Use addNewComponent");mm(t,e)}static removeComponent(e){return pm(e.gameObject,e),e}static getOrAddComponent(e,t){const s=this.getComponent(e,t);return s||this.addNewComponent(e,t)}static getComponent(e,t){return e===null?null:Nr(t,e)}static getComponents(e,t,s=null){return e===null?s!=null?s:[]:zr(t,e,s)}static findByGuid(e,t){return Mt(e,t,!0,!0)}static findObjectOfType(e,t,s=!0){return _m(e,t,s)}static findObjectsOfType(e,t){const s=[];return bm(e,s,t),s}static getComponentInChildren(e,t){return $r(t,e)}static getComponentsInChildren(e,t,s=null){return Wr(t,e,s)}static getComponentInParent(e,t){return Tl(t,e)}static getComponentsInParent(e,t,s=null){return kl(t,e,s)}static getAllComponents(e){var n;return[...(n=e.userData)==null?void 0:n.components]}static*iterateComponents(e){var s;const t=(s=e==null?void 0:e.userData)==null?void 0:s.components;if(t&&Array.isArray(t))for(let n=0;n<t.length;n++)yield t[n]}}Ns(p,"GameObject");S.prototype.addNewComponent=function(i){return p.addNewComponent(this,i)};S.prototype.removeComponent=function(i){return p.removeComponent(i)};S.prototype.getOrAddComponent=function(i){return p.getOrAddComponent(this,i)};S.prototype.getComponent=function(i){return p.getComponent(this,i)};S.prototype.getComponents=function(i,e){return p.getComponents(this,i,e)};S.prototype.getComponentInChildren=function(i){return p.getComponentInChildren(this,i)};S.prototype.getComponentsInChildren=function(i,e){return p.getComponentsInChildren(this,i,e)};S.prototype.getComponentInParent=function(i){return p.getComponentInParent(this,i)};S.prototype.getComponentInParent=function(i,e){return p.getComponentsInParent(this,i,e)};const Le=class{constructor(){r(this,"__context");r(this,"__name");r(this,"gameObject");r(this,"guid","invalid");r(this,"sourceId");r(this,"__didAwake",!1);r(this,"__didStart",!1);r(this,"__didEnable",!1);r(this,"__isEnabled");r(this,"__destroyed",!1);r(this,"_worldPosition");r(this,"_worldQuaternion");r(this,"_worldEuler");r(this,"_worldRotation");this.__internalNewInstanceCreated()}get isComponent(){return!0}get context(){var e;return(e=this.__context)!=null?e:E.Current}set context(e){this.__context=e}get scene(){return this.context.scene}get layer(){var e;return(e=this.gameObject)==null?void 0:e.userData.layer}get name(){var e;return(e=this.gameObject)==null?void 0:e.userData.name}set name(e){this.gameObject?(this.gameObject.userData||(this.gameObject.userData={}),this.gameObject.userData.name=e,this.__name=e):this.__name=e}get tag(){var e;return(e=this.gameObject)==null?void 0:e.userData.tag}set tag(e){this.gameObject&&(this.gameObject.userData.tag=e)}get static(){var e;return(e=this.gameObject)==null?void 0:e.userData.static}get hideFlags(){var e;return(e=this.gameObject)==null?void 0:e.userData.hideFlags}get activeAndEnabled(){return!(this.destroyed||this.__isEnabled===!1||!this.__isActiveInHierarchy)}get __isActive(){return this.gameObject.visible}get __isActiveInHierarchy(){if(!this.gameObject)return!1;const e=this.gameObject[Li];return e===void 0?!0:e}awake(){}onEnable(){}onDisable(){}onDestroy(){this.__destroyed=!0}startCoroutine(e,t=xe.Update){return this.context.registerCoroutineUpdate(this,e,t)}stopCoroutine(e,t=xe.Update){this.context.unregisterCoroutineUpdate(e,t)}get destroyed(){return this.__destroyed}destroy(){this.destroyed||gm(this)}__internalNewInstanceCreated(){this.__didAwake=!1,this.__didStart=!1,this.__didEnable=!1,this.__isEnabled=void 0,this.__destroyed=!1}__internalAwake(){this.__didAwake||(this.__didAwake=!0,this.awake())}__internalStart(){this.__didStart||(this.__didStart=!0,this.start&&this.start())}__internalEnable(){this.__didEnable||(this.__didEnable=!0,this.onEnable())}__internalDisable(){!this.__didEnable||(this.__didEnable=!1,this.onDisable())}get worldPosition(){return this._worldPosition||(this._worldPosition=new y),C(this.gameObject,this._worldPosition),this._worldPosition}set worldPosition(e){D(this.gameObject,e)}setWorldPosition(e,t,s){Le._worldPositionBuffer.set(e,t,s),this.worldPosition=Le._worldPositionBuffer}get worldQuaternion(){return this._worldQuaternion||(this._worldQuaternion=new O),J(this.gameObject,this._worldQuaternion)}set worldQuaternion(e){Z(this.gameObject,e)}setWorldQuaternion(e,t,s,n){Le._worldQuaternionBuffer.set(e,t,s,n),this.worldQuaternion=Le._worldQuaternionBuffer}get worldEuler(){return this._worldEuler||(this._worldEuler=new Pe),this._worldEuler.setFromQuaternion(this.worldQuaternion),this._worldEuler}set worldEuler(e){var t;this._worldQuaternion||(this._worldQuaternion=new O),(t=this._worldQuaternion)==null||t.setFromEuler(e),this.worldQuaternion=this._worldQuaternion}get worldRotation(){const e=this.worldEuler;this._worldRotation||(this._worldRotation=new y);const t=this._worldRotation;return t.set(e.x,e.y,e.z),t.x=A.toDegrees(t.x),t.y=A.toDegrees(t.y),t.z=A.toDegrees(t.z),t}set worldRotation(e){this.setWorldRotation(e.x,e.y,e.z,!0)}setWorldRotation(e,t,s,n=!0){n&&(e=A.toRadians(e),t=A.toRadians(t),s=A.toRadians(s)),Le._worldEulerBuffer.set(e,t,s),Le._worldQuaternionBuffer.setFromEuler(Le._worldEulerBuffer),this.worldQuaternion=Le._worldQuaternionBuffer}get forward(){return Le._forward.set(0,0,1).applyQuaternion(this.worldQuaternion)}};let Se=Le;r(Se,"_worldPositionBuffer",new y),r(Se,"_worldQuaternionBuffer",new O),r(Se,"_worldEulerBuffer",new Pe),r(Se,"_tempQuaternionBuffer2",new O),r(Se,"_forward",new y(0,0,1));Ns(Se,"Component");class v extends Se{get enabled(){var e;return(e=this.__isEnabled)!=null?e:!0}set enabled(e){e!==this.__isEnabled&&(this.__isEnabled=e,!!this.__didAwake&&(e?this.__internalEnable():this.__internalDisable()))}}Ns(v,"Behaviour");var Fm=Object.defineProperty,Bm=(i,e)=>Fm(i,"name",{value:e,configurable:!0}),zs;(function(i){i.PointerDown="pointerDown"})(zs||(zs={}));class Kl extends EventTarget{constructor(e){super();r(this,"_doubleClickTimeThreshold",.5);r(this,"_longPressTimeThreshold",1);r(this,"_specialCursorTrigger",0);r(this,"context");r(this,"_pointerDown",[!1]);r(this,"_pointerUp",[!1]);r(this,"_pointerClick",[!1]);r(this,"_pointerDoubleClick",[!1]);r(this,"_pointerPressed",[!1]);r(this,"_pointerPositions",[new V]);r(this,"_pointerPositionsLastFrame",[new V]);r(this,"_pointerPositionsDelta",[new V]);r(this,"_pointerPositionsRC",[new V]);r(this,"_pointerPositionDown",[new V]);r(this,"_pointerDownTime",[]);r(this,"_pointerUpTime",[]);r(this,"_pointerIds",[]);r(this,"_pointerTypes",[""]);r(this,"_mouseWheelChanged",[!1]);r(this,"_pointerEvent",[]);r(this,"keysPressed",{});this.context=e,this.context.post_render_callbacks.push(this.onEndOfFrame.bind(this));const t=this.context.renderer.domElement;t.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!0}),t.addEventListener("touchend",this.onTouchUp.bind(this),!1),t.addEventListener("pointerdown",this.onPointerDown.bind(this),!1),t.addEventListener("pointermove",this.onPointerMove.bind(this),!1),t.addEventListener("pointerup",this.onPointerUp.bind(this),!1),t.addEventListener("wheel",this.onMouseWheel.bind(this),{passive:!0}),window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keypress",this.onKeyPressed.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1),window.addEventListener("blur",this.onLostFocus.bind(this))}get mousePosition(){return this._pointerPositions[0]}get mousePositionRC(){return this._pointerPositionsRC[0]}get mouseDown(){return this._pointerDown[0]}get mouseUp(){return this._pointerUp[0]}get mouseClick(){return this._pointerClick[0]}get mouseDoubleClick(){return this._pointerDoubleClick[0]}get mousePressed(){return this._pointerPressed[0]}get mouseWheelChanged(){return this.getMouseWheelChanged(0)}setCursorPointer(){this._specialCursorTrigger+=1,this.context.domElement.style.cursor="pointer"}setCursorNormal(){this._specialCursorTrigger-=1,this._specialCursorTrigger=Math.max(0,this._specialCursorTrigger),this._specialCursorTrigger===0&&(this.context.domElement.style.cursor="default")}getPointerPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&e++;return e}getPointerPosition(e){return e>=this._pointerPositions.length?null:this._pointerPositions[e]}getPointerPositionLastFrame(e){return e>=this._pointerPositionsLastFrame.length?null:this._pointerPositionsLastFrame[e]}getPointerPositionDelta(e){return e>=this._pointerPositionsDelta.length?null:this._pointerPositionsDelta[e]}getPointerPositionRC(e){return e>=this._pointerPositionsRC.length?null:this._pointerPositionsRC[e]}getPointerDown(e){return e>=this._pointerDown.length?!1:this._pointerDown[e]}getPointerUp(e){return e>=this._pointerUp.length?!1:this._pointerUp[e]}getPointerPressed(e){return e>=this._pointerPressed.length?!1:this._pointerPressed[e]}getPointerClicked(e){return e>=this._pointerClick.length?!1:this._pointerClick[e]}getPointerDoubleClicked(e){return e>=this._pointerDoubleClick.length?!1:this._pointerDoubleClick[e]}getPointerDownTime(e){return e>=this._pointerDownTime.length?-1:this._pointerDownTime[e]}getPointerUpTime(e){return e>=this._pointerUpTime.length?-1:this._pointerUpTime[e]}getPointerLongPress(e){return e>=this._pointerDownTime.length?!1:this.getPointerPressed(e)&&this.context.time.time-this._pointerDownTime[e]>this._longPressTimeThreshold}getIsMouse(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="mouse"}getIsTouch(e){return e>=this._pointerTypes.length?!1:this._pointerTypes[e]==="touch"}getTouchesPressedCount(){let e=0;for(let t=0;t<this._pointerPressed.length;t++)this._pointerPressed[t]&&this.getIsTouch(t)&&e++;return e}getMouseWheelChanged(e=0){return e>=this._mouseWheelChanged.length?!1:this._mouseWheelChanged[e]}getPointerEvent(e){var t;if(!(e>=this._pointerEvent.length))return(t=this._pointerEvent[e])!=null?t:void 0}getKeyDown(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.startFrame===this.context.time.frameCount)return t.key}return null}getKeyPressed(){for(const e in this.keysPressed){const t=this.keysPressed[e];if(t.pressed)return t.key}return null}isKeyDown(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.startFrame)===this.context.time.frameCount&&this.keysPressed[e].pressed}isKeyUp(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.frame)===this.context.time.frameCount&&!this.keysPressed[e].pressed}isKeyPressed(e){var t;return this.context.application.isVisible&&this.context.application.hasFocus&&((t=this.keysPressed[e])==null?void 0:t.pressed)}createPointerDown(e){this.onDown(e)}createPointerMove(e){this.onMove(e)}createPointerUp(e){this.onUp(e)}onLostFocus(){for(const e in this.keysPressed)this.keysPressed[e].pressed=!1}onEndOfFrame(){for(let e=0;e<this._pointerUp.length;e++)this._pointerUp[e]=!1;for(let e=0;e<this._pointerDown.length;e++)this._pointerDown[e]=!1;for(let e=0;e<this._pointerClick.length;e++)this._pointerClick[e]=!1;for(let e=0;e<this._pointerDoubleClick.length;e++)this._pointerDoubleClick[e]=!1;for(const e of this._pointerPositionsDelta)e.set(0,0);for(let e=0;e<this._mouseWheelChanged.length;e++)this._mouseWheelChanged[e]=!1}onKeyDown(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];t&&t.pressed||(this.keysPressed[e.keyCode]={pressed:!0,frame:this.context.time.frameCount+1,startFrame:this.context.time.frameCount+1,key:e.key})}onKeyPressed(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!0,t.frame=this.context.time.frameCount+1)}onKeyUp(e){if(!this.context.application.hasFocus)return;const t=this.keysPressed[e.keyCode];!t||(t.pressed=!1,t.frame=this.context.time.frameCount+1)}onMouseWheel(e){this._mouseWheelChanged.length<=0&&this._mouseWheelChanged.push(!1),this._mouseWheelChanged[0]=!0}onTouchMove(e){}onTouchUp(e){}onPointerDown(e){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;e.preventDefault&&e.preventDefault();let t=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(t=e.button),this.onDown({button:t,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}onPointerMove(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),s<0&&(s=0);const n={button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e};this.onMove(n)}onPointerUp(e,t=void 0){if(e.defaultPrevented||e.pointerType===void 0&&e.pointerId===void 0)return;t!==!0&&e.preventDefault();let s=e.pointerType==="mouse"?e.button:this.getPointerIndex(e.pointerId);e.pointerId===void 0&&e.button!==void 0&&(s=e.button),this._pointerIds[s]=-1,this.onUp({button:s,clientX:e.clientX,clientY:e.clientY,pointerType:e.pointerType,source:e})}isInRect(e){return!0}onDown(e){if(!!this.isInRect(e)){for(this.setPointerState(e.button,this._pointerPressed,!0),this.setPointerState(e.button,this._pointerDown,!0),this.setPointerStateT(e.button,this._pointerEvent,e.source);e.button>=this._pointerTypes.length;)this._pointerTypes.push(e.pointerType);for(this._pointerTypes[e.button]=e.pointerType===void 0?"mouse":e.pointerType;e.button>=this._pointerPositionDown.length;)this._pointerPositionDown.push(new V);this._pointerPositionDown[e.button].set(e.clientX,e.clientY),e.button>=this._pointerDownTime.length&&this._pointerDownTime.push(0),this._pointerDownTime[e.button]=this.context.time.time,this.updatePointerPosition(e),E.Current=this.context,this.dispatchEvent(new Event(zs.PointerDown))}}onMove(e){!this.isInRect(e)||(this.updatePointerPosition(e),this.setPointerStateT(e.button,this._pointerEvent,e.source))}onUp(e){if(this.setPointerState(e.button,this._pointerPressed,!1),this.setPointerStateT(e.button,this._pointerEvent,e.source),!this.isInRect(e))return;if(this.setPointerState(e.button,this._pointerUp,!0),this.updatePointerPosition(e),!this._pointerPositionDown[e.button]){console.warn("Received pointer up event without matching down event for button: "+e.button);return}const t=e.clientX-this._pointerPositionDown[e.button].x,s=e.clientY-this._pointerPositionDown[e.button].y;if(e.button>=this._pointerUpTime.length&&this._pointerUpTime.push(-99),Math.abs(t)<5&&Math.abs(s)<5){this.setPointerState(e.button,this._pointerClick,!0);const n=this._pointerUpTime[e.button],o=this.context.time.time-n;o<this._doubleClickTimeThreshold&&o>0&&this.setPointerState(e.button,this._pointerDoubleClick,!0)}this._pointerUpTime[e.button]=this.context.time.time}updatePointerPosition(e){for(;e.button>=this._pointerPositions.length;)this._pointerPositions.push(new V);for(;e.button>=this._pointerPositionsLastFrame.length;)this._pointerPositionsLastFrame.push(new V);for(;e.button>=this._pointerPositionsDelta.length;)this._pointerPositionsDelta.push(new V);const t=this._pointerPositionsLastFrame[e.button];t.copy(this._pointerPositions[e.button]),this._pointerPositionsDelta[e.button].set(e.clientX-t.x,e.clientY-t.y),this._pointerPositions[e.button].x=e.clientX,this._pointerPositions[e.button].y=e.clientY;const s=e.clientX+window.scrollX,n=e.clientY+window.scrollY;for(;e.button>=this._pointerPositionsRC.length;)this._pointerPositionsRC.push(new V);this._pointerPositionsRC[e.button].x=(s-this.context.domX)/this.context.domWidth*2-1,this._pointerPositionsRC[e.button].y=-((n-this.context.domY)/this.context.domHeight)*2+1}getPointerIndex(e){for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===e)return t;for(let t=0;t<this._pointerIds.length;t++)if(this._pointerIds[t]===-1&&(this._pointerIds[t]=e),this._pointerIds[t]===e)return t;return this._pointerIds.push(e),this._pointerIds.length-1}setPointerState(e,t,s){for(;t.length<=e;)t.push(!1);t[e]=s}setPointerStateT(e,t,s){for(;t.length<=e;)t.push(null);t[e]=s}}Bm(Kl,"Input");var Ye;(function(i){i[i.BACKSPACE=8]="BACKSPACE",i[i.TAB=9]="TAB",i[i.ENTER=13]="ENTER",i[i.SHIFT=16]="SHIFT",i[i.CTRL=17]="CTRL",i[i.ALT=18]="ALT",i[i.PAUSE=19]="PAUSE",i[i.CAPS_LOCK=20]="CAPS_LOCK",i[i.ESCAPE=27]="ESCAPE",i[i.SPACE=32]="SPACE",i[i.PAGE_UP=33]="PAGE_UP",i[i.PAGE_DOWN=34]="PAGE_DOWN",i[i.END=35]="END",i[i.HOME=36]="HOME",i[i.LEFT_ARROW=37]="LEFT_ARROW",i[i.UP_ARROW=38]="UP_ARROW",i[i.RIGHT_ARROW=39]="RIGHT_ARROW",i[i.DOWN_ARROW=40]="DOWN_ARROW",i[i.INSERT=45]="INSERT",i[i.DELETE=46]="DELETE",i[i.KEY_0=48]="KEY_0",i[i.KEY_1=49]="KEY_1",i[i.KEY_2=50]="KEY_2",i[i.KEY_3=51]="KEY_3",i[i.KEY_4=52]="KEY_4",i[i.KEY_5=53]="KEY_5",i[i.KEY_6=54]="KEY_6",i[i.KEY_7=55]="KEY_7",i[i.KEY_8=56]="KEY_8",i[i.KEY_9=57]="KEY_9",i[i.KEY_A=65]="KEY_A",i[i.KEY_B=66]="KEY_B",i[i.KEY_C=67]="KEY_C",i[i.KEY_D=68]="KEY_D",i[i.KEY_E=69]="KEY_E",i[i.KEY_F=70]="KEY_F",i[i.KEY_G=71]="KEY_G",i[i.KEY_H=72]="KEY_H",i[i.KEY_I=73]="KEY_I",i[i.KEY_J=74]="KEY_J",i[i.KEY_K=75]="KEY_K",i[i.KEY_L=76]="KEY_L",i[i.KEY_M=77]="KEY_M",i[i.KEY_N=78]="KEY_N",i[i.KEY_O=79]="KEY_O",i[i.KEY_P=80]="KEY_P",i[i.KEY_Q=81]="KEY_Q",i[i.KEY_R=82]="KEY_R",i[i.KEY_S=83]="KEY_S",i[i.KEY_T=84]="KEY_T",i[i.KEY_U=85]="KEY_U",i[i.KEY_V=86]="KEY_V",i[i.KEY_W=87]="KEY_W",i[i.KEY_X=88]="KEY_X",i[i.KEY_Y=89]="KEY_Y",i[i.KEY_Z=90]="KEY_Z",i[i.LEFT_META=91]="LEFT_META",i[i.RIGHT_META=92]="RIGHT_META",i[i.SELECT=93]="SELECT",i[i.NUMPAD_0=96]="NUMPAD_0",i[i.NUMPAD_1=97]="NUMPAD_1",i[i.NUMPAD_2=98]="NUMPAD_2",i[i.NUMPAD_3=99]="NUMPAD_3",i[i.NUMPAD_4=100]="NUMPAD_4",i[i.NUMPAD_5=101]="NUMPAD_5",i[i.NUMPAD_6=102]="NUMPAD_6",i[i.NUMPAD_7=103]="NUMPAD_7",i[i.NUMPAD_8=104]="NUMPAD_8",i[i.NUMPAD_9=105]="NUMPAD_9",i[i.MULTIPLY=106]="MULTIPLY",i[i.ADD=107]="ADD",i[i.SUBTRACT=109]="SUBTRACT",i[i.DECIMAL=110]="DECIMAL",i[i.DIVIDE=111]="DIVIDE",i[i.F1=112]="F1",i[i.F2=113]="F2",i[i.F3=114]="F3",i[i.F4=115]="F4",i[i.F5=116]="F5",i[i.F6=117]="F6",i[i.F7=118]="F7",i[i.F8=119]="F8",i[i.F9=120]="F9",i[i.F10=121]="F10",i[i.F11=122]="F11",i[i.F12=123]="F12",i[i.NUM_LOCK=144]="NUM_LOCK",i[i.SCROLL_LOCK=145]="SCROLL_LOCK",i[i.SEMICOLON=186]="SEMICOLON",i[i.EQUALS=187]="EQUALS",i[i.COMMA=188]="COMMA",i[i.DASH=189]="DASH",i[i.PERIOD=190]="PERIOD",i[i.FORWARD_SLASH=191]="FORWARD_SLASH",i[i.GRAVE_ACCENT=192]="GRAVE_ACCENT",i[i.OPEN_BRACKET=219]="OPEN_BRACKET",i[i.BACK_SLASH=220]="BACK_SLASH",i[i.CLOSE_BRACKET=221]="CLOSE_BRACKET",i[i.SINGLE_QUOTE=222]="SINGLE_QUOTE"})(Ye||(Ye={}));var Um=Object.defineProperty,Nm=(i,e)=>Um(i,"name",{value:e,configurable:!0});class $s{constructor(e,t){r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new j(1,1,0,0));r(this,"context");r(this,"gameObject");r(this,"lightmapTexture",null);r(this,"lightmapScaleOffsetUniform",{value:new j(1,1,0,0)});r(this,"lightmapUniform",{value:null});r(this,"beforeRenderCallback");this.gameObject=e,this.context=t}get lightmap(){return this.lightmapTexture}set lightmap(e){e!==this.lightmapTexture&&(this.lightmapTexture=e,this.setupLightmap())}init(e,t,s,n=!1){if(console.assert(this.gameObject!==void 0&&this.gameObject!==null,"Missing gameobject",this),this.lightmapIndex=e,this.lightmapIndex<0)return;this.lightmapScaleOffset=t,this.lightmapTexture=s,n&&this.setLightmapDebugMaterial(),this.setupLightmap()}bindOnBeforeRender(){this.beforeRenderCallback=this.onBeforeRenderThreeComplete.bind(this),this.context.addBeforeRenderListener(this.gameObject,this.beforeRenderCallback)}onBeforeRenderThreeComplete(e,t,s,n,o,a){this.onBeforeRenderThree(o)}setupLightmap(){if(this.gameObject.type==="Object3D")return;if(this.gameObject.type==="Group"){console.warn("Lightmap on multimaterial object is not supported yet... please ask kindly for implementation.");return}console.assert(this.gameObject.type==="Mesh","Lightmap only works on meshes",this);const e=this.gameObject;e.geometry.getAttribute("uv2")||e.geometry.setAttribute("uv2",e.geometry.getAttribute("uv"));const t=this.gameObject.material.clone();if(this.gameObject.material=t,this.gameObject.material.onBeforeCompile=(s,n)=>{s.uniforms.lightmap=this.lightmapUniform,s.uniforms.lightmapScaleOffset=this.lightmapScaleOffsetUniform},this.lightmapIndex>=0){const s=this.lightmapTexture,n=this.gameObject.material;n&&s&&(n.uniforms||(n.uniforms={}),n.lightMap=s,n.uniforms.lightmap={value:s})}}onBeforeRenderThree(e){const t=e.uniforms;t&&t.lightmap&&(this.lightmapScaleOffsetUniform.value=this.lightmapScaleOffset,this.lightmapUniform.value=this.lightmapTexture,t.lightmap=this.lightmapUniform,t.lightmapScaleOffset=this.lightmapScaleOffsetUniform)}setLightmapDebugMaterial(){this.gameObject.material=new Xa({vertexShader:`
                attribute vec2 uv2;
                varying vec2 vUv2;
                void main()
                {
                    vUv2 = uv2;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
                }
                `,fragmentShader:`
                uniform sampler2D lightmap;
                uniform float lightMapIntensity;
                uniform vec4 lightmapScaleOffset;
                varying vec2 vUv2;

                // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
                vec4 conv_sRGBToLinear( in vec4 value ) {
                    return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
                }

                void main() {
                    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
                    
                    vec4 lightMapTexel = texture2D( lightmap, lUv);
                    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
                    //lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
                    //lightMapTexel.a = 1.;
                    //lightMapTexel = conv_sRGBToLinear(lightMapTexel);
                    // lightMapTexel.rgb = vec3(1.);

                    // gl_FragColor = vec4(vUv2.xy, 0, 1);
                    gl_FragColor = lightMapTexel;
                }
                `,defines:{USE_LIGHTMAP:""}})}}Nm($s,"RendererLightmap");var zm=Object.defineProperty,Ws=(i,e)=>zm(i,"name",{value:e,configurable:!0});const _=Ws(function(i){if(i===void 0&&(i=null),!Array.isArray(i))i=Jr(i);else for(let e=0;e<i.length;e++){const t=i[e];i[e]=Jr(t)}return function(e,t){Object.getOwnPropertyDescriptor(e,"$serializedTypes")||(e.$serializedTypes={});const s=e.$serializedTypes=e.$serializedTypes||{};s[t]=i}},"serializeable");function Jr(i){var e,t;switch((t=(e=i==null?void 0:i.prototype)==null?void 0:e.constructor)==null?void 0:t.name){case"Number":case"String":case"Boolean":return null}return i}Ws(Jr,"setNullForPrimitiveTypes");const $m="__NEEDLE__ALL_PROPERTIES";function Wm(i){i[$m]=!0}Ws(Wm,"allProperties");const Hm="__NEEDLE__STRICT";function Gm(i){i[Hm]=!0}Ws(Gm,"strict");var ec=Object.defineProperty,Vm=Object.getOwnPropertyDescriptor,Qe=(i,e)=>ec(i,"name",{value:e,configurable:!0}),Ft=(i,e,t,s)=>{for(var n=s>1?void 0:s?Vm(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&ec(e,t,n),n};const tc=w("noInstancing"),ic=!!w("debuglightmaps");class sc{constructor(){r(this,"path",null);r(this,"asset",null);r(this,"default")}}Qe(sc,"FieldWithDefault");var nc;(function(i){i[i.Both=0]="Both",i[i.Back=1]="Back",i[i.Front=2]="Front"})(nc||(nc={}));class rc{constructor(e){r(this,"_renderer");r(this,"_targets",[]);this._renderer=e;const t=this.setMaterial.bind(this),s=this.getMaterial.bind(this),n=e.gameObject;if(this._targets=[],n)switch(n.type){case"Group":this._targets=[...n.children];break;case"Mesh":this._targets.push(n);break}return new Proxy(this,{get(o,a){if(typeof a=="string"){const l=parseInt(a);if(!isNaN(l))return s(l)}return o[a]},set(o,a,l){return typeof a=="string"&&t(l,Number.parseInt(a)),Reflect.set(o,a,l)}})}is(e){return this._renderer===e}get length(){return this._targets.length}setMaterial(e,t){if(t<0||t>=this._targets.length)return;const s=this._renderer.gameObject;if(!s)return;const n=s.children[t];!n||(n.material=e)}getMaterial(e){if(e<0)return null;const t=this._targets;if(e>=t.length)return null;const s=t[e];return s?s.material:null}}Qe(rc,"SharedMaterialArray");const oc=class extends v{constructor(){super(...arguments);r(this,"receiveShadows",!1);r(this,"shadowCastingMode",Hs.Off);r(this,"lightmapIndex",-1);r(this,"lightmapScaleOffset",new j(1,1,0,0));r(this,"enableInstancing");r(this,"renderOrder");r(this,"allowOcclusionWhenDynamic",!0);r(this,"_lightmaps");r(this,"_sharedMaterials");r(this,"_lightmapTextureOverride");r(this,"_isInstancingEnabled",!1);r(this,"handles");r(this,"prevLayers")}get material(){return this.gameObject.material}set material(i){this.gameObject.material=i}get sharedMaterials(){return(!this._sharedMaterials||!this._sharedMaterials.is(this))&&(this._sharedMaterials=new rc(this)),this._sharedMaterials}static get shouldSuppressInstancing(){return tc}get lightmap(){var i;return((i=this._lightmaps)==null?void 0:i.length)?this._lightmaps[0].lightmap:null}set lightmap(i){var e;if(this._lightmapTextureOverride=i,i===void 0&&(i=this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex)),(e=this._lightmaps)==null?void 0:e.length)for(const t of this._lightmaps)t.lightmap=i}awake(){var e,t;const i=this.gameObject.type;if(i==="Group"){for(const s of this.gameObject.children)s.layers.mask=this.gameObject.layers.mask;if(this.renderOrder!==void 0){let s=0;for(let n=0;n<this.gameObject.children.length;n++){const o=this.gameObject.children[n];if(!(o.type!=="Mesh"||p.getComponent(o,oc))){if(this.renderOrder.length<=s){console.error("Incorrect element count",this);break}o.renderOrder=this.renderOrder[s],s+=1}}}}if(this.lightmapIndex>=0){const s=this._lightmapTextureOverride!==void 0?this._lightmapTextureOverride:this.context.lightmaps.tryGetLightmap(this.sourceId,this.lightmapIndex);if(s){if(this._lightmaps=[],i==="Mesh"){if(!((e=this.gameObject.material)==null?void 0:e.isMeshBasicMaterial)){const n=new $s(this.gameObject,this.context);this._lightmaps.push(n),n.init(this.lightmapIndex,this.lightmapScaleOffset,s,ic)}}else if(i==="Group"){for(const n of this.gameObject.children)if(!((t=n.material)==null?void 0:t.isMeshBasicMaterial)){const o=new $s(n,this.context);this._lightmaps.push(o),o.init(this.lightmapIndex,this.lightmapScaleOffset,s,ic),o.bindOnBeforeRender()}}}}(i==="Mesh"||i==="SkinnedMesh")&&(this.renderOrder!==void 0&&this.renderOrder.length>0&&(this.gameObject.renderOrder=this.renderOrder[0]),this.context.addBeforeRenderListener(this.gameObject,this.onBeforeRenderThree.bind(this)))}setInstancingEnabled(i){if(this._isInstancingEnabled===i)return i&&(this.handles===void 0||this.handles!=null&&this.handles.length>0);if(this._isInstancingEnabled=i,i){if(this.handles===void 0){if(this.handles=qm.setup(this.gameObject,this.context,null,{rend:this,foundMeshes:0}),this.handles)return p.markAsInstancedRendered(this.gameObject,!0),!0}else if(this.handles!==null){for(const e of this.handles)e.updateInstanceMatrix(!0),e.add();return p.markAsInstancedRendered(this.gameObject,!0),!0}}else{if(this.handles)for(const e of this.handles)e.remove();return!0}return!1}start(){if(this.enableInstancing&&!tc&&this.setInstancingEnabled(!0),this.gameObject.frustumCulled=this.allowOcclusionWhenDynamic,this.gameObject.type==="Group")for(let i=0;i<this.gameObject.children.length;i++){const e=this.gameObject.children[i];e.frustumCulled=this.allowOcclusionWhenDynamic}}onEnable(){this._isInstancingEnabled?this.setInstancingEnabled(!0):this.enabled&&(this.gameObject.visible=!0)}onDisable(){this.handles&&this.handles.length>0?this.setInstancingEnabled(!1):this.enabled||(this.gameObject.visible=!1)}onDestroy(){this.handles=null}onBeforeRenderThree(i,e,t,s,n,o){var a;if(!t&&this.context.isInXR){const l=this.context.renderer.xr.getCamera();((a=l.cameras)==null?void 0:a.length)>0&&(t=l)}if(this._lightmaps)for(const l of this._lightmaps)l.onBeforeRenderThree(n)}onBeforeRender(){var e;if(!this.gameObject)return;const i=this.gameObject[Kr]===!0||this.gameObject.matrixWorldNeedsUpdate;if(this.gameObject.type==="Group"&&((e=this.gameObject.children)==null?void 0:e.length)>0)for(const t of this.gameObject.children)this.applySettings(t);else this.applySettings(this.gameObject);if(i&&(delete this.gameObject[Kr],this.handles)){for(let t=this.handles.length-1;t>=0;t--)this.handles[t].updateInstanceMatrix();this.gameObject.matrixWorldNeedsUpdate=!1}if(this.handles&&this.handles.length<=0&&p.markAsInstancedRendered(this.gameObject,!1),this._isInstancingEnabled&&this.handles)for(let t=0;t<this.handles.length;t++){const s=this.handles[t];this.prevLayers||(this.prevLayers=[]);const n=s.object.layers.mask;t>=this.prevLayers.length?this.prevLayers.push(n):this.prevLayers[t]=n,s.object.layers.disableAll()}}onAfterRender(){if(this._isInstancingEnabled&&this.handles&&this.prevLayers&&this.prevLayers.length>=this.handles.length)for(let i=0;i<this.handles.length;i++){const e=this.handles[i];e.object.layers.mask=this.prevLayers[i]}}applySettings(i){i.receiveShadow=this.receiveShadows,this.shadowCastingMode==Hs.On?i.castShadow=!0:i.castShadow=!1}};let se=oc;Qe(se,"Renderer");Ft([_()],se.prototype,"receiveShadows",2);Ft([_()],se.prototype,"shadowCastingMode",2);Ft([_()],se.prototype,"lightmapIndex",2);Ft([_(j)],se.prototype,"lightmapScaleOffset",2);Ft([_()],se.prototype,"enableInstancing",2);Ft([_()],se.prototype,"renderOrder",2);Ft([_()],se.prototype,"allowOcclusionWhenDynamic",2);class Zr extends se{}Qe(Zr,"MeshRenderer");class ac extends Zr{awake(){super.awake(),this.allowOcclusionWhenDynamic=!1}}Qe(ac,"SkinnedMeshRenderer");var Hs;(function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.TwoSided=2]="TwoSided",i[i.ShadowsOnly=3]="ShadowsOnly"})(Hs||(Hs={}));const Kr="NEEDLE_NEED_UPDATE_INSTANCE";class de{static markDirty(e,t=!0){if(!!e&&(p.isUsingInstancing(e)&&(e[Kr]=!0,e.matrixWorldNeedsUpdate=!0),t))for(const s of e.children)de.markDirty(s,!0)}}Qe(de,"InstancingUtil");class lc{constructor(){r(this,"objs",[])}setup(e,t,s,n,o=0){const a=this.tryCreateOrAddInstance(e,t,n);if(a)return s===null&&(s=[]),s.push(a),s;if(o<=0&&e.type!=="Mesh"){const l=o+1;for(const c of e.children)s=this.setup(c,t,s,n,l)}return s}tryCreateOrAddInstance(e,t,s){if(e.type==="Mesh"){const n=s.foundMeshes;if(s.foundMeshes+=1,!s.rend.enableInstancing||n>=s.rend.enableInstancing.length||!s.rend.enableInstancing[n])return null;const o=e,a=o.geometry,l=o.material;for(const h of this.objs)if(!h.isFull()&&h.geo===a&&h.material===l)return h.addInstance(o);const c=new Gs(e.name,a,l,200,t);return this.objs.push(c),c.addInstance(o)}return null}}Qe(lc,"InstancingHandler");const qm=new lc;class cc{constructor(e,t,s){r(this,"instanceIndex",-1);r(this,"object");r(this,"instancer");this.instanceIndex=e,this.object=t,this.instancer=s,p.markAsInstancedRendered(t,!0)}get name(){return this.object.name}updateInstanceMatrix(e=!1){this.instanceIndex<0||(this.object.updateWorldMatrix(!0,e),this.instancer.updateInstance(this.object.matrixWorld,this.instanceIndex))}add(){this.instanceIndex>=0||this.instancer.add(this)}remove(){this.instanceIndex<0||this.instancer.remove(this)}}Qe(cc,"InstanceHandle");const Fa=class{constructor(e,t,s,n,o){r(this,"name","");r(this,"geo");r(this,"material");r(this,"context");r(this,"inst");r(this,"handles",[]);r(this,"maxCount");this.name=e,this.geo=t,this.material=s,this.context=o,this.maxCount=n,this.inst=new Hf(t,s,n),this.inst.count=0,this.inst.layers.set(2),this.inst.visible=!0,this.context.scene.add(this.inst)}get currentCount(){return this.inst.count}isFull(){return this.currentCount>=this.maxCount}addInstance(e){if(this.currentCount>=this.maxCount)return console.error("TOO MANY INSTANCES - resize is not yet implemented!",this.inst.count),null;const t=new cc(-1,e,this);return this.add(t),t}add(e){e.instanceIndex<0&&(e.instanceIndex=this.currentCount,e.instanceIndex>=this.handles.length?this.handles.push(e):this.handles[e.instanceIndex]=e),e.object.updateWorldMatrix(!0,!0),this.inst.setMatrixAt(e.instanceIndex,e.object.matrixWorld),this.inst.instanceMatrix.needsUpdate=!0,this.inst.count+=1,this.inst.count>0&&(this.inst.visible=!0)}remove(e){if(!e||e.instanceIndex<0||e.instanceIndex>=this.handles.length||this.inst.count<=0)return;if(this.handles[e.instanceIndex]!==e){console.error("instance handle is not part of renderer, was it removed before?",e.instanceIndex,this.name);const s=this.handles.indexOf(e);if(s<0)return;e.instanceIndex=s}if(this.handles[e.instanceIndex]=null,this.inst.setMatrixAt(e.instanceIndex,Fa.nullMatrix),!(e.instanceIndex>=this.currentCount-1)&&this.currentCount>0){const s=this.handles[this.currentCount-1];s&&(s.instanceIndex=e.instanceIndex,s.updateInstanceMatrix(),this.handles[e.instanceIndex]=s,this.handles[this.currentCount-1]=null)}this.inst.count>0&&(this.inst.count-=1),e.instanceIndex=-1,this.inst.count<=0&&(this.inst.visible=!1),this.inst.instanceMatrix.needsUpdate=!0}updateInstance(e,t){this.inst.setMatrixAt(t,e),this.inst.instanceMatrix.needsUpdate=!0}};let Gs=Fa;r(Gs,"nullMatrix",new Oe);Qe(Gs,"InstancedMeshRenderer");var Xm=Object.defineProperty,Je=(i,e)=>Xm(i,"name",{value:e,configurable:!0});const ji=w("debugphysics");class eo{constructor(){r(this,"mass",1);r(this,"kinematic",!1);r(this,"physicsEvents",!1);r(this,"drag",0);r(this,"angularDrag",.05);r(this,"sleepThreshold",.01)}}Je(eo,"BodyOptions");class Vs{constructor(e,t){r(this,"obj");r(this,"parent");r(this,"body");r(this,"shapes",[]);r(this,"collisonCallback",null);r(this,"_hasRigidbody",!1);r(this,"_didSleepLastStep",!1);this.obj=e,this.parent=e.parent,this.body=t}}Je(Vs,"PhysicsObject");class hc{constructor(e,t){r(this,"obj");r(this,"contact");r(this,"target");r(this,"type");this.contact=e,this.type=t,this.obj=null,this.target=null}}Je(hc,"CollisionData");class Ym{constructor(e,t,s,n){r(this,"body");r(this,"contact");r(this,"target");r(this,"type");this.body=e,this.contact=t,this.target=s,this.type=n}}Je(Ym,"CannonCollision");class Me{constructor(){r(this,"ray");r(this,"screenPoint");r(this,"raycaster");r(this,"results");r(this,"targets");r(this,"recursive",!0);r(this,"minDistance");r(this,"maxDistance");r(this,"lineThreshold");r(this,"layerMask");r(this,"ignore")}screenPointFromOffset(e,t){this.screenPoint===void 0&&(this.screenPoint=new V),this.screenPoint.x=e/window.innerWidth*2-1,this.screenPoint.y=-(t/window.innerHeight)*2+1}setMask(e){this.layerMask||(this.layerMask=new Es);const t=this.layerMask;t?t.mask=e:this.layerMask=e}}r(Me,"AllLayers",4294967295);Je(Me,"RaycastOptions");class dc{constructor(e,t,s){r(this,"distance");r(this,"point");r(this,"object");this.object=e,this.distance=t,this.point=s}}Je(dc,"SphereIntersection");class uc{constructor(e){r(this,"raycaster",new Sr);r(this,"defaultRaycastOptions",new Me);r(this,"targetBuffer",new Array(1));r(this,"defaultThresholds",{Mesh:{},Line:{threshold:0},LOD:{},Points:{threshold:0},Sprite:{}});r(this,"sphereResults",new Array);r(this,"sphereMask",new Es);r(this,"tempBoundingBox",new Jt);r(this,"context");r(this,"world",new Vf);r(this,"objects",[]);r(this,"tempPosition",new y);r(this,"tempQuaternion",new O);if(this.context=e,this.world.gravity.set(0,-9.82,0),ji){const t={};t.onInit=(s,n,o)=>{n.layers.set(-1)},qf(e.scene,this.world.bodies,t)}}sphereOverlap(e,t){if(this.sphereResults.length=0,!this.context.scene)return this.sphereResults;const s=new Gf(e,t),n=this.sphereMask;n.enableAll(),n.disable(2);for(const o of this.context.scene.children){const a=this.onSphereOverlap(o,s,n);a&&this.sphereResults.push(a)}return this.sphereResults.sort((o,a)=>o.distance-a.distance)}onSphereOverlap(e,t,s){if(e.type==="Mesh"){if(!e.layers.test(s))return null;const n=e,o=n.geometry;if(o.boundingBox||o.computeBoundingBox(),!o.boundingBox)return null;n.matrixWorldNeedsUpdate&&n.updateMatrixWorld();const a=this.tempBoundingBox.copy(o.boundingBox).applyMatrix4(n.matrixWorld);if(t.intersectsBox(a)){const c=C(e).distanceTo(t.center);return new dc(e,c,t.center.clone())}}else if(e.children)for(const n of e.children){const o=this.onSphereOverlap(n,t,s);if(o)return o}return null}raycastFromRay(e,t=null){const s=t!=null?t:this.defaultRaycastOptions;return s.ray=e,this.raycast(s)}raycast(e=null){var l,c,h,d,u;e||(e=this.defaultRaycastOptions);const t=(l=e.screenPoint)!=null?l:this.context.input.mousePositionRC,s=(c=e.raycaster)!=null?c:this.raycaster;if(s.near=(h=e.minDistance)!=null?h:0,s.far=(d=e.maxDistance)!=null?d:1/0,s.params=this.defaultThresholds,e.lineThreshold?s.params.Line={threshold:e.lineThreshold}:s.params.Line={threshold:0},e.ray)s.ray.copy(e.ray);else{const g=this.context.mainCamera;if(!g)return console.error("Can not perform raycast - no main camera found"),this.defaultRaycastOptions.results&&(this.defaultRaycastOptions.results.length=0),(u=this.defaultRaycastOptions.results)!=null?u:[];s.setFromCamera(t,g)}let n=e.targets;n||(n=this.targetBuffer,n[0]=this.context.scene);let o=e.results;o||(this.defaultRaycastOptions.results||(this.defaultRaycastOptions.results=new Array),o=this.defaultRaycastOptions.results),e.layerMask!==void 0?e.layerMask instanceof Es?s.layers.mask=e.layerMask.mask:s.layers.mask=e.layerMask:(s.layers.enableAll(),s.layers.disable(2)),o.length=0,s.intersectObjects(n,e.recursive,o);const a=e.ignore;return a!==void 0&&a.length>0&&(o=o.filter(g=>!a.includes(g.object))),o}addPreStepListener(e){this.world.addEventListener("preStep",e)}addPostStepListener(e){this.world.addEventListener("postStep",e)}addConstraint(e){this.world.addConstraint(e)}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}multiplyGravity(e){this.world.gravity.x*=e.x,this.world.gravity.y*=e.y,this.world.gravity.z*=e.z}addBody(e,t){for(let s=0;s<this.objects.length;s++){const n=this.objects[s];if(n.obj===e){n._hasRigidbody=!0;break}}this.world.addBody(t)}removeBody(e,t,s=!0){this.world.removeBody(t);for(let n=0;n<this.objects.length;n++){const o=this.objects[n];if(o.obj===e){o._hasRigidbody=!1,s&&this.objects.splice(n,1);break}}}removeShape(e,t){for(const s of this.objects)if(s.obj===e){s.body&&(s.body.removeShape(t),s.body.updateMassProperties());return}}createBody(e,t){const s=this.internalCreateBody(e,null);t.mass&&(s.mass=t.mass),t.kinematic?s.type=he.KINEMATIC:s.type=he.DYNAMIC,t.drag&&(s.linearDamping=t.drag),t.angularDrag&&(s.angularDamping=t.angularDrag),t.sleepThreshold&&(s.sleepSpeedLimit=t.sleepThreshold),s.name=e.name,this.world.addBody(s);const n=new Vs(e,s);return n._hasRigidbody=!0,this.objects.push(n),ji&&console.log("created new body",s),t.physicsEvents&&this.registerCollisionEvents(n),s}addBoxCollider(e,t,s,n,o){const a=this.tempPosition;e.getWorldScale(a);const l=new Lt(.5*a.x*n.x,.5*a.y*n.y,.5*a.z*n.z),c=new Xf(l);c.collisionResponse=!t,s=s.clone(),s.multiply(a);const h=this.addShape(e,c,s,o);if(h!==null){if(this.isAlreadyRegistered(h))return c;const d=new Vs(e,h);this.objects.push(d)}return c}addSphereCollider(e,t,s,n){const o=this.tempPosition;e.getWorldScale(o);const a=Math.max(o.x,o.y,o.z),l=new Yf(s*a);t=t.clone(),t.multiply(o);const c=this.addShape(e,l,t,n);if(c!==null){if(this.isAlreadyRegistered(c))return l;const h=new Vs(e,c);this.objects.push(h)}return l}addMeshCollider(e){ji&&console.warn("TODO mesh collider not yet supported")}isAlreadyRegistered(e){for(const t of this.objects)if(t.body===e)return!0;return!1}addShape(e,t,s,n){let o=null;if(n?(n.initialize(),console.assert(!!n.body,"rigidbody didn't initialize / produce a physics body",n),o=n.body):(o=this.internalCreateBody(e,null),o.type=he.KINEMATIC,this.world.addBody(o)),o){s.x*=-1;const a=J(e),l=C(e);l.add(s);const c=new O(o.quaternion.x,o.quaternion.y,o.quaternion.z,o.quaternion.w);a.multiply(c.invert());const h=o.position,d=new Lt(l.x-h.x,l.y-h.y,l.z-h.z),u=new Ya(a.x,a.y,a.z,a.w);o.addShape(t,d,u),o.updateMassProperties()}return o}step(e){e=Math.min(e,1/30),this.world.step(e)}postStep(){for(let e=0;e<this.objects.length;e++){const t=this.objects[e],s=t.body;if(!s||!s.world)continue;s.sleepTick(this.context.time.time),ji&&(!t._didSleepLastStep&&s.sleepState===he.SLEEPING?console.log("BODY SLEEPING",s):t._didSleepLastStep&&s.sleepState!==he.SLEEPING&&console.log("BODY WOKE UP",s)),t._didSleepLastStep=s.sleepState===he.SLEEPING;const n=t.obj;if(s.type===he.KINEMATIC){const o=C(n,null);s.position.set(o.x,o.y,o.z);const a=J(n);s.quaternion.set(a.x,a.y,a.z,a.w);continue}if(t.parent&&n.parent===t.parent){Ml(n,s.quaternion.x,s.quaternion.y,s.quaternion.z,s.quaternion.w);const o=s.position;Ls(n,o.x,o.y,o.z),s.velocity.length()>s.sleepSpeedLimit&&de.markDirty(n)}}}internalCreateBody(e,t){const s=new he;e.getWorldPosition(this.tempPosition);const n=this.tempPosition;s.position=new Lt(n.x,n.y,n.z);const o=this.tempQuaternion;return e.getWorldQuaternion(o),s.quaternion=new Ya(o.x,o.y,o.z,o.w),s.type=he.KINEMATIC,t&&(s.addShape(t),s.updateMassProperties()),s}registerCollisionEvents(e){if(e.collisonCallback&&this.unregisterCollisionEvents(e),!e.body)return;const t=Je(s=>this.raiseCollisionEvents(e.obj,s),"evt");e.collisonCallback=t.bind(this),e.body.addEventListener("collide",e.collisonCallback)}unregisterCollisionEvents(e){!e.collisonCallback||!e.body||e.body.removeEventListener("collide",e.collisonCallback)}raiseCollisionEvents(e,t){var l,c;const s=new hc(t.contact,t.type);let n=0;const o=this.objects;function a(){if(!(n>0))for(let h=0;h<o.length;h++){if(n==2)return;const d=o[h];d.body==t.body?(s.obj=d.obj,++n):d.body==t.target&&(s.target=d.obj,++n)}}Je(a,"requestData"),ji&&console.log("collision between",t.contact.bi,t.contact.bj,e,t);for(let h=0;h<((c=(l=e.userData)==null?void 0:l.components)==null?void 0:c.length);h++){const d=e.userData.components[h];d.onCollision&&(a(),d.onCollision(s))}}}Je(uc,"Physics");var Qm=Object.defineProperty,Jm=(i,e)=>Qm(i,"name",{value:e,configurable:!0});class fc{constructor(){r(this,"deltaTime",0);r(this,"time",0);r(this,"frame",0);r(this,"clock",new Qf);r(this,"_smoothedFps",0);r(this,"_fpsSamples",[]);r(this,"_fpsSampleIndex",0)}get realtimeSinceStartup(){return this.clock.elapsedTime}get frameCount(){return this.frame}get smoothedFps(){return this._smoothedFps}update(){this.deltaTime=this.clock.getDelta(),this.deltaTime=Math.min(.1,this.deltaTime),this.frame+=1,this.time+=this.deltaTime,this._fpsSamples.length<30?this._fpsSamples.push(this.deltaTime):this._fpsSamples[this._fpsSampleIndex++%30]=this.deltaTime;let e=0;for(let t=0;t<this._fpsSamples.length;t++)e+=this._fpsSamples[t];this._smoothedFps=1/(e/this._fpsSamples.length)}}Jm(fc,"Time");var Zm=Object.defineProperty,Km=(i,e)=>Zm(i,"name",{value:e,configurable:!0});class Bt extends v{constructor(){super(...arguments);r(this,"url",null);r(this,"urlParameterName",null);r(this,"localhost",null)}getWebsocketUrl(){let e=this.url?Bt.GetUrl(this.url,this.localhost):null;if(this.urlParameterName){const o=w(this.urlParameterName);o&&typeof o=="string"&&(e=o)}if(!e)return null;const s=new RegExp("(((https?)|(?<socket_prefix>wss?))://)?(www.)?(?<url>.+)","gm").exec(e);return(s==null?void 0:s.groups)?(s==null?void 0:s.groups.socket_prefix)?e:"wss://"+(s==null?void 0:s.groups.url):null}static GetUrl(e,t){let s=e;const n=Bt.IsLocalNetwork()&&t;return n&&(s=t),(e==null?void 0:e.startsWith("/"))&&(s=(n?s:window.location.origin)+e),s}static IsLocalNetwork(e=window.location.hostname){return new RegExp(".{3}..{2,3}..{2,3}..{2,3}|localhost","gm").test(e)===!0?!0:["localhost","127.0.0.1","","::1","marcel-pfc-domain.de"].includes(e)||e.startsWith("192.168.")||e.startsWith("10.0.")||e.endsWith(".local")}}Km(Bt,"Networking");var eg=Object.defineProperty,to=(i,e)=>eg(i,"name",{value:e,configurable:!0});const pc={};function qs(i,e){pc[i]=e}to(qs,"registerType");function mc(i){const e=i.getBufferIdentifier();return pc[e](i)}to(mc,"tryCast");function gc(i){return typeof i.guid=="function"?i.guid():null}to(gc,"tryGetGuid");var tg=Object.defineProperty,Xs=(i,e)=>tg(i,"name",{value:e,configurable:!0}),io;(function(i){i.ConnectionList="connection-list"})(io||(io={}));class _c{constructor(){r(this,"_host");r(this,"_client");r(this,"_clientData");this.onEnable()}get isHost(){return this._host!==void 0}onEnable(){const e="HOST-5980e65c-8438-453e-8b35-f13c736dcd81";this.trySetupHost(e)}trySetupHost(e){let t=new Rr(e);t.on("error",s=>{console.error(s),this._host=void 0,this.trySetupClient(e)}),t.on("open",s=>{this._host=new bc(t)})}trySetupClient(e){this._client=new Rr,this._client.on("error",t=>{console.error("Client error",t)}),this._client.on("open",t=>{console.log("client connected",t),this._clientData=this._client.connect(e,{metadata:{id:t}}),this._clientData.on("open",()=>{console.log("Connected to host")}),this._clientData.on("data",s=>{console.log("<<",s)})})}}Xs(_c,"PeerNetworking");class so{constructor(e){r(this,"_peer");this._peer=e}}Xs(so,"AbstractPeerHandler");class ig extends so{get isHost(){return!1}onConnection(e){}}Xs(ig,"PeerClient");class bc extends so{constructor(e){super(e);r(this,"_connections",[]);var t;console.log("I AM THE HOST"),(t=this._peer)==null||t.on("connection",this.onConnection.bind(this)),this._peer.on("close",()=>{this.broadcast("BYE")}),setInterval(()=>{this.broadcast("HELLO")},2e3)}get isHost(){return!0}onConnection(e){console.log("host connection",e),e.on("open",()=>{this._connections.push(e),this.broadcastConnection(e)})}broadcastConnection(e){const t=this._connections.map(s=>{var n;return(n=s.metadata)==null?void 0:n.id}).filter(s=>s!==void 0);this.broadcast({type:io.ConnectionList,connections:t})}broadcast(e){if(e!=null){console.log(">>",e);for(const t in this._peer.connections){const s=this._peer.connections[t];if(!!s)if(Array.isArray(s))for(const n of s)!n||n.send(e);else console.warn(s)}}}}Xs(bc,"PeerHost");var sg=Object.defineProperty,ii=(i,e)=>sg(i,"name",{value:e,configurable:!0});let no="wss://needle-tiny-starter.glitch.me/socket";const ue=!!w("debugnet"),Ys=!!(ue||w("debugowner"));var ro;(function(i){i.ConnectionInfo="connection-start-info"})(ro||(ro={}));var W;(function(i){i.Join="join-room",i.Leave="leave-room",i.JoinedRoom="joined-room",i.LeftRoom="left-room",i.UserJoinedRoom="user-joined-room",i.UserLeftRoom="user-left-room"})(W||(W={}));class ng{constructor(){r(this,"room");r(this,"viewId");r(this,"allowEditing");r(this,"inRoom")}}ii(ng,"JoinedRoomResponse");class rg{constructor(){r(this,"room")}}ii(rg,"LeftRoomResponse");class og{constructor(){r(this,"userId")}}ii(og,"UserJoinedOrLeftRoomModel");var Y;(function(i){i.RequestHasOwner="request-has-owner",i.ResponseHasOwner="response-has-owner",i.RequestIsOwner="request-is-owner",i.ResponseIsOwner="response-is-owner",i.RequestOwnership="request-ownership",i.GainedOwnership="gained-ownership",i.RemoveOwnership="remove-ownership",i.LostOwnership="lost-ownership",i.GainedOwnershipBroadcast="gained-ownership-broadcast",i.LostOwnershipBroadcast="lost-ownership-broadcast"})(Y||(Y={}));class Qs{constructor(e,t){r(this,"guid");r(this,"connection");r(this,"_hasOwnership",!1);r(this,"_isOwned");r(this,"_gainSubscription");r(this,"_lostSubscription");r(this,"_hasOwnerResponse");r(this,"_isWaitingForOwnershipResponseCallback",null);this.connection=e,this.guid=t,this._gainSubscription=this.onGainedOwnership.bind(this),this._lostSubscription=this.onLostOwnership.bind(this),e.beginListen(Y.LostOwnership,this._lostSubscription),e.beginListen(Y.GainedOwnershipBroadcast,this._gainSubscription),this._hasOwnerResponse=this.onHasOwnerResponse.bind(this),e.beginListen(Y.ResponseHasOwner,this._hasOwnerResponse)}get hasOwnership(){return this._hasOwnership}get isOwned(){return this._isOwned}get isConnected(){return this.connection.isConnected}updateIsOwned(){this.connection.send(Y.RequestHasOwner,{guid:this.guid})}onHasOwnerResponse(e){e.guid===this.guid&&(this._isOwned=e.value)}requestOwnershipIfNotOwned(){return this._isWaitingForOwnershipResponseCallback!==null?this:(this._isWaitingForOwnershipResponseCallback=this.waitForHasOwnershipRequestResponse.bind(this),this.connection.beginListen(Y.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this.connection.send(Y.RequestHasOwner,{guid:this.guid}),this)}waitForHasOwnershipRequestResponse(e){e.guid===this.guid&&(this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Y.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this._isOwned=e.value,e.value||(Ys&&console.log("request ownership",this.guid),this.requestOwnership()))}requestOwnershipAsync(){return new Promise((e,t)=>{this.requestOwnership();let s=0;const n=ii(()=>{if(s++>10)return t("Timeout");setTimeout(()=>{this.hasOwnership?e(this):n()},100)},"waitForOwnership");n()})}requestOwnership(){return Ys&&console.log("Request ownership",this.guid),this.connection.send(Y.RequestOwnership,{guid:this.guid}),this}freeOwnership(){return this.connection.send(Y.RemoveOwnership,{guid:this.guid}),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Y.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null),this}destroy(){this.connection.stopListening(Y.GainedOwnership,this._gainSubscription),this.connection.stopListening(Y.LostOwnership,this._lostSubscription),this.connection.stopListening(Y.ResponseHasOwner,this._hasOwnerResponse),this._isWaitingForOwnershipResponseCallback&&(this.connection.stopListening(Y.ResponseHasOwner,this._isWaitingForOwnershipResponseCallback),this._isWaitingForOwnershipResponseCallback=null)}onGainedOwnership(e){e.guid===this.guid&&(this._isOwned=!0,this.connection.connectionId===e.owner?(Ys&&console.log("GAINED OWNERSHIP",this.guid),this._hasOwnership=!0):this._hasOwnership=!1)}onLostOwnership(e){e===this.guid&&(Ys&&console.log("LOST OWNERSHIP",this.guid),this._hasOwnership=!1,this._isOwned=!1)}}ii(Qs,"OwnershipModel");var Fi;(function(i){i[i.OnConnection=0]="OnConnection",i[i.OnRoomJoin=1]="OnRoomJoin",i[i.Queued=2]="Queued",i[i.Immediate=3]="Immediate"})(Fi||(Fi={}));class yc{constructor(e){r(this,"context");r(this,"_peer",null);r(this,"_usersInRoomCopy",[]);r(this,"_defaultMessagesBuffer",[]);r(this,"_defaultMessagesBufferArray",[]);r(this,"_listeners",{});r(this,"_listenersBinary",{});r(this,"connected",!1);r(this,"channelId");r(this,"_connectionId",null);r(this,"_isConnectingToWebsocket",!1);r(this,"_ws");r(this,"_waitingForSocket",{});r(this,"_isInRoom",!1);r(this,"_currentRoomName",null);r(this,"_currentRoomViewId",null);r(this,"_currentRoomAllowEditing",!0);r(this,"_currentInRoom",[]);r(this,"_state",{});r(this,"_currentDelay",-1);this.context=e}get peer(){return this._peer||(this._peer=new _c),this._peer}tryGetState(e){return e==="invalid"?null:this._state[e]}get connectionId(){return this._connectionId}get isDebugEnabled(){return ue}get isConnected(){return this.connected}get currentRoomName(){return this._currentRoomName}get allowEditing(){return this._currentRoomAllowEditing}get currentRoomViewId(){return this._currentRoomViewId}get isInRoom(){return this._isInRoom}get currentLatency(){return this._currentDelay}userIsInRoom(e){return this._currentInRoom.indexOf(e)!==-1}usersInRoom(e=null){e||(e=this._usersInRoomCopy),e.length=0;for(const t of this._currentInRoom)e.push(t);return e}joinRoom(e,t=!1){this.connect(),ue&&console.log("join: "+e),this.send(W.Join,{room:e,viewOnly:t},0)}leaveRoom(e=null){if(e||(e=this.currentRoomName),!e){console.error("Can not leave unknown room");return}this.send(W.Leave,{room:e})}send(e,t=null,s=2){if(t===null&&(t={}),s===2){this._defaultMessagesBuffer.push({key:e,value:t});return}return this.sendWithWebsocket(e,t,s)}sendDeleteRemoteState(e){this.send("delete-state",{guid:e,dontSave:!0}),delete this._state[e]}sendBinary(e){var t;ue&&console.log("<< bin",e.length),(t=this._ws)==null||t.send(e)}sendBufferedMessagesNow(){var s;if(!this._ws)return;this._defaultMessagesBufferArray.length=0;const e=Object.keys(this._defaultMessagesBuffer).length;for(const n in this._defaultMessagesBuffer){const o=this._defaultMessagesBuffer[n];if(e<=1){this.sendWithWebsocket(o.key,o.value,3);break}const a=this.toMessage(o.key,o.value);this._defaultMessagesBufferArray.push(a)}if(this._defaultMessagesBuffer.length=0,this._defaultMessagesBufferArray.length>0&&ue&&console.log("SEND BUFFERED",this._defaultMessagesBufferArray.length),this._defaultMessagesBufferArray.length<=0)return;const t=JSON.stringify(this._defaultMessagesBufferArray);(s=this._ws)==null||s.send(t)}beginListen(e,t){return this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t),t}stopListening(e,t){if(!t||!this._listeners[e])return;const s=this._listeners[e].indexOf(t);s>=0&&this._listeners[e].splice(s,1)}beginListenBinrary(e,t){return this._listenersBinary[e]||(this._listenersBinary[e]=[]),this._listenersBinary[e].push(t),t}stopListenBinary(e,t){if(!this._listenersBinary[e])return;const s=this._listenersBinary[e].indexOf(t);s>=0&&this._listenersBinary[e].splice(s,1)}connect(){if(this.connected)return;ue&&console.log("connecting");const e=p.findObjectOfType(Bt,this.context,!1),t=e==null?void 0:e.getWebsocketUrl();t&&(no=t),this.connectWebsocket()}connectWebsocket(){if(this._isConnectingToWebsocket)return;this._isConnectingToWebsocket=!0,console.log("Connecting to "+no);const e=new Jf.WebsocketBuilder(no).onOpen(()=>{this._ws=e,this._isConnectingToWebsocket=!1,this.connected=!0,console.log("Connected to websocket"),this.onSendQueued(0)}).onClose(t=>{this.connected=!1,this._isInRoom=!1}).onError((t,s)=>{console.error(t,s)}).onMessage(this.onMessage.bind(this)).onRetry(()=>{console.log("websocket connection retry")}).build()}onMessage(e,t){const s=t.data;try{if(typeof s!="string"){s.size&&this.handleIncomingBinaryMessage(s);return}const n=JSON.parse(s);if(Array.isArray(n))for(const o of n)this.handleIncomingStringMessage(o);else this.handleIncomingStringMessage(n);return}catch{ue&&s==="pong"&&console.log("<<",s)}}async handleIncomingBinaryMessage(e){const t=await e.arrayBuffer();var s=new Uint8Array(t);const n=new Zf(s),o=n.getBufferIdentifier(),a=this._listenersBinary[o],l=mc(n),c=gc(l);if(c&&typeof c=="string"&&(this._state[c]=l),!a)return;const h=l!=null?l:n;for(const d of a)d(h)}handleIncomingStringMessage(e){var n,o,a,l,c,h,d;if(ue&&console.log("<<",(n=e.key)!=null?n:e),e.key)switch(e.key){case ro.ConnectionInfo:if(e.data){const b=e.data;b&&(console.assert(b.id!==void 0&&b.id!==null&&b.id.length>0,"server did not send connection id",b.id),console.log("Your id is: "+b.id,(o=this.context.alias)!=null?o:""),this._connectionId=b.id)}else console.warn("Expected connection id in "+e.key);break;case W.JoinedRoom:if(ue&&console.log(e),e){this._isInRoom=!0;const b=e;this._currentRoomName=b.room,this._currentRoomViewId=b.viewId,this._currentRoomAllowEditing=(a=b.allowEditing)!=null?a:!0,console.log("Room view id",this._currentRoomViewId),this._currentInRoom.length=0,this._currentInRoom.push(...b.inRoom),ue&&console.log("joined room with",this._currentInRoom,(l=this.context.alias)!=null?l:"")}this.onSendQueued(1);break;case W.LeftRoom:e.room===this.currentRoomName&&(this._isInRoom=!1,this._currentRoomName=null,this._currentInRoom.length=0);break;case W.UserJoinedRoom:if(e.data){const b=e.data;this._currentInRoom.push(b.userId),ue&&console.log(b.userId+" joined","now in room:",this._currentInRoom)}break;case W.UserLeftRoom:if(e.data){const b=e.data,x=this._currentInRoom.indexOf(b.userId);x>=0&&(console.log(b.userId+" left",(c=this.context.alias)!=null?c:""),this._currentInRoom.splice(x,1)),b.userId===this.connectionId&&console.log("you left the room")}break;case"ping":case"pong":const g=(h=e.data)==null?void 0:h.time;g&&(this._currentDelay=this.context.time.time-g),ue&&console.log("Current latency: "+this._currentDelay.toFixed(1)+" sec","Clients in room: "+((d=this._currentInRoom)==null?void 0:d.length));break}const t=this._listeners[e.key];if(t)for(const u of t)u(e.data);const s=e.data;s&&(this._state[s.guid]=s)}toMessage(e,t){return{key:e,data:t}}sendWithWebsocket(e,t,s=1){if(!this._ws){const o=this._waitingForSocket[s]||[];o.push(()=>this.sendWithWebsocket(e,t,s)),this._waitingForSocket[s]=o;return}const n=JSON.stringify(this.toMessage(e,t));ue&&console.log(">>",e),this._ws.send(n)}onSendQueued(e){const t=this._waitingForSocket[e];if(t){for(const s of t)s();t.length=0}}}ii(yc,"NetworkConnection");var vc=Object.defineProperty,ag=Object.getOwnPropertyDescriptor,lg=(i,e)=>vc(i,"name",{value:e,configurable:!0}),cg=(i,e,t,s)=>{for(var n=s>1?void 0:s?ag(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&vc(e,t,n),n};class Js extends v{constructor(){super(...arguments);r(this,"constraintActive",!0);r(this,"locked",!1);r(this,"sources",[])}}lg(Js,"LookAtConstraint");cg([_(S)],Js.prototype,"sources",2);var wc=Object.defineProperty,hg=Object.getOwnPropertyDescriptor,dg=(i,e)=>wc(i,"name",{value:e,configurable:!0}),ug=(i,e,t,s)=>{for(var n=s>1?void 0:s?hg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&wc(e,t,n),n};class si extends v{constructor(){super(...arguments);r(this,"autoRotate",!1);r(this,"autoRotateSpeed",1);r(this,"enableKeys",!0);r(this,"enableDamping",!0);r(this,"dampingFactor",.1);r(this,"enableZoom",!0);r(this,"minZoom",0);r(this,"maxZoom",1/0);r(this,"enablePan",!0);r(this,"lookAtConstraint",null);r(this,"lookAtConstraint01",1);r(this,"middleClickToFocus",!0);r(this,"doubleClickToFocus",!0);r(this,"useSlerp",!1);r(this,"debugLog",!1);r(this,"targetLerpSpeed",5);r(this,"_lookTargetPosition");r(this,"_controls",null);r(this,"_cameraObject",null);r(this,"_lerpToTargetPosition",!1);r(this,"_lerpCameraToTarget",!1);r(this,"_cameraTargetPosition",null);r(this,"_inputs",0);r(this,"_enableTime",0)}get controls(){return this._controls}get controllerObject(){return this._cameraObject}onStartInteraction(e){var t;(t=this.controls)==null||t.addEventListener("start",e)}awake(){this._lookTargetPosition=new y}onEnable(){this._enableTime=this.context.time.time;const e=p.getComponent(this.gameObject,N),t=e==null?void 0:e.cam;this._controls||(console.assert(t!=null,"Missing camera",this),t&&(this._cameraObject=t),this._controls=new Qa(t,this.context.renderer.domElement)),this._controls&&(this._controls.enableDamping=this.enableDamping,this._controls.enableKeys=this.enableKeys,this._controls.autoRotate=this.autoRotate,this._controls.autoRotateSpeed=this.autoRotateSpeed,this._controls.enableZoom=this.enableZoom,(t==null?void 0:t.type)==="PerspectiveCamera"?(this._controls.minDistance=this.minZoom,this._controls.maxDistance=this.maxZoom):(this._controls.minZoom=this.minZoom,this._controls.maxZoom=this.maxZoom),this._controls.dampingFactor=this.dampingFactor,this._controls.enablePan=this.enablePan)}onDisable(){this._controls&&(this._controls.enabled=!1,this._controls.autoRotate=!1)}start(){if(this._controls){const e=p.getComponent(this.gameObject,N);if(e&&!this.setFromTargetPosition()){console.log("NO TARGET");const t=new y(0,0,-1).applyMatrix4(e.cam.matrixWorld);this.setTarget(t)}}this.startCoroutine(this.startRaycastDelayed())}*startRaycastDelayed(){if(yield,!this.setFromTargetPosition()){const e=new Me;e.screenPoint=new V(0,0),e.lineThreshold=.1;const t=this.context.physics.raycast(e);t.length>0&&this.setTarget(t[0].point)}}onBeforeRender(){var t,s,n,o;if(!this._controls)return;(this.context.input.getPointerDown(0)||this.context.input.getPointerDown(1)||this.context.input.getPointerDown(2))&&(this._inputs+=1),this._inputs>0&&(this._controls.autoRotate=!1,this._lerpCameraToTarget=!1,this._lerpToTargetPosition=!1),this._inputs=0;let e=this.middleClickToFocus&&this.context.input.getPointerClicked(1);if(e||(e=this.doubleClickToFocus&&this.context.input.getPointerDoubleClicked(0)&&this.context.time.time-this._enableTime>.3),e?this.setTargetFromRaycast():(this.context.input.getPointerDown(0)||this.context.input.mouseWheelChanged)&&(this._lerpToTargetPosition=!1,this._lerpCameraToTarget=!1),this._lerpToTargetPosition||this._lerpCameraToTarget){const a=this.context.time.deltaTime*this.targetLerpSpeed;this._lerpCameraToTarget&&this._cameraTargetPosition&&this._cameraObject&&(this.useSlerp&&typeof((t=this._cameraObject)==null?void 0:t.position.slerp)=="function"?((s=this._cameraObject)==null?void 0:s.position).slerp(this._cameraTargetPosition,a):(n=this._cameraObject)==null||n.position.lerp(this._cameraTargetPosition,a),this._cameraObject.position.distanceTo(this._cameraTargetPosition)<.01&&(this._lerpCameraToTarget=!1)),this._lerpToTargetPosition&&(this.lerpTarget(this._lookTargetPosition,a),this._lookTargetPosition.distanceTo(this._controls.target)<.005&&(this._lerpToTargetPosition=!1))}((o=this.lookAtConstraint)==null?void 0:o.locked)&&this.setFromTargetPosition(0,this.lookAtConstraint01),this._controls&&(this.debugLog&&(this._controls.domElement=this.context.renderer.domElement),this._controls.enabled=!0,this._controls.update())}setCameraTarget(e){this._lerpCameraToTarget=!0,this._cameraTargetPosition=e==null?void 0:e.clone()}setFromTargetPosition(e=0,t=1){var n;if(!this._controls)return!1;const s=(n=this.lookAtConstraint)==null?void 0:n.sources;if(s&&s.length>0){const o=s[e];if(o)return o.getWorldPosition(this._lookTargetPosition),this.lerpTarget(this._lookTargetPosition,t),!0}return!1}setTarget(e=null,t=!1){!this._controls||(e!==null&&this._lookTargetPosition.copy(e),t?this._controls.target.copy(this._lookTargetPosition):this._lerpToTargetPosition=!0)}lerpTarget(e,t){!this._controls||this._controls.target.lerp(e,t)}distanceToTarget(e){return this._controls?this._controls.target.distanceTo(e):-1}setTargetFromRaycast(){if(!this.controls)return;const e=this.context.physics.raycast();for(const t of e)if(t.distance>0&&p.isActiveInHierarchy(t.object)){if(this._lookTargetPosition.copy(t.point),this._lerpToTargetPosition=!0,this._cameraTargetPosition=null,this.context.mainCamera){this._lerpCameraToTarget=!0;const s=C(this.context.mainCamera);this._cameraTargetPosition=s.clone().sub(this.controls.target).add(this._lookTargetPosition)}break}}}dg(si,"OrbitControls");ug([_(Js)],si.prototype,"lookAtConstraint",2);var fg=Object.defineProperty,pg=(i,e)=>fg(i,"name",{value:e,configurable:!0});class Re extends f{constructor(e,t,s,n){super(e,t,s);r(this,"alpha",1);this.alpha=n}clone(){const e=super.clone();return e.alpha=this.alpha,e}lerp(e,t){const s=e;return s.alpha&&(this.alpha=A.lerp(this.alpha,s.alpha,t)),super.lerp(e,t)}multiply(e){const t=e;return t.alpha&&(this.alpha=this.alpha*t.alpha),super.multiply(e)}}pg(Re,"RGBAColor");var xc=Object.defineProperty,mg=Object.getOwnPropertyDescriptor,oo=(i,e)=>xc(i,"name",{value:e,configurable:!0}),ht=(i,e,t,s)=>{for(var n=s>1?void 0:s?mg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&xc(e,t,n),n},Pc;(function(i){i[i.Skybox=1]="Skybox",i[i.SolidColor=2]="SolidColor",i[i.Uninitialized=4]="Uninitialized"})(Pc||(Pc={}));const Oc=w("debugcam");class N extends v{constructor(){super(...arguments);r(this,"orthographic",!1);r(this,"orthographicSize",5);r(this,"ARBackgroundAlpha",0);r(this,"_nearClipPlane",.1);r(this,"_farClipPlane",1e3);r(this,"_backgroundColor");r(this,"_fov",60);r(this,"_cam",null);r(this,"_clearFlags",2);r(this,"_skybox")}get fieldOfView(){return this._fov}set fieldOfView(e){const t=this._fov!=e;this._fov=e,t&&this._cam&&this._cam instanceof Cr&&(this._cam.fov=this._fov,this._cam.updateProjectionMatrix())}get nearClipPlane(){return this._nearClipPlane}set nearClipPlane(e){const t=this._nearClipPlane!=e;this._nearClipPlane=e,this._cam&&t&&(this._cam.near=e,this._cam.updateProjectionMatrix())}get farClipPlane(){return this._farClipPlane}set farClipPlane(e){const t=this._farClipPlane!=e;this._farClipPlane=e,this._cam&&t&&(this._cam.far=e,this._cam.updateProjectionMatrix())}get clearFlags(){return this._clearFlags}set clearFlags(e){this._clearFlags=e,this.applyClearFlagsIfIsActiveCamera()}get backgroundColor(){var e;return(e=this._backgroundColor)!=null?e:null}set backgroundColor(e){if(!!e){if(this._backgroundColor)this._backgroundColor.copy(e);else{if(!e.clone)return;this._backgroundColor=e.clone()}this.applyClearFlagsIfIsActiveCamera()}}get cam(){return this.activeAndEnabled&&this.buildCamera(),this._cam}awake(){this.sourceId||console.warn("Camera has no source - the camera should be exported inside a gltf",this.name)}onEnable(){Oc&&console.log(this),this.buildCamera(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this),this.applyClearFlagsIfIsActiveCamera()}buildCamera(){if(this._cam)return;const e=this.gameObject.isCamera;let t=null;if(e?t=this.gameObject:t=this.gameObject.children[0],t&&t.isCamera)t.type==="PerspectiveCamera"&&(t.fov=this._fov,t.near=this._nearClipPlane,t.far=this._farClipPlane,t.updateProjectionMatrix());else if(!this.orthographic)t=new Cr(this.fieldOfView,window.innerWidth/window.innerHeight,this._nearClipPlane,this._farClipPlane),t.fov=this.fieldOfView;else{const s=this.orthographicSize*100;t=new Kf(window.innerWidth/-s,window.innerWidth/s,window.innerHeight/s,window.innerHeight/-s,this._nearClipPlane,this._farClipPlane)}this._cam=t,this.layer===0&&this._cam.layers.enableAll(),this.tag=="MainCamera"&&this.context.setCurrentCamera(this)}applyClearFlagsIfIsActiveCamera(){var e;if(this._cam&&this.context.mainCameraComponent===this)switch(this._clearFlags){case 1:if(this.context.isInXR&&(!this.ARBackgroundAlpha||this.ARBackgroundAlpha<.001)){this.context.scene.background=null,this.context.renderer.setClearColor(0,0);return}this.enableSkybox();break;case 2:if(this.backgroundColor){let t=this.backgroundColor.alpha;this.context.isInXR&&(t=(e=this.ARBackgroundAlpha)!=null?e:0),this.context.scene.background=null,this.context.renderer.setClearColor(this.backgroundColor,t)}break;case 4:this.context.scene.background=null,this.context.renderer.setClearColor(0,0);break}}enableSkybox(){this._skybox||(this._skybox=new Cc(this)),this._skybox.enable()}}oo(N,"Camera");ht([_()],N.prototype,"fieldOfView",1);ht([_()],N.prototype,"nearClipPlane",1);ht([_()],N.prototype,"farClipPlane",1);ht([_()],N.prototype,"clearFlags",1);ht([_()],N.prototype,"orthographic",2);ht([_()],N.prototype,"orthographicSize",2);ht([_()],N.prototype,"ARBackgroundAlpha",2);ht([_(Re)],N.prototype,"backgroundColor",1);class Cc{constructor(e){r(this,"_camera");r(this,"_skybox");this._camera=e}get context(){var e;return(e=this._camera)==null?void 0:e.context}enable(){this._skybox=this.context.lightmaps.tryGetSkybox(this._camera.sourceId),this._skybox?(Oc&&console.log("Set skybox",this._camera),this._skybox.encoding=Zt,this._skybox.mapping=Er,this.context.scene.background=this._skybox):console.warn("Failed to load/find skybox texture",this)}}oo(Cc,"CameraSkybox");function Sc(i){const e="created/implictly",t=new S;i.add(t);const s=p.addNewComponent(t,N,!1);s.sourceId=e;const n=p.addNewComponent(t,si,!1);return n.sourceId=e,s}oo(Sc,"createCameraWithOrbitControl");var gg=Object.defineProperty,_g=(i,e)=>gg(i,"name",{value:e,configurable:!0});async function ao(i){}_g(ao,"post_awake");var bg=Object.defineProperty,Rc=(i,e)=>bg(i,"name",{value:e,configurable:!0});class yg{constructor(){r(this,"_context")}get context(){var e;return(e=this._context)!=null?e:E.Current}get isStateMachineBehaviour(){return!0}}Rc(yg,"StateMachineBehaviour");class Zs{constructor(e,t,s,n){r(this,"_name");r(this,"_nameHash");r(this,"_normalizedTime");r(this,"_length");r(this,"_speed");this._name=e.name,this._nameHash=e.hash,this._normalizedTime=t,this._length=s,this._speed=n}get name(){return this._name}get nameHash(){return this._nameHash}get normalizedTime(){return this._normalizedTime}get length(){return this._length}get speed(){return this._speed}}Rc(Zs,"AnimatorStateInfo");var dt;(function(i){i[i.If=1]="If",i[i.IfNot=2]="IfNot",i[i.Greater=3]="Greater",i[i.Less=4]="Less",i[i.Equals=6]="Equals",i[i.NotEqual=7]="NotEqual"})(dt||(dt={}));var lo;(function(i){i[i.Float=1]="Float",i[i.Int=3]="Int",i[i.Bool=4]="Bool",i[i.Trigger=9]="Trigger"})(lo||(lo={}));var vg=Object.defineProperty,wg=(i,e)=>vg(i,"name",{value:e,configurable:!0});class Ec{constructor(){r(this,"_types",{})}add(e,t){const s=this._types[e];s===void 0?this._types[e]=t:s!==t&&console.warn("Type name exists multiple times in your project and may lead to runtime errors:",e)}get(e){return this._types[e]}}wg(Ec,"_TypeStore");const m=new Ec,Bi=w("gizmos"),fe=w("debugextension");var xg=Object.defineProperty,Ui=(i,e)=>xg(i,"name",{value:e,configurable:!0});const Ks=w("debugresolvedependencies"),Pg=[{prefix:"nodes/",dependencyName:"node"},{prefix:"meshes/",dependencyName:"mesh"},{prefix:"materials/",dependencyName:"material"},{prefix:"textures/",dependencyName:"texture"},{prefix:"animations/",dependencyName:"animation"}];async function en(i,e){Ks&&console.log(i,e);const t=[];tn(Pg,i,e,t);const s=await Promise.all(t);return typeof e=="string"&&s.length===1?s[0]:s}Ui(en,"resolveReferences");function tn(i,e,t,s){if(typeof t=="object"&&t!==void 0&&t!==null)for(const n of Object.keys(t)){const o=t[n];if(typeof o=="string"){const a=ho(e,o);if(a!==null)typeof a.then=="function"?s.push(a.then(l=>t[n]=l)):t[n]=a;else for(const l of i){const c=sn(l.prefix,o);if(c>=0){Ks&&console.log(l,c,l.dependencyName),s.push(e==null?void 0:e.getDependency(l.dependencyName,c).then(h=>(t[n]=h,h)));break}}}else if(Array.isArray(o))for(let a=0;a<o.length;a++){const l=o[a],c=ho(e,l);if(c!==null){typeof c.then=="function"?s.push(c.then(h=>o[a]=h)):o[a]=c;continue}for(const h of i){const d=sn(h.prefix,l);if(d>=0){Ks&&console.log(h,d,h.dependencyName),s.push(e==null?void 0:e.getDependency(h.dependencyName,d).then(u=>o[a]=u));break}}typeof l=="object"&&tn(i,e,l,s)}else typeof o=="object"&&tn(i,e,o,s)}else typeof t=="string"&&Ac(i,e,t,s)}Ui(tn,"internalResolve");const co="extensions/";function ho(i,e){if(i&&i.plugins&&typeof e=="string"&&e.startsWith(co)){let t=e.substring(co.length);const s=t.indexOf("/");s>=0&&(t=t.substring(0,s));const n=i.plugins[t];if(fe&&console.log(t,n),typeof(n==null?void 0:n.resolve)=="function"){const o=e.substring(co.length+t.length+1);return n.resolve(i,o)}}return null}Ui(ho,"resolveExtension");function Ac(i,e,t,s){for(const n of i){const o=sn(n.prefix,t);if(o>=0)return Ks&&console.log(n,o,n.dependencyName),s.push(e==null?void 0:e.getDependency(n.dependencyName,o).then(a=>a)),!0}return!1}Ui(Ac,"tryResolveDependency");function sn(i,e){if(typeof e=="string"&&e.startsWith(i)){const t=e.substring(i.length),s=Number.parseInt(t);if(s>=0)return s}return-1}Ui(sn,"tryGetIndex");var Og=Object.defineProperty,Tc=(i,e)=>Og(i,"name",{value:e,configurable:!0});const uo="NEEDLE_persistent_assets";function kc(i){return(i==null?void 0:i.___persistentAsset)===!0}Tc(kc,"isPersistentAsset");class Lc{constructor(e){r(this,"parser");this.parser=e}get name(){return uo}async afterRoot(e){var n,o;if(!((o=(n=this.parser)==null?void 0:n.json)==null?void 0:o.extensions))return;const t=this.parser.json.extensions[uo];if(!t)return;fe&&console.log(t);const s=new Array;for(const a of t==null?void 0:t.assets){const l=en(this.parser,a);l&&s.push(l)}await Promise.all(s)}resolve(e,t){const s=Number.parseInt(t);if(s>=0){fe&&console.log(t);const n=e.json.extensions[uo];if(n){const o=n==null?void 0:n.assets[s];if(o&&typeof o=="object"){o.___persistentAsset=!0;const a=o.__type;a&&m.get(a)}return o}}return null}}Tc(Lc,"NEEDLE_persistent_assets");var Cg=Object.defineProperty,pe=(i,e)=>Cg(i,"name",{value:e,configurable:!0});const Ut=w("debugserializer");class Dc{constructor(){r(this,"typeMap",{})}register(e,t){if(this.typeMap[e]!==void 0){if(this.typeMap[e]===t)return;console.warn("Type "+e+" is already registered",t,this.typeMap[e])}Ut&&console.log("Register type serializer for "+e,t),this.typeMap[e]=t}getSerializer(e){if(!!e)return this.typeMap[e]}getSerializerForConstructor(e,t=0){var c,h,d,u;if(t>20)return;if(!e||!e.constructor){Ut&&console.log("invalid type");return}const s=(h=e.name)!=null?h:(c=e.constructor)==null?void 0:c.name;if(!s){Ut&&console.log("invalid name",s);return}const n=this.getSerializer(s);if(n!==void 0)return Ut&&console.log("FOUND "+s,e.name,e.constructor.name,n,this.typeMap),n;let o=Object.getPrototypeOf(e);if(!(o.prototype||o.constructor)){Ut&&console.warn("No prototype for "+s,e,e.name,e.prototype,e.constructor.name);return}const l=(d=o.prototype)!=null?d:o.constructor;if(l!==e){const g=this.getSerializerForConstructor(l,++t);if(g){Ut&&console.log("FOUND "+l.constructor.name,l.name,l,g);const b=(u=l.name)!=null?u:l.constructor.name;b==="Function"?console.error("Registering Function is not allowed, something went wrong",e,l,g):this.register(b,g)}return g}}}pe(Dc,"SerializationHelper");const nn=new Dc;class ni{constructor(e){if(Array.isArray(e))for(const t of e)nn.register(t.name,this);else nn.register(e.name,this)}}pe(ni,"TypeSerializer");class fo{constructor(e){r(this,"root");r(this,"gltf");r(this,"gltfId");r(this,"object");r(this,"target");r(this,"nodeId");r(this,"nodeToObject");r(this,"objectToNode");r(this,"context");r(this,"path");this.root=e}}pe(fo,"SerializationContext");function Mc(i,e){const t=i.$serializedTypes;if(t===void 0)return null;const s={};for(const n in t){let o=i[n];if(o!=null&&typeof o=="object"){const a=nn.getSerializerForConstructor(o);if(a){s[n]=a.onSerialize(o,e);continue}}s[n]=o}return s.name=i.constructor.name,typeof i.guid=="string"&&(s.guid=i.guid),s}pe(Mc,"serializeObject");const rn=[];function po(i,e){if(!i)return e;typeof i.$serializedTypes=="object"&&(e||(e={}),Object.assign(e,i.$serializedTypes));const t=Object.getPrototypeOf(i);return po(t,e)}pe(po,"collectSerializedTypesInBaseTypes");function on(i,e,t){if(!i)return!1;if(t.target=i,i.onBeforeDeserialize!==void 0){const n=i.onBeforeDeserialize(e,t);if(typeof n=="boolean")return n}const s=po(i);if(e){if(typeof e.guid=="string"&&(i.guid=e.guid),s)for(const n in s){const o=s[n],a=e[n];if(t.path=n,o===null)i[n]=a;else{let l=function(c){const d=c.type;return d?an(a,d,t,void 0,i[n]):an(a,c,t,void 0,i[n])};if(pe(l,"tryResolve"),i.onBeforeDeserializeMember!==void 0&&i.onBeforeDeserializeMember(n,a,t)===!0)continue;if(Array.isArray(o))for(let c=0;c<o.length;c++){const h=o[c],d=l(h);if(d!==void 0||c===o.length-1){i[n]=d;break}}else i[n]=l(o);rn.length=0,i.onAfterDeserializeMember!==void 0&&i.onAfterDeserializeMember(n,a,t)}}Ic(i,e)}return i.onAfterDeserialize!==void 0&&i.onAfterDeserialize(e,t),t.path=void 0,!0}pe(on,"deserializeObject");function Ic(i,e){for(const s of Object.keys(e)){const n=e[s];if(typeof n=="object"&&n!==null&&n!==void 0){const o=i[s];if(!o){Ut&&console.log(s,"is undefined on",i);continue}for(const a of Object.keys(n))o[a]===void 0&&t(n[a])&&!t(o)&&(o[a]=n[a])}}function t(s){switch(typeof s){case"number":case"string":case"boolean":return!0}return!1}pe(t,"isPrimitiveType")}pe(Ic,"implictlyAssignPrimitiveTypes");function an(i,e,t,s,n){let o=typeof e=="function"&&e.prototype===void 0,a=e;if(o)try{if(a=e==null?void 0:e.call(e,n),o=!1,a==null)return}catch(d){console.error("Error in callback",d,i)}if(!o&&n instanceof a)return n;if(n&&typeof n=="object"&&kc(n)){if(n.__concreteInstance)return n.__concreteInstance;const d=n;if(!d.$serializedTypes&&a.prototype.$serializedTypes&&(d.$serializedTypes=a.prototype.$serializedTypes),d.$serializedTypes&&on(d,i,t),n&&a!==void 0)try{const u=new a;fe&&console.log("Create concrete instance for persistent asset",n,"instance:",u),ln(u,n),n.__concreteInstance=u,n=u}catch(u){console.error("Error creating instance or creating values on instance",u,n,a)}return n}if(s||(s={serializer:nn.getSerializerForConstructor(a)}),Array.isArray(i)){const d=[];for(let u=0;u<i.length;u++){const g=i[u],b=an(g,e,t,s,g);d.push(b)}return d}const l=s.serializer;if(l)return l.onDeserialize(i,t);let c;i&&(i.isMaterial||i.isTexture||i.isObject3D)?c=i:c=new a(...jc(i));const h=c;return h.$serializedTypes&&on(h,i,t),c}pe(an,"deserializeObjectWithType");function jc(i){if(rn.length=0,typeof i=="object"&&i!==null&&i!==void 0)for(const e of Object.keys(i))rn.push(i[e]);return rn}pe(jc,"setBuffer");function ln(i,e){if(e!=null&&i!=null)for(const t of Object.keys(e)){const s=Fc(i,t);(!s||s.writable===!0||(s==null?void 0:s.set)!==void 0)&&(i[t]=e[t])}}pe(ln,"assign");function Fc(i,e){let t;do t=Object.getOwnPropertyDescriptor(i,e);while(!t&&(i=Object.getPrototypeOf(i)));return t}pe(Fc,"getPropertyDescriptor");var Sg=Object.defineProperty,Rg=(i,e)=>Sg(i,"name",{value:e,configurable:!0});const ut=w("debuganimatorcontroller");class ri{constructor(e){r(this,"normalizedStartOffset",0);r(this,"_speed",1);r(this,"animator");r(this,"model");r(this,"_mixer");r(this,"_activeState");r(this,"_activeStates",[]);r(this,"animationRoot",null);r(this,"lastPosition");r(this,"lastRotation");r(this,"startPosition",null);r(this,"startRotation",null);r(this,"lastTime",0);r(this,"tempRot",new O);r(this,"tempRot2",new O);r(this,"tempPos",new y);r(this,"tempPos2",new y);r(this,"rootMotionBone",new S);this.model=e,ut&&console.log(this)}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){if(t<0)t=0;else if(t>=this.model.layers.length){console.warn("invalid layer");return}const a=this.model.layers[t].stateMachine;for(const l of a.states)if(l.name===e||l.hash===e){ut&&console.log("transition to ",l),this.transitionTo(l,n,s);return}console.warn("Could not find "+e+" to play")}Reset(){this.setStartTransition()}SetBool(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetBool(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:!1}SetFloat(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetFloat(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetInteger(e,t){var n;const s=typeof e=="string"?"name":"hash";return(n=this.model)==null?void 0:n.parameters.filter(o=>o[s]===e).forEach(o=>o.value=t)}GetInteger(e){var s,n,o;const t=typeof e=="string"?"name":"hash";return(o=(n=(s=this.model)==null?void 0:s.parameters.find(a=>a[t]===e))==null?void 0:n.value)!=null?o:0}SetTrigger(e){var s;ut&&console.log("SET TRIGGER",e);const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!0)}ResetTrigger(e){var s;const t=typeof e=="string"?"name":"hash";return(s=this.model)==null?void 0:s.parameters.filter(n=>n[t]===e).forEach(n=>n.value=!1)}IsInTransition(){return this._activeStates.length>1}SetSpeed(e){this._speed=e}FindState(e){if(!e)return null;for(const t of this.model.layers)for(const s of t.stateMachine.states)if(s.name===e)return s;return null}get context(){var e;return(e=this.animator)==null?void 0:e.context}applyRootMotion(e){this.internalApplyRootMotion(e)}bind(e){this.animator=e,this._mixer=new Ar(this.animator.gameObject),this.createActions()}clone(){const e=ks(this.model,(s,n,o)=>{var a;return o==null?!0:!(o.type==="Object3D"||o.isObject3D===!0||((a=o==null?void 0:o.constructor)==null?void 0:a.name)==="AnimationAction"||o.tracks!==void 0)});return console.assert(e!==this.model),new ri(e)}update(){if(!this.animator)return;this.evaluateTransitions(),this.updateActiveStates();const e=this.animator.context.time.deltaTime;this._mixer.update(e)}updateActiveStates(){for(let e=0;e<this._activeStates.length;e++){const t=this._activeStates[e],s=t.motion;if(!s.action)this._activeStates.splice(e,1),e--;else{const n=s.action;n.getEffectiveWeight()<=0&&!n.isRunning()&&(ut&&console.debug("REMOVE",t.name,n.getEffectiveWeight(),n.isRunning(),n.isScheduled()),this._activeStates.splice(e,1),e--)}}}setStartTransition(){for(const e of this.model.layers){const t=e.stateMachine,s=t.states[t.defaultState];this.transitionTo(s,0,this.normalizedStartOffset)}}evaluateTransitions(){var o;let e=!1;if(!this._activeState){if(this.setStartTransition(),!this._activeState)return;e=!0}const t=this._activeState,s=t.motion.action;for(const a of t.transitions){if(!a.hasExitTime&&a.conditions.length<=0)continue;let l=!0;for(const c of a.conditions)if(!this.evaluateCondition(c)){l=!1;break}if(!!l){ut&&l&&console.log("All conditions are met",a.conditions,s);for(const c of a.conditions){const h=this.model.parameters.find(d=>d.name===c.parameter);(h==null?void 0:h.type)===lo.Trigger&&(h.value=!1)}if(s){const c=t.motion.clip.duration,h=c<=0?1:s.time/c;if(!a.hasExitTime||h>=a.exitTime&&s.time>=s.getClip().duration){s.clampWhenFinished=!0,ut&&(console.log("transition to "+a.destinationState,a),console.log(s.time,a.exitTime)),this.transitionTo(a.destinationState,a.duration,a.offset);return}}else{this.transitionTo(a.destinationState,a.duration,a.offset);return}}}let n=!1;if(t.motion.isLooping&&s&&s.time>=s.getClip().duration&&(n=!0,s.reset(),s.time=0,s.play()),!n&&t&&!e&&s&&this.animator&&t.behaviours){const a=s==null?void 0:s.getClip().duration,l=s.time/a,c=new Zs(this._activeState,l,a,this._speed);for(const h of t.behaviours)h.instance&&((o=h.instance.onStateUpdate)==null||o.call(h.instance,this.animator,c,0))}}transitionTo(e,t,s){var h,d,u,g,b,x,P,R;if(!this.animator)return;const n=0;if(typeof e=="number"&&(e==-1&&(e=this.model.layers[n].stateMachine.defaultState),e=this.model.layers[n].stateMachine.states[e]),!(e==null?void 0:e.motion)||!e.motion.clip)return;const o=this._activeState===e;if(o){const M=e.motion;!M.action_loopback&&M.clip&&(this._mixer.uncacheAction(M.clip,this.animator.gameObject),M.action_loopback=this._mixer.clipAction(M.clip))}if(((h=this._activeState)==null?void 0:h.behaviours)&&this._activeState.motion.action){const M=(d=this._activeState)==null?void 0:d.motion.clip.duration,ce=this._activeState.motion.action.time/M,B=new Zs(this._activeState,ce,M,this._speed);for(const k of this._activeState.behaviours)(g=(u=k.instance)==null?void 0:u.onStateExit)==null||g.call(k.instance,this.animator,B,n)}const a=(b=this._activeState)==null?void 0:b.motion.action;a&&a.fadeOut(t),o&&(e.motion.action=e.motion.action_loopback,e.motion.action_loopback=a);const l=this._activeState;this._activeState=e;const c=(x=e.motion)==null?void 0:x.action;if(c){s=Math.max(0,Math.min(1,s)),c.isRunning()&&c.stop(),c.reset(),c.timeScale=this._speed,c.enabled=!0;const M=e.motion.clip.duration;if(c.time=s*M,c.clampWhenFinished=!0,c.setLoop(Ja,0),t>0?c.fadeIn(t):c.setEffectiveWeight(1),c.play(),this._activeStates.includes(e)||this._activeStates.push(e),this._activeState.behaviours){const ce=new Zs(e,s,M,this._speed);for(const B of this._activeState.behaviours)(R=(P=B.instance)==null?void 0:P.onStateEnter)==null||R.call(B.instance,this.animator,ce,n)}}else console.warn("No action",e.motion,this);ut&&console.log("TRANSITION FROM "+(l==null?void 0:l.name)+" TO "+e.name,t,a,c,c==null?void 0:c.getEffectiveTimeScale(),c==null?void 0:c.getEffectiveWeight(),c==null?void 0:c.isRunning(),c==null?void 0:c.isScheduled(),c==null?void 0:c.paused)}evaluateCondition(e){const t=this.model.parameters.find(s=>s.name===e.parameter);if(!t)return!1;switch(e.mode){case dt.If:return t.value===!0;case dt.IfNot:return t.value===!1;case dt.Greater:return t.value>e.threshold;case dt.Less:return t.value<e.threshold;case dt.Equals:return t.value===e.threshold;case dt.NotEqual:return t.value!==e.threshold}return!1}createActions(){var e,t,s;for(const n of this.model.layers){const o=n.stateMachine;for(let a=0;a<o.states.length;a++){const l=o.states[a];if(!!l.motion){if(this.animator&&l.motion.clips){const c=(e=l.motion.clips)==null?void 0:e.find(h=>{var d,u;return h.node.name===((u=(d=this.animator)==null?void 0:d.gameObject)==null?void 0:u.name)});l.motion.clip=c==null?void 0:c.clip}if((t=l.motion)==null?void 0:t.clip){const c=this._mixer.clipAction(l.motion.clip);l.motion.action=c}if(l.behaviours&&Array.isArray(l.behaviours))for(const c of l.behaviours){if(!(c==null?void 0:c.typeName))continue;const h=m.get(c.typeName),d=new h;d.isStateMachineBehaviour&&(d._context=(s=this.context)!=null?s:void 0,ln(d,c.properties),c.instance=d),ut&&console.log("Created animator controller behaviour",l.name,c.typeName,c.properties,d)}}}}}*enumerateActions(){for(const e of this.model.layers){const t=e.stateMachine;for(let s=0;s<t.states.length;s++){const n=t.states[s];(n==null?void 0:n.motion)&&(n.motion.action&&(yield n.motion.action),n.motion.action_loopback&&(yield n.motion.action_loopback))}}}internalApplyRootMotion(e){if(!this.animationRoot)if(this.animationRoot=this.findRootBone(e),!this.animationRoot&&e.children.length>0&&(this.animationRoot=e.children[0]),this.animationRoot){console.log(this.animationRoot),this.startPosition=this.animationRoot.position.clone(),this.lastPosition=this.startPosition.clone(),this.startRotation=this.animationRoot.quaternion.clone(),this.lastRotation=this.startRotation.clone(),this.animationRoot.add(new Ei);const n=this.animationRoot.parent;this.rootMotionBone.position.copy(this.animationRoot.position),this.rootMotionBone.add(this.animationRoot),n==null||n.add(this.rootMotionBone),this.rootMotionBone.add(new Ei)}else return;const t=this.animationRoot.quaternion,s=this.tempPos.copy(this.animationRoot.position);e=this.rootMotionBone;for(const n of this._activeStates){const o=n.motion.action;if(!o)continue;if(o.time<this.lastTime){this.lastTime=o.time,this.lastPosition.copy(this.animationRoot.position),this.lastRotation.copy(this.animationRoot.quaternion);break}this.lastTime=o.time;const a=this.tempRot2.multiplyQuaternions(this.tempRot.copy(t),this.lastRotation.invert()),l=this.tempPos2.copy(s).sub(this.lastPosition);l.applyQuaternion(e.quaternion),l.multiplyScalar(o.getEffectiveWeight()),e.position.add(l),e.quaternion.multiplyQuaternions(e.quaternion,a);break}this.lastPosition.copy(s),this.lastRotation.copy(t),this.animationRoot.position.set(0,0,0),this.animationRoot.quaternion.identity()}findRootBone(e){if(this.animationRoot)return this.animationRoot;if(e.type==="Bone")return this.animationRoot=e,this.animationRoot;if(e.children)for(const t of e.children){const s=this.findRootBone(t);if(s)return s}return null}}Rg(ri,"AnimatorController");var Bc=Object.defineProperty,Eg=Object.getOwnPropertyDescriptor,Ag=(i,e)=>Bc(i,"name",{value:e,configurable:!0}),cn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Eg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Bc(e,t,n),n};const Tg=w("debuganimator");class ft extends v{constructor(){super(...arguments);r(this,"applyRootMotion",!1);r(this,"hasRootMotion",!1);r(this,"keepAnimatorControllerStateOnDisable",!1);r(this,"speed",1);r(this,"normalizedStartOffset",0);r(this,"_animatorController",null)}set runtimeAnimatorController(e){this._animatorController&&this._animatorController.model===e||(e?e instanceof ri?this._animatorController=e:this._animatorController=new ri(e):this._animatorController=null)}get runtimeAnimatorController(){return this._animatorController}Play(e,t=-1,s=Number.NEGATIVE_INFINITY,n=0){var o;(o=this.runtimeAnimatorController)==null||o.Play(e,t,s,n)}Reset(){var e;(e=this._animatorController)==null||e.Reset()}SetBool(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetBool(e,t)}GetBool(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetBool(e))!=null?s:!1}SetFloat(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetFloat(e,t)}GetFloat(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetFloat(e))!=null?s:-1}SetInteger(e,t){var s;(s=this.runtimeAnimatorController)==null||s.SetInteger(e,t)}GetInteger(e){var t,s;return(s=(t=this.runtimeAnimatorController)==null?void 0:t.GetInteger(e))!=null?s:-1}SetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.SetTrigger(e)}ResetTrigger(e){var t;(t=this.runtimeAnimatorController)==null||t.ResetTrigger(e)}IsInTransition(){var e,t;return(t=(e=this.runtimeAnimatorController)==null?void 0:e.IsInTransition())!=null?t:!1}SetSpeed(e){var t;e!==this.speed&&(this.speed=e,(t=this._animatorController)==null||t.SetSpeed(e))}set minMaxSpeed(e){this.speed=A.lerp(e.x,e.y,Math.random())}set minMaxOffsetNormalized(e){this.normalizedStartOffset=A.lerp(e.x,e.y,Math.random()),this.runtimeAnimatorController&&(this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset)}awake(){if(!!this.gameObject){if(this.runtimeAnimatorController){const e=this.runtimeAnimatorController.clone();console.assert(this.runtimeAnimatorController!==e),this.runtimeAnimatorController=e,console.assert(this.runtimeAnimatorController===e),this.runtimeAnimatorController.bind(this),this.runtimeAnimatorController.SetSpeed(this.speed),this.runtimeAnimatorController.normalizedStartOffset=this.normalizedStartOffset}Tg&&console.log(this.name,this)}}onDisable(){var e;this.keepAnimatorControllerStateOnDisable||(e=this._animatorController)==null||e.Reset()}onBeforeRender(){var e;this._animatorController&&(this._animatorController.update(),this.applyRootMotion&&((e=this._animatorController)==null||e.applyRootMotion(this.gameObject)))}}Ag(ft,"Animator");cn([_()],ft.prototype,"applyRootMotion",2);cn([_()],ft.prototype,"hasRootMotion",2);cn([_()],ft.prototype,"keepAnimatorControllerStateOnDisable",2);cn([_()],ft.prototype,"runtimeAnimatorController",1);var Uc=Object.defineProperty,kg=Object.getOwnPropertyDescriptor,Nc=(i,e)=>Uc(i,"name",{value:e,configurable:!0}),zc=(i,e,t,s)=>{for(var n=s>1?void 0:s?kg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Uc(e,t,n),n};class Nt extends v{constructor(){super(...arguments);r(this,"playAutomatically",!0);r(this,"randomStartTime",!0);r(this,"_tempAnimationClipBeforeGameObjectExisted",null);r(this,"mixer");r(this,"_actions",[]);r(this,"_currentActions",[]);r(this,"_handles",[]);r(this,"_didInit",!1)}get clip(){var e;return((e=this.animations)==null?void 0:e.length)?this.animations[0]:null}set clip(e){if(!this.gameObject){this._tempAnimationClipBeforeGameObjectExisted=e;return}!e||(this.gameObject.animations||(this.gameObject.animations=[]),this.gameObject.animations.push(e))}set animations(e){this.gameObject.animations=e}get animations(){return this.gameObject.animations}get currentAction(){return this._currentActions[0]}get currentActions(){return this._currentActions}get actions(){return this._actions}set actions(e){this._actions=e}awake(){this._tempAnimationClipBeforeGameObjectExisted&&(this.clip=this._tempAnimationClipBeforeGameObjectExisted,this._tempAnimationClipBeforeGameObjectExisted=null),this.playAutomatically&&this.init()}onEnable(){if(this.playAutomatically&&this.actions.length>0&&this.currentActions.length<=0){const e=Math.floor(Math.random()*this.actions.length);this.play(e)}}start(){this.randomStartTime&&this.currentAction&&(this.currentAction.time=Math.random()*this.currentAction.getClip().duration)}update(){var e;if(!!this.mixer){this.mixer.update(this.context.time.deltaTime);for(const t of this._handles)t._update();((e=this._handles)==null?void 0:e.length)>0&&de.markDirty(this.gameObject)}}getAction(e){var t;return(t=this.actions)==null?void 0:t.find(s=>s.getClip().name===e)}play(e,t){if(this.init(),!this.mixer)return;let s=e;if(typeof e=="number"){if(e>=this.animations.length)return;s=this.animations[e]}else typeof e=="string"&&(s=this.animations.find(o=>o.name===e));if(!s){console.error("Could not find clip",e);return}for(const o of this.actions)if(o.getClip()===s)return this.internalOnPlay(o,t);const n=this.mixer.clipAction(s);return this.actions.push(n),this.internalOnPlay(n,t)}internalOnPlay(e,t){var a;var s=this.currentAction;if(s===e&&s.isRunning()&&s.time<s.getClip().duration){const l=this.tryFindHandle(e);if(l)return l.getPromise()}const n=(a=t==null?void 0:t.exclusive)!=null?a:!0;(t==null?void 0:t.fadeDuration)?(n&&(s==null||s.fadeOut(t.fadeDuration)),e.fadeIn(t.fadeDuration)):n&&(s==null||s.stop()),e.reset(),e.enabled=!0,e.time=0,e.timeScale=1,(t==null?void 0:t.clampWhenFinished)&&(e.clampWhenFinished=!0),(t==null?void 0:t.startTime)!==void 0&&(e.time=t.startTime),(t==null?void 0:t.loop)!==void 0&&(e.loop=t.loop?ep:Ja),e.play();const o=new $c(e,this.mixer,t,l=>{this._handles.splice(this._handles.indexOf(o),1)});return this._handles.push(o),o.getPromise()}tryFindHandle(e){for(const t of this._handles)if(t.action===e)return t}init(){if(!this._didInit&&(this._didInit=!0,!!this.gameObject)){this.actions=[],this.mixer=new Ar(this.gameObject);for(let e=0;e<this.animations.length;e++){const t=this.mixer.clipAction(this.animations[e]);this.actions.push(t)}}}}Nc(Nt,"Animation");zc([_()],Nt.prototype,"playAutomatically",2);zc([_()],Nt.prototype,"randomStartTime",2);class $c{constructor(e,t,s,n){r(this,"mixer");r(this,"action");r(this,"promise",null);r(this,"resolve",null);r(this,"reject",null);r(this,"_options");r(this,"_resolveCallback",null);r(this,"_rejectCallback",null);r(this,"_loopCallback");r(this,"_finishedCallback");r(this,"_resolvedOrRejectedCallback");this.action=e,this.mixer=t,this._resolvedOrRejectedCallback=n,this._options=s}getPromise(){return this.promise?this.promise:(this.promise=new Promise((e,t)=>{this._resolveCallback=e,this._rejectCallback=t,this.resolve=this.onResolve.bind(this),this.reject=this.onReject.bind(this)}),this._loopCallback=this.onLoop.bind(this),this._finishedCallback=this.onFinished.bind(this),this.mixer.addEventListener("loop",this._loopCallback),this.mixer.addEventListener("finished",this._finishedCallback),this.promise)}_update(){var e;!this._options||this._options.endTime!==void 0&&this.action.time>this._options.endTime&&(this._options.loop===!0?this.action.time=(e=this._options.startTime)!=null?e:0:(this.action.time=this._options.endTime,this.action.timeScale=0,this.onResolve()))}onResolve(){var e,t;this.dispose(),(e=this._resolvedOrRejectedCallback)==null||e.call(this,this),(t=this._resolveCallback)==null||t.call(this,this.action)}onReject(e){var t,s;this.dispose(),(t=this._resolvedOrRejectedCallback)==null||t.call(this,this),(s=this._rejectCallback)==null||s.call(this,e)}onLoop(e){}onFinished(e){e.action===this.action&&this.onResolve()}dispose(){this._loopCallback&&this.mixer.removeEventListener("loop",this._loopCallback),this._finishedCallback&&this.mixer.removeEventListener("finished",this._finishedCallback),this._loopCallback=void 0,this._finishedCallback=void 0}}Nc($c,"AnimationHandle");var Lg=Object.defineProperty,Dg=(i,e)=>Lg(i,"name",{value:e,configurable:!0});class Wc extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"width",0);r(this,"centered",!0);r(this,"_centerPos")}awake(){this._centerPos=new y}update(){if(!this.from||!this.to)return;const e=C(this.from).clone(),t=C(this.to).clone(),s=e.distanceTo(t);this._centerPos.copy(e),this._centerPos.add(t),this._centerPos.multiplyScalar(.5),D(this.gameObject,this.centered?this._centerPos:e),this.gameObject.lookAt(C(this.to).clone()),this.gameObject.scale.set(this.width,this.width,s)}}Dg(Wc,"AlignmentConstraint");var Hc=Object.defineProperty,Mg=Object.getOwnPropertyDescriptor,Gc=(i,e)=>Hc(i,"name",{value:e,configurable:!0}),pt=(i,e,t,s)=>{for(var n=s>1?void 0:s?Mg(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Hc(e,t,n),n};class Ze{constructor(){r(this,"time");r(this,"value");r(this,"inTangent");r(this,"inWeight");r(this,"outTangent");r(this,"outWeight");r(this,"weightedMode")}}Gc(Ze,"Keyframe");pt([_()],Ze.prototype,"time",2);pt([_()],Ze.prototype,"value",2);pt([_()],Ze.prototype,"inTangent",2);pt([_()],Ze.prototype,"inWeight",2);pt([_()],Ze.prototype,"outTangent",2);pt([_()],Ze.prototype,"outWeight",2);pt([_()],Ze.prototype,"weightedMode",2);class mo{constructor(){r(this,"keys")}get duration(){return!this.keys||this.keys.length==0?0:this.keys[this.keys.length-1].time}evaluate(e){if(!this.keys||this.keys.length==0)return 0;let t=null;for(const s of this.keys){if(t&&s.time>e&&e>t.time)return A.lerp(t.value,s.value,(e-t.time)/(s.time-t.time));t=s}return this.keys[this.keys.length-1].value}}Gc(mo,"AnimationCurve");pt([_(Ze)],mo.prototype,"keys",2);var Vc=Object.defineProperty,Ig=Object.getOwnPropertyDescriptor,qc=(i,e)=>Vc(i,"name",{value:e,configurable:!0}),mt=(i,e,t,s)=>{for(var n=s>1?void 0:s?Ig(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Vc(e,t,n),n};const Ie=w("debugaudio");var Xc;(function(i){i[i.Logarithmic=0]="Logarithmic",i[i.Linear=1]="Linear",i[i.Custom=2]="Custom"})(Xc||(Xc={}));var ws;const ne=(ws=class extends v{constructor(){super(...arguments);r(this,"clip","");r(this,"playOnAwake",!1);r(this,"spatialBlend",0);r(this,"minDistance",1);r(this,"maxDistance",100);r(this,"volume",1);r(this,"rollOffMode",0);r(this,"_loop",!1);r(this,"sound",null);r(this,"helper",null);r(this,"wasPlaying",!1);r(this,"audioLoader",null);r(this,"shouldPlay",!1);r(this,"_lastClipStartedLoading",null);r(this,"lerp",(i,e,t)=>i*(1-t)+e*t);r(this,"_lastContextTime",0);r(this,"_hasEnded",!0)}static get userInteractionRegistered(){return ne._didCallBeginWaitForUserInteraction||(ne._didCallBeginWaitForUserInteraction=!0,ne._beginWaitForUserInteraction()),ne._userInteractionRegistered}static registerWaitForAllowAudio(i){if(i!==null){if(this._userInteractionRegistered){i();return}this.callbacks.indexOf(i)===-1&&this.callbacks.push(i),ne._didCallBeginWaitForUserInteraction||(ne._didCallBeginWaitForUserInteraction=!0,ne._beginWaitForUserInteraction())}}static _beginWaitForUserInteraction(i=null){i!==null&&this.registerWaitForAllowAudio(i);let t=qc(()=>{if(t!=null&&!ne._userInteractionRegistered){ne._userInteractionRegistered=!0,console.log("registered interaction, can play audio now"),document.removeEventListener("pointerdown",t),document.removeEventListener("click",t),document.removeEventListener("dragstart",t),document.removeEventListener("touchstart",t);for(const s of this.callbacks)s();this.callbacks.length=0}},"callback").bind(this);document.addEventListener("pointerdown",t),document.addEventListener("click",t),document.addEventListener("dragstart",t),document.addEventListener("touchstart",t)}get loop(){return this.sound&&(this._loop=this.sound.getLoop()),this._loop}set loop(i){this._loop=i,this.sound&&this.sound.setLoop(i)}get Sound(){var i;if(!this.sound&&ne._userInteractionRegistered){const e=(i=p.getComponent(this.context.mainCamera,Ni))!=null?i:p.findObjectOfType(Ni,this.context);(e==null?void 0:e.listener)&&(this.sound=new tp(e.listener),this.gameObject.add(this.sound))}return this.sound}get ShouldPlay(){return this.shouldPlay}awake(){this.audioLoader=new Tr,this.playOnAwake&&(this.shouldPlay=!0),window.addEventListener("visibilitychange",i=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this.isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){ne._beginWaitForUserInteraction(()=>{this.enabled&&!this.destroyed&&this.loadAndPlay(this.clip)})}onLoaded(i){Ie&&console.log("audio buffer loaded"),ne.registerWaitForAllowAudio(()=>{Ie&&console.log("finished loading",i);const e=this.Sound;if(!e){console.warn("Failed getting sound",this.name);return}e.isPlaying&&e.stop(),e.setBuffer(i),e.loop=this.loop,e.setVolume(this.volume),e.autoplay=this.shouldPlay;const t=this.lerp(1e3,this.minDistance,this.spatialBlend);switch(Ie&&console.log("Ref distance= "+t),e.setRefDistance(t),e.setMaxDistance(this.maxDistance),this.rollOffMode){case 0:e.setDistanceModel("linear");break;case 1:e.setDistanceModel("exponential");break}e.isPlaying&&e.stop(),this.spatialBlend>0&&Ie&&!this.helper&&(console.log(this),this.helper=new ip(e,e.getRefDistance()),e.add(this.helper)),this.shouldPlay&&ne._userInteractionRegistered&&this.play()})}loadAndPlay(i){if(this.clip=i,this.clip&&(Ie&&console.log(this.clip),this.clip.endsWith(".mp3")||this.clip.endsWith(".wav"))){if(this.audioLoader||(this.audioLoader=new Tr),this.shouldPlay=!0,this._lastClipStartedLoading===this.clip)return;this._lastClipStartedLoading=this.clip,Ie&&console.log("load audio",this.clip),this.audioLoader.load(this.clip,this.onLoaded.bind(this),()=>{},console.error)}}play(i=void 0){if(i&&i!==this.clip){this.loadAndPlay(i);return}this.shouldPlay=!0,this._hasEnded=!1,Ie&&console.log("play",this),this.sound&&!this.sound.isPlaying&&(Ie&&console.log("start playing",this.sound.getVolume(),this.sound),this.sound.play())}pause(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&this.sound.isPlaying&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,this.sound.pause())}stop(){var i;this._hasEnded=!0,this.shouldPlay=!1,this.sound&&(this._lastContextTime=(i=this.sound)==null?void 0:i.context.currentTime,Ie&&console.log(this._lastContextTime),this.sound.stop())}get isPlaying(){var i,e;return(e=(i=this.sound)==null?void 0:i.isPlaying)!=null?e:!1}set isPlaying(i){}get time(){var i,e;return((i=this.sound)==null?void 0:i.source)?((e=this.sound.source)==null?void 0:e.context.currentTime)-this._lastContextTime+this.sound.offset:0}set time(i){if(this.sound){if(i===this.sound.offset)return;const e=this.isPlaying;this.stop(),this.sound.offset=i,e&&this.play()}}update(){this.helper&&(this.isPlaying&&this.helper.update(),this.helper.visible=this.isPlaying),this.sound&&!this.sound.isPlaying&&this.shouldPlay&&!this._hasEnded&&(this._hasEnded=!0,Ie&&console.log("Audio clip ended",this.clip),this.sound.dispatchEvent({type:"ended",target:this}))}},r(ws,"_didCallBeginWaitForUserInteraction",!1),r(ws,"callbacks",[]),r(ws,"_userInteractionRegistered",!1),ws);let re=ne;qc(re,"AudioSource");mt([_()],re.prototype,"clip",2);mt([_()],re.prototype,"playOnAwake",2);mt([_()],re.prototype,"loop",1);mt([_()],re.prototype,"spatialBlend",2);mt([_()],re.prototype,"minDistance",2);mt([_()],re.prototype,"maxDistance",2);mt([_()],re.prototype,"volume",2);mt([_()],re.prototype,"rollOffMode",2);var jg=Object.defineProperty,Fg=(i,e)=>jg(i,"name",{value:e,configurable:!0});class Ni extends v{constructor(){super(...arguments);r(this,"_listener",null)}get listener(){return this._listener==null&&(this._listener=new Za),this._listener}awake(){re.registerWaitForAllowAudio(()=>{const e=this.listener;if(e==null||e.parent)return;const t=p.getComponentInParent(this.gameObject,N);t?t.cam.add(e):this.gameObject.add(e)})}}Fg(Ni,"AudioListener");var Bg=Object.defineProperty,Ug=(i,e)=>Bg(i,"name",{value:e,configurable:!0});let zi,$i;function hn(i,e){zi||(zi=new sp,zi.setDecoderPath("./include/draco/"),zi.setDecoderConfig({type:"js"})),$i||($i=new np,$i.setTranscoderPath("./include/ktx2/"),e.renderer&&$i.detectSupport(e.renderer)),i.setDRACOLoader(zi),i.setKTX2Loader($i)}Ug(hn,"addDracoAndKTX2Loaders");var Ng=Object.defineProperty,Wi=(i,e)=>Ng(i,"name",{value:e,configurable:!0});class go{constructor(e,t,s,n){r(this,"success");r(this,"filename");r(this,"hash");r(this,"size");r(this,"url");this.success=e,this.filename=t,this.hash=s,this.size=n}}Wi(go,"Upload_Result");async function Yc(i,e){const t=await i.arrayBuffer(),s=_o(t),n=i.name.split(".").pop(),o=s+"."+n,a=i.name.split(".").shift();console.assert(a!==void 0);const l={alias:a,filename:o},h=await(await fetch(e+"/exists",{method:"POST",body:JSON.stringify(l)})).json();if(h.success||console.warn("exists check did fail"),h.exists)return console.log("file already exists",s),new go(!0,o,s,i.size);console.log("begin uploading file",a,i.size);const d=new FormData;d.append("file",i);const u={};u.filesize=i.size,a&&(u.alias=a);const b=await(await fetch(e+"/upload/file",{method:"POST",body:d,headers:u})).json();if((b==null?void 0:b.success)===!1)return b.message!==void 0?console.error("Upload failed:",b.message):console.error("Upload failed"),null;console.assert(b.hash_sum===s,"hash sum did not match","received:",b.hash_sum,"expected:",s),b.success&&console.log("successfully uploaded",s,b.id);const x=new go(b.success,o,s,i.size);return x.url=e,x}Wi(Yc,"upload_file");function _o(i){return rp(new Uint8Array(i))}Wi(_o,"hash");async function bo(i,e,t,s,n=!1){try{const o=await fetch(s+"/download/file",{method:"POST",body:i});if(o.status!==200)return console.error("download failed",o),null;const a=await o.blob(),l=await a.arrayBuffer();n||console.assert(a.size===t,"size mismatch","expected:",t,"got:",a.size);const c=_o(l);return n||console.assert(c===e,"hash mismatch, downloaded file is invalid"),a.arrayBuffer()}catch(o){console.error(o)}return null}Wi(bo,"download_file");async function Qc(i,e){var d;const t=await fetch(i),s=(d=t.body)==null?void 0:d.getReader(),n=t.headers.get("Content-Length"),o=n?parseInt(n):0;if(!s)return null;let a=0,l=[];for(;;){const{done:u,value:g}=await s.read();if(g&&(l.push(g),a+=g.length,e.call(null,new ProgressEvent("progress",{loaded:a,total:o}))),u)break}const c=new Uint8Array(a);let h=0;for(let u of l)c.set(u,h),h+=u.length;return c}Wi(Qc,"download");var zg=Object.defineProperty,yo=(i,e)=>zg(i,"name",{value:e,configurable:!0});const Hi=w("debugavatar");class vo{constructor(e,t,s,n){r(this,"root");r(this,"head");r(this,"leftHand");r(this,"rigthHand");var o;this.root=e,this.head=t,this.leftHand=s,this.rigthHand=n,(o=this.root)==null||o.traverse(a=>a.layers.set(2))}get isValid(){return this.head!==null&&this.head!==void 0}assignRandomColors(){dn.assignRandomPlayerColors(this)}}yo(vo,"AvatarModel");class dn{constructor(){r(this,"avatarRegistryUrl",null);r(this,"avatarModelCache",new Map)}async getOrCreateNewAvatarInstance(e,t){if(!t)return console.error("Can not create avatar: failed to provide id or root object"),null;let s=null;if(typeof t=="string"){if(s=await this.loadAvatar(e,t),!s){const o=new Ce;s=p.instantiate(Mt(t,e.scene),o)}}else s=t;if(!s)return null;const n=this.findAvatar(s);return n.assignRandomColors(),n.isValid?(Hi&&console.log("[Custom Avatar] valid config",t,Hi?n:""),n):(console.warn("[Custom Avatar] config isn't valid",t,Hi?n:""),null)}async loadAvatar(e,t){var n;if(console.assert(t!=null&&typeof t=="string","Avatar id must not be null"),t.length<=0||!t)return null;if(Hi&&console.log("[Custom Avatar] "+t+", loading..."),t.endsWith(".glb")||(t+=".glb"),this.avatarRegistryUrl===null){const o=await fetch("./"+t);let a=null;if(o.ok){const c=await o.blob();c&&(a=await c.arrayBuffer())}if(!a&&(a=await bo(t,t,0,"no url here go away",!0),!a))return null;const l=await ys(e,a,null,0);return(n=l==null?void 0:l.scene)!=null?n:null}const s=new kr;return hn(s,e),new Promise((o,a)=>{const l=this.avatarRegistryUrl+"/"+t;s.load(l,async c=>{await wa(e,l,c),o(c.scene)},c=>{Hi&&console.log("[Custom Avatar] "+c.loaded/c.total*100+"% loaded of "+c.total/1024+"kB")},c=>{console.error("[Custom Avatar] Error when loading: "+c),o(null)})})}cacheModel(e,t){}findAvatar(e){const t=e;let s=t;s.children.length==1&&(s=e.children[0]);let n=this.findAvatarPart(s,"head");const o=this.findAvatarPart(s,"left"),a=this.findAvatarPart(s,"right");if(!n){n=t;let c=new y;new Jt().setFromObject(n).getSize(c);let h=Math.max(c.x,c.y,c.z);console.warn("[Custom Avatar] Normalizing head scale, it's too big: "+h+" meters! Should be < 0.3m"),h>.3&&n.scale.multiplyScalar(1/h*.3)}return new vo(t,n,o,a)}findAvatarPart(e,t){for(let s of e.children)if(s.name.toLowerCase().indexOf(t)>-1)return s;return null}handleCustomAvatarErrors(e){if(!e.ok)throw Error(e.statusText);return e}static assignRandomPlayerColors(e){const t=new Map;function s(n){if(n.type==="Mesh"){const o=n,a=o.material;if(a&&a.name){if(t.has(a.uuid)){const l=t.get(a.uuid);l&&(o.material=l);return}if(a.name.endsWith("_playercolor")||a.name.endsWith("_player_color2")){const l=a.uuid;o.material=a.clone(),o.material.color=new f(Math.random(),Math.random(),Math.random()),t.set(l,o.material)}}}}yo(s,"findPlayerColorMeshesAndAssignColors"),e.head&&e.head.traverse(s),e.leftHand&&e.leftHand.traverse(s),e.rigthHand&&e.rigthHand.traverse(s)}}yo(dn,"AvatarLoader");var Jc=Object.defineProperty,$g=Object.getOwnPropertyDescriptor,Wg=(i,e)=>Jc(i,"name",{value:e,configurable:!0}),wo=(i,e,t,s)=>{for(var n=s>1?void 0:s?$g(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Jc(e,t,n),n};class Gi extends v{constructor(){super(...arguments);r(this,"length",1);r(this,"depthTest",!0);r(this,"isGizmo",!0);r(this,"_axes",null)}onEnable(){if(this.isGizmo&&!Bi)return;this._axes||(this._axes=new Ei(this.length)),this.gameObject.add(this._axes);const e=this._axes.material;e&&e.depthTest!==void 0&&(e.depthTest=this.depthTest)}onDisable(){!this._axes||this.gameObject.remove(this._axes)}}Wg(Gi,"AxesHelper");wo([_()],Gi.prototype,"length",2);wo([_()],Gi.prototype,"depthTest",2);wo([_()],Gi.prototype,"isGizmo",2);var Hg=Object.defineProperty,Gg=(i,e)=>Hg(i,"name",{value:e,configurable:!0});class Zc extends v{constructor(){super(...arguments);r(this,"from");r(this,"to");r(this,"hint");r(this,"desiredDistance",1)}onEnable(){}update(){if(!this.from||!this.to||!this.hint)return;let e=C(this.to).clone(),t=C(this.from).clone(),s=e.distanceTo(t),n=e.clone();n.sub(t);let o=t.clone();o.add(e),o.multiplyScalar(.5);let a=C(this.hint).clone();a.sub(o);let l=new y;l.crossVectors(a,n),l.crossVectors(n,l),l.normalize();let c=s*.5,h=Math.max(this.desiredDistance,c),d=Math.sqrt(h*h-c*c),u=l.clone();u.multiplyScalar(d),u.add(o),D(this.gameObject,u);let g=o.clone();g.sub(l),this.gameObject.lookAt(g)}}Gg(Zc,"BasicIKConstraint");var Vg=Object.defineProperty,qg=(i,e)=>Vg(i,"name",{value:e,configurable:!0});const Pi=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new eo;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new Lt(e.x,e.y,e.z),t?new Lt(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?he.KINEMATIC:he.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?Pi.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):Pi.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){Pi.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(Pi.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=C(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let Ee=Pi;r(Ee,"tempPosition",new y),r(Ee,"copyVector3",new y);qg(Ee,"Rigidbody");var Xg=Object.defineProperty,Yg=(i,e)=>Xg(i,"name",{value:e,configurable:!0});class Kc extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{attachedRigidbody:Ee,size:y,center:y,isTrigger:null});r(this,"attachedRigidbody");r(this,"size");r(this,"center");r(this,"isTrigger");r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addBoxCollider(this.gameObject,this.isTrigger,this.center,this.size,this.attachedRigidbody))}}Yg(Kc,"BoxCollider");var Qg=Object.defineProperty,Jg=(i,e)=>Qg(i,"name",{value:e,configurable:!0});const Zg=new Ka(1,1,1);function xo(i=null){const e=new f(i!=null?i:14540253),t=new op(Zg);return new ap(t,new lp({color:e}))}Jg(xo,"CreateWireCube");var Kg=Object.defineProperty,e_=(i,e)=>Kg(i,"name",{value:e,configurable:!0});const t_=w("gizmos");class Vi extends v{constructor(){super(...arguments);r(this,"box",null);r(this,"testBox",new Jt);r(this,"_lastMatrixUpdateFrame",-1);r(this,"_helper",null);r(this,"_color",null)}isInBox(e){var t;if(!!e){if(this.box||(this.box=new Jt),this.updateBox(!1),e.type==="Mesh")this.testBox.setFromObject(e);else{const s=C(e);this.testBox.set(s,s)}return(t=this.box)==null?void 0:t.intersectsBox(this.testBox)}}intersects(e){return e?this.updateBox(!1).intersectsBox(e):!1}updateBox(e=!1){return this.box||(this.box=new Jt),(e||this.context.time.frameCount!=this._lastMatrixUpdateFrame)&&(this._lastMatrixUpdateFrame=this.context.time.frameCount,this.box.setFromCenterAndSize(new y(0,0,0),new y(1,1,1)),this.box.applyMatrix4(this.gameObject.matrixWorld)),this.box}awake(){this._helper=null,this._color=null,this.box=null}showHelper(e=null,t=!1){var s;if(!(!t_&&!t)){if(this._helper){e&&((s=this._color)==null||s.set(e)),this.gameObject.add(this._helper);return}this._helper=xo(e),this.gameObject.add(this._helper)}}}e_(Vi,"BoxHelperComponent");var i_=Object.defineProperty,s_=(i,e)=>i_(i,"name",{value:e,configurable:!0});class eh{}s_(eh,"UnityObject");var n_=Object.defineProperty,th=(i,e)=>n_(i,"name",{value:e,configurable:!0});class qi extends v{constructor(){super(...arguments);r(this,"canGrab",!0)}onPointerClick(e){}}th(qi,"Interactable");class Xi extends v{constructor(){super(...arguments);r(this,"isUsed",!0);r(this,"usedBy",null)}}th(Xi,"UsageMarker");var r_=Object.defineProperty,ih=(i,e)=>r_(i,"name",{value:e,configurable:!0});class Po extends Vi{}ih(Po,"DeleteBox");class sh extends v{constructor(){super(...arguments);r(this,"deleteBoxes",[])}awake(){this.deleteBoxes=p.findObjectsOfType(Po,this.context)}update(){for(const e of this.deleteBoxes){const t=this.gameObject;e.isInBox(t)===!0&&(p.getComponentInParent(this.gameObject,Xi)||Bs(this.gameObject,this.context.connection))}}}ih(sh,"Deletable");var nh=Object.defineProperty,o_=Object.getOwnPropertyDescriptor,rh=(i,e)=>nh(i,"name",{value:e,configurable:!0}),a_=(i,e,t,s)=>{for(var n=s>1?void 0:s?o_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&nh(e,t,n),n},oh;(function(i){i[i.Never=0]="Never",i[i.Desktop=1]="Desktop",i[i.Mobile=2]="Mobile"})(oh||(oh={}));class Oo extends v{constructor(){super(...arguments);r(this,"visibleOn")}onEnable(){this.apply()}apply(){this.test()||p.setActive(this.gameObject,!1)}test(){return this.visibleOn<0?!0:ah()?(this.visibleOn&2)!=0:(this.visibleOn&1)!=0}}rh(Oo,"DeviceFlag");a_([_()],Oo.prototype,"visibleOn",2);let un;function ah(){if(un===!0||un===!1)return un;let i=!1;return function(e){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))&&(i=!0)}(navigator.userAgent||navigator.vendor||window.opera),un=i,i}rh(ah,"isMobile");var l_=Object.defineProperty,c_=(i,e)=>l_(i,"name",{value:e,configurable:!0});class oe{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}static sizeOf(){return 12}static createVec3(e,t,s,n){return e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}c_(oe,"Vec3");var h_=Object.defineProperty,d_=(i,e)=>h_(i,"name",{value:e,configurable:!0});class Co{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}position(e){return(e||new oe).__init(this.bb_pos,this.bb)}rotation(e){return(e||new oe).__init(this.bb_pos+12,this.bb)}scale(e){return(e||new oe).__init(this.bb_pos+24,this.bb)}static sizeOf(){return 36}static createTransform(e,t,s,n,o,a,l,c,h,d){return e.prep(4,36),e.prep(4,12),e.writeFloat32(d),e.writeFloat32(h),e.writeFloat32(c),e.prep(4,12),e.writeFloat32(l),e.writeFloat32(a),e.writeFloat32(o),e.prep(4,12),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}d_(Co,"Transform");var u_=Object.defineProperty,f_=(i,e)=>u_(i,"name",{value:e,configurable:!0});class je{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedTransformModel(e,t){return(t||new je).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedTransformModel(e,t){return e.setPosition(e.position()+Lr),(t||new je).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}fast(){const e=this.bb.__offset(this.bb_pos,6);return e?!!this.bb.readInt8(this.bb_pos+e):!1}transform(e){const t=this.bb.__offset(this.bb_pos,8);return t?(e||new Co).__init(this.bb_pos+t,this.bb):null}dontSave(){const e=this.bb.__offset(this.bb_pos,10);return e?!!this.bb.readInt8(this.bb_pos+e):!1}static startSyncedTransformModel(e){e.startObject(4)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addFast(e,t){e.addFieldInt8(1,+t,0)}static addTransform(e,t){e.addFieldStruct(2,t,0)}static addDontSave(e,t){e.addFieldInt8(3,+t,0)}static endSyncedTransformModel(e){return e.endObject()}static finishSyncedTransformModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedTransformModelBuffer(e,t){e.finish(t,void 0,!0)}}f_(je,"SyncedTransformModel");var p_=Object.defineProperty,lh=(i,e)=>p_(i,"name",{value:e,configurable:!0});const gt=w("debugsync"),Yi="STRS";qs(Yi,je.getRootAsSyncedTransformModel);const Fe=new As;function So(i,e,t=!0){Fe.clear();const s=Fe.createString(i);je.startSyncedTransformModel(Fe),je.addGuid(Fe,s),je.addFast(Fe,t);const n=e.worldPosition,o=e.worldEuler,a=e.gameObject.scale;je.addTransform(Fe,Co.createTransform(Fe,n.x,n.y,n.z,o.x,o.y,o.z,a.x,a.y,a.z));const l=je.endSyncedTransformModel(Fe);return Fe.finish(l,Yi),Fe.asUint8Array()}lh(So,"createTransformModel");class _t extends v{constructor(){super(...arguments);r(this,"overridePhysics",!0);r(this,"interpolatePosition",!0);r(this,"interpolateRotation",!0);r(this,"fastMode",!1);r(this,"syncDestroy",!1);r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"rb",null);r(this,"_wasKinematic",!1);r(this,"_receivedDataBefore",!1);r(this,"_targetPosition");r(this,"_targetRotation");r(this,"_receivedFastUpdate",!1);r(this,"_shouldRequestOwnership",!1);r(this,"joinedRoomCallback",null);r(this,"receivedDataCallback",null);r(this,"tempEuler",new Pe);r(this,"receivedUpdate",!1);r(this,"lastWorldPos");r(this,"lastWorldRotation")}requestOwnership(){gt&&console.log("Request ownership"),this._model?this._model.requestOwnership():(this._shouldRequestOwnership=!0,this._needsUpdate=!0)}hasOwnership(){var e,t;return(t=(e=this._model)==null?void 0:e.hasOwnership)!=null?t:void 0}isOwned(){var e;return(e=this._model)==null?void 0:e.isOwned}awake(){gt&&console.log("new instance",this.guid,this),this._receivedDataBefore=!1,this._targetPosition=new y,this._targetRotation=new O,this.lastWorldPos=new y,this.lastWorldRotation=new O,this.rb=p.getComponentInChildren(this.gameObject,Ee),this.rb&&(this._wasKinematic=this.rb.kinematic),this.receivedUpdate=!0,this._model=new Qs(this.context.connection,this.guid),this.context.connection.isConnected&&this.tryGetLastState(),this.joinedRoomCallback=this.tryGetLastState.bind(this),this.context.connection.beginListen(W.JoinedRoom,this.joinedRoomCallback),this.receivedDataCallback=this.onReceivedData.bind(this),this.context.connection.beginListenBinrary(Yi,this.receivedDataCallback)}onDestroy(){this.syncDestroy&&Hl(this.guid,this.context.connection),this._model=null,this.context.connection.stopListening(W.JoinedRoom,this.joinedRoomCallback),this.context.connection.stopListenBinary(Yi,this.receivedDataCallback)}tryGetLastState(){const e=this.context.connection.tryGetState(this.guid);e&&this.onReceivedData(e)}onReceivedData(e){var t;if(!this.destroyed&&typeof e.guid=="function"&&e.guid()===this.guid){gt&&console.log("new data",this.context.connection.connectionId,this.context.time.frameCount,this.guid,e),this.receivedUpdate=!0,this._receivedFastUpdate=e.fast();const s=e.transform();if(s){de.markDirty(this.gameObject,!0);const n=s.position();n&&(this.interpolatePosition&&((t=this._targetPosition)==null||t.set(n.x(),n.y(),n.z())),(!this.interpolatePosition||!this._receivedDataBefore)&&this.setWorldPosition(n.x(),n.y(),n.z()));const o=s.rotation();o&&(this.tempEuler.set(o.x(),o.y(),o.z()),this.interpolateRotation&&this._targetRotation.setFromEuler(this.tempEuler),(!this.interpolateRotation||!this._receivedDataBefore)&&Nl(this.gameObject,this.tempEuler))}this._receivedDataBefore=!0}}onEnable(){this.lastWorldPos.copy(this.worldPosition),this.lastWorldRotation.copy(this.worldQuaternion),this._needsUpdate=!0,this._model&&this._model.updateIsOwned()}onDisable(){this._model&&this._model.freeOwnership()}onBeforeRender(){var o;if(!this.activeAndEnabled||!this.context.connection.isConnected)return;if(!this.context.connection.isInRoom||!this._model){gt&&console.log("no model or room",this.name,this.guid,this.context.connection.isInRoom);return}this._shouldRequestOwnership&&(this._shouldRequestOwnership=!1,this._model.requestOwnership());let e=this.worldPosition,t=this.worldQuaternion;if(this._model.isOwned&&!this.receivedUpdate){const a=e.distanceTo(this.lastWorldPos),l=t.angleTo(this.lastWorldRotation),c=this._model.hasOwnership||this.fastMode?1e-4:.001;(a>c||l>c)&&(this._model.hasOwnership?this._needsUpdate=!0:(gt&&console.log(this.guid,"reset because not owned but",this.gameObject.name,this.lastWorldPos),this.worldPosition=this.lastWorldPos,e.copy(this.lastWorldPos),this.worldQuaternion=this.lastWorldRotation,t.copy(this.lastWorldRotation),de.markDirty(this.gameObject,!0),this._needsUpdate=!1))}if(this._model&&!this._model.hasOwnership&&this._model.isOwned&&this._receivedDataBefore){const l=this._receivedFastUpdate||this.fastMode?.5:.3;let c=!1;if(this.interpolatePosition&&this._targetPosition){const h=this.worldPosition;h.lerp(this._targetPosition,l),this.worldPosition=h,c=!0}if(this.interpolateRotation&&this._targetRotation){const h=this.worldQuaternion;h.slerp(this._targetRotation,l),this.worldQuaternion=h,c=!0}c&&de.markDirty(this.gameObject,!0)}if(this.receivedUpdate=!1,this.lastWorldPos.copy(e),this.lastWorldRotation.copy(t),!this._model)return;if(!this._model||this._model.hasOwnership===void 0||!this._model.hasOwnership){this.rb&&(this.rb.kinematic=(o=this._model.isOwned)!=null?o:!1,this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject());return}this.rb&&(this._wasKinematic!==void 0&&(gt&&console.log("reset kinematic",this.rb.name,this._wasKinematic),this.rb.kinematic=this._wasKinematic),this.gameObject.position.distanceTo(new y(0,0,0))>1e3&&(gt&&console.log("RESET",this.name),this.gameObject.position.set(0,1,0),this.rb.setVelocity(0,0,0),this.rb.setBodyFromGameObject()));const s=10,n=this.rb||this.fastMode;if(this._needsUpdate&&(this.context.time.frameCount%s==0||n)){gt&&console.log("send update",this.context.connection.connectionId,this.guid,this.gameObject.name,this.gameObject.guid),this.overridePhysics&&this.rb&&this.rb.setBodyFromGameObject(),this._needsUpdate=!1;const a=So(this.guid,this,!!n);this.context.connection.sendBinary(a)}}}lh(_t,"SyncedTransform");class m_{static createButton(e,t={}){const s=document.createElement("button");function n(){if(t.domOverlay===void 0){var c=document.createElement("div");c.style.display="none",document.body.appendChild(c);var h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width",38),h.setAttribute("height",38),h.style.position="absolute",h.style.right="20px",h.style.top="20px",h.addEventListener("click",function(){u.end()}),c.appendChild(h);var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),d.setAttribute("stroke","#fff"),d.setAttribute("stroke-width",2),h.appendChild(d),t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("dom-overlay"),t.domOverlay={root:c}}t.optionalFeatures===void 0&&(t.optionalFeatures=[]),t.optionalFeatures.push("local-floor"),t.optionalFeatures.push("hand-tracking"),t.optionalFeatures.push("layers");let u=null;async function g(x){x.addEventListener("end",b),await e.xr.setSession(x),s.textContent="STOP AR",t.domOverlay.root.style.display="",u=x}function b(){u.removeEventListener("end",b),s.textContent="START AR",t.domOverlay.root.style.display="none",u=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="START AR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){u===null?navigator.xr.requestSession("immersive-ar",t).then(g):u.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="AR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="ARButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-ar").then(function(c){c?n():a()}).catch(a),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}}const br=class{static createButton(e,t){t&&console.error('THREE.VRButton: The "options" parameter has been removed. Please set the reference space type via renderer.xr.setReferenceSpaceType() instead.');const s=document.createElement("button");function n(){let c=null;async function h(u){u.addEventListener("end",d),await e.xr.setSession(u),s.textContent="EXIT VR",c=u}function d(){c.removeEventListener("end",d),s.textContent="ENTER VR",c=null}s.style.display="",s.style.cursor="pointer",s.style.left="calc(50% - 50px)",s.style.width="100px",s.textContent="ENTER VR",s.onmouseenter=function(){s.style.opacity="1.0"},s.onmouseleave=function(){s.style.opacity="0.5"},s.onclick=function(){if(c===null){const u={optionalFeatures:["local-floor","bounded-floor","hand-tracking","high-fixed-foveation-level","layers"]};navigator.xr.requestSession("immersive-vr",u).then(h)}else c.end()}}function o(){s.disabled=!0,s.style.display="",s.style.cursor="auto",s.style.left="calc(50% - 75px)",s.style.width="150px",s.onmouseenter=null,s.onmouseleave=null,s.onclick=null}function a(){o(),s.textContent="VR NOT SUPPORTED"}function l(c){c.style.position="absolute",c.style.bottom="20px",c.style.padding="12px 6px",c.style.border="1px solid #fff",c.style.borderRadius="4px",c.style.background="rgba(0,0,0,0.1)",c.style.color="#fff",c.style.font="normal 13px sans-serif",c.style.textAlign="center",c.style.opacity="0.5",c.style.outline="none",c.style.zIndex="999"}if("xr"in navigator)return s.id="VRButton",s.style.display="none",l(s),navigator.xr.isSessionSupported("immersive-vr").then(function(c){c?n():a(),br.xrSessionIsGranted&&(console.log("XR session is granted - will enter immersive web now"),s.click())}),s;{const c=document.createElement("a");return window.isSecureContext===!1?(c.href=document.location.href.replace(/^http:/,"https:"),c.innerHTML="WEBXR NEEDS HTTPS"):(c.href="https://immersiveweb.dev/",c.innerHTML="WEBXR NOT AVAILABLE"),c.style.left="calc(50% - 90px)",c.style.width="180px",c.style.textDecoration="none",l(c),c}}static registerSessionGrantedListener(){if("xr"in navigator)try{navigator.xr.addEventListener("sessiongranted",()=>{console.log("Received session granted event"),br.xrSessionIsGranted=!0})}catch(e){console.error(e)}}};let fn=br;r(fn,"xrSessionIsGranted",!1);fn.registerSessionGrantedListener();var g_=Object.defineProperty,pn=(i,e)=>g_(i,"name",{value:e,configurable:!0});const mn="noVoip",ae=w("debugvoip"),__=w("voip");var gn;(function(i){i.Update_ID="peer-update-id"})(gn||(gn={}));class ch{constructor(e){r(this,"id");this.id=e}}pn(ch,"PeerModel");var hh;(function(i){i[i.None=0]="None",i[i.Errors=1]="Errors",i[i.ErrorsAndWarnings=2]="ErrorsAndWarnings",i[i.All=3]="All"})(hh||(hh={}));class dh{constructor(e,t,s,n){r(this,"peer");r(this,"voip");r(this,"userId");r(this,"peerId");r(this,"call",null);r(this,"callErrorListener",null);r(this,"stream",null);this.voip=e,this.peer=t,this.userId=s,this.peerId=n}close(){var e;ae&&console.log("close voip call"),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.open&&this.call.close(),(e=this.stream)==null||e.getTracks().forEach(function(t){t.stop()})}updateMute(e){var s;if(!this.stream)return;const t=(s=this.stream)==null?void 0:s.getAudioTracks();for(const n of t)n.enabled=!e}async startVoipCall(){if(!await bt.HasMicrophonePermissions()){console.warn("no permission to use microphone, can not start call");return}ae&&console.log("start voip call"),this.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.updateMute(this.voip.muteOutput),ae&&console.log(this.stream),this.call=this.peer.call(this.peerId,this.stream,{metadata:{userId:this.userId}}),this.call.on("error",t=>{console.error(t)}),this.call.on("stream",t=>{ae&&console.log("received stream from remote again",t)}),this.peer.on("close",this.onCallClose.bind(this)),this.callErrorListener=t=>{var s;t.message.includes(this.peerId)?(console.log("Could not connect to "+this.peerId),this.callErrorListener&&this.peer.off("error",this.callErrorListener),this.call&&this.call.close(),(s=this.stream)==null||s.getTracks().forEach(function(n){n.stop()}),this.stream=null):console.error(t)},this.peer.on("error",this.callErrorListener)}onCallClose(e){ae&&console.log("call closed",e)}}pn(dh,"PeerConnection");class uh{constructor(e,t,s){r(this,"voip");r(this,"call");r(this,"audio",null);r(this,"stream",null);r(this,"obj");r(this,"analyzer",null);r(this,"waitingForStart",!1);r(this,"closed",!1);r(this,"audioElement",null);this.voip=e,this.obj=t,this.call=s}get currentStream(){return this.stream}get currentAudio(){return this.audio}get currentAnalyzer(){return this.analyzer}openAudioStream(e){const t=e.getAudioTracks();for(const s of t)if(s.kind==="audio"&&s.readyState==="live"){this.open(s);return}console.warn("failed finding valid audio stream to begin call")}open(e){console.assert(e.kind==="audio","invalid track kind, expected audio but received "+e.kind),!this.waitingForStart&&(this.waitingForStart=!0,re.userInteractionRegistered||ae&&console.log("Incoming call, waiting for user interaction before opening audio"),re.registerWaitForAllowAudio(async()=>{if(this.call.open&&!this.closed){ae&&console.log("Setup audio and begin listening"),this.stream=new MediaStream([e]);const t=new Za;this.audio=new el(t),this.audio.setVolume(this.voip.muteInput?0:1),this.audio.setMediaStreamSource(this.stream);const s=document.createElement("audio");this.audioElement=s,s.style.display="none",document.body.appendChild(s),s.srcObject=this.stream,s.sinkId!==void 0&&navigator.mediaDevices.enumerateDevices().then(n=>{if(!!s){console.log(n);for(const o of n)if(o.label==="Speakerphone"){s.sinkId=o.deviceId;break}}}),ae&&console.log("call is setup, you should hear something now"),this.analyzer=new cp(this.audio,32)}}))}close(){var e,t,s;this.closed=!0,((e=this.call)==null?void 0:e.open)&&this.call.close(),(t=this.audio)==null||t.disconnect(),(s=this.stream)==null||s.getTracks().forEach(n=>{n.stop()}),this.stream=null,this.audioElement&&this.audioElement.remove()}}pn(uh,"AudioConnection");class bt extends v{constructor(){super(...arguments);r(this,"requireParam",!1);r(this,"peer",null);r(this,"model",null);r(this,"connections",{});r(this,"currentIncomingCalls",{});r(this,"_inputMuted",!1);r(this,"_outputMuted",!1)}set muteInput(e){var s;if(e===this._inputMuted||(this._inputMuted=e,!this.currentIncomingCalls))return;const t=this._inputMuted?0:1;for(const n in this.currentIncomingCalls){const o=this.currentIncomingCalls[n];(s=o==null?void 0:o.currentAudio)==null||s.setVolume(t)}}get muteInput(){return this._inputMuted}set muteOutput(e){if(e!==this._outputMuted&&(this._outputMuted=e,!!this.connections))for(const t in this.connections){const s=this.connections[t];s==null||s.updateMute(e)}}get muteOutput(){return this._outputMuted}getFrequency(e){if(e===null){for(const s in this.currentIncomingCalls){const n=this.currentIncomingCalls[s];if(n&&n.currentAnalyzer)return n.currentAnalyzer.getAverageFrequency()}return null}const t=this.currentIncomingCalls[e];return t&&t.currentAnalyzer?t.currentAnalyzer.getAverageFrequency():null}awake(){if(w(mn)){console.log("VOIP is disabled by url parameter: "+mn);return}if(this.requireParam&&!__){console.debug("VOIP must be enabled explicitly by url parameter");return}this.peer=new Rr,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,this.context.connection.beginListen(W.JoinedRoom,e=>{navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}),this.context.connection.beginListen(gn.Update_ID,e=>{if(e.id!==this.context.connection.connectionId){const t=this.connections[e.id];if(t&&t.close(),this.peer&&this.context.connection.connectionId){const s=new dh(this,this.peer,this.context.connection.connectionId,e.peerId);this.connections[e.id]=s,s.startVoipCall()}}}),this.context.connection.beginListen(W.UserLeftRoom,e=>{const{userId:t}=e,s=this.connections[t];this.connections[t]=null,s&&s.close();const n=this.currentIncomingCalls[t];ae&&console.log("UserLeftRoom",e,t,n),n&&(n.close(),this.currentIncomingCalls[t]=null)}),this.peer.on("open",this.onOpenPeerConnection.bind(this))}onEnable(){}onDisable(){console.log("TODO: close all");for(const e in this.currentIncomingCalls){const t=this.currentIncomingCalls[e];t==null||t.close();const s=this.connections[e];s==null||s.close()}}async onOpenPeerConnection(e){ae&&console.log("Peer connection established and received id"),this.model=new ch(e),this.context.connection.send(gn.Update_ID,this.model,Fi.OnRoomJoin),this.peer&&(this.peer.on("call",this.onReceiveCall.bind(this)),this.peer.on("connection",function(t){ae&&console.log("CONNECTION",t),t.on("data",function(s){ae&&console.log("Received",s)})}))}async onReceiveCall(e){const{metadata:t}=e;console.assert(t.userId);const{userId:s}=t,n=this.currentIncomingCalls[s];if(n&&n.close(),ae&&console.log("received call"),await bt.HasMicrophonePermissions()){const o=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});e.answer(o)}else e.answer(null);this.currentIncomingCalls[s]=new uh(this,this.gameObject,e),e.on("stream",o=>{var a;ae&&console.log("receive caller stream, will setup audio now"),(a=this.currentIncomingCalls[s])==null||a.openAudioStream(o)}),e.on("error",console.error)}static async HasMicrophonePermissions(){return(await navigator.permissions.query({name:"microphone"})).state!=="denied"}}pn(bt,"Voip");var b_=Object.defineProperty,fh=(i,e)=>b_(i,"name",{value:e,configurable:!0});const oi=w("debugflags");var Q;(function(i){i[i.Never=0]="Never",i[i.Browser=1]="Browser",i[i.AR=2]="AR",i[i.VR=4]="VR",i[i.FirstPerson=8]="FirstPerson",i[i.ThirdPerson=16]="ThirdPerson"})(Q||(Q={}));const Ba=class{constructor(){r(this,"Mask",1|16)}Has(e){const t=this.Mask&e;return oi&&console.log("HAS",e,this.Mask,"Result="+t),t!==0}Set(e){this.Mask=e,K.Apply()}Enable(e){this.Mask|=e,K.Apply()}Disable(e){this.Mask&=~e,K.Apply()}Toggle(e){this.Mask^=e,K.Apply()}EnableAll(){this.Mask=4294967295|0,K.Apply()}DisableAll(){this.Mask=0,K.Apply()}};let Ke=Ba;r(Ke,"Global",new Ba);fh(Ke,"XRState");const Ge=class extends v{constructor(){super(...arguments);r(this,"visibleIn")}static Apply(){for(const e of this.registry)e.UpdateVisible(Ke.Global)}awake(){Ge.registry.push(this)}onEnable(){Ge.firstApply||(Ge.firstApply=!0,Ge.Apply())}onDestroy(){const e=Ge.registry.indexOf(this);e>=0&&Ge.registry.splice(e,1)}get isOn(){return this.gameObject.visible}UpdateVisible(e=null){if(!this.enabled)return;let t;const s=e;s&&typeof s=="number"&&(console.assert(typeof s=="number","XRFlag.UpdateVisible: state must be a number",s),oi&&console.log(s),Ge.buffer.Mask=s,e=Ge.buffer);const n=e;if(n?(oi&&console.log("use passed in mask"),t=n.Has(this.visibleIn)):(oi&&console.log("use global mask"),Ke.Global.Has(this.visibleIn)),t!==void 0)if(t)oi&&console.trace("is visible",this.name,this.gameObject.uuid),p.setActive(this.gameObject,!0);else{if(oi&&console.trace("is not visible",this.name,this.gameObject.uuid),!this.gameObject.visible)return;this.gameObject.visible=!1}}};let K=Ge;r(K,"registry",[]),r(K,"firstApply"),r(K,"buffer",new Ke);fh(K,"XRFlag");var y_=Object.defineProperty,ph=(i,e)=>y_(i,"name",{value:e,configurable:!0});const yt=w("debugavatar"),ot=class extends v{constructor(){super(...arguments);r(this,"connectionId");r(this,"avatar")}static onAvatarMarkerCreated(e){return ot._onNewAvatarMarkerAdded.push(e),e}static onAvatarMarkerDestroyed(e){return ot._onAvatarMarkerDestroyed.push(e),e}awake(){ot.instances.push(this),yt&&console.log(this);for(const e of ot._onNewAvatarMarkerAdded)e({avatarMarker:this,gameObject:this.gameObject})}onDestroy(){ot.instances.splice(ot.instances.indexOf(this),1);for(const e of ot._onAvatarMarkerDestroyed)e({avatarMarker:this,gameObject:this.gameObject})}isLocalAvatar(){return this.connectionId===this.context.connection.connectionId}setVisible(e){this.avatar&&("setVisible"in this.avatar?this.avatar.setVisible(e):p.setActive(this.avatar,e))}};let ee=ot;r(ee,"instances",[]),r(ee,"_onNewAvatarMarkerAdded",[]),r(ee,"_onAvatarMarkerDestroyed",[]);ph(ee,"AvatarMarker");const xs=class{constructor(e,t,s){r(this,"_isVisible",!0);r(this,"guid");r(this,"root",null);r(this,"head",null);r(this,"handLeft",null);r(this,"handRight",null);r(this,"lastUpdate",-1);r(this,"isLocalAvatar",!1);r(this,"flags",null);r(this,"headScale",new y(1,1,1));r(this,"handLeftScale",new y(1,1,1));r(this,"handRightScale",new y(1,1,1));r(this,"webxr");r(this,"lastAvatarId",null);r(this,"hasAvatarOverride",!1);r(this,"context");r(this,"avatarMarker",null);r(this,"_headTarget",new S);r(this,"_handLeftTarget",new S);r(this,"_handRightTarget",new S);r(this,"_canInterpolate",!1);this.context=e,this.guid=t,this.webxr=s,this.setupCustomAvatar(this.webxr.defaultAvatar)}setVisible(e){this._isVisible=e,this.updateVisibility()}updateFlags(){if(!this.flags)return;let e=this.isLocalAvatar?Q.FirstPerson:Q.ThirdPerson;for(const t of this.flags)t.gameObject.visible=!0,t.UpdateVisible(e)}async setAvatarOverride(e){return this.hasAvatarOverride=e!==null,this.hasAvatarOverride&&this.lastAvatarId!==e&&(this.lastAvatarId=e,e!=null&&e.length>0)?await this.setupCustomAvatar(e):null}tryUpdate(e,t){if(e.guid===this.guid&&(this.lastAvatarId!==e.avatarId&&e.avatarId&&e.avatarId.length>0&&(this.lastAvatarId=e.avatarId,this.setupCustomAvatar(e.avatarId)),this.lastUpdate=e.time,this.head)){this._canInterpolate=!0;const s=this.isLocalAvatar?this.head:this._headTarget;if(s.position.set(e.position.x,e.position.y,e.position.z),s.quaternion.set(e.rotation.x,e.rotation.y,e.rotation.z,e.rotation.w),s.scale.set(e.scale,e.scale,e.scale),s.scale.multiply(this.headScale),this.handLeft){const n=this.isLocalAvatar?this.handLeft:this._handLeftTarget;n.position.set(e.posLeftHand.x,e.posLeftHand.y,e.posLeftHand.z),n.quaternion.set(e.rotLeftHand._x,e.rotLeftHand._y,e.rotLeftHand._z,e.rotLeftHand._w),n.quaternion.multiply(xs.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handLeftScale)}if(this.handRight){const n=this.isLocalAvatar?this.handRight:this._handRightTarget;n.position.set(e.posRightHand.x,e.posRightHand.y,e.posRightHand.z),n.quaternion.set(e.rotRightHand._x,e.rotRightHand._y,e.rotRightHand._z,e.rotRightHand._w),n.quaternion.multiply(xs.invertRotation),n.scale.set(e.scale,e.scale,e.scale),n.scale.multiply(this.handRightScale)}}}update(){if(this.isLocalAvatar||!this._canInterpolate)return;const e=this.context.time.deltaTime/.1;this.head&&(this.head.position.lerp(this._headTarget.position,e),this.head.quaternion.slerp(this._headTarget.quaternion,e),this.head.scale.lerp(this._headTarget.scale,e)),this.handLeft&&this._handLeftTarget&&(this.handLeft.position.lerp(this._handLeftTarget.position,e),this.handLeft.quaternion.slerp(this._handLeftTarget.quaternion,e),this.handLeft.scale.lerp(this._handLeftTarget.scale,e)),this.handRight&&this._handRightTarget&&(this.handRight.position.lerp(this._handRightTarget.position,e),this.handRight.quaternion.slerp(this._handRightTarget.quaternion,e),this.handRight.scale.lerp(this._handRightTarget.scale,e))}destroy(){var e,t;yt&&console.log("Destroy avatar",this.guid),(e=this.root)==null||e.removeFromParent(),(t=this.avatarMarker)==null||t.destroy(),this.lastAvatarId=null,this.head&&le.Remove(this.context,this.head)}updateVisibility(){const e=this.root;e&&p.setActive(e,this._isVisible)}async setupCustomAvatar(e){var n,o,a,l,c;if(yt&&console.log("LOAD",e,this),!e||typeof e=="string"&&e.length<=0)return!1;this.head&&le.Remove(this.context,this.head);const t=e;if((t==null?void 0:t.loadAssetAsync)!==void 0){await t.loadAssetAsync();const h=t.asset;p.setActive(h,!1),e=p.instantiate(h),p.setActive(e,!0)}yt&&console.log(e);const s=await xs.loader.getOrCreateNewAvatarInstance(this.context,e);if(yt&&console.log(s,s==null?void 0:s.isValid,this.lastAvatarId,e),s==null?void 0:s.isValid){if(this.root=s.root,this.avatarMarker=p.addNewComponent(this.root,ee),this.avatarMarker.connectionId=this.guid,this.avatarMarker.avatar=this,this.head&&this.head!==s.head&&((n=this.head)==null||n.removeFromParent()),this.head=s.head,this.headScale.copy(this.head.scale),this.head&&!this.isLocalAvatar&&le.Add(this.context,this.head,this.avatarMarker),s.leftHand&&((o=this.handLeft)==null||o.removeFromParent()),this.handLeft=(a=s.leftHand)!=null?a:this.handLeft,this.handLeft?this.handLeftScale.copy(this.handLeft.scale):this.handLeftScale.set(1,1,1),s.rigthHand&&((l=this.handRight)==null||l.removeFromParent()),this.handRight=(c=s.rigthHand)!=null?c:this.handRight,this.handRight?this.handRightScale.copy(this.handRight.scale):this.handRightScale.set(1,1,1),this.context.scene.add(this.root),this.flags==null&&(this.flags=[]),this.flags.length=0,this.flags.push(...p.getComponentsInChildren(this.root,K)),this.flags.length<=0&&this.head){const h=p.addNewComponent(this.head,K);h.visibleIn=Q.ThirdPerson|Q.VR,this.flags.push(h),yt&&console.log("Added flag to head: "+h.visibleIn,this.head.name)}return yt&&console.log("[Avatar], is Local? ",this.isLocalAvatar,this.root),this.updateFlags(),this.updateVisibility(),!0}else return yt&&console.warn("build avatar failed"),!1}};let vt=xs;r(vt,"loader",new dn),r(vt,"invertRotation",new O().setFromAxisAngle(new y(0,1,0),Math.PI));ph(vt,"WebXRAvatar");var v_=Object.defineProperty,Ro=(i,e)=>v_(i,"name",{value:e,configurable:!0});class le{static Add(e,t,s=null){if(!!t){for(const n of this.Pois)if(n.obj===t)return;this.Pois.push({obj:t,avatar:s}),this.LastChangeTime=e.time.time}}static Remove(e,t){var s,n;if(!!t){for(const o of this.Pois)if(o.obj===t){this.Pois.splice(this.Pois.indexOf(o),1),this.LastChangeTime=(n=e==null?void 0:e.time.time)!=null?n:(s=E.Current)==null?void 0:s.time.time;return}}}}r(le,"Pois",[]),r(le,"LastChangeTime",0);Ro(le,"Avatar_POI");var _n;(function(i){i.TargetChanged="avatar-look-target-changed"})(_n||(_n={}));class mh{constructor(){r(this,"guid");r(this,"position",new y)}}Ro(mh,"TargetModel");class bn extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"avatar",null);r(this,"_model",null);r(this,"_targetModel",new mh);r(this,"_currentTargetObject",null);r(this,"_lastUpdateTime",0);r(this,"_lookDuration",0);r(this,"_lastPoiChangedTime",0)}set controlledTarget(e){this.target=e;const t=m.get("MoveRandom");if(t&&this.target){const s=p.getComponent(this.target,t);s&&s.destroy()}}awake(){if(this.avatar=p.getComponentInParent(this.gameObject,ee),this.avatar){const e=p.getComponentInParent(this.gameObject,ee);this._model=new Qs(this.context.connection,this.guid),(e==null?void 0:e.isLocalAvatar)&&this._model.requestOwnership()}this.context.connection.beginListen(_n.TargetChanged,e=>{var t;this.target&&e&&e.guid===((t=this.avatar)==null?void 0:t.guid)&&D(this.target,e.position)})}update(){var t;if((!this.context.connection.isConnected||((t=this._model)==null?void 0:t.hasOwnership))&&(le.LastChangeTime!==this._lastPoiChangedTime&&(this._lastPoiChangedTime=le.LastChangeTime,this._lookDuration=0),this.selectTarget(),this._currentTargetObject&&this.context.time.frameCount%10==0&&this.target)){const s=C(this._currentTargetObject);D(this.target,s),this.context.connection.isConnected&&this.avatar&&(this.context.connection.send(_n.TargetChanged,this._targetModel),this._targetModel.guid=this.avatar.guid,this._targetModel.position.copy(s))}}selectTarget(){if(this.context.time.time-this._lastUpdateTime>this._lookDuration){this._lastUpdateTime=this.context.time.time,this._lookDuration=Math.random()*.5+.2;const t=le.Pois;if(t.length>0){const s=t[Math.floor(Math.random()*t.length)];if(s&&s.obj){if(s.avatar&&s.avatar===this.avatar)return;this._currentTargetObject=s.obj}}}}}Ro(bn,"Avatar_Brain_LookAt");var w_=Object.defineProperty,yn=(i,e)=>w_(i,"name",{value:e,configurable:!0}),vn;(function(i){i[i.PhysicalDevice=0]="PhysicalDevice",i[i.Touch=1]="Touch"})(vn||(vn={}));var me;(function(i){i.SelectStart="select-start",i.SelectEnd="select-end",i.Update="update"})(me||(me={}));class Eo extends v{}yn(Eo,"TeleportTarget");const G=class extends v{constructor(){super(...arguments);r(this,"webXR");r(this,"index",-1);r(this,"controllerModel");r(this,"controller");r(this,"controllerGrip");r(this,"hand");r(this,"handPointerModel");r(this,"grabbed",null);r(this,"input",null);r(this,"type",0);r(this,"_wristQuaternion",null);r(this,"movementVector",new y);r(this,"worldRot",new O);r(this,"joystick",new V);r(this,"didRotate",!1);r(this,"didTeleport",!1);r(this,"didChangeScale",!1);r(this,"lastHit",null);r(this,"raycastLine",null);r(this,"_raycastHitPoint",null);r(this,"_connnectedCallback",null);r(this,"_disconnectedCallback",null);r(this,"_selectStartEvt",null);r(this,"_selectEndEvt",null);r(this,"_selectionPressed",!1);r(this,"_selectionPressedLastFrame",!1);r(this,"_selectionStartTime",0);r(this,"_selectionEndTime",0);r(this,"_useSmoothing",!0);r(this,"_isConnected",!1);r(this,"rayRotation",new O);r(this,"_pinchStartTime");r(this,"selectStartCallback",null);r(this,"lastSelectStartObject",null);r(this,"_didNotEndSelection",!1)}static CreateRaycastLine(){const e=new tl(this.geometry),t=e.material;return t.color=this.raycastColor,e.layers.set(1),e.name="line",e.scale.z=1,e}static CreateRaycastHitPoint(){const e=new il(.5,22,22),t=new Ai({color:this.raycastColor}),s=new kt(e,t);return s.visible=!1,s.layers.set(1),s}static Create(e,t,s,n){const o=s?p.addNewComponent(s,G,!1):new G;o.webXR=e,o.index=t,o.type=n;const a=e.context;return o.controller=a.renderer.xr.getController(t),o.controllerGrip=a.renderer.xr.getControllerGrip(t),o.controllerModel=this.Factory.createControllerModel(o.controller),o.controllerGrip.add(o.controllerModel),o.hand=a.renderer.xr.getHand(t),o.hand.add(new dp(o.hand)),o.hand.traverse(l=>l.layers.set(2)),o.handPointerModel=new up(o.hand,o.controller),o.controller.addEventListener("connected",l=>{o.setControllerLayers(o.controllerModel,2),o.setControllerLayers(o.controllerGrip,2),setTimeout(()=>{o.setControllerLayers(o.controllerGrip,2)},1e3)}),o.hand.addEventListener("connected",l=>{var h;if(l.data.hand){e.Rig&&e.Rig.add(o.hand),o.type=0,o.handPointerModel.traverse(u=>u.layers.set(2)),(h=o.handPointerModel.pointerObject)==null||h.traverse(u=>u.layers.set(2));const d=o.hand.joints;if(d)for(const u of Object.keys(d)){const g=d[u];g.parent||o.hand.add(g)}}}),o}static addEventListener(e,t){var n;const s=(n=this.eventSubs[e])!=null?n:[];s.push(t),this.eventSubs[e]=s}get isUsingHands(){var t;const e=(t=this.input)==null?void 0:t.hand;return e!=null}get wrist(){if(!this.hand)return null;const e=this.hand.joints;return e?e.wrist:null}getWristQuaternion(){const e=this.wrist;return e?(this._wristQuaternion||(this._wristQuaternion=new O),J(e).multiply(this._wristQuaternion.setFromEuler(new Pe(-Math.PI/4,0,0)))):null}get selectionDown(){return this._selectionPressed&&!this._selectionPressedLastFrame}get selectionUp(){return!this._selectionPressed&&this._selectionPressedLastFrame}get selectionPressed(){return this._selectionPressed}get selectionClick(){return this._selectionEndTime-this._selectionStartTime<.3}get raycastHitPoint(){return this._raycastHitPoint}get useSmoothing(){return this._useSmoothing}awake(){if(!this.controller){console.warn("Missing Controller!!!",this);return}this._connnectedCallback=this.onSourceConnected.bind(this),this._disconnectedCallback=this.onSourceDisconnected.bind(this),this._selectStartEvt=this.onSelectStart.bind(this),this._selectEndEvt=this.onSelectEnd.bind(this),this.type===1&&(this.controllerGrip.addEventListener("connected",this._connnectedCallback),this.controllerGrip.addEventListener("disconnected",this._disconnectedCallback),this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.addEventListener("selectstart",this._selectStartEvt),this.controller.addEventListener("selectend",this._selectEndEvt))}onDestroy(){var e,t,s;this.type===1&&(this.controllerGrip.removeEventListener("connected",this._connnectedCallback),this.controllerGrip.removeEventListener("disconnected",this._disconnectedCallback),this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),this.type===0&&(this.controller.removeEventListener("selectstart",this._selectStartEvt),this.controller.removeEventListener("selectend",this._selectEndEvt)),(e=this.hand)==null||e.clear(),(t=this.controllerGrip)==null||t.clear(),(s=this.controller)==null||s.clear()}onEnable(){var e,t,s,n,o;this.hand&&(this.hand.name="Hand"),this.controllerGrip&&(this.controllerGrip.name="ControllerGrip"),this.controller&&(this.controller.name="Controller"),this.raycastLine&&(this.raycastLine.name="RaycastLine;"),this.webXR.Controllers.indexOf(this)<0&&this.webXR.Controllers.push(this),this.raycastLine||(this.raycastLine=G.CreateRaycastLine()),this._raycastHitPoint||(this._raycastHitPoint=G.CreateRaycastHitPoint()),(e=this.webXR.Rig)==null||e.add(this.hand),(t=this.webXR.Rig)==null||t.add(this.controllerGrip),(s=this.webXR.Rig)==null||s.add(this.controller),(n=this.webXR.Rig)==null||n.add(this.raycastLine),(o=this.raycastLine)==null||o.add(this._raycastHitPoint),this.hand.add(this.handPointerModel),console.log("ADDED TO RIG",this.webXR.Rig)}onDisable(){var t,s,n,o,a;(t=this.hand)==null||t.removeFromParent(),(s=this.controllerGrip)==null||s.removeFromParent(),(n=this.controller)==null||n.removeFromParent(),(o=this.raycastLine)==null||o.removeFromParent(),(a=this._raycastHitPoint)==null||a.removeFromParent();const e=this.webXR.Controllers.indexOf(this);e>=0&&this.webXR.Controllers.splice(e,1)}onSourceConnected(e){if(this._isConnected){console.warn("Received connected event for controller that is already connected",this.index,e);return}this._isConnected=!0,this.input=e.data,this.type===1&&(this.onSelectStart(),this.createPointerEvent("down"))}onSourceDisconnected(e){if(!this._isConnected){console.warn("Received discnnected event for controller that is not connected",e);return}this._isConnected=!1,this.type===1&&(this.onSelectEnd(),this.createPointerEvent("up")),this.input=null}createPointerEvent(e){switch(e){case"down":this.context.input.createPointerDown({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break;case"move":break;case"up":this.context.input.createPointerUp({pointerId:this.index,clientX:0,clientY:0,button:this.index,pointerType:"touch"});break}}update(){this.context.time.frameCount%60==0&&(this.setControllerLayers(this.controller,2),this.setControllerLayers(this.controllerGrip,2),this.setControllerLayers(this.hand,2));const e=G.eventSubs[me.Update];if(e&&e.length>0)for(const n of e)n(this);let t=1;this.type===0?t=this.context.time.deltaTime/.1:this.isUsingHands&&this.handPointerModel.pinched&&(t=this.context.time.deltaTime/.3),this.rayRotation.slerp(J(this.controller),this.useSmoothing?t:1);const s=C(this.controller);if(this.raycastLine)if(this.type===1)this.raycastLine.visible=!1;else if(this.isUsingHands){this.raycastLine.visible=!this.grabbed,D(this.raycastLine,s);const n=this.hand.joints;if(n&&n.wrist&&this.grabbed&&this.grabbed.isCloseGrab){const a=this.getWristQuaternion();a&&this.rayRotation.copy(a)}Z(this.raycastLine,this.rayRotation)}else this.raycastLine.visible=!0,Z(this.raycastLine,this.rayRotation),D(this.raycastLine,s);this.lastHit=this.updateLastHit(),this.grabbed&&this.grabbed.update(),this._selectionPressedLastFrame=this._selectionPressed,this.selectStartCallback&&this.selectStartCallback()}onUpdate(e){var n,o;if(this.lastHit=null,!e||e.inputSources.length<=this.index){this.input=null;return}if(this.type===0&&(this.input=e.inputSources[this.index]),!this.input)return;const t=this.webXR.Rig;if(!t)return;this._didNotEndSelection&&!this.handPointerModel.pinched&&(this._didNotEndSelection=!1,this.onSelectEnd()),this.updateStick(this.input);const s=(o=(n=this.input)==null?void 0:n.gamepad)==null?void 0:o.buttons;switch(this.input.handedness){case"left":const a=3*G.MovementSpeedFactor,l=2,c=A.clamp01(this.joystick.length()*2),h=this.joystick.x>0?1:-1;let d=Math.pow(this.joystick.x,l);d*=h,d*=c;const u=this.joystick.y>0?1:-1;let g=Math.pow(this.joystick.y,l);g*=u,d*=c,t.getWorldQuaternion(this.worldRot),this.movementVector.set(d,0,g),this.movementVector.applyQuaternion(this.webXR.TransformOrientation),this.movementVector.y=0,this.movementVector.applyQuaternion(this.worldRot),t.position.add(this.movementVector.multiplyScalar(a*this.context.time.deltaTime)),this.isUsingHands&&this.runTeleport(t,s);break;case"right":const b=this.joystick.x,x=Math.abs(b);if(x<.4)this.didRotate=!1;else if(x>.5&&!this.didRotate){const P=b>0?-1:1;t.rotateY(A.toRadians(30*P)),this.didRotate=!0}this.runTeleport(t,s);break}}runTeleport(e,t){var l,c,h;let s=-this.joystick.y;if(((l=this.hand)==null?void 0:l.visible)&&!this.grabbed){const d=this.handPointerModel.isPinched();d&&this._pinchStartTime===void 0&&(this._pinchStartTime=this.context.time.time),d&&this._pinchStartTime&&this.context.time.time-this._pinchStartTime>.8&&(s=this.handPointerModel.isPinched()?1:0),d||(this._pinchStartTime=void 0)}else this._pinchStartTime=void 0;let n=s>.5,o=this.webXR.Rig?((h=(c=this.webXR.Rig)==null?void 0:c.scale)==null?void 0:h.x)<.999:!1,a=null;if(t&&this.input&&!this.input.hand)for(let d=0;d<t.length;d++){const u=t[d];if(d===4)if(u.pressed&&!this.didChangeScale){this.didChangeScale=!0;const g=this.webXR.Rig;if(g)if(o){o=!1,g.scale.set(1,1,1),a=1,G.MovementSpeedFactor=1;const b=this.context.mainCamera;G.PreviousCameraFarDistance&&(b.far=G.PreviousCameraFarDistance)}else{o=!0,n=!0,a=.1,G.MovementSpeedFactor=a*2;const b=this.context.mainCamera;G.PreviousCameraFarDistance=b.far,b.far/=a}}else u.pressed||(this.didChangeScale=!1)}if(n){if(!this.didTeleport){const d=this.raycast();if(this.didTeleport=!0,d&&d.length>0){const u=d[0];if(o||this.isValidTeleportTarget(u.object)){const g=u.point;D(e,g)}}}}else s<.1&&(this.didTeleport=!1);a!==null&&(e.scale.set(a,a,a),e.updateMatrixWorld())}isValidTeleportTarget(e){return p.getComponentInParent(e,Eo)!=null}updateStick(e){var t;!e||!e.gamepad||((t=e.gamepad.axes)==null?void 0:t.length)<4||(this.joystick.x=e.gamepad.axes[2],this.joystick.y=e.gamepad.axes[3])}updateLastHit(){var n,o;const e=this.raycast(),t=e?e[0]:null;this.lastHit=t;let s=1;if(this.webXR.Rig&&(s/=this.webXR.Rig.scale.x),this.raycastLine){this.raycastLine.scale.z=s*((o=(n=this.lastHit)==null?void 0:n.distance)!=null?o:9999);const a=this.raycastLine.material;t!=null?a.color=G.raycastColor:a.color=G.raycastNoHitColor}if(this._raycastHitPoint){if(this.lastHit!=null){this._raycastHitPoint.position.z=-1;const a=A.clamp(this.lastHit.distance*.01*s,.015,.1);this._raycastHitPoint.scale.set(a,a,a)}this._raycastHitPoint.visible=this.lastHit!==null}return t}onSelectStart(){!this.context.connection.allowEditing||(this.selectStartCallback=()=>this.onHandleSelectStart())}onHandleSelectStart(){this.selectStartCallback=null,this._selectionPressed=!0,this._selectionStartTime=this.context.time.time,this._selectionEndTime=1e3;let e=null,t=!1;if(this.isUsingHands?(e=this.overlap(),e.length<=0?(e=this.raycast(),t=!1):t=!0):e=this.raycast(),e&&e.length>0)for(const s of e){const n=s.object;if(!this.testIsVisible(n)){console.log("not visible");continue}this.lastSelectStartObject=n;const o={selected:n,grab:n},a=G.eventSubs[me.SelectStart];if(a&&a.length>0)for(const l of a)l(this,o);o.grab!==n&&console.log("Grabbed object changed","original",n,"new",o.grab),o.grab&&(this.grabbed=Be.TryTake(this,o.grab,s,t));break}else{const s=G.eventSubs[me.SelectStart],n={selected:null,grab:null};if(s&&s.length>0)for(const o of s)o(this,n)}}onSelectEnd(){var s,n;if(this.isUsingHands&&this.handPointerModel.pinched){this._didNotEndSelection=!0;return}if(!this._selectionPressed)return;this.selectStartCallback=null,this._selectionPressed=!1,this._selectionEndTime=this.context.time.time;const e={grab:(n=(s=this.grabbed)==null?void 0:s.selected)!=null?n:this.lastSelectStartObject},t=G.eventSubs[me.SelectEnd];if(t&&t.length>0)for(const o of t)o(this,e);this.grabbed&&(this.grabbed.free(),this.grabbed=null)}testIsVisible(e){return e?p.isActiveInHierarchy(e):!0}setControllerLayers(e,t){var s,n;if(!!e&&(e.layers.set(t),e.children))for(const o of e.children)((s=this.grabbed)==null?void 0:s.selected)===o||((n=this.grabbed)==null?void 0:n.selectedMesh)===o||this.setControllerLayers(o,t)}getRay(){const e=new sl;return e.origin.copy(C(this.controller)),e.direction.set(0,0,-1).applyQuaternion(this.rayRotation),e}overlap(){const e=this.isUsingHands&&this.handPointerModel?this.handPointerModel.pointerObject:this.controllerGrip;if(!e)return new Array;const t=C(e).clone();return this.context.physics.sphereOverlap(t,.02)}raycast(){const e=new Me;return e.layerMask=new Es,e.layerMask.set(0),e.ray=this.getRay(),this.context.physics.raycast(e)}};let F=G;r(F,"Factory",new hp),r(F,"raycastColor",new f(.9,.3,.3)),r(F,"raycastNoHitColor",new f(.6,.6,.6)),r(F,"geometry",new Ts().setFromPoints([new y(0,0,0),new y(0,0,-1)])),r(F,"handModels",{}),r(F,"eventSubs",{}),r(F,"PreviousCameraFarDistance"),r(F,"MovementSpeedFactor",1);yn(F,"WebXRController");var wn;(function(i){i.WillTake="WillTake",i.DidTake="DidTake",i.WillFree="WillFree",i.DidFree="DidFree"})(wn||(wn={}));const te=class{constructor(){r(this,"sync",null);r(this,"selected",null);r(this,"selectedParent",null);r(this,"selectedMesh",null);r(this,"controller",null);r(this,"grabTime",0);r(this,"grabUUID","");r(this,"isCloseGrab",!1);r(this,"originalMaterial",null);r(this,"usageMarker",null);r(this,"rigidbodies",null);r(this,"didReparent",!1);r(this,"grabDistance",0);r(this,"interactable",null);r(this,"positionSource",null);r(this,"grabPoint",new y);r(this,"localPositionOffsetToGrab",null);r(this,"localPositionOffsetToGrab_worldSpace",new y);r(this,"localQuaternionToGrab",new O(0,0,0,1));r(this,"targetDir",null);r(this,"quaternionLerp",null);r(this,"controllerDir",new y);r(this,"controllerWorldPos",new y);r(this,"lastControllerWorldPos",new y);r(this,"controllerPosDelta",new y);r(this,"totalChangeAlongDirection",0);r(this,"rigPositionLastFrame",new y)}static AddEventListener(e,t){return te.Events[e]||(te.Events[e]=[]),te.Events[e].push(t),t}static RemoveEventListener(e,t){if(!t||!te.Events[e])return;const s=te.Events[e].indexOf(t);s>=0&&te.Events[e].splice(s,1)}static Register(e){this.Current.find(t=>t===e)||this.Current.push(e)}static Remove(e){const t=this.Current.indexOf(e);t>=0&&this.Current.splice(t,1)}static TryTake(e,t,s,n){const o=p.getComponentInParent(t,qi);if(!o)return console.warn("Prevented taking object that is not interactable",t),null;let a=t;const l=p.getComponentInParent(t,_t);l&&(l.requestOwnership(),a=l.gameObject);for(const h of this.Current)if(h.selected===a)return h.controller===e||(h.free(),h.Take(e,a,t,l,o,s,n)),h;const c=new te;return c.Take(e,a,t,l,o,s,n),c}Take(e,t,s,n,o,a,l){var b,x;if(console.assert(t!==null,"Expected object to be taken but was",t),e.isUsingHands?this.positionSource=l?e.wrist:e.controller:this.positionSource=e.controller,!this.positionSource)return console.warn("No position source"),this;const c={controller:e,take:t,hit:s,sync:n,interactable:o};(b=te.Events.WillTake)==null||b.forEach(P=>P(this,c));const h=s;(h==null?void 0:h.material)&&(this.originalMaterial=h.material,Array.isArray(h.material)||(h.material=h.material.clone(),h.material&&h.material.emissive&&(h.material.emissive.b=.2))),this.selected=t,this.selectedParent||(this.selectedParent=t.parent),this.selectedMesh=h,this.controller=e,this.interactable=o,this.isCloseGrab=l,this.didReparent=!1,this.sync=n,this.grabTime=e.context.time.time,this.grabUUID=Date.now().toString(),this.usageMarker=p.addNewComponent(this.selected,Xi),this.rigidbodies=p.getComponentsInChildren(this.selected,Ee),C(this.positionSource,this.lastControllerWorldPos);const d=yn(()=>l?this.lastControllerWorldPos.clone():a.point.clone(),"getGrabPoint");this.grabDistance=d().distanceTo(this.lastControllerWorldPos),this.totalChangeAlongDirection=0,this.localPositionOffsetToGrab=this.selected.worldToLocal(d());const u=e.isUsingHands&&l?this.controller.getWristQuaternion().clone():e.rayRotation.clone();J(this.selected,this.localQuaternionToGrab).premultiply(u.invert());const g=this.controller.webXR.Rig;return g&&this.rigPositionLastFrame.copy(C(g)),le.Add(e.context,this.selected),te.Register(this),this.sync&&(this.sync.fastMode=!0),(x=te.Events.DidTake)==null||x.forEach(P=>P(this,c)),this}free(){var n,o,a,l;if(!this.selected)return;const e={controller:this.controller,take:this.selected,hit:this.selected,sync:this.sync,interactable:null};(n=te.Events.WillFree)==null||n.forEach(c=>c(this,e)),le.Remove(this.controller.context,this.selected),te.Remove(this),this.sync&&(this.sync.fastMode=!1);const t=this.selectedMesh;t&&this.originalMaterial&&t.material&&(t.material=this.originalMaterial);const s=this.selected;if(this.didReparent&&s.parent){const c=this.selectedParent;c?c.attach(s):(o=this.controller)==null||o.context.scene.attach(s)}if((a=this.usageMarker)==null||a.destroy(),this.controller&&(this.controller.grabbed=null),this.selected=null,this.selectedParent=null,this.selectedMesh=null,this.sync=null,this.rigidbodies)for(const c of this.rigidbodies)c.wakeUp(),!!c.smoothedVelocity&&c.setVelocity(c.smoothedVelocity.x,c.smoothedVelocity.y,c.smoothedVelocity.z);this.rigidbodies=null,this.localPositionOffsetToGrab=null,this.quaternionLerp=null,(l=te.Events.DidFree)==null||l.forEach(c=>c(this,e))}controllerMovementSinceLastFrame(){if(!this.positionSource||!this.controller)return 0;this.controllerDir.set(0,0,-1),this.controllerDir.applyQuaternion(this.controller.rayRotation),C(this.positionSource,this.controllerWorldPos),this.controllerPosDelta.copy(this.controllerWorldPos),this.controllerPosDelta.sub(this.lastControllerWorldPos),this.lastControllerWorldPos.copy(this.controllerWorldPos);const e=this.controller.webXR.Rig;if(e){const s=C(e),n=this.rigPositionLastFrame.sub(s);this.controllerPosDelta.add(n),this.rigPositionLastFrame.copy(s)}return this.controllerDir.dot(this.controllerPosDelta)}update(){var e,t;if(this.sync&&this.controller&&this.controller.context.connection.isInRoom&&this.controller.context.time.time-this.grabTime>3&&this.sync.hasOwnership()===!1&&(console.log("no ownership, will leave",this.sync.guid),this.free()),!(this.interactable&&!this.interactable.canGrab)){if(!this.didReparent&&this.selected&&this.controller){const s=(t=(e=this.controller.webXR.Rig)==null?void 0:e.scale.x)!=null?t:1;this.totalChangeAlongDirection+=this.controllerMovementSinceLastFrame();let n=1;this.controller.type===0&&(n=Math.max(0,1+this.totalChangeAlongDirection*2/s),n=n*n*n),this.grabDistance/s<.8&&(n=1),this.targetDir||(this.targetDir=new y),this.targetDir.set(0,0,-this.grabDistance*n);const o=this.targetDir.applyQuaternion(this.controller.rayRotation).add(this.controllerWorldPos),a=this.controller.rayRotation.clone().multiplyQuaternions(this.controller.rayRotation,this.localQuaternionToGrab);this.quaternionLerp||(this.quaternionLerp=a.clone()),this.quaternionLerp.slerp(a,this.controller.useSmoothing?this.controller.context.time.deltaTime/.03:1),Z(this.selected,this.quaternionLerp),this.selected.updateWorldMatrix(!1,!1),this.grabPoint.copy(o),this.localPositionOffsetToGrab&&(this.localPositionOffsetToGrab_worldSpace.copy(this.localPositionOffsetToGrab),this.selected.localToWorld(this.localPositionOffsetToGrab_worldSpace).sub(C(this.selected)),o.sub(this.localPositionOffsetToGrab_worldSpace)),D(this.selected,o)}if(this.rigidbodies!=null)for(const s of this.rigidbodies)s.wakeUp(),s.setBodyFromGameObject({x:0,y:0,z:0});de.markDirty(this.selected,!0)}}};let Be=te;r(Be,"Events",{}),r(Be,"Current",[]);yn(Be,"AttachedObject");var gh=Object.defineProperty,x_=Object.getOwnPropertyDescriptor,P_=(i,e)=>gh(i,"name",{value:e,configurable:!0}),O_=(i,e,t,s)=>{for(var n=s>1?void 0:s?x_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&gh(e,t,n),n};class xn extends v{constructor(){super(...arguments);r(this,"webAR",null);r(this,"invertForward",!1);r(this,"_arScale",5);r(this,"_rig",null);r(this,"_startPose",null);r(this,"_placementPose",null);r(this,"_isTouching",!1)}get arScale(){return this._arScale}set arScale(e){e!==this._arScale&&(this._arScale=e,this.setScale(e))}onBegin(e){this._placementPose=null,this.gameObject.visible=!1,this.gameObject.matrixAutoUpdate=!1,this._startPose=this.gameObject.matrix.clone(),e.addEventListener("selectstart",this.onSelectStart.bind(this)),e.addEventListener("selectend",this.onSelectEnd.bind(this)),setTimeout(()=>this.gameObject.visible=!1,1e3)}onUpdate(e,t,s){if(s&&!this._placementPose&&this._isTouching){if(this.webAR&&this.webAR.setReticleActive(!1),this._placementPose=new Oe().fromArray(s.transform.matrix).invert(),e){if(this.invertForward){const n=new Oe().makeRotationY(Math.PI);this._placementPose.premultiply(n)}this._rig=e,this.setScale(this.arScale)}else this._rig=null;this.gameObject.visible=!0}}onEnd(e,t){this._placementPose=null,this.gameObject.visible=!1,this._startPose&&this.gameObject.matrix.copy(this._startPose),this.gameObject.matrixAutoUpdate=!0,e&&(e.matrixAutoUpdate=!0),de.markDirty(this.gameObject,!0),setTimeout(()=>this.gameObject.visible=!0,100)}onSelectStart(){this._isTouching=!0}onSelectEnd(){this._isTouching=!1}setScale(e){const t=this._rig;!t||!this._placementPose||(t.matrixAutoUpdate=!1,t.matrix.multiplyMatrices(new Oe().makeScale(e,e,e),this._placementPose),t.matrix.decompose(t.position,t.quaternion,t.scale),t.updateMatrixWorld())}}P_(xn,"WebARSessionRoot");O_([_()],xn.prototype,"arScale",1);var C_=Object.defineProperty,S_=(i,e)=>C_(i,"name",{value:e,configurable:!0});class Ao extends v{awake(){}}S_(Ao,"XRRig");var R_=Object.defineProperty,To=(i,e)=>R_(i,"name",{value:e,configurable:!0});const ai=w("debugaddressables");class _h{constructor(e){r(this,"_context");r(this,"_assetReferences",{});this._context=e,this._context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){}findAssetReference(e){return this._assetReferences[e]||null}registerAssetReference(e){!e.uri||(this._assetReferences[e.uri]?console.warn("Asset reference already registered",e):this._assetReferences[e.uri]=e)}}To(_h,"Addressables");class Ue{constructor(e){r(this,"_loading");r(this,"_asset");r(this,"_glbRoot");r(this,"_uri");r(this,"_progressListeners",[]);r(this,"_isLoadingRawBinary",!1);r(this,"_rawBinary");this._uri=e,Ql(this._uri,this.onResolvePrefab.bind(this))}static getOrCreate(e,t){const s=t.addressables,n=s.findAssetReference(e);if(n)return n;const o=new Ue(e);return s.registerAssetReference(o),o}get asset(){var e;return(e=this._glbRoot)!=null?e:this._asset}set asset(e){this._asset=e}get uri(){return this._uri}get rawAsset(){return this._asset}async onResolvePrefab(e){return e===this.uri&&(this.mustLoad&&await this.loadAssetAsync(),this.asset)?this.asset:null}get mustLoad(){return!this.asset||this.asset.__destroyed===!0}isLoaded(){return this._rawBinary||this.asset!==void 0}unload(){this.asset&&(ai&&console.log("Unload",this.asset),this.asset.scene?p.destroy(this.asset.scene):p.destroy(this.asset)),this.asset=null}async preload(){var t;if(!this.mustLoad||this._isLoadingRawBinary)return null;if(this._rawBinary!==void 0)return this._rawBinary;this._isLoadingRawBinary=!0,ai&&console.log("Preload",this.uri);const e=await Qc(this.uri,s=>{this.raiseProgressEvent(s)});return this._rawBinary=(t=e==null?void 0:e.buffer)!=null?t:null,this._isLoadingRawBinary=!1,this._rawBinary}async loadAssetAsync(e){if(!this.mustLoad)return;if(e&&this._progressListeners.push(e),this._loading!==void 0)return this._loading;const t=E.Current;this._rawBinary?(this._loading=ys(t,this._rawBinary,this.uri,null),this.raiseProgressEvent(new ProgressEvent("progress",{loaded:this._rawBinary.byteLength,total:this._rawBinary.byteLength}))):(ai&&console.log("Load async",this.uri),this._loading=xi(t,this.uri,null,!0,n=>{this.raiseProgressEvent(n)}));const s=await this._loading;if(this._progressListeners.length=0,this._glbRoot=this.tryGetActualGameObjectRoot(s),this._loading=void 0,s)return ei(t),s.scene!==void 0&&(this.asset=s),this.asset}async instantiate(e){return this.onInstantiate(e,!1)}async instantiateSynced(e,t=!0){return this.onInstantiate(e,!0,t)}beginListenDownload(e){this._progressListeners.indexOf(e)<0&&this._progressListeners.push(e)}endListenDownload(e){const t=this._progressListeners.indexOf(e);t>=0&&this._progressListeners.splice(t,1)}raiseProgressEvent(e){for(const t of this._progressListeners)t(this,e)}async onInstantiate(e,t=!1,s){const n=E.Current;if(e||(e=n.scene),this.mustLoad&&await this.loadAssetAsync(),ai&&console.log("Instantiate",this.uri,"parent:",e),this.asset){ai&&console.log("Add to scene",this.asset);let o=e instanceof Ce?e:null;if(o||(o=new Ce),typeof e=="object"&&(e instanceof S?o.parent=e:Object.assign(o,e)),t){o.context=n;const a=this.asset;a.guid=this.uri;const l=Yr(a,o,void 0,s);if(l)return l}else{const a=p.instantiate(this.asset,o);if(a)return a}}else ai&&console.warn("Failed to load asset",this.uri);return null}tryGetActualGameObjectRoot(e){if(e&&e.scene){const t=e.scene;return t.isGroup&&t.children.length===1&&t.children[0].name+"glb"===t.name?t.children[0]:t}return null}}To(Ue,"AssetReference");class bh extends ni{constructor(){super([Ue])}onSerialize(e,t){if(e&&e.uri!==void 0&&typeof e.uri=="string")return e.uri}onDeserialize(e,t){return typeof e=="string"?t.context?Ue.getOrCreate(e,t.context):(console.error("Missing context"),null):null}}To(bh,"AddressableSerializer");new bh;var E_=Object.defineProperty,A_=(i,e)=>E_(i,"name",{value:e,configurable:!0});class zt{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}x(){return this.bb.readFloat32(this.bb_pos)}y(){return this.bb.readFloat32(this.bb_pos+4)}z(){return this.bb.readFloat32(this.bb_pos+8)}w(){return this.bb.readFloat32(this.bb_pos+12)}static sizeOf(){return 16}static createVec4(e,t,s,n,o){return e.prep(4,16),e.writeFloat32(o),e.writeFloat32(n),e.writeFloat32(s),e.writeFloat32(t),e.offset()}}A_(zt,"Vec4");var T_=Object.defineProperty,k_=(i,e)=>T_(i,"name",{value:e,configurable:!0});class q{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsVrUserStateBuffer(e,t){return(t||new q).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsVrUserStateBuffer(e,t){return e.setPosition(e.position()+Lr),(t||new q).__init(e.readInt32(e.position())+e.position(),e)}guid(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}time(){const e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt64(this.bb_pos+e):this.bb.createLong(0,0)}avatarId(e){const t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}position(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new oe).__init(this.bb_pos+t,this.bb):null}rotation(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new zt).__init(this.bb_pos+t,this.bb):null}scale(){const e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readFloat32(this.bb_pos+e):0}posLeftHand(e){const t=this.bb.__offset(this.bb_pos,16);return t?(e||new oe).__init(this.bb_pos+t,this.bb):null}posRightHand(e){const t=this.bb.__offset(this.bb_pos,18);return t?(e||new oe).__init(this.bb_pos+t,this.bb):null}rotLeftHand(e){const t=this.bb.__offset(this.bb_pos,20);return t?(e||new zt).__init(this.bb_pos+t,this.bb):null}rotRightHand(e){const t=this.bb.__offset(this.bb_pos,22);return t?(e||new zt).__init(this.bb_pos+t,this.bb):null}static startVrUserStateBuffer(e){e.startObject(10)}static addGuid(e,t){e.addFieldOffset(0,t,0)}static addTime(e,t){e.addFieldInt64(1,t,e.createLong(0,0))}static addAvatarId(e,t){e.addFieldOffset(2,t,0)}static addPosition(e,t){e.addFieldStruct(3,t,0)}static addRotation(e,t){e.addFieldStruct(4,t,0)}static addScale(e,t){e.addFieldFloat32(5,t,0)}static addPosLeftHand(e,t){e.addFieldStruct(6,t,0)}static addPosRightHand(e,t){e.addFieldStruct(7,t,0)}static addRotLeftHand(e,t){e.addFieldStruct(8,t,0)}static addRotRightHand(e,t){e.addFieldStruct(9,t,0)}static endVrUserStateBuffer(e){return e.endObject()}static finishVrUserStateBufferBuffer(e,t){e.finish(t)}static finishSizePrefixedVrUserStateBufferBuffer(e,t){e.finish(t,void 0,!0)}}k_(q,"VrUserStateBuffer");var L_=Object.defineProperty,Pn=(i,e)=>L_(i,"name",{value:e,configurable:!0});const yh=w("debugxr"),Qi=w("debugavatar");w("debugavatarvoip");var $t;(function(i){i.WebXR_UserJoined="webxr-user-joined",i.WebXR_UserLeft="webxr-user-left",i.VRSessionStart="vr-session-started",i.VRSessionEnd="vr-session-ended",i.VRSessionUpdate="vr-session-update"})($t||($t={}));var On;(function(i){i.VR="vr",i.AR="ar"})(On||(On={}));const ko="VRUS";qs(ko,q.getRootAsVrUserStateBuffer);function Cn(){return new Date().getTime()}Pn(Cn,"getTimeStampNow");function vh(i){let e=i&4294967295,t=i/Math.pow(2,32)&1048575;return fp.create(e,t)}Pn(vh,"flatbuffers_long_from_number");const Ps=class{constructor(e){r(this,"guid");r(this,"time");r(this,"avatarId");r(this,"position",new y);r(this,"rotation",new j);r(this,"scale",1);r(this,"posLeftHand",new y);r(this,"posRightHand",new y);r(this,"rotLeftHand",new O);r(this,"rotRightHand",new O);this.guid=e}update(e,t,s,n,o){var d,u,g,b,x,P;this.time=Cn(),this.avatarId=o,this.position.set(t.x,t.y,t.z),e&&this.position.applyMatrix4(e.matrixWorld);let a=Ps.quat0;const l=Ps.quat1;a.set(s.x,s.y,s.z,s.w),a=a.multiplyQuaternions(a,Ps.invertRotation),e&&(e.getWorldQuaternion(l),a.multiplyQuaternions(l,a)),this.rotation.set(a.x,a.y,a.z,a.w),this.scale=e.scale.x;const c=(d=n.LeftController)==null?void 0:d.controllerGrip;c&&(c.getWorldPosition(this.posLeftHand),c.getWorldQuaternion(this.rotLeftHand));const h=(u=n.RightController)==null?void 0:u.controllerGrip;if(h&&(h.getWorldPosition(this.posRightHand),h.getWorldQuaternion(this.rotRightHand)),(b=(g=n.LeftController)==null?void 0:g.hand)==null?void 0:b.visible){const R=n.LeftController.wrist;R&&(R.getWorldPosition(this.posLeftHand),R.getWorldQuaternion(this.rotLeftHand))}if((P=(x=n.RightController)==null?void 0:x.hand)==null?void 0:P.visible){const R=n.RightController.wrist;R&&(R.getWorldPosition(this.posRightHand),R.getWorldQuaternion(this.rotRightHand))}}sendAsBuffer(e,t){e.clear();const s=e.createString(this.guid),n=e.createString(this.avatarId);q.startVrUserStateBuffer(e),q.addGuid(e,s),q.addTime(e,vh(this.time)),q.addAvatarId(e,n),q.addPosition(e,oe.createVec3(e,this.position.x,this.position.y,this.position.z)),q.addRotation(e,zt.createVec4(e,this.rotation.x,this.rotation.y,this.rotation.z,this.rotation.w)),q.addScale(e,this.scale),q.addPosLeftHand(e,oe.createVec3(e,this.posLeftHand.x,this.posLeftHand.y,this.posLeftHand.z)),q.addPosRightHand(e,oe.createVec3(e,this.posRightHand.x,this.posRightHand.y,this.posRightHand.z)),q.addRotLeftHand(e,zt.createVec4(e,this.rotLeftHand.x,this.rotLeftHand.y,this.rotLeftHand.z,this.rotLeftHand.w)),q.addRotRightHand(e,zt.createVec4(e,this.rotRightHand.x,this.rotRightHand.y,this.rotRightHand.z,this.rotRightHand.w));const o=q.endVrUserStateBuffer(e);e.finish(o,ko);const a=e.asUint8Array();t.sendBinary(a)}setFromBuffer(e,t){if(!e)return;this.guid=e,this.time=t.time().toFloat64();const s=t.avatarId();s&&(this.avatarId=s);const n=t.position();n&&this.position.set(n.x(),n.y(),n.z());const o=t.rotation();o&&this.rotation.set(o.x(),o.y(),o.z(),o.w());const a=t.posLeftHand();a&&this.posLeftHand.set(a.x(),a.y(),a.z());const l=t.posRightHand();l&&this.posRightHand.set(l.x(),l.y(),l.z());const c=t.rotLeftHand();c&&this.rotLeftHand.set(c.x(),c.y(),c.z(),c.w());const h=t.rotRightHand();h&&this.rotRightHand.set(h.x(),h.y(),h.z(),h.w()),this.scale=t.scale()}};let et=Ps;r(et,"invertRotation",new O().setFromAxisAngle(new y(0,1,0),Math.PI)),r(et,"quat0",new O),r(et,"quat1",new O);Pn(et,"VRUserState");class Sn extends v{constructor(){super(...arguments);r(this,"webXR",null);r(this,"debugAvatarUser",null);r(this,"voip",null);r(this,"tempState",new et(""));r(this,"_removeAvatarsList",[]);r(this,"eventSub_ConnectionEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"eventSub_WebXRUpdateEvent",null);r(this,"avatars",{});r(this,"localAvatar",null);r(this,"k_LocalAvatarNoNetworkingGuid","local");r(this,"ownership",null);r(this,"xrState",null);r(this,"builder",new As(1024))}async awake(){if(this.webXR||(this.webXR=this.gameObject.getComponent(T)),this.webXR||(this.webXR=p.findObjectOfType(T,this.context)),!this.webXR&&(console.log("Missing webxr component"),this.webXR=p.findObjectOfType(T,this.context),!this.webXR)){console.error("Could not find webxr component");return}if(this.voip||(this.voip=p.findObjectOfType(bt,this.context)),Qi){const e="debug-avatar-"+Qi,t=new vt(this.context,e,this.webXR);if(this.debugAvatarUser=t,typeof Qi=="string"&&Qi.length>0)if(await t.setAvatarOverride(Qi)){const s=new et(e);s.position.y+=1;const n=.5;s.posLeftHand.y+=n,s.posLeftHand.x+=n,s.posRightHand.y+=n,s.posRightHand.x-=n,t.tryUpdate(s,0)}else t.destroy()}}onEnable(){if(!this.webXR&&(this.webXR=p.getComponent(this.gameObject,T),!this.webXR)){console.warn("Missing webxr component on "+this.gameObject.name);return}this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),T.addEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),this.eventSub_WebXRUpdateEvent=this.onXRSessionUpdate.bind(this),T.addEventListener(H.XRUpdate,this.eventSub_WebXRUpdateEvent),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),T.addEventListener(H.XRStopped,this.eventSub_WebXREndEvent),this.eventSub_ConnectionEvent=this.onConnected.bind(this),this.context.connection.beginListen(W.JoinedRoom,this.eventSub_ConnectionEvent),this.context.connection.beginListen($t.WebXR_UserJoined,e=>{console.log("webxr user joined evt")}),this.context.connection.beginListen($t.WebXR_UserLeft,e=>{const t=e.id!==null&&e.id!==void 0;if(!!t&&(console.log("webxr user left evt"),t)){const s=this.avatars[e.id];s==null||s.destroy(),this.avatars[e.id]=void 0}}),this.context.connection.beginListenBinrary(ko,e=>{const t=e.guid();if(!t)return;const s=e.time().toFloat64(),n=this.tempState;n.setFromBuffer(t,e);const o=this.onTryGetAvatar(t,s);o==null||o.tryUpdate(n,s)}),this.context.connection.beginListen($t.VRSessionUpdate,e=>{const t=e.guid,s=e.time,n=this.onTryGetAvatar(t,s);n==null||n.tryUpdate(e,s)})}onTryGetAvatar(e,t){if(e===this.context.connection.connectionId)return null;const s=new Date().getTime()-t;if(s>5e3)return yh&&console.log("old data",s,e),null;let n=this.avatars[e];if(n===void 0)try{console.log("create new avatar");const o=new vt(this.context,e,this.webXR);n=o,this.avatars[e]=o}catch(o){this.avatars[e]=null,console.error(o)}return n}onDisable(){this.eventSub_ConnectionEvent&&this.context.connection.stopListening(W.JoinedRoom,this.eventSub_ConnectionEvent),T.removeEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),T.removeEventListener(H.XRUpdate,this.eventSub_WebXRUpdateEvent),T.removeEventListener(H.XRStopped,this.eventSub_WebXREndEvent)}update(){const e=Cn();this.debugAvatarUser&&(this.debugAvatarUser.lastUpdate=e),this.detectPotentiallyDisconnectedAvatarsAndRemove();for(const t in this.avatars){const s=this.avatars[t];!s||s.update()}}detectPotentiallyDisconnectedAvatarsAndRemove(){const e=Cn();for(const t in this.avatars){const s=this.avatars[t];if(!s){this._removeAvatarsList.push(t);continue}e-s.lastUpdate>1e4&&(console.log("avatar timed out (didnt receive any updates in  a while) - destroying it now"),s.destroy(),this.avatars[t]=void 0)}for(const t of this._removeAvatarsList)delete this.avatars[t];this._removeAvatarsList.length=0}buildLocalAvatar(){var t,s;if(this.localAvatar)return;const e=(s=(t=this.context.connection)==null?void 0:t.connectionId)!=null?s:this.k_LocalAvatarNoNetworkingGuid;this.localAvatar=new vt(this.context,e,this.webXR),this.localAvatar.isLocalAvatar=!0,this.localAvatar.setAvatarOverride(this.getAvatarId()),this.avatars[this.localAvatar.guid]=this.localAvatar}onConnected(){var e,t,s;yh&&console.log("Hey you are connected as "+this.context.connection.connectionId),((e=this.localAvatar)==null?void 0:e.guid)===this.k_LocalAvatarNoNetworkingGuid&&(this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0),this.localAvatar=null,this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null)}onXRSessionStart(e){var t,s,n;if(console.log("XR session started"),this.context.connection.send($t.WebXR_UserJoined,{id:this.context.connection.connectionId,mode:On.VR}),this.localAvatar&&((t=this.localAvatar)==null||t.destroy(),this.avatars[this.localAvatar.guid]=void 0,this.localAvatar=null),this.xrState=null,(s=this.ownership)==null||s.freeOwnership(),this.ownership=null,this.avatars)for(const o in this.avatars)(n=this.avatars[o])==null||n.updateFlags()}onXRSessionEnded(e){console.log("XR session ended"),this.context.connection.send($t.WebXR_UserLeft,{id:this.context.connection.connectionId,mode:On.VR})}onXRSessionUpdate(e){var h,d,u,g,b;(d=this.xrState)!=null||(this.xrState=new et((h=this.context.connection.connectionId)!=null?h:this.k_LocalAvatarNoNetworkingGuid)),(g=this.ownership)!=null||(this.ownership=new Qs(this.context.connection,(u=this.context.connection.connectionId)!=null?u:this.k_LocalAvatarNoNetworkingGuid)),this.ownership.guid=(b=this.context.connection.connectionId)!=null?b:this.k_LocalAvatarNoNetworkingGuid,this.buildLocalAvatar();const{frame:t,xr:s,rig:n}=e,o=t.getViewerPose(s.getReferenceSpace());if(!o)return;const a=o==null?void 0:o.transform,l=a.position,c=a.orientation;this.xrState.update(n,l,c,this.webXR,this.getAvatarId()),this.localAvatar&&(this.context.connection.connectionId&&(this.localAvatar.guid=this.context.connection.connectionId),this.localAvatar.tryUpdate(this.xrState,0)),!(this.ownership&&!this.ownership.hasOwnership&&this.context.connection.isConnected&&(this.context.time.frameCount%120==0&&this.ownership.requestOwnership(),!this.ownership.hasOwnership))&&(!this.context.connection.isConnected||!this.context.connection.connectionId||this.xrState.sendAsBuffer(this.builder,this.context.connection))}getAvatarId(){return w("avatar")}}Pn(Sn,"WebXRSync");var wh=Object.defineProperty,D_=Object.getOwnPropertyDescriptor,xh=(i,e)=>wh(i,"name",{value:e,configurable:!0}),M_=(i,e,t,s)=>{for(var n=s>1?void 0:s?D_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&wh(e,t,n),n},H;(function(i){i.XRStarted="xrStarted",i.XRStopped="xrStopped",i.XRUpdate="xrUpdate",i.RequestVRSession="requestVRSession"})(H||(H={}));var yr;const X=(yr=class extends v{constructor(){super(...arguments);r(this,"enableVR",!0);r(this,"enableAR",!0);r(this,"defaultAvatar");r(this,"createVRButton",!0);r(this,"createARButton",!0);r(this,"controllers",[]);r(this,"rig");r(this,"isInit",!1);r(this,"_requestedAR",!1);r(this,"_requestedVR",!1);r(this,"_isInAR",!1);r(this,"_isInVR",!1);r(this,"_arButton");r(this,"_vrButton");r(this,"webAR",null);r(this,"_transformOrientation",new O);r(this,"_currentHeadPose",null);r(this,"_originalCameraParent",null);r(this,"_originalCameraPosition",new y);r(this,"_originalCameraRotation",new O);r(this,"xrMirrorWindow",null)}static get XRSupported(){return"xr"in navigator}static get IsInWebXR(){return this._isInXr}static addEventListener(i,e){this.events.addEventListener(i,e)}static removeEventListener(i,e){this.events.removeEventListener(i,e)}static createVRButton(i,e){var s;X.XRSupported||console.warn("WebXR is not supported on this device");const t=fn.createButton(i.context.renderer);return t.classList.add("webxr-ar-button"),t.classList.add("webxr-button"),this.resetButtonStyles(t),((s=e==null?void 0:e.registerClick)!=null?s:!0)&&t.addEventListener("click",i.onClickedVRButton.bind(i)),t}static createARButton(i,e){var o,a;const t=(o=i.webAR)==null?void 0:o.trySetupOverlay(),s={requiredFeatures:["hit-test"]};t&&(s.domOverlay={root:t},s.optionalFeatures=["dom-overlay"]);const n=m_.createButton(i.context.renderer,s);return n.classList.add("webxr-ar-button"),n.classList.add("webxr-button"),X.resetButtonStyles(n),((a=e==null?void 0:e.registerClick)!=null?a:!0)&&n.addEventListener("click",i.onClickedARButton.bind(i)),n}static resetButtonStyles(i){!i||(i.style.position="",i.style.bottom="",i.style.left="")}endSession(){const i=this.context.renderer.xr.getSession();i&&i.end()}get Rig(){return this.rig}get Controllers(){return this.controllers}get LeftController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="left"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="left"?this.controllers[1]:null}get RightController(){var i,e;return this.controllers.length>0&&((i=this.controllers[0].input)==null?void 0:i.handedness)==="right"?this.controllers[0]:this.controllers.length>1&&((e=this.controllers[1].input)==null?void 0:e.handedness)==="right"?this.controllers[1]:null}awake(){if(this.defaultAvatar&&typeof this.defaultAvatar=="string"&&(this.defaultAvatar=Ue.getOrCreate(this.defaultAvatar,this.context)),!p.findObjectOfType(Sn,this.context)){const i=p.addNewComponent(this.gameObject,Sn,!1);i.webXR=this}}onEnable(){if(this.isInit||!this.enableAR&&!this.enableVR)return;this.isInit=!0,this.context.renderer.xr.enabled=!0,this.webAR=new Ji(this);const i=X.XRSupported;let e,t;const s=document.createElement("div");s.classList.add("webxr-buttons"),this.context.domElement.append(s),this.enableAR&&this.createARButton&&(e=X.createARButton(this),this._arButton=e,s.appendChild(e)),this.createVRButton&&this.enableVR&&(i||!this.enableAR)&&(t=X.createVRButton(this),this._vrButton=t,s.appendChild(t)),setTimeout(()=>{X.resetButtonStyles(t),X.resetButtonStyles(e)},1e3)}get TransformOrientation(){return this._transformOrientation}get HeadPose(){return this._currentHeadPose}onBeforeRender(i){var t;if(!i)return;const e=this.context.renderer.xr.getSession();if(e){const s=i.getViewerPose(this.context.renderer.xr.getReferenceSpace());if(this._currentHeadPose=s,!s)return;const n=s==null?void 0:s.transform;n&&this._transformOrientation.set(n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w);for(const o of this.controllers)o.onUpdate(e);this._isInAR&&((t=this.webAR)==null||t.onUpdate(e,i))}X._isInXr===!1&&e&&this.onEnterXR(e,i),X.events.dispatchEvent({type:H.XRUpdate,frame:i,xr:this.context.renderer.xr,rig:this.rig})}onClickedARButton(){this._isInAR||(this._requestedAR=!0,this._requestedVR=!1,this.captureCameraState())}onClickedVRButton(){if(!this._isInVR){if(this._requestedVR){this.onExitXR(null);return}this._requestedAR=!1,this._requestedVR=!0,this.captureCameraState(),this.ensureRig();for(let i=0;i<2;i++)F.Create(this,i,this.gameObject,vn.PhysicalDevice);X.events.dispatchEvent({type:H.RequestVRSession})}}captureCameraState(){this.context.mainCamera&&(this._originalCameraPosition.copy(C(this.context.mainCamera)),this._originalCameraRotation.copy(J(this.context.mainCamera)),this._originalCameraParent=this.context.mainCamera.parent)}ensureRig(){if(!this.rig){const i=p.findObjectOfType(Ao,this.context);i?(this.rig=i.gameObject,this.rig.rotateY(Math.PI)):(this.rig=new gp,this.rig.name="XRRig",this.context.scene.add(this.rig))}}onEnterXR(i,e){var o;console.log("[XR] session begin",i),X._isInXr=!0,this.ensureRig();const t=this.context.renderer.xr.getReferenceSpace();if(t&&this.rig){const a=e.getViewerPose(t),l=a==null?void 0:a.transform.orientation;if(l){const c=new O(l.x,l.y,l.z,l.w),h=new Pe().setFromQuaternion(c);this.rig.rotateY(h.y)}}const s=this.context.renderer.xr;if(this.context.mainCamera){const a=s.getCamera(this.context.mainCamera);for(const l of a.cameras)l.layers.enableAll();this.rig.add(this.context.mainCamera)}const n=this._requestedAR?Q.AR:Q.VR;switch(Ke.Global.Set(n),n){case Q.AR:this._isInAR=!0,(o=this.webAR)==null||o.onBegin(i);break;case Q.VR:this._isInVR=!0,this.onEnterVR(i);break}i.addEventListener("end",()=>{console.log("[XR] session end"),X._isInXr=!1,this.onExitXR(i)}),this.onEnterXR_HandleMirrorWindow(i),X.events.dispatchEvent({type:H.XRStarted,session:i})}onExitXR(i){var e,t;this._isInAR&&i&&((e=this.webAR)==null||e.onEnd(i)),this._isInAR=!1,this._isInVR=!1,this._requestedAR=!1,this._requestedVR=!1,this.xrMirrorWindow&&(this.xrMirrorWindow.close(),this.xrMirrorWindow=null),this.destroyControllers(),this.context.mainCamera&&((t=this._originalCameraParent)==null||t.add(this.context.mainCamera),D(this.context.mainCamera,this._originalCameraPosition),Z(this.context.mainCamera,this._originalCameraRotation),this.context.mainCamera.scale.set(1,1,1)),Ke.Global.Set(Q.Browser|Q.ThirdPerson),X.events.dispatchEvent({type:H.XRStopped,session:i})}onEnterVR(i){}destroyControllers(){var i;for(let e=this.controllers.length-1;e>=0;e-=1)(i=this.controllers[e])==null||i.destroy();this.controllers.length=0}onEnterXR_HandleMirrorWindow(i){!w("mirror")||setTimeout(()=>{if(!X.IsInWebXR)return;const e=new URL(window.location.href);Mi(e.searchParams,mn,1),Mi(e.searchParams,"isMirror",1);const t=e.toString();this.xrMirrorWindow=window.open(t,"webxr sync","popup=yes"),this.xrMirrorWindow&&(this.xrMirrorWindow.onload=()=>{this.xrMirrorWindow&&(this.xrMirrorWindow.onbeforeunload=()=>{X.IsInWebXR&&i.end()})})},1e3)}},r(yr,"_isInXr",!1),r(yr,"events",new mp),yr);let T=X;xh(T,"WebXR");M_([_(Ue)],T.prototype,"defaultAvatar",2);const Oi=class{constructor(e){r(this,"webxr");r(this,"reticle",null);r(this,"hitTestSource",null);r(this,"reticleActive",!0);r(this,"previousBackground",null);r(this,"previousEnvironment",null);r(this,"sessionRoot",null);r(this,"_previousParent",null);r(this,"arDomOverlay",null);r(this,"arOverlayElement",null);this.webxr=e}get context(){return this.webxr.context}trySetupOverlay(){return this.arDomOverlay=this.webxr.context.domElement,"getAROverlayContainer"in this.arDomOverlay&&(this.arOverlayElement=this.arDomOverlay.getAROverlayContainer()),this.arOverlayElement}setReticleActive(e){this.reticleActive=e}onBegin(e){var s,n;const t=this.webxr.context;this.reticleActive=!0;for(let o=0;o<4;o++)F.Create(this.webxr,o,this.webxr.gameObject,vn.Touch);(!this.sessionRoot||this.sessionRoot.destroyed||!this.sessionRoot.activeAndEnabled)&&(this.sessionRoot=p.findObjectOfType(xn,t)),this.previousBackground=t.scene.background,this.previousEnvironment=t.scene.environment,t.scene.background=null,e.requestReferenceSpace("viewer").then(o=>{e.requestHitTestSource({space:o}).then(a=>{this.hitTestSource=a})}),!this.reticle&&this.sessionRoot&&(this.reticle=new kt(new pp(.07,.09,32).rotateX(-Math.PI/2),new Ai),this.reticle.name="AR Placement reticle",this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.webxr.scene?(this.webxr.scene.add(this.reticle),this.webxr.scene.visible=!0):console.warn("Could not found WebXR Rig")),this._previousParent=this.webxr.gameObject,Oi.tempWebXRObject||(Oi.tempWebXRObject=new S),this.context.scene.add(Oi.tempWebXRObject),p.addComponent(Oi.tempWebXRObject,this.webxr),this.sessionRoot?(this.sessionRoot.webAR=this,(s=this.sessionRoot)==null||s.onBegin(e)):console.warn("No WebARSessionRoot found in scene"),this.arDomOverlay&&this.arOverlayElement&&this.arDomOverlay.onEnterAR(e,this.arOverlayElement),(n=this.context.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}onEnd(e){var s;this._previousParent&&(console.log("ADD",this._previousParent),p.addComponent(this._previousParent,this.webxr),this._previousParent=null),this.hitTestSource=null;const t=this.webxr.context;t.scene.background=this.previousBackground,t.scene.environment=this.previousEnvironment,this.sessionRoot&&this.sessionRoot.onEnd(this.webxr.Rig,e),this.arDomOverlay&&this.arDomOverlay.onExitAR(e),(s=this.context.mainCameraComponent)==null||s.applyClearFlagsIfIsActiveCamera()}onUpdate(e,t){var n,o;if(!this.hitTestSource)return;const s=t.getHitTestResults(this.hitTestSource);if(s.length){const a=s[0],l=this.webxr.context.renderer.xr.getReferenceSpace();if(l){const c=a.getPose(l);if((n=this.sessionRoot)==null||n.onUpdate(this.webxr.Rig,e,c),this.reticle&&(this.reticle.visible=this.reticleActive,this.reticleActive&&c)){const h=c.transform.matrix;this.reticle.matrix.fromArray(h),this.webxr.Rig&&this.reticle.matrix.premultiply(this.webxr.Rig.matrix)}}}else(o=this.sessionRoot)==null||o.onUpdate(this.webxr.Rig,e,null),this.reticle&&(this.reticle.visible=!1)}};let Ji=Oi;r(Ji,"tempWebXRObject");xh(Ji,"WebAR");var I_=Object.defineProperty,Ph=(i,e)=>I_(i,"name",{value:e,configurable:!0}),Zi;(function(i){i.SelectStart="selectstart",i.SelectEnd="selectend"})(Zi||(Zi={}));const Ci=class extends qi{constructor(){super();r(this,"transformSelf",!0);r(this,"selectStartEventListener",[]);r(this,"selectEndEventListener",[]);r(this,"_dragHelper",null);r(this,"_draggingRigidbodies",[]);r(this,"_waitingForDragStart",null);r(this,"_isDragging",!1);r(this,"_marker",null);r(this,"_dragDelta");r(this,"_didDrag",!1);this.selectStartEventListener=[],this.selectEndEventListener=[],this._dragDelta=new V}static get HasAnySelected(){return this._active!==null}addEventListener(e,t){switch(e){case Zi.SelectStart:this.selectStartEventListener.push(t);break;case Zi.SelectEnd:this.selectEndEventListener.push(t);break}}start(){}allowEdit(e=null){return this.context.connection.allowEditing}onPointerEnter(e){if(!this.allowEdit(this.gameObject)||T.IsInWebXR)return;const t=p.getComponentInParent(e.object,Ci);!t||t!==this||(Ci.lastHovered=e.object,this.context.domElement.style.cursor="pointer")}onPointerExit(e){!this.allowEdit(this.gameObject)||T.IsInWebXR||Ci.lastHovered===e.object&&(this.context.domElement.style.cursor="auto")}onPointerDown(e){!this.allowEdit(this.gameObject)||T.IsInWebXR||(this._dragDelta.set(0,0),this._didDrag=!1,this._waitingForDragStart=e,e.StopPropagation())}onPointerUp(e){this._waitingForDragStart=null,!!this.allowEdit(this.gameObject)&&(T.IsInWebXR||(this.onDragEnd(e),e.StopPropagation()))}update(){var e;if(!T.IsInWebXR){if(this._waitingForDragStart){if(!this._didDrag){const s=this.context.input.getPointerPositionDelta(0);if(s&&this._dragDelta.add(s),this._dragDelta.length()>2)this._didDrag=!0;else return}const t=this._waitingForDragStart;this._waitingForDragStart=null,this.onDragStart(t)}this._dragHelper&&this._dragHelper.hasSelected&&this.onUpdateDrag(),this._isDragging&&!((e=this._dragHelper)==null?void 0:e.hasSelected)&&this.onDragEnd(null)}}onDragStart(e){if(!this._dragHelper)if(this.context.mainCamera)this._dragHelper=new Rn(this.context.mainCamera);else return;if(!e||!e.object)return;const t=p.getComponentInParent(e.object,Ci);if(!t||t!==this)return;let s=e.object;this.transformSelf&&(s=this.gameObject);const n={selected:s,attached:s};for(const c of this.selectStartEventListener)c(this,n);if(!n.attached)return;n.attached!==s,s=n.attached,this._isDragging=!0,this._dragHelper.setSelected(s,this.context);const o=p.getComponentInChildren(s,_t);o&&(o.fastMode=!0,o==null||o.requestOwnership()),this._marker=p.addNewComponent(s,Xi),this._draggingRigidbodies.length=0;const a=p.getComponentsInChildren(s,Ee);a&&this._draggingRigidbodies.push(...a);const l=Mr();p.invokeOnChildren(this._dragHelper.selected,l("onDragStart"))}onUpdateDrag(){if(!!this._dragHelper){this._dragHelper.onUpdate(this.context);for(const e of this._draggingRigidbodies)e.wakeUp(),e.setBodyFromGameObject()}}onDragEnd(e){if(!this||!this._isDragging||(this._isDragging=!1,!this._dragHelper))return;this._draggingRigidbodies.length=0;const t=this._dragHelper.selected;if(this._dragHelper.setSelected(null,this.context),e==null?void 0:e.object){const n=p.getComponentInChildren(e.object,_t);n&&(n.fastMode=!1),this._marker&&this._marker.destroy()}for(const n of this.selectEndEventListener)n(this);const s=Mr();p.invokeOnChildren(t,s("onDragEnd"))}};let wt=Ci;r(wt,"_active",null),r(wt,"lastHovered");Ph(wt,"DragControls");const Ua=class{constructor(e){r(this,"_selected",null);r(this,"_context",null);r(this,"_camera");r(this,"_cameraPlane",new nl);r(this,"_hasGroundPlane",!1);r(this,"_groundPlane",new nl);r(this,"_groundOffset",new y);r(this,"_groundOffsetFactor",0);r(this,"_groundDistance",0);r(this,"_groundPlanePoint",new y);r(this,"_raycaster",new Sr);r(this,"_cameraPlaneOffset",new y);r(this,"_intersection",new y);r(this,"_worldPosition",new y);r(this,"_inverseMatrix",new Oe);r(this,"_rbs",[]);r(this,"_groundLine");r(this,"_groundMarker");r(this,"_groundOffsetVector",new y(0,1,0));r(this,"_requireUpdateGroundPlane",!0);r(this,"_didDragOnGroundPlaneLastFrame",!1);this._camera=e;const t=new tl(Ua.geometry),s=t.material;s.color=new f(.4,.4,.4),t.layers.set(2),t.name="line",t.scale.y=1,this._groundLine=t;const n=new il(.5,22,22),o=new Ai({color:s.color}),a=new kt(n,o);a.visible=!1,a.layers.set(2),this._groundMarker=a}get hasSelected(){return this._selected!==null&&this._selected!==void 0}get selected(){return this._selected}setSelected(e,t){if(this._selected&&t)for(const s of this._rbs)s.wakeUp(),!!s.smoothedVelocity&&s.setVelocity(s.smoothedVelocity.x,s.smoothedVelocity.y,s.smoothedVelocity.z);if(this._selected&&le.Remove(t,this._selected),this._selected=e,this._context=t,this._rbs.length=0,e?(t.scene.add(this._groundLine),t.scene.add(this._groundMarker)):(this._groundLine.removeFromParent(),this._groundMarker.removeFromParent()),this._selected){if(!t){console.error("DragHelper: no context");return}le.Add(t,this._selected,null),this._groundOffsetFactor=0,this._hasGroundPlane=!0,this._groundOffset.set(0,0,0),this._requireUpdateGroundPlane=!0,this._rbs=p.getComponentsInChildren(this._selected,Ee),this.onUpdateScreenSpacePlane()}}onUpdate(e){var l,c,h,d,u;if(!this._context)return;const t=Ye.SPACE,s=Ye.KEY_D;Ye.KEY_S;const n=((l=this._context)==null?void 0:l.input.isKeyPressed(t))||((c=this._context)==null?void 0:c.input.isKeyPressed(s)),o=this._context.input.getTouchesPressedCount()>=2||n;if(o){const g=this._context.input.getPointerPositionDelta(0);g&&(this._groundOffsetVector.set(0,1,0),(h=this._selected)==null||h.rotateOnWorldAxis(this._groundOffsetVector,g.x*this._context.time.deltaTime))}const a=this._context.input.getPointerPositionRC(0);if(!!a&&(this._raycaster.setFromCamera(a,this._camera),this._selected)){this._groundOffsetVector.set(0,1,0);const g=C(this._camera).clone().sub(C(this._selected)).normalize(),b=Math.abs(g.dot(this._groundOffsetVector)),x=((d=this._context)==null?void 0:d.input.isKeyPressed(t))||((u=this._context)==null?void 0:u.input.isKeyPressed(s)),P=!o&&b>.2&&!x&&this._context.input.getPointerPressedCount()<=1,R=this._didDragOnGroundPlaneLastFrame!==P;if(this._didDragOnGroundPlaneLastFrame=P,this._hasGroundPlane||(this._requireUpdateGroundPlane=!0),(this._requireUpdateGroundPlane||!P||R)&&this.onUpdateGroundPlane(),this._requireUpdateGroundPlane=!1,this._hasGroundPlane)if(this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection)){const M=this._intersection.y;if(this._groundPlanePoint.copy(this._intersection).sub(this._groundOffset),this._groundPlanePoint.y=M,P){this._groundOffsetVector.set(0,1,0);const ce=this._intersection.sub(this._groundOffset).add(this._groundOffsetVector.multiplyScalar(this._groundOffsetFactor));this.onUpdateWorldPosition(ce,this._groundPlanePoint,!1),this.onDidUpdate();return}}else this._groundPlanePoint.set(0,99999,0);R&&this.onUpdateScreenSpacePlane(),this._requireUpdateGroundPlane=!0,this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&(this.onUpdateWorldPosition(this._intersection.sub(this._cameraPlaneOffset),this._groundPlanePoint,!0),this.onDidUpdate())}}onUpdateWorldPosition(e,t,s){if(!!this._selected){if(s){const n=C(this._selected);n.y=e.y,e=n}if(D(this._selected,e),D(this._groundLine,e),this._hasGroundPlane?this._groundLine.scale.y=this._groundDistance:this._groundLine.scale.y=1e3,this._groundMarker.visible=t!==null,t){const n=C(this._camera).distanceTo(t)*.01;this._groundMarker.scale.set(n,n,n),D(this._groundMarker,t)}}}onUpdateScreenSpacePlane(){if(!this._selected||!this._context)return;const e=this._context.input.getPointerPositionRC(0);!e||(this._raycaster.setFromCamera(e,this._camera),this._cameraPlane.setFromNormalAndCoplanarPoint(this._camera.getWorldDirection(this._cameraPlane.normal),this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld)),this._raycaster.ray.intersectPlane(this._cameraPlane,this._intersection)&&this._selected.parent&&(this._inverseMatrix.copy(this._selected.parent.matrixWorld).invert(),this._cameraPlaneOffset.copy(this._intersection).sub(this._worldPosition.setFromMatrixPosition(this._selected.matrixWorld))))}onUpdateGroundPlane(){if(!this._selected||!this._context)return;const e=C(this._selected),t=new sl(new y(0,.1,0).add(e),new y(0,-1,0)),s=new Me;s.ignore=[this._selected];const n=this._context.physics.raycastFromRay(t,s);for(let o=0;o<n.length;o++){const a=n[o];if(!a.face||this.contains(this._selected,a.object))continue;const l=new y(0,1,0);this._groundPlane.setFromNormalAndCoplanarPoint(l,a.point);break}this._hasGroundPlane=!0,this._groundPlane.setFromNormalAndCoplanarPoint(t.direction.multiplyScalar(-1),t.origin),this._raycaster.ray.intersectPlane(this._groundPlane,this._intersection),this._groundDistance=this._intersection.distanceTo(e),this._groundOffset.copy(this._intersection).sub(e)}onDidUpdate(){de.markDirty(this._selected);for(const e of this._rbs)e.wakeUp(),e.setBodyFromGameObject({x:0,y:0,z:0}),e.setAngularVelocity(0,0,0)}contains(e,t){if(e===t)return!0;if(e.children){for(const s of e.children)if(this.contains(s,t))return!0}return!1}};let Rn=Ua;r(Rn,"geometry",new Ts().setFromPoints([new y(0,0,0),new y(0,-1,0)]));Ph(Rn,"DragHelper");var Oh=Object.defineProperty,j_=Object.getOwnPropertyDescriptor,Ch=(i,e)=>Oh(i,"name",{value:e,configurable:!0}),Sh=(i,e,t,s)=>{for(var n=s>1?void 0:s?j_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Oh(e,t,n),n},Lo;(function(i){i.ObjectAdded="object-added"})(Lo||(Lo={}));class Rh extends v{constructor(){super(...arguments);r(this,"_listeners",{})}addEventListener(e,t,s){!t||(this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(t))}dispatchEvent(e){if(!e||!this._listeners[e.type])return!1;for(const t of this._listeners[e.type])"handleEvent"in t?t.handleEvent(e):t(e);return!0}removeEventListener(e,t,s){!t||!this._listeners[e]||(this._listeners[e]=this._listeners[e].filter(n=>n!==t))}}Ch(Rh,"EventTargetBehaviour");class En extends Rh{constructor(){super(...arguments);r(this,"filesBackendUrl");r(this,"localhost");r(this,"_dragOver");r(this,"_drop")}onEnable(){this.filesBackendUrl=this.filesBackendUrl?Bt.GetUrl(this.filesBackendUrl,this.localhost):void 0,this._dragOver=this.onDrag.bind(this),this._drop=this.onDrop.bind(this),this.context.domElement.addEventListener("dragover",this._dragOver),this.context.domElement.addEventListener("drop",this._drop)}onDisable(){this.context.domElement.removeEventListener("dragover",this._dragOver),this.context.domElement.removeEventListener("drop",this._drop)}onDrag(e){e.preventDefault()}async onDrop(e){if(console.log(e),!e.dataTransfer)return;e.preventDefault();const t=e.dataTransfer.items;if(!!t)for(const s in t){const n=t[s];if(n.kind==="file"){const o=n.getAsFile();if(!o)continue;console.log("Register file "+o.name+" to",this.filesBackendUrl);const a=await wf(o,this.context,this.filesBackendUrl);a&&this.addObject(e,a)}else n.kind==="string"&&n.type=="text/plain"&&n.getAsString(async o=>{console.log("dropped url",o);try{const a=new URL(o);if(!a)return;const l=await xf(a,this.context);l&&this.addObject(e,l)}catch{console.log("dropped string is not a valid URL!",o)}})}}async addObject(e,t){const s=new Me;s.setMask(16777215),s.screenPointFromOffset(e.offsetX,e.offsetY);const n=this.context.physics.raycast(s);if(n&&n.length>0)for(const o of n){t.position.copy(o.point);break}this.gameObject.add(t),this.dispatchEvent(new CustomEvent(Lo.ObjectAdded,{detail:t}))}}Ch(En,"DropListener");Sh([_()],En.prototype,"filesBackendUrl",2);Sh([_()],En.prototype,"localhost",2);var Eh=Object.defineProperty,F_=Object.getOwnPropertyDescriptor,B_=(i,e)=>Eh(i,"name",{value:e,configurable:!0}),An=(i,e,t,s)=>{for(var n=s>1?void 0:s?F_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Eh(e,t,n),n};class li extends qi{constructor(){super(...arguments);r(this,"parent",null);r(this,"object",null);r(this,"limitCount",10);r(this,"limitInterval",60);r(this,"_currentCount",0);r(this,"_startPosition",null);r(this,"_startQuaternion",null)}awake(){var t,s,n,o;if(this.object){if(this.object===this.gameObject){console.error("Can not duplicate self");return}this.object.visible=!1,this._startPosition=(s=(t=this.object.position)==null?void 0:t.clone())!=null?s:new y(0,0,0),this._startQuaternion=(o=(n=this.object.quaternion)==null?void 0:n.clone())!=null?o:new O(0,0,0,1)}const e=p.getComponentInParent(this.gameObject,wt);e?e.addEventListener(Zi.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.attached=null;return}const c=this.handleDuplication(l.selected);c&&(console.assert(c!==l.selected,"Duplicated object is original"),l.attached=c)}):console.warn("Could no find drag controls in parent",this.name),F.addEventListener(me.SelectStart,(a,l)=>{if(this._currentCount>=this.limitCount){l.grab=null;return}const c=this.handleDuplication(l.selected);c&&(l.grab=c)}),this.cloneLimitIntervalFn()}cloneLimitIntervalFn(){this.destroyed||(this._currentCount>0&&(this._currentCount-=1),setTimeout(()=>{this.cloneLimitIntervalFn()},this.limitInterval/this.limitCount*1e3))}handleDuplication(e){var t,s;if(this._currentCount>=this.limitCount||!this.object)return null;if(e===this.gameObject||this.handleMultiObject(e)){if(this.object===this.gameObject)return null;this.object.visible=!0,this._startPosition&&this.object.position.copy(this._startPosition),this._startQuaternion&&this.object.quaternion.copy(this._startQuaternion);const n=new Ce;this.parent||(this.parent=this.gameObject.parent),this.parent&&(n.parent=(s=this.parent.guid)!=null?s:(t=this.parent.userData)==null?void 0:t.guid,n.keepWorldPosition=!0),n.position=this.worldPosition,n.rotation=this.worldQuaternion,n.context=this.context,this._currentCount+=1;const o=p.instantiateSynced(this.object,n);return console.assert(o!==this.object,"Duplicated object is original"),this.object.visible=!1,this._startPosition&&this.object.position.clone().copy(this._startPosition),this._startQuaternion&&this.object.quaternion.clone().copy(this._startQuaternion),o}return null}handleMultiObject(e){return this.gameObject.type==="Group"||this.gameObject.type==="Object3D"?this.isInChildren(this.gameObject,e):!1}isInChildren(e,t){if(!e)return!1;if(e===t)return!0;if(e.children){for(let s of e.children)if(this.isInChildren(s,t))return!0}return!1}}B_(li,"Duplicatable");An([_(S)],li.prototype,"parent",2);An([_(S)],li.prototype,"object",2);An([_()],li.prototype,"limitCount",2);An([_()],li.prototype,"limitInterval",2);var U_=Object.defineProperty,Ah=(i,e)=>U_(i,"name",{value:e,configurable:!0});class Ki{constructor(e,t){r(this,"method");r(this,"enabled");this.method=e,this.enabled=t!==void 0?t:!0}invoke(...e){if(this.enabled!==!1){if(!this.method){console.warn("No function. Please check you assigned a method to invoke on export",this);return}this.method(...e)}}}Ah(Ki,"CallInfo");class tt{constructor(e){r(this,"methods",[]);this.methods=e!=null?e:[]}invoke(...e){for(const t of this.methods)t.invoke(...e)}addEventListener(e){return this.methods.push(new Ki(e,!0)),e}removeEventListener(e){if(!!e)for(let t=this.methods.length-1;t>=0;t--)this.methods[t].method===e&&(this.methods[t].enabled=!1,this.methods.splice(t,1))}removeAllEventListeners(){this.methods.length=0}}Ah(tt,"EventList");var N_=Object.defineProperty,z_=(i,e)=>N_(i,"name",{value:e,configurable:!0});class Th extends v{}z_(Th,"EventTrigger");var $_=Object.defineProperty,W_=(i,e)=>$_(i,"name",{value:e,configurable:!0});class kh extends v{constructor(){super(...arguments);r(this,"_controls",null)}onEnable(){var t;const e=(t=p.getComponent(this.gameObject,N))==null?void 0:t.cam;this._controls=new _p(e,this.context.renderer.domElement),this._controls.rollSpeed=.5,this._controls.movementSpeed=3,this._controls.dragToLook=!0}onDisable(){var e;(e=this._controls)==null||e.dispose(),this._controls=null}update(){this._controls&&this._controls.update(this.context.time.deltaTime)}}W_(kh,"FlyControls");var Lh=Object.defineProperty,H_=Object.getOwnPropertyDescriptor,G_=(i,e)=>Lh(i,"name",{value:e,configurable:!0}),Dh=(i,e,t,s)=>{for(var n=s>1?void 0:s?H_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Lh(e,t,n),n};class Tn extends v{constructor(){super(...arguments);r(this,"objectBounds",!1);r(this,"color");r(this,"_gizmoObject",null);r(this,"_boxHelper",null)}onEnable(){var e,t;!Bi||(this._gizmoObject||(this.objectBounds&&this.gameObject.isMesh===!0?this._gizmoObject=new rl(this.gameObject,(e=this.color)!=null?e:16776960):(this.objectBounds=!1,this._gizmoObject=xo((t=this.color)!=null?t:16776960))),this.objectBounds?(this.scene.add(this._gizmoObject),this._boxHelper=this._gizmoObject,this.startCoroutine(this.syncObjectBounds(),xe.OnBeforeRender)):this.gameObject.add(this._gizmoObject))}onDisable(){this._gizmoObject&&this.gameObject.remove(this._gizmoObject)}*syncObjectBounds(){var e;for(;this._boxHelper;)(e=this._boxHelper)==null||e.update(),yield}}G_(Tn,"BoxGizmo");Dh([_()],Tn.prototype,"objectBounds",2);Dh([_(f)],Tn.prototype,"color",2);class V_{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(e.constructor.name!=="InstancedMesh")return;const s=this.writer,n=s.extensionsUsed,o={};t.extensions=t.extensions||{},t.extensions[this.name]=o;let a=new Oe;const l=new Array,c=new Array,h=new Array;for(let b=0;b<e.count;b++){e.getMatrixAt(b,a);let x=new y,P=new O,R=new y;a.decompose(x,P,R),l.push(x.x,x.y,x.z),c.push(P.x,P.y,P.z,P.w),h.push(R.x,R.y,R.z)}const d=new Float32Array(l),u=new Float32Array(c),g=new Float32Array(h);o.attributes={TRANSLATION:s.processAccessor(new Ti(d,3)),ROTATION:s.processAccessor(new Ti(u,4)),SCALE:s.processAccessor(new Ti(g,3))},n[this.name]=!0}}var q_=Object.defineProperty,Do=(i,e)=>q_(i,"name",{value:e,configurable:!0});const xt=fe,kn="$___Export_Components",X_="NEEDLE_components";var Zv;class Mh{constructor(){r(this,Zv)}}Zv=Kt;Do(Mh,"ExtensionData");class Ih{constructor(e,t,s){r(this,"node");r(this,"nodeIndex");r(this,"nodeDef");this.node=e,this.nodeIndex=t,this.nodeDef=s}}Do(Ih,"ExportData");class Mo{constructor(){r(this,"parser");r(this,"nodeToObjectMap",{});r(this,"exportContext");r(this,"objectToNodeMap",{});r(this,"context");r(this,"writer")}get name(){return X_}registerExport(e){e.register(t=>{const s=t.serializeUserData.bind(t);return this.writer=t,t.serializeUserData=(n,o)=>{try{this.serializeUserData(n,o),s(n,o)}finally{this.afterSerializeUserData(n,o)}},this})}beforeParse(){this.exportContext={},this.objectToNodeMap={}}serializeUserData(e,t){var n;const s=(n=e.userData)==null?void 0:n.components;!s||s.length<=0||(delete e.userData.components,e[kn]=s)}afterSerializeUserData(e,t){if(e.type==="Scene"&&xt&&console.log("DONE",JSON.stringify(t)),e[kn]===void 0)return;const s=e[kn];delete e[kn],s!==null&&(e.userData.components=s)}writeNode(e,t){let s=this.writer.json.nodes.length;console.log(e.name,s,e.uuid);const n=new Ih(e,s,t);this.exportContext[s]=n,this.objectToNodeMap[e.uuid]=s}afterParse(e){var t;xt&&console.log("AFTER",e);for(const s in this.exportContext){const n=this.exportContext[s],o=n.node,a=n.nodeDef,l=n.nodeIndex,c=(t=o.userData)==null?void 0:t.components;if(!c||c.length<=0)continue;const h=new Mh;a.extensions=a.extensions||{},a.extensions[this.name]=h,this.context.object=o,this.context.nodeId=l,this.context.objectToNode=this.objectToNodeMap;const d=[];for(const u of c){this.context.target=u;const g=zu(u,this.context);g!==null&&d.push(g)}d.length>0&&(h[Kt]=d,xt&&console.log("DID WRITE",o,"nodeIndex",l,d))}}beforeRoot(){return xt&&console.log("BEGIN LOAD"),this.nodeToObjectMap={},null}async afterRoot(e){const t=e.parser,s=t==null?void 0:t.extensions;if(!s)return;const n=s[this.name];xt&&console.log("After root",e,this.parser,s);const o=[];if(n===!0){const a=t.json.nodes;for(let l=0;l<a.length;l++){const c=await t.getDependency("node",l);this.nodeToObjectMap[l]=c}for(let l=0;l<a.length;l++){const c=a[l],h=l,d=c.extensions;if(!d)continue;const u=d[this.name];if(!u)continue;xt&&console.log("NODE",c);const g=this.nodeToObjectMap[h];if(!g){console.error("Could not find object for node index: "+h,c,t);continue}o.push(this.createComponents(g,u))}}await Promise.all(o)}async createComponents(e,t){if(!t)return;const s=t[Kt];if(s){xt&&console.log(e.name,s);for(const n in s){const o=s[n];xt&&console.log("Serialized data",JSON.parse(JSON.stringify(o))),o&&this.parser&&await en(this.parser,o),e.userData=e.userData||{},e.userData[Kt]=e.userData[Kt]||[],e.userData[Kt].push(o)}}}}Do(Mo,"NEEDLE_components");var Y_=Object.defineProperty,jh=(i,e)=>Y_(i,"name",{value:e,configurable:!0});class Fh extends Vi{constructor(){super(...arguments);r(this,"sceneRoot")}start(){this.startCoroutine(this.updateGltfBox())}*updateGltfBox(){for(;;)for(let e=0;e<10;e++)yield}}jh(Fh,"GltfExportBox");class Pt extends v{constructor(){super(...arguments);r(this,"binary",!0);r(this,"objects",[]);r(this,"exporter");r(this,"ext")}async exportNow(e){console.log("DO EXPORT",this.objects);const t={binary:this.binary,pivot:Pt.calculateCenter(this.objects)},s=await this.export(this.objects,t);this.binary?e.endsWith(".glb")||(e+=".glb"):e.endsWith(".gltf")||(e+=".gltf"),this.binary?Pt.saveArrayBuffer(s,e):Pt.saveJson(s,e)}async export(e,t){var l;if(e===null||e.length<=0){console.log("no objects set to export");return}this.exporter||(this.exporter=new bp,this.exporter.register(c=>new V_(c)),this.ext=new Mo,this.ext.registerExport(this.exporter)),Pt.filterTopmostParent(e);const s={trs:!1,onlyVisible:!0,truncateDrawRange:!1,binary:(l=t==null?void 0:t.binary)!=null?l:!0,maxTextureSize:1/0,embedImages:!0,includeCustomExtensions:!0,animations:Pt.collectAnimations(e)},n=new S;(t==null?void 0:t.pivot)&&n.position.sub(t.pivot),console.log("EXPORT",e),e.forEach(c=>{c&&(n.children.push(c),c.matrixAutoUpdate=!1,c.matrix.copy(c.matrixWorld),p.getComponentsInChildren(c,se).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))});const o=new fo(n);return this.ext.context=o,new Promise((c,h)=>{var d;try{(d=this.exporter)==null||d.parse(n,u=>{a(),c(u)},u=>{a(),h(u)},s)}catch(u){console.error(u),h(u)}finally{console.log("FINALLY")}});function a(){e.forEach(c=>{!c||(c.matrixAutoUpdate=!0,p.getComponentsInChildren(c,se).forEach(h=>{p.isActiveInHierarchy(h.gameObject)&&h.setInstancingEnabled(!1)}))})}}static saveArrayBuffer(e,t){this.save(new Blob([e],{type:"application/octet-stream"}),t)}static saveJson(e,t){this.save("data: text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),t)}static save(e,t){const s=document.createElement("a");s.style.display="none",document.body.appendChild(s),typeof e=="string"?s.href=e:s.href=URL.createObjectURL(e),s.download=t,s.click(),s.remove()}static collectAnimations(e,t){t=t||[];for(const s of e)!s||s.traverseVisible(n=>{n.animations&&n.animations.length>0&&t.push(...n.animations)});return t}static calculateCenter(e,t){const s=t||new y;return s.set(0,0,0),e.forEach(n=>{s.add(C(n))}),console.log(s),s.divideScalar(e.length),s}static filterTopmostParent(e){if(!(e.length<=0))for(let t=0;t<e.length;t++){let s=e[t];if(!s){e.splice(t,1),t--;continue}for(;s.parent;){if(e.includes(s.parent)){e.splice(t,1),t--;break}s=s.parent}}}}jh(Pt,"GltfExport");var Bh=Object.defineProperty,Q_=Object.getOwnPropertyDescriptor,J_=(i,e)=>Bh(i,"name",{value:e,configurable:!0}),Io=(i,e,t,s)=>{for(var n=s>1?void 0:s?Q_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Bh(e,t,n),n};class es extends v{constructor(){super(...arguments);r(this,"isGizmo",!1);r(this,"color0");r(this,"color1");r(this,"gridHelper");r(this,"size");r(this,"divisions");r(this,"offset")}onEnable(){var s,n;if(this.isGizmo&&!Bi)return;const e=this.size,t=this.divisions;this.gridHelper||(this.gridHelper=new yp(e,t,(s=this.color0)!=null?s:new f(.4,.4,.4),(n=this.color1)!=null?n:new f(.6,.6,.6)),this.offset!==void 0&&(this.gridHelper.position.y+=this.offset),this.gameObject.add(this.gridHelper))}}J_(es,"GridHelper");Io([_()],es.prototype,"isGizmo",2);Io([_(f)],es.prototype,"color0",2);Io([_(f)],es.prototype,"color1",2);var Uh=Object.defineProperty,Z_=Object.getOwnPropertyDescriptor,jo=(i,e)=>Uh(i,"name",{value:e,configurable:!0}),ci=(i,e,t,s)=>{for(var n=s>1?void 0:s?Z_(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Uh(e,t,n),n};function K_(i){return i*180/Math.PI}jo(K_,"toDegrees");function Ln(i){return i*Math.PI/180}jo(Ln,"toRadians");const Nh=300,zh=w("debuglights");var $h;(function(i){i[i.Realtime=4]="Realtime",i[i.Baked=2]="Baked",i[i.Mixed=1]="Mixed"})($h||($h={}));class Ot extends v{constructor(){super(...arguments);r(this,"type",0);r(this,"intensity",1);r(this,"range",1);r(this,"spotAngle",1);r(this,"innerSpotAngle",1);r(this,"color",new f(16777215));r(this,"shadowNearPlane",.1);r(this,"shadowBias",0);r(this,"shadowNormalBias",1);r(this,"shadows",Dn.None);r(this,"lightmapBakeType",4);r(this,"light")}get isBaked(){return this.lightmapBakeType===2}get selfIsLight(){if(this.gameObject.isLight===!0)return!0;switch(this.gameObject.type){case"SpotLight":case"PointLight":case"DirectionalLight":return!0}return!1}getWorldPosition(e){return this.light?this.type===it.Directional?this.light.getWorldPosition(e).multiplyScalar(1):this.light.getWorldPosition(e):e}onEnable(){this.createLight(),!this.isBaked&&(this.light&&(this.selfIsLight||this.light.parent!==this.gameObject&&this.gameObject.add(this.light)),this.type===it.Directional&&this.startCoroutine(this.updateMainLightRoutine(),xe.LateUpdate))}createLight(){if(this.light)return;let e=this.selfIsLight;if(e)switch(this.light=this.gameObject,this.type){case it.Directional:this.setDirectionalLight(this.light);break}else switch(this.type){case it.Directional:const t=new xp(this.color,this.intensity*Math.PI);if(t.position.set(0,0,-Nh*.5).applyQuaternion(this.gameObject.quaternion),this.gameObject.add(t.target),Ls(t.target,0,0,0),this.light=t,this.gameObject.position.set(0,0,0),this.gameObject.rotation.set(0,0,0),zh){const a=new Pp(this.light,.2,this.color);this.context.scene.add(a)}break;case it.Spot:const s=new wp(this.color,this.intensity*Math.PI,this.range,Ln(this.spotAngle/2),1-Ln(this.innerSpotAngle/2)/Ln(this.spotAngle/2),2);s.position.set(0,0,0),s.rotation.set(0,0,0),this.light=s;const n=s.target;s.add(n),n.position.set(0,0,this.range),n.rotation.set(0,0,0);break;case it.Point:const o=new vp(this.color,this.intensity*Math.PI,this.range);this.light=o;break}if(this.light!==void 0){this.shadows!=Dn.None?this.light.castShadow=!0:this.light.castShadow=!1,this.light.shadow.mapSize.width=2048,this.light.shadow.mapSize.height=2048,this.light.shadow.bias=this.shadowBias*-3e-5,this.light.shadow.normalBias=this.shadowNormalBias*-3e-5;const t=this.light.shadow.camera;t.near=this.shadowNearPlane,t.far=Nh;const s=this.gameObject.scale.x,n=this.gameObject.scale.y;this.gameObject.scale.set(1,1,1),t.left*=s,t.right*=s,t.top*=n,t.bottom*=n,this.light.shadow.needsUpdate=!0,zh&&this.context.scene.add(new Op(t)),this.isBaked?this.light.removeFromParent():e||this.gameObject.add(this.light)}}*updateMainLightRoutine(){for(;;){this.type===it.Directional&&((!this.context.mainLight||this.intensity>this.context.mainLight.intensity)&&(this.context.mainLight=this),yield);break}}setDirectionalLight(e){e.add(e.target),e.target.position.set(0,0,-1)}}jo(Ot,"Light");ci([_()],Ot.prototype,"type",2);ci([_(f)],Ot.prototype,"color",2);ci([_()],Ot.prototype,"shadowBias",2);ci([_()],Ot.prototype,"shadowNormalBias",2);ci([_()],Ot.prototype,"shadows",2);ci([_()],Ot.prototype,"lightmapBakeType",2);new y(0,0,0);var it;(function(i){i[i.Spot=0]="Spot",i[i.Directional=1]="Directional",i[i.Point=2]="Point",i[i.Area=3]="Area",i[i.Rectangle=3]="Rectangle",i[i.Disc=4]="Disc"})(it||(it={}));var Dn;(function(i){i[i.None=0]="None",i[i.Hard=1]="Hard",i[i.Soft=2]="Soft"})(Dn||(Dn={}));var Wh=Object.defineProperty,eb=Object.getOwnPropertyDescriptor,Fo=(i,e)=>Wh(i,"name",{value:e,configurable:!0}),ts=(i,e,t,s)=>{for(var n=s>1?void 0:s?eb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Wh(e,t,n),n};const hi=w("debugLODs"),tb=w("noLODs");var Hh;(function(i){i[i.None=0]="None",i[i.CrossFade=1]="CrossFade",i[i.SpeedTree=2]="SpeedTree"})(Hh||(Hh={}));class di{constructor(){r(this,"screenRelativeTransitionHeight");r(this,"distance");r(this,"renderers")}}Fo(di,"LODModel");ts([_()],di.prototype,"screenRelativeTransitionHeight",2);ts([_()],di.prototype,"distance",2);ts([_()],di.prototype,"renderers",2);class Gh{constructor(e,t){r(this,"model");r(this,"renderers");this.model=t,this.renderers=[];for(const s of t.renderers){const n=this.findRenderer(s,e.gameObject);n&&n.gameObject?this.renderers.push(n):hi&&console.warn("Renderer not found: "+s,e.gameObject)}}findRenderer(e,t){const s=p.foreachComponent(t,n=>{var a;return n.guid===e||((a=Object.getPrototypeOf(n))==null?void 0:a.guid)===e?n:null});if(s)return s;for(const n of t.children){const o=this.findRenderer(e,n);if(o)return o}return null}}Fo(Gh,"LOD");class Mn extends v{constructor(){super(...arguments);r(this,"fadeMode",0);r(this,"localReferencePoint");r(this,"lodCount",0);r(this,"size",0);r(this,"animateCrossFading",!1);r(this,"lodModels");r(this,"_lods",[]);r(this,"_settings",[]);r(this,"_lodsHandler");r(this,"_distanceFactor",1)}start(){if(!tb&&!this._lodsHandler&&!!this.gameObject&&(hi&&console.log(this),this.lodModels&&Array.isArray(this.lodModels))){let e=0,t=[];for(const n of this.lodModels){e=Math.max(n.distance,e);const o=new Gh(this,n);this._lods.push(o);for(const a of o.renderers)t.includes(a)||t.push(a)}this._lodsHandler=new Array;for(let n=0;n<t.length;n++){const o=new Cp;this._lodsHandler.push(o),this.gameObject.add(o)}const s=new S;hi&&console.log(t);for(let n=0;n<t.length;n++){const o=t[n],a=this._lodsHandler[n],l=o.gameObject;let c=0,h=0;hi&&console.log(n,l.name);for(const u of this._lods){let g=null;u.renderers.includes(o)?g=l:g=s,hi&&console.log("add",u.model.distance,g.name);const b=u.model.distance;h=b-c,c=Math.max(b,c),this.onAddLodLevel(a,g,b)}const d=c+h;hi&&console.log("cull",d),this.onAddLodLevel(a,s,d)}}}update(){if(!this.gameObject||!this._lodsHandler)return;const e=this.context.mainCamera;if(!!e)for(const t of this._lodsHandler)t.update(e)}onAddLodLevel(e,t,s){e.addLevel(t,s*this._distanceFactor);const n={lod:e,levelIndex:e.levels.length-1,distance:s};this._settings.push(n)}distanceFactor(e){if(e!==this._distanceFactor){this._distanceFactor=e;for(const t of this._settings){const s=t.lod.levels[t.levelIndex];s.distance=t.distance*e}}}}Fo(Mn,"LODGroup");ts([_(y)],Mn.prototype,"localReferencePoint",2);ts([_(di)],Mn.prototype,"lodModels",2);var ib=Object.defineProperty,sb=(i,e)=>ib(i,"name",{value:e,configurable:!0});class Vh extends v{onEnable(){this.enabled&&this.context.physics.addMeshCollider(this.gameObject)}}sb(Vh,"MeshCollider");var nb=Object.defineProperty,qh=(i,e)=>nb(i,"name",{value:e,configurable:!0});class Xh extends v{}qh(Xh,"NavMesh");class Yh extends v{}qh(Yh,"NavMeshAgent");var Qh=Object.defineProperty,rb=Object.getOwnPropertyDescriptor,ob=(i,e)=>Qh(i,"name",{value:e,configurable:!0}),ab=(i,e,t,s)=>{for(var n=s>1?void 0:s?rb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Qh(e,t,n),n};const Bo=w("debugnestedgltf");class Uo extends v{constructor(){super(...arguments);r(this,"filePath");r(this,"_isLoadingOrDoneLoading",!1)}listenToProgress(e){var t;(t=this.filePath)==null||t.beginListenDownload(e)}preload(){var e;(e=this.filePath)==null||e.preload()}async start(){var t,s,n,o,a,l;if(this._isLoadingOrDoneLoading)return;Bo&&console.log(this,this.guid);const e=this.gameObject.parent;if(e){this._isLoadingOrDoneLoading=!0;const c=new Ce;c.idProvider=new ye(this.hash(this.guid)),c.parent=e,this.gameObject.updateMatrix();const h=this.gameObject.matrix;Bo&&console.log("Load nested:",(s=(t=this.filePath)==null?void 0:t.uri)!=null?s:this.filePath,this.gameObject.position);const d=await((o=(n=this.filePath)==null?void 0:n.instantiate)==null?void 0:o.call(this.filePath,c));d&&(d.matrixAutoUpdate=!1,d.matrix.identity(),d.applyMatrix4(h),d.matrixAutoUpdate=!0),this.destroy(),Bo&&console.log("Nested loading done:",(l=(a=this.filePath)==null?void 0:a.uri)!=null?l:this.filePath,d)}}hash(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}ob(Uo,"NestedGltf");ab([_(Ue)],Uo.prototype,"filePath",2);var lb=Object.defineProperty,cb=(i,e)=>lb(i,"name",{value:e,configurable:!0});class Jh extends v{constructor(){super(...arguments);r(this,"from");r(this,"affectPosition");r(this,"affectRotation");r(this,"alignLookDirection");r(this,"levelLookDirection");r(this,"positionOffset");r(this,"rotationOffset")}update(){if(!this.from)return;var e=C(this.from),t=J(this.from);this.affectPosition&&D(this.gameObject,e.add(this.positionOffset));const s=new Pe(this.rotationOffset.x,this.rotationOffset.y,this.rotationOffset.z),n=new O().setFromEuler(s);this.affectRotation&&Z(this.gameObject,t.multiply(n));let o=new y;this.from.getWorldDirection(o).multiplyScalar(50),this.levelLookDirection&&(o.y=0),this.alignLookDirection&&this.gameObject.lookAt(o)}}cb(Jh,"OffsetConstraint");var hb=Object.defineProperty,No=(i,e)=>hb(i,"name",{value:e,configurable:!0});class Zh{constructor(){r(this,"randomizeRotationDirection",0);r(this,"duration",5);r(this,"loop",!0);r(this,"prewarm",!1);r(this,"startDelay");r(this,"startDelayMultiplier",0);r(this,"startLifetime");r(this,"startLifetimeMultiplier",5);r(this,"startSpeed");r(this,"startSpeedMultiplier",5);r(this,"startSize3D",!1);r(this,"startSize");r(this,"startSizeMultiplier",1);r(this,"startSizeX");r(this,"startSizeXMultiplier",1);r(this,"startSizeY");r(this,"startSizeYMultiplier",1);r(this,"startSizeZ");r(this,"startSizeZMultiplier",1);r(this,"startRotation3D",!1);r(this,"startRotation");r(this,"startRotationMultiplier",0);r(this,"startRotationX");r(this,"startRotationXMultiplier",0);r(this,"startRotationY");r(this,"startRotationYMultiplier",0);r(this,"startRotationZ");r(this,"startRotationZMultiplier",0);r(this,"flipRotation",0);r(this,"startColor",new f(1,1,1));r(this,"startColor1",new f(0,0,0));r(this,"gravityModifier");r(this,"gravityModifierMultiplier",0);r(this,"simulationSpace",0);r(this,"customSimulationSpace",null);r(this,"simulationSpeed",1);r(this,"useUnscaledTime",!1);r(this,"scalingMode",1);r(this,"playOnAwake",!0);r(this,"maxParticles",1e3);r(this,"emitterVelocityMode",1);r(this,"stopAction",0);r(this,"ringBufferMode",0);r(this,"ringBufferLoopRange",new V(0,1));r(this,"cullingMode",0)}}No(Zh,"MainModule");class Kh{constructor(){r(this,"burstCount",0);r(this,"enabled",!0);r(this,"rate",10);r(this,"rateMutliplier",1);r(this,"rateOverDistance",0);r(this,"rateOverDistanceMultiplier",0);r(this,"rateOverTime",0);r(this,"rateOverTimeMultiplier",0)}}No(Kh,"EmissionModule");class ed{constructor(){r(this,"shapeType",Ne.Box);r(this,"enabled",!0);r(this,"alignToDirection",!1);r(this,"angle",0);r(this,"arc",360);r(this,"arcmode",0);r(this,"box",new y(1,1,1));r(this,"boxThickness",new y(0,0,0));r(this,"position",new y(0,0,0));r(this,"rotation",new y(0,0,0));r(this,"scale",new y(1,1,1));r(this,"radius",1);r(this,"sphericalDirectionAmount",0)}}No(ed,"ShapeModule");var Ne;(function(i){i[i.Sphere=0]="Sphere",i[i.SphereShell=1]="SphereShell",i[i.Hemisphere=2]="Hemisphere",i[i.HemisphereShell=3]="HemisphereShell",i[i.Cone=4]="Cone",i[i.Box=5]="Box",i[i.Mesh=6]="Mesh",i[i.ConeVolume=7]="ConeVolume",i[i.Circle=10]="Circle",i[i.SingleSidedEdge=11]="SingleSidedEdge",i[i.MeshRenderer=12]="MeshRenderer",i[i.SkinnedMeshRenderer=13]="SkinnedMeshRenderer",i[i.BoxShell=14]="BoxShell",i[i.BoxEdge=15]="BoxEdge",i[i.Donut=16]="Donut",i[i.Rectangle=17]="Rectangle",i[i.Sprite=18]="Sprite",i[i.SpriteRenderer=19]="SpriteRenderer"})(Ne||(Ne={}));var db=Object.defineProperty,zo=(i,e)=>db(i,"name",{value:e,configurable:!0});const td=w("debugparticles");class id{constructor(){r(this,"age",0);r(this,"lifetime",0);r(this,"position");r(this,"velocity");r(this,"color")}}zo(id,"ParticleState");class $o extends v{constructor(){super(...arguments);r(this,"sharedMaterial");r(this,"mesh")}get mainTexture(){if(this.sharedMaterial){const e=this.context.assets.findTexture(this.sharedMaterial);if(e)return e}return null}getMesh(e){return this.mesh?this.context.assets.findMesh(this.mesh):null}awake(){td&&console.log(this)}}zo($o,"ParticleSystemRenderer");class sd extends v{constructor(){super(...arguments);r(this,"main");r(this,"emission");r(this,"shape");r(this,"renderer");r(this,"geometry");r(this,"material");r(this,"particlesMesh");r(this,"positions");r(this,"positionsArray");r(this,"particleStates",[]);r(this,"activeCount",0);r(this,"shapeRotation",new O);r(this,"tempVec3",new y);r(this,"tempQuat",new O)}awake(){this.renderer=p.getComponent(this.gameObject,$o),td&&console.log(this)}onEnable(){if(this.geometry)return;this.particleStates=[],this.shapeRotation.setFromEuler(new Pe(this.shape.rotation.x,this.shape.rotation.y,this.shape.rotation.z)),this.geometry=new Ts,this.positionsArray=new Float32Array(this.main.maxParticles*3),this.positions=new ol(this.positionsArray,3),this.geometry.setAttribute("position",this.positions);const e=new Float32Array(this.main.maxParticles*3);for(let s=0;s<e.length;s++)e[s*3]=1,e[s*3+1]=1,e[s*3+2]=1;const t=new ol(e,3);this.geometry.setAttribute("color",t),this.material=new Sp({size:this.main.startSize,color:16777215,vertexColors:!0}),this.material.map=this.renderer.mainTexture,this.particlesMesh=new Rp(this.geometry,this.material),this.particlesMesh.layers.enable(2),this.gameObject.add(this.particlesMesh),this.activeCount=this.main.prewarm?this.main.maxParticles:0}update(){if(!this.geometry)return;const e=this.context.time.deltaTime;this.emit(e);for(let t=0;t<this.activeCount;t+=1){const s=this.particleStates[t];if(!s)continue;const n=s.velocity.x*e,o=s.velocity.y*e,a=s.velocity.z*e;s.position.x+=n,s.position.y+=o,s.position.z+=a,this.updateOverLifetime(t,s),this.geometry.attributes.position.setXYZ(t,s.position.x,s.position.y,s.position.z),this.geometry.attributes.color.setXYZ(t,s.color.r,s.color.g,s.color.b)}this.geometry&&(this.geometry.attributes.position.needsUpdate=!0,this.geometry.setDrawRange(0,this.activeCount))}emit(e){var s;const t=this.activeCount;for(let n=0;n<t;n+=1){if(n>=this.particleStates.length){const a=new id;a.lifetime=(s=this.main.startLifetime)!=null?s:1,a.position=new y,a.velocity=new y,a.color=new f(1,0,0),this.particleStates.push(a),this.initializeParticle(n,a),a.age=a.lifetime*Math.random()}const o=this.particleStates[n];if(o.age>o.lifetime){this.activeCount-=1,this.activeCount=Math.max(0,this.activeCount),this.initializeParticle(n,o);continue}o.age+=e,this.particleStates[n]=o}this.activeCount+=e*this.emission.rate,this.activeCount=Math.min(this.main.maxParticles,this.activeCount)}initializeParticle(e,t){if(!this.geometry)return;t.age=0,t.color.set(this.main.startColor),this.main.startColor1&&t.color.lerp(this.main.startColor1,Math.random()),this.geometry.attributes.color.needsUpdate=!0,this.assignPosition(t.position),this.assignVelocity(t.position,t.velocity);const s=t.position;s.multiply(this.shape.scale),s.applyQuaternion(this.shapeRotation),s.add(this.shape.position),this.particleStates.splice(e,1),this.particleStates.push(t)}updateOverLifetime(e,t){}assignPosition(e){switch(this.shape.shapeType){case Ne.Sphere:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).multiplyScalar(this.shape.radius);break;case Ne.Box:e.set(Math.random()-.5,Math.random()-.5,Math.random()-.5);break;default:e.set(0,0,0);break}}assignVelocity(e,t){switch(this.shape.shapeType){case Ne.Sphere:t.set(e.x,e.y,e.z);break;case Ne.Box:t.set(0,0,1),this.shape.sphericalDirectionAmount>0&&(this.tempVec3.set(e.x,e.y,e.z).multiply(this.shape.scale).normalize(),t.lerp(this.tempVec3,this.shape.sphericalDirectionAmount));break;case Ne.Cone:const s=new y(0,1,0);t.copy(s);break;case Ne.Circle:this.tempQuat.setFromAxisAngle(this.tempVec3.set(0,0,1),Math.random()*A.toRadians(this.shape.arc)),t.copy(this.tempVec3.set(1,0,0).applyQuaternion(this.tempQuat));break;default:t.set(Math.random()*2-1,Math.random()*2-1,Math.random()*2-1);break}switch(t.normalize(),this.shape.shapeType){case Ne.Circle:e.add(t).multiplyScalar(this.shape.radius);break}t.multiplyScalar(this.main.startSpeedMultiplier)}}zo(sd,"ParticleSystem");var ub=Object.defineProperty,nd=(i,e)=>ub(i,"name",{value:e,configurable:!0});function*rd(i,e=null){const t=e?e.time:E.Current.time,s=t.time;for(;t.time-s<i;)yield}nd(rd,"WaitForSeconds");function*fb(i){for(let e=0;e<i;e++)yield}nd(fb,"WaitForFrames");var pb=Object.defineProperty,mb=(i,e)=>pb(i,"name",{value:e,configurable:!0});class Ct extends v{constructor(){super(...arguments);r(this,"_didAssignPlayerColor",!1)}awake(){this.context.connection.beginListen(W.JoinedRoom,this.tryAssignColor.bind(this))}onEnable(){this._didAssignPlayerColor||this.startCoroutine(this.waitForConnection())}*waitForConnection(){for(;!this.destroyed&&this.enabled&&(yield rd(.2),!this.tryAssignColor()););}tryAssignColor(){const e=p.getComponentInParent(this.gameObject,ee);return e&&e.connectionId?(this._didAssignPlayerColor=!0,this.assignUserColor(e.connectionId),!0):!1}assignUserColor(e){const t=Ct.hashCode(e),s=Ct.colorFromHashCode(t);if(this.gameObject.type==="Mesh"){const n=this.gameObject;this.assignColor(s,e,n)}else if(this.gameObject.children)for(const n of this.gameObject.children){const o=n;o.material&&o.material.color&&this.assignColor(s,e,o)}}assignColor(e,t,s){let n=s.material;!n||(n._playerMaterial!==t?(n=n.clone(),n._playerMaterial=t,s.material=n):console.log("DONT CLONE",n),n.color=e)}static hashCode(e){var t=0,s,n;if(e.length===0)return t;for(s=0;s<e.length;s++)n=e.charCodeAt(s),t=(t<<5)-t+n,t|=0;return t}static colorFromHashCode(e){const t=(e&16711680)>>16,s=(e&65280)>>8,n=e&255;return new f(t/255,s/255,n/255)}}mb(Ct,"PlayerColor");var gb=Object.defineProperty,_b=(i,e)=>gb(i,"name",{value:e,configurable:!0});const Si=class extends v{constructor(){super(...arguments);r(this,"$serializedTypes",{mass:null,drag:null,angularDrag:null,isKinematic:null});r(this,"mass",1);r(this,"isKinematic",!1);r(this,"drag",0);r(this,"angularDrag",1);r(this,"detectCollision",!0);r(this,"sleepThreshold",.01);r(this,"parent",null);r(this,"_body",null);r(this,"currentVelocity");r(this,"smoothedVelocity");r(this,"lastWorldPosition")}get body(){return this._body===null&&this.initialize(),this._body}awake(){this._body=null,this.currentVelocity=new y,this.smoothedVelocity=new y,this.lastWorldPosition=C(this.gameObject).clone()}onEnable(){this._body?this.context.physics.addBody(this.gameObject,this._body):this.initialize(),this.body&&(this.body.wakeUp(),this.gameObject.updateWorldMatrix(!0,!1),this.setBodyFromGameObject())}onDisable(){this._body&&this.context.physics.removeBody(this.gameObject,this._body,!1)}onDestroy(){this._body&&this.context.physics.removeBody(this.gameObject,this._body)}initialize(){if(this._body)return;const e=new eo;e.drag=this.drag,e.angularDrag=this.angularDrag,e.mass=this.mass,e.kinematic=this.isKinematic,e.physicsEvents=this.detectCollision,e.sleepThreshold=this.sleepThreshold,this._body=this.context.physics.createBody(this.gameObject,e),this.parent=this.gameObject.parent}wakeUp(){var e;(e=this.body)==null||e.wakeUp()}applyForce(e,t){var s;(s=this.body)==null||s.applyForce(new Lt(e.x,e.y,e.z),t?new Lt(t.x,t.y,t.z):void 0)}set kinematic(e){this.isKinematic=e,this.body&&(this.body.type=e?he.KINEMATIC:he.DYNAMIC)}get kinematic(){return this.isKinematic}getVelocity(){var e,t,s;return this.body?Si.tempPosition.set((e=this.body)==null?void 0:e.velocity.x,(t=this.body)==null?void 0:t.velocity.y,(s=this.body)==null?void 0:s.velocity.z):Si.tempPosition.set(0,0,0)}setVelocity(e,t,s){!this.body||(this.body.velocity.x=e/this.context.time.deltaTime,this.body.velocity.y=t/this.context.time.deltaTime,this.body.velocity.z=s/this.context.time.deltaTime)}setAngularVelocity(e,t,s){!this.body||(this.body.angularVelocity.x=e/this.context.time.deltaTime,this.body.angularVelocity.y=t/this.context.time.deltaTime,this.body.angularVelocity.z=s/this.context.time.deltaTime)}setBodyFromGameObject(e=null){if(this.body&&this.gameObject&&!this.destroyed){const t=this.worldPosition;this.body.position.set(t.x,t.y,t.z);const s=this.worldQuaternion;if(this.body.quaternion.set(s.x,s.y,s.z,s.w),e){Si.copyVector3.set(e.x,e.y,e.z),this.smoothedVelocity.lerp(Si.copyVector3,this.context.time.deltaTime/.1);const n=this.smoothedVelocity;this.body.velocity.x=n.x,this.body.velocity.y=n.y,this.body.velocity.z=n.z}}}onBeforeRender(){this.updateVelocity()}updateVelocity(){if(!!this.currentVelocity&&this.body&&this.gameObject){const e=C(this.gameObject);this.currentVelocity.subVectors(e,this.lastWorldPosition),this.lastWorldPosition.copy(e),this.smoothedVelocity.lerp(this.currentVelocity,this.context.time.deltaTime/.1)}}};let is=Si;r(is,"tempPosition",new y),r(is,"copyVector3",new y);_b(is,"Rigidbody");var bb=Object.defineProperty,yb=(i,e)=>bb(i,"name",{value:e,configurable:!0});class od extends v{async start(){this.gameObject.visible=!1}}yb(od,"SceneSettings");var vb=Object.defineProperty,Wo=(i,e)=>vb(i,"name",{value:e,configurable:!0});function ad(){return new Promise((i,e)=>{let s=Wo(()=>{s!=null&&(document.removeEventListener("pointerdown",s),document.removeEventListener("click",s),document.removeEventListener("dragstart",s),document.removeEventListener("touchstart",s),i())},"callback");document.addEventListener("pointerdown",s),document.addEventListener("click",s),document.addEventListener("dragstart",s),document.addEventListener("touchstart",s)})}Wo(ad,"awaitInputAsync");async function ld(i){await ad(),i()}Wo(ld,"awaitInput");var cd=Object.defineProperty,wb=Object.getOwnPropertyDescriptor,xb=(i,e)=>cd(i,"name",{value:e,configurable:!0}),Wt=(i,e,t,s)=>{for(var n=s>1?void 0:s?wb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&cd(e,t,n),n},hd;(function(i){i[i.VideoClip=0]="VideoClip",i[i.Url=1]="Url"})(hd||(hd={}));var dd;(function(i){i[i.None=0]="None",i[i.AudioSource=1]="AudioSource",i[i.Direct=2]="Direct",i[i.APIOnly=3]="APIOnly"})(dd||(dd={}));class ze extends v{constructor(){super();r(this,"renderer",null);r(this,"playOnAwake",!0);r(this,"playOnEnable");r(this,"targetMaterialProperty");r(this,"time",0);r(this,"_playbackSpeed",1);r(this,"_isLooping",!1);r(this,"audioOutputMode",1);r(this,"source");r(this,"clip",null);r(this,"url",null);r(this,"videoElement",null);r(this,"videoTexture",null);r(this,"videoMaterial",null);r(this,"_isPlaying",!1);r(this,"wasPlaying",!1);r(this,"_receivedInput",!1);ld(()=>{this._receivedInput=!0,this.updateVideoElementSettings()})}get playbackSpeed(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.playbackRate)!=null?t:this._playbackSpeed}set playbackSpeed(e){this._playbackSpeed=e,this.videoElement&&(this.videoElement.playbackRate=e)}get isLooping(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.loop)!=null?t:this._isLooping}set isLooping(e){this._isLooping=e,this.videoElement&&(this.videoElement.loop=e)}get currentTime(){var e,t;return(t=(e=this.videoElement)==null?void 0:e.currentTime)!=null?t:this.time}set currentTime(e){this.videoElement?this.videoElement.currentTime=e:this.time=e}get isPlaying(){const e=this.videoElement;return e?e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>e.HAVE_CURRENT_DATA:!1}setClipURL(e){this.url!==e&&(this.url=e,this.source=1,this.videoElement&&(this.videoElement.src=e,this._isPlaying&&this.videoElement.play()))}awake(){this.create(this.playOnAwake),window.addEventListener("visibilitychange",e=>{switch(document.visibilityState){case"hidden":this.wasPlaying=this._isPlaying,this.pause();break;case"visible":this.wasPlaying&&this.play();break}})}onEnable(){this.playOnEnable===!0&&this.handleBeginPlaying(!0)}onDisable(){this.pause()}onDestroy(){var e;this.videoElement&&((e=this.videoElement.parentElement)==null||e.removeChild(this.videoElement),this.videoElement=null),this.videoTexture&&(this.videoTexture.dispose(),this.videoTexture=null)}play(){var e,t,s;!this.videoElement||this._isPlaying&&!((e=this.videoElement)==null?void 0:e.ended)&&!((t=this.videoElement)==null?void 0:t.paused)||(this._isPlaying=!0,this._receivedInput||(this.videoElement.muted=!0),this.updateVideoElementSettings(),(s=this.videoElement)==null||s.play().catch(n=>{console.warn(n)}))}stop(){this._isPlaying=!1,!!this.videoElement&&(this.videoElement.currentTime=0,this.videoElement.pause())}pause(){var e;this._isPlaying=!1,(e=this.videoElement)==null||e.pause()}create(e){var s;let t;switch(this.source){case 0:t=this.clip;break;case 1:t=this.url;break}!t||(this.videoElement||(this.videoElement=document.createElement("video"),(s=this.context.domElement)==null||s.prepend(this.videoElement),this.updateVideoElementStyles()),typeof t=="string"?this.videoElement.src=t:this.videoElement.srcObject=t,this.videoTexture||(this.videoTexture=new Ep(this.videoElement)),this.videoTexture.flipY=!1,this.videoTexture.encoding=Zt,this.handleBeginPlaying(e))}handleBeginPlaying(e){if(!this.enabled||!this.videoElement)return;const t=this.gameObject.material;if(t)if(t!==this.videoMaterial&&(this.videoMaterial=t.clone(),this.gameObject.material=this.videoMaterial),!this.targetMaterialProperty)this.videoMaterial.map=this.videoTexture;else switch(this.targetMaterialProperty){default:this.videoMaterial.map=this.videoTexture;break}else{console.warn("Can not play video, no material found, this might be a multimaterial case which is not supported yet");return}this.updateVideoElementSettings(),this.updateVideoElementStyles(),e&&this.play()}updateVideoElementSettings(){!this.videoElement||(this.videoElement.loop=this._isLooping,this.videoElement.currentTime=this.currentTime,this.videoElement.playbackRate=this._playbackSpeed,this.videoElement.playsInline=!0,this.videoElement.muted=!this._receivedInput&&this.audioOutputMode!==0,(this.playOnAwake||this.playOnEnable)&&(this.videoElement.autoplay=!0))}updateVideoElementStyles(){!this.videoElement||(this.videoElement.style.userSelect="none",this.videoElement.style.visibility="hidden",this.videoElement.style.display="none")}}xb(ze,"VideoPlayer");Wt([_(S)],ze.prototype,"renderer",2);Wt([_()],ze.prototype,"playOnAwake",2);Wt([_()],ze.prototype,"playOnEnable",2);Wt([_()],ze.prototype,"targetMaterialProperty",2);Wt([_()],ze.prototype,"time",2);Wt([_()],ze.prototype,"playbackSpeed",1);Wt([_()],ze.prototype,"isLooping",1);var Pb=Object.defineProperty,Ob=(i,e)=>Pb(i,"name",{value:e,configurable:!0});class ud extends v{constructor(){super(...arguments);r(this,"streamOnAwake",!0);r(this,"requestOpen",!1);r(this,"captureStream",null)}start(){this.streamOnAwake&&this.open()}async open(e=!1){if(!(this.captureStream&&!e)){this.close(),this.requestOpen=!0;try{const t=p.getComponentInChildren(this.gameObject,ze);if(t){const s={video:!0,audio:!1};this.captureStream=await navigator.mediaDevices.getDisplayMedia(s),this.captureStream&&this.requestOpen&&(t.clip=this.captureStream,t.create(!0))}}catch(t){console.error("Error: "+t)}}}close(){if(this.requestOpen=!1,this.captureStream){for(const e of this.captureStream.getTracks())e.stop();this.captureStream=null}}}Ob(ud,"ScreenCapture");var fd=Object.defineProperty,Cb=Object.getOwnPropertyDescriptor,Sb=(i,e)=>fd(i,"name",{value:e,configurable:!0}),Rb=(i,e,t,s)=>{for(var n=s>1?void 0:s?Cb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&fd(e,t,n),n};class Ho extends v{constructor(){super(...arguments);r(this,"shadowColor",new Re(0,0,0,1))}awake(){this.applyShadowMaterial()}applyLightBlendMaterial(){const e=this.gameObject.getComponent(se);if(e){const t=e.material;t.blending=Ap,t.onBeforeCompile=s=>{s.fragmentShader=s.fragmentShader.replace("vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;",`vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
                
                // diffuse-only lighting with overdrive to somewhat compensate
                // for the loss of indirect lighting and to make it more visible.
                vec3 direct = reflectedLight.directDiffuse * 3.;
                float max = max(direct.r, max(direct.g, direct.b));
                
                // early out - we're simply returning direct lighting and some alpha based on it so it can 
                // be blended onto the scene.
                gl_FragColor = vec4(direct, max);
                return;
                `)}}}applyShadowMaterial(){var t;const e=this.gameObject.getComponent(se);if(e)if(((t=e.material)==null?void 0:t.type)!=="ShadowMaterial"){const s=new Tp;s.color=this.shadowColor,s.opacity=this.shadowColor.alpha,e.material=s}else{const s=e.material;s.color=this.shadowColor,s.opacity=this.shadowColor.alpha}}}Sb(Ho,"ShadowCatcher");Rb([_(Re)],Ho.prototype,"shadowColor",2);var pd=Object.defineProperty,Eb=Object.getOwnPropertyDescriptor,Ab=(i,e)=>pd(i,"name",{value:e,configurable:!0}),Tb=(i,e,t,s)=>{for(var n=s>1?void 0:s?Eb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&pd(e,t,n),n},Na;const md=(Na=class extends v{constructor(){super(...arguments);r(this,"target",null);r(this,"followFactor",.1);r(this,"rotateFactor",.1);r(this,"flipForward",!1);r(this,"_firstUpdate",!0)}onEnable(){const i=p.getComponentInChildren(this.gameObject,N);i&&i.cam&&(i.gameObject.position.set(0,0,0),i.cam.position.set(0,0,0),i.gameObject.quaternion.identity(),i.cam.quaternion.setFromEuler(new Pe(0,Math.PI,0)))}onBeforeRender(){this.followFactor<=0||this.updateNow(!1)}updateNow(i){if(!(!this.target||this.target===this.gameObject)){if(this.followFactor>0){const e=C(this.target),t=this._firstUpdate||i?1:A.clamp01(this.context.time.deltaTime*this.followFactor);this.worldPosition=this.worldPosition.lerp(e,t)}if(this.rotateFactor>0){const e=J(this.target);this.flipForward&&e.multiply(md._invertForward);const t=this._firstUpdate||i?1:A.clamp01(this.context.time.deltaTime*this.rotateFactor);this.worldQuaternion=this.worldQuaternion.slerp(e,t)}this._firstUpdate=!1}}},r(Na,"_invertForward",new O().setFromAxisAngle(new y(0,1,0),Math.PI)),Na);let In=md;Ab(In,"SmoothFollow");Tb([_(S)],In.prototype,"target",2);var gd=Object.defineProperty,kb=Object.getOwnPropertyDescriptor,Go=(i,e)=>gd(i,"name",{value:e,configurable:!0}),jn=(i,e,t,s)=>{for(var n=s>1?void 0:s?kb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&gd(e,t,n),n};class ss extends v{constructor(){super(...arguments);r(this,"triggerMask",0);r(this,"onEnter");r(this,"onStay");r(this,"onExit");r(this,"currentIntersected",[]);r(this,"lastIntersected",[])}update(){this.currentIntersected.length=0;for(const e of Bn.triggers)e.triggerMask===this.triggerMask&&e.test(this.gameObject)&&this.currentIntersected.push(e);for(let e=this.lastIntersected.length-1;e>=0;e--){const t=this.lastIntersected[e];this.currentIntersected.indexOf(t)<0&&(this.onExitTrigger(t),this.lastIntersected.splice(e,1))}for(const e of this.currentIntersected)this.lastIntersected.indexOf(e)<0&&this.onEnterTrigger(e),this.onTrigger(e);this.lastIntersected.length=0,this.lastIntersected.push(...this.currentIntersected)}onEnterTrigger(e){var t;e.raiseOnEnterEvent(this),(t=this.onEnter)==null||t.invoke(this,e)}onExitTrigger(e){var t;e.raiseOnExitEvent(this),(t=this.onExit)==null||t.invoke(this,e)}onTrigger(e){var t;e.raiseOnStayEvent(this),(t=this.onStay)==null||t.invoke(this,e)}}Go(ss,"SpatialTriggerReceiver");jn([_(tt)],ss.prototype,"onEnter",2);jn([_(tt)],ss.prototype,"onStay",2);jn([_(tt)],ss.prototype,"onExit",2);var za;const Fn=(za=class extends v{constructor(){super(...arguments);r(this,"triggerMask");r(this,"boxHelper");r(this,"args",new Vo)}start(){console.log(this)}onEnable(){var i;Fn.triggers.push(this),this.boxHelper||(this.boxHelper=p.addNewComponent(this.gameObject,Vi),(i=this.boxHelper)==null||i.showHelper())}onDisable(){Fn.triggers.splice(Fn.triggers.indexOf(this),1)}test(i){var e;return this.boxHelper&&(e=this.boxHelper.isInBox(i))!=null?e:!1}raiseOnEnterEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onEnterTrigger",!1,i,this)}raiseOnStayEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onStayTrigger",!1,i,this)}raiseOnExitEvent(i){this.args.trigger=this,this.args.source=i,p.invoke(this.gameObject,"onExitTrigger",!1,i,this)}},r(za,"triggers",[]),za);let Bn=Fn;Go(Bn,"SpatialTrigger");jn([_()],Bn.prototype,"triggerMask",2);class Vo{constructor(){r(this,"source");r(this,"trigger")}}Go(Vo,"SpatialTriggerEventArgs");var Lb=Object.defineProperty,Db=(i,e)=>Lb(i,"name",{value:e,configurable:!0});class _d extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"_firstPersonMode",!1);r(this,"orbit",null);r(this,"firstPersonFollow",null);r(this,"spectatorUIDomElement",null);r(this,"_avatar",null);r(this,"eventSub_WebXRRequestStartEvent",null);r(this,"eventSub_WebXRStartEvent",null);r(this,"eventSub_WebXREndEvent",null);r(this,"_sessionHasStarted",!1);r(this,"_isFirstStart",!0);r(this,"_firstPersonIsSetup",!1);r(this,"_orbitStartPos",new y);r(this,"_orbitStartRot",new O);r(this,"_orbitStartPos2",new y);r(this,"_orbitStartRot2",new O)}get firstPersonMode(){return!0}set firstPersonMode(e){}enableFirstPersonMode(){this._firstPersonMode=!0,this.updateUI(),this.cam&&(this.firstPersonFollow&&(this.firstPersonFollow.enabled=!0,this.firstPersonFollow.updateNow(!0)),this.orbit&&(this.orbit.enabled=!1))}enableThirdPersonMode(){this._firstPersonMode=!1,this.updateUI(),this.firstPersonFollow&&(this.firstPersonFollow.enabled=!1),!!this.cam&&(D(this.cam.cam,this._orbitStartPos),Z(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),Z(this.cam.gameObject,this._orbitStartRot2),this.orbit&&(this.orbit.enabled=!0,this.orbit.setFromTargetPosition()))}awake(){var t,s;p.setActive(this.gameObject,!1);const e="#spectator-camera-ui";if(this.spectatorUIDomElement=this.context.domElement.querySelector(e),this.spectatorUIDomElement||console.warn("Could not find spectator camera UI element",e),(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),!this.isSupportedPlatform()){console.log("Disable spectator cam",window.navigator.userAgent,this);return}if(this.cam=p.getComponent(this.gameObject,N),!this.cam){console.error("Spectator camera needs camera component",this);return}this.cam&&(this.cam.enabled=!0,this._orbitStartPos.copy(C(this.cam.cam)),this._orbitStartRot.copy(J(this.cam.cam)),this._orbitStartPos2.copy(C(this.cam.gameObject)),this._orbitStartRot2.copy(J(this.cam.gameObject))),this.eventSub_WebXRRequestStartEvent=this.onXRSessionRequestStart.bind(this),this.eventSub_WebXRStartEvent=this.onXRSessionStart.bind(this),this.eventSub_WebXREndEvent=this.onXRSessionEnded.bind(this),T.addEventListener(H.RequestVRSession,this.eventSub_WebXRRequestStartEvent),T.addEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),T.addEventListener(H.XRStopped,this.eventSub_WebXREndEvent),(s=this.context.domElement.querySelector("button#toggle-spectator-view"))==null||s.addEventListener("click",this.toggleView.bind(this)),this.updateUI()}onDestroy(){T.removeEventListener(H.RequestVRSession,this.eventSub_WebXRStartEvent),T.removeEventListener(H.XRStarted,this.eventSub_WebXRStartEvent),T.removeEventListener(H.XRStopped,this.eventSub_WebXREndEvent)}toggleView(){this.firstPersonMode=!this.firstPersonMode}updateUI(){var t;const e=this.context.domElement.querySelector("button#toggle-spectator-view");if(!!e&&(e.disabled=!0,e.firstChild&&(this._sessionHasStarted?e.firstChild.textContent=this.firstPersonMode?"\u{1F441}\uFE0F":"\u{1F4F7}":e.firstChild.textContent="Waiting for VR session"),((t=e.children)==null?void 0:t.length)>1)){const s=e.children[1];s.style.display=this._sessionHasStarted?"block":"none",this.firstPersonMode?s.textContent="First-Person View. See what the person in VR sees":s.textContent="Third-Person View. Freely move the camera around"}}isSupportedPlatform(){const e=window.navigator.userAgent,t=/Windows|MacOS/.test(e),s=/Windows NT/.test(e)&&/Edg/.test(e)&&!/Win64/.test(e);return t&&!s}onXRSessionRequestStart(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.remove("hidden"),p.setActive(this.gameObject,!0),this.cam&&this.cam.cam&&(D(this.cam.cam,this._orbitStartPos),Z(this.cam.cam,this._orbitStartRot),D(this.cam.gameObject,this._orbitStartPos2),Z(this.cam.gameObject,this._orbitStartRot2)),this.firstPersonMode?this.enableFirstPersonMode():this.enableThirdPersonMode()}onXRSessionStart(e){this._sessionHasStarted=!0,this.updateUI()}onXRSessionEnded(e){var t;this._sessionHasStarted=!1,(t=this.spectatorUIDomElement)==null||t.classList.add("hidden"),p.setActive(this.gameObject,!1)}onAfterRender(){var l,c,h;if(!this.cam)return;if(this.firstPersonMode&&!this._firstPersonIsSetup&&(!this._avatar||((l=this._avatar)==null?void 0:l.destroyed))){for(const d of ee.instances)if(d.avatar&&"isLocalAvatar"in d.avatar&&((c=d.avatar)==null?void 0:c.isLocalAvatar)){this._avatar=d;const u=d.avatar.head;if(!u)continue;this.setupFollowMode(u)}}const e=this.context.renderer,t=e.xr.enabled;if(!e.xr.isPresenting)return;const s=e.getRenderTarget();let n=null;if(!s){if(!e.state.bindFramebuffer||!e.state.bindXRFramebuffer)return;n=e._framebuffer,e.state.bindXRFramebuffer(null)}this.setAvatarFlagsBeforeRender(),e.setClearColor(new f(1,1,1)),e.setRenderTarget(null),e.xr.enabled=!1;const o=(h=this.cam)==null?void 0:h.cam;this.context.updateAspect(o);const a=e.xr.isPresenting;e.xr.isPresenting=!1,e.setSize(this.context.domWidth,this.context.domHeight),e.render(this.context.scene,o),e.xr.isPresenting=a,e.xr.enabled=t,s?e.setRenderTarget(s):e.state.bindXRFramebuffer(n),this.resetAvatarFlags()}setupFollowMode(e,t=!0){if(!e||!this.cam||this._firstPersonIsSetup)return;this._firstPersonIsSetup=!0;const s=e.add(new S);s.add(new Ei),this.firstPersonFollow=p.addNewComponent(this.cam.gameObject,In),this.firstPersonFollow.target=s,this.firstPersonFollow.followFactor=12,this.firstPersonFollow.rotateFactor=5,t&&(this.firstPersonFollow.flipForward=!0);const n=this.context.mainCamera;n&&(this.cam.cam.near=n.near,this.cam.cam.far=n.far,this.cam.cam.updateProjectionMatrix()),this.orbit&&(this.orbit.enabled=!1)}setAvatarFlagsBeforeRender(){for(const e of ee.instances)if(e.avatar&&"isLocalAvatar"in e.avatar){const t=this.firstPersonMode&&this._firstPersonIsSetup&&e.avatar.isLocalAvatar?Q.FirstPerson:Q.ThirdPerson,s=e.avatar.flags;if(!s)continue;for(const n of s)n.UpdateVisible(t)}}resetAvatarFlags(){var e;for(const t of ee.instances)if(t.avatar&&"flags"in t.avatar){const s=t.avatar.flags;if(!s)continue;for(const n of s)((e=t.avatar)==null?void 0:e.isLocalAvatar)?n.UpdateVisible(Q.FirstPerson):n.UpdateVisible(Q.ThirdPerson)}}}Db(_d,"SpectatorCamera");var bd=Object.defineProperty,Mb=Object.getOwnPropertyDescriptor,Ib=(i,e)=>bd(i,"name",{value:e,configurable:!0}),yd=(i,e,t,s)=>{for(var n=s>1?void 0:s?Mb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&bd(e,t,n),n};class Un extends v{constructor(){super(...arguments);r(this,"attachedRigidbody",null);r(this,"isTrigger",!1);r(this,"radius",.5);r(this,"center",new y(0,0,0));r(this,"_shape",null)}onEnable(){this._shape||(this._shape=this.context.physics.addSphereCollider(this.gameObject,this.center,this.radius,this.attachedRigidbody))}}Ib(Un,"SphereCollider");yd([_(Ee)],Un.prototype,"attachedRigidbody",2);yd([_(y)],Un.prototype,"center",2);var jb=Object.defineProperty,Fb=(i,e)=>jb(i,"name",{value:e,configurable:!0});class vd extends v{constructor(){super(...arguments);r(this,"anchor",null);r(this,"connectedBody",null);r(this,"connectedAnchor",null);r(this,"spring",10);r(this,"damper",.2);r(this,"rb",null)}awake(){if(this.rb=p.getComponent(this.gameObject,Ee),!this.connectedBody||!this.connectedBody.body||!this.rb||!this.rb.body)return;this.connectedBody.body.mass=Math.min(this.rb.body.mass*.99,this.connectedBody.body.mass);const e=new kp(this.rb.body,this.connectedBody.body,{restLength:.01,stiffness:this.spring*.5,damping:this.damper});this.context.physics.addPostStepListener(t=>{e.applyForce()})}update(){}}Fb(vd,"SpringJoint");var wd=Object.defineProperty,Bb=Object.getOwnPropertyDescriptor,Nn=(i,e)=>wd(i,"name",{value:e,configurable:!0}),zn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Bb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&wd(e,t,n),n},xd;(function(i){i[i.Simple=0]="Simple",i[i.Sliced=1]="Sliced",i[i.Tiled=2]="Tiled"})(xd||(xd={}));class Ub{constructor(){r(this,"x");r(this,"y")}}Nn(Ub,"Vec2");class qo{constructor(){r(this,"texture");r(this,"triangles");r(this,"uv");r(this,"vertices");r(this,"_geometry")}}Nn(qo,"Sprite");zn([_(Rs)],qo.prototype,"texture",2);class Xo{static getOrCreateGeometry(e){if(e._geometry)return e._geometry;const t=new Ts;e._geometry=t;const s=new Float32Array(e.triangles.length*3),n=new Float32Array(e.triangles.length*2);for(let o=0;o<e.triangles.length;o+=1){const a=e.triangles[o];s[o*3]=-e.vertices[a].x,s[o*3+1]=e.vertices[a].y,s[o*3+2]=0;const l=e.uv[a];n[o*2]=l.x,n[o*2+1]=1-l.y}return t.setAttribute("position",new Ti(s,3)),t.setAttribute("uv",new Ti(n,2)),t}}Nn(Xo,"SpriteUtils");class ns extends v{constructor(){super(...arguments);r(this,"drawMode",0);r(this,"size",{x:1,y:1});r(this,"color");r(this,"sharedMaterial");r(this,"_sprite");r(this,"_currentSprite")}get sprite(){return this._sprite}set sprite(e){e!==this._sprite&&(this._sprite=e,this.updateSprite())}awake(){this._currentSprite=void 0}start(){this.drawMode===2&&console.warn("Tiled draw mode is not supported yet",this),this._currentSprite?this.gameObject&&this.gameObject.add(this._currentSprite):this.updateSprite()}updateSprite(){if(!!this.__didAwake&&!!this.sprite&&!!this.sharedMaterial){if(this._currentSprite)this._currentSprite.geometry=Xo.getOrCreateGeometry(this.sprite),this._currentSprite.material.map=this.sprite.texture;else{const e=new Ai({color:16777215,side:al});if(!e)return;if(this.color&&(e.color||(e.color=new f),e.color.copy(this.color),e.opacity=this.color.alpha),e.alphaTest=.5,this.sprite.texture&&!e.wireframe){const t=this.sprite.texture;e.map=t}this._currentSprite=new kt(Xo.getOrCreateGeometry(this.sprite),e)}this._currentSprite.parent!==this.gameObject&&(this.drawMode===2&&this._currentSprite.scale.set(this.size.x,this.size.y,1),this.gameObject&&this.gameObject.add(this._currentSprite))}}}Nn(ns,"SpriteRenderer");zn([_()],ns.prototype,"drawMode",2);zn([_(Re)],ns.prototype,"color",2);zn([_(Lp)],ns.prototype,"sharedMaterial",2);var Nb=Object.defineProperty,zb=(i,e)=>Nb(i,"name",{value:e,configurable:!0});class Ae{constructor(){r(this,"bb",null);r(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsSyncedCameraModel(e,t){return(t||new Ae).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsSyncedCameraModel(e,t){return e.setPosition(e.position()+Lr),(t||new Ae).__init(e.readInt32(e.position())+e.position(),e)}userId(e){const t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}guid(e){const t=this.bb.__offset(this.bb_pos,6);return t?this.bb.__string(this.bb_pos+t,e):null}dontSave(){const e=this.bb.__offset(this.bb_pos,8);return e?!!this.bb.readInt8(this.bb_pos+e):!1}pos(e){const t=this.bb.__offset(this.bb_pos,10);return t?(e||new oe).__init(this.bb_pos+t,this.bb):null}rot(e){const t=this.bb.__offset(this.bb_pos,12);return t?(e||new oe).__init(this.bb_pos+t,this.bb):null}static startSyncedCameraModel(e){e.startObject(5)}static addUserId(e,t){e.addFieldOffset(0,t,0)}static addGuid(e,t){e.addFieldOffset(1,t,0)}static addDontSave(e,t){e.addFieldInt8(2,+t,0)}static addPos(e,t){e.addFieldStruct(3,t,0)}static addRot(e,t){e.addFieldStruct(4,t,0)}static endSyncedCameraModel(e){return e.endObject()}static finishSyncedCameraModelBuffer(e,t){e.finish(t)}static finishSizePrefixedSyncedCameraModelBuffer(e,t){e.finish(t,void 0,!0)}}zb(Ae,"SyncedCameraModel");var Pd=Object.defineProperty,$b=Object.getOwnPropertyDescriptor,Od=(i,e)=>Pd(i,"name",{value:e,configurable:!0}),Cd=(i,e,t,s)=>{for(var n=s>1?void 0:s?$b(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Pd(e,t,n),n};const $n="SCAM";qs($n,Ae.getRootAsSyncedCameraModel);const ge=new As;class Sd{constructor(e,t){r(this,"userId");r(this,"guid");this.guid=t,this.userId=e}send(e,t){var n;const s=(n=e.cam)==null?void 0:n.cam;if(s){ge.clear();const o=ge.createString(this.guid),a=ge.createString(this.userId);Ae.startSyncedCameraModel(ge),Ae.addGuid(ge,o),Ae.addUserId(ge,a);const l=C(s),c=Vr(s);Ae.addPos(ge,oe.createVec3(ge,l.x,l.y,l.z)),Ae.addRot(ge,oe.createVec3(ge,c.x,c.y,c.z));const h=Ae.endSyncedCameraModel(ge);ge.finish(h,$n),t.sendBinary(ge.asUint8Array())}}}Od(Sd,"CameraModel");class Wn extends v{constructor(){super(...arguments);r(this,"cam",null);r(this,"cameraPrefab",null);r(this,"_lastWorldPosition");r(this,"_lastWorldQuaternion");r(this,"_model",null);r(this,"_needsUpdate",!0);r(this,"_lastUpdateTime",0);r(this,"remoteCams",{});r(this,"userToCamMap",{});r(this,"_camTimeoutInSeconds",10);r(this,"_receiveCallback",null)}getUserCamera(e){const t=this.userToCamMap[e];return t?this.remoteCams[t].obj:null}async awake(){this._lastWorldPosition=this.worldPosition.clone(),this._lastWorldQuaternion=this.worldQuaternion.clone(),this.cameraPrefab&&("uri"in this.cameraPrefab&&(this.cameraPrefab=await this.cameraPrefab.instantiate(this.gameObject)),this.cameraPrefab&&"isObject3D"in this.cameraPrefab&&(this.cameraPrefab.visible=!1))}start(){var e;this.cam||(console.warn("Missing camera, fallback to main camera",this),this.cam=(e=this.context.mainCameraComponent)!=null?e:null)}onEnable(){this._receiveCallback=this.context.connection.beginListenBinrary($n,this.onReceivedRemoteCameraInfoBin.bind(this))}onDisable(){this.context.connection.stopListenBinary($n,this._receiveCallback)}update(){for(const s in this.remoteCams){const n=this.remoteCams[s],o=this.context.time.realtimeSinceStartup-n.lastUpdate;if(!n||o>this._camTimeoutInSeconds){console.log("Remote cam timeout",n,o),(n==null?void 0:n.obj)&&p.destroy(n.obj),delete this.remoteCams[s],n&&delete this.userToCamMap[n.userId];continue}}if(T.IsInWebXR)return;if(this.cam===null){this.enabled=!1;return}if(!this.context.connection.isConnected||this.context.connection.connectionId===null)return;this._model===null&&(this._model=new Sd(this.context.connection.connectionId,this.context.connection.connectionId+"_camera"));const e=C(this.cam.cam),t=J(this.cam.cam);(e.distanceTo(this._lastWorldPosition)>.001||t.angleTo(this._lastWorldQuaternion)>.01)&&(this._needsUpdate=!0),this._lastWorldPosition.copy(e),this._lastWorldQuaternion.copy(t),!((!this._needsUpdate||this.context.time.frameCount%2!=0)&&!(this.context.time.realtimeSinceStartup-this._lastUpdateTime>this._camTimeoutInSeconds*.5))&&(this._lastUpdateTime=this.context.time.realtimeSinceStartup,this._needsUpdate=!1,this._model.send(this,this.context.connection))}onReceivedRemoteCameraInfoBin(e){const t=e.guid();if(!t)return;const s=e.userId();if(!s||!this.context.connection.userIsInRoom(s)||!this.cameraPrefab)return;let n=this.remoteCams[t];if(!n)if("isObject3D"in this.cameraPrefab){const c=new Ce;c.context=this.context;const h=p.instantiate(this.cameraPrefab,c);n=this.remoteCams[t]={obj:h,lastUpdate:this.context.time.realtimeSinceStartup,userId:s},n.obj.visible=!0,this.gameObject.add(h),this.userToCamMap[s]=t;const d=p.getOrAddComponent(h,ee);d.connectionId=s,d.avatar=h}else return;const o=n.obj;n.lastUpdate=this.context.time.realtimeSinceStartup,de.markDirty(o);const a=e.pos();a&&Ls(o,a.x(),a.y(),a.z());const l=e.rot();l&&Ms(o,l.x(),l.y(),l.z())}}Od(Wn,"SyncedCamera");Cd([_(N)],Wn.prototype,"cam",2);Cd([_([S,Ue])],Wn.prototype,"cameraPrefab",2);var Rd=Object.defineProperty,Wb=Object.getOwnPropertyDescriptor,Hb=(i,e)=>Rd(i,"name",{value:e,configurable:!0}),rs=(i,e,t,s)=>{for(var n=s>1?void 0:s?Wb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Rd(e,t,n),n};const Yo="view",Ed=w("debugsyncedroom");class Ht extends v{constructor(){super(...arguments);r(this,"roomName");r(this,"urlParameterName");r(this,"joinRandomRoom",!0);r(this,"requireRoomParameter",!1);r(this,"autoRejoin",!0);r(this,"_roomPrefix");r(this,"_lastPingTime",0);r(this,"_lastRoomTime",-1)}awake(){this._roomPrefix===void 0&&(this._roomPrefix=this.roomName,this.roomName="")}onEnable(){const e=w(Yo);if(e&&typeof e=="string"&&e.length>0){console.log("Join as viewer"),this.context.connection.joinRoom(e,!0);return}this.tryJoinRoom()}onDisable(){this.roomName&&this.roomName.length>0&&this.context.connection.leaveRoom(this.roomName)}tryJoinRoom(e=0){let t=!1;if(this.urlParameterName){const s=w(this.urlParameterName);if(s&&typeof s=="string"){t=!0;const n=yl(s);this.roomName=n}else if(this.joinRandomRoom&&(console.log("No room name found in url, generating random one"),this.setRandomRoomUrlParameter(),e<1))return this.tryJoinRoom(e+1)}else this.joinRandomRoom&&(this.roomName===null||this.roomName===void 0||this.roomName.length<=0)&&(console.log("generate room name"),this.roomName=this.generateRoomName());return this.requireRoomParameter&&!t?(Ed&&console.log('No required room parameter "'+this.urlParameterName+'" in url - will not connect to networking backend.'),!1):!this.roomName||this.roomName.length<=0?(Ed&&console.error('Missing room name on "'+this.name+'". Make sure this is correctly configured in Unity',this.context.connection.isDebugEnabled?this:""),!1):(this.context.connection.isConnected||this.context.connection.connect(),this._roomPrefix&&(this.roomName=this._roomPrefix+this.roomName),this.context.connection.joinRoom(this.roomName),!0)}update(){this.context.connection.isConnected&&(this.context.time.time-this._lastPingTime>3&&(this._lastPingTime=this.context.time.time,this.context.connection.send("ping",{time:this.context.time.time})),this.context.connection.isInRoom&&(this._lastRoomTime=this.context.time.time)),this._lastRoomTime>0&&this.context.time.time-this._lastRoomTime>.3&&(this._lastRoomTime=-1,this.autoRejoin?(console.log("Disconnected from networking backend - attempt reconnecting now"),this.tryJoinRoom()):console.warn("You are not connected to a room anymore (possibly because the tab was inactive for too long and the server kicked you)"))}get currentRoomName(){const e=w(Yo);return e||w(this.urlParameterName)}setRandomRoomUrlParameter(){const e=Di(),t=this.generateRoomName();w(this.urlParameterName)?e.set(this.urlParameterName,t):e.append(this.urlParameterName,t),Fr(t,e)}generateRoomName(){return bl()+"_"+ml(100,999)}getViewOnlyUrl(){if(this.context.connection.isConnected&&this.context.connection.currentRoomViewId){const e=window.location.search,t=new URLSearchParams(e);return t.has(this.urlParameterName)&&t.delete(this.urlParameterName),t.set(Yo,this.context.connection.currentRoomViewId),window.location.origin+window.location.pathname+"?"+t.toString()}return null}}Hb(Ht,"SyncedRoom");rs([_()],Ht.prototype,"roomName",2);rs([_()],Ht.prototype,"urlParameterName",2);rs([_()],Ht.prototype,"joinRandomRoom",2);rs([_()],Ht.prototype,"requireRoomParameter",2);rs([_()],Ht.prototype,"autoRejoin",2);var Gb=Object.defineProperty,Ad=(i,e)=>Gb(i,"name",{value:e,configurable:!0});function Td(){const i=w("testwindowcount")||0;i&&i>0&&kd(i)}Ad(Td,"detect_run_tests");function kd(i){if(w("testwindow"))return null;const e=new URL(window.location.href);Mi(e.searchParams,mn,1),Mi(e.searchParams,"testwindow",1);const t=e.toString(),s=[];window.onbeforeunload=()=>{for(const c of s)c.close()};const n=.05,o=128;let a=0,l=0;for(let c=0;c<i;c++){a*o+o*.01>=window.innerWidth&&(l+=1,a=0);const h=a*(o*(1+n))+window.screenLeft,d=l*(o*(1+n))+window.screenTop+90+60*l;a+=1;const u=window.open(t,"test window "+c,`popup=yes width=${o} height=${o} top=${d} left=${h}`);if(!u){console.warn("Failed to open window");continue}s.push(u),u.onload=()=>{u.onbeforeunload=()=>{for(let g=0;g<s.length;g++){const b=s[g];b!==u&&b.close()}s.length=0}}}return s}Ad(kd,"spawnWindows");var Vb=Object.defineProperty,Qo=(i,e)=>Vb(i,"name",{value:e,configurable:!0});class Ld extends v{awake(){Td()}}Qo(Ld,"TestRunner");class Dd extends v{constructor(){super(...arguments);r(this,"transformsPerFrame",10);r(this,"interval",0);r(this,"useFlatbuffers",!0);r(this,"builder",null);r(this,"models",null)}awake(){if(this.useFlatbuffers)this.context.connection.beginListenBinrary(Yi,e=>{});else{this.models=[];for(let e=0;e<this.transformsPerFrame;e++)this.models.push(new Jo(this.context.connection.connectionId+"_simulatedTransform_"+e,this))}}update(){if(!!this.context.connection.isConnected){if(this.useFlatbuffers){if(!this.context.connection.connectionId||this.context.time.frameCount%this.interval!=0)return;this.builder===null&&(this.builder=new As(1024));const e=this.builder;for(let t=0;t<this.transformsPerFrame;t++){e.clear();const s=So(this.context.connection.connectionId,this);this.context.connection.sendBinary(s)}}else if(this.models)for(let e=0;e<this.models.length;e++){const t=this.models[e];t.dontSave=!0,t.update(this,null),this.context.connection.send("TestSimulateUserData-"+e,t)}}}}Qo(Dd,"TestSimulateUserData");class Jo{constructor(e,t){r(this,"guid");r(this,"fast",!1);r(this,"position");r(this,"rotation");r(this,"velocity");r(this,"dontSave");this.guid=e,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:0},this.update(t,null)}isValid(){return this.fast!==void 0||this.position!==void 0||this.rotation!==void 0||this.velocity!==void 0}update(e,t){const s=e.worldPosition;this.position.x=s.x,this.position.y=s.y,this.position.z=s.z;const n=e.worldQuaternion;if(this.rotation.x=n.x,this.rotation.y=n.y,this.rotation.z=n.z,this.rotation.w=n.w,this.fast=!1,t){const o=t.getVelocity();this.velocity===void 0&&(this.velocity={x:0,y:0,z:0}),this.velocity.x=o.x,this.velocity.y=o.y,this.velocity.z=o.z}}}r(Jo,"temp",new y);Qo(Jo,"TransformModel");var Md=Object.defineProperty,qb=Object.getOwnPropertyDescriptor,Xb=(i,e)=>Md(i,"name",{value:e,configurable:!0}),Yb=(i,e,t,s)=>{for(var n=s>1?void 0:s?qb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Md(e,t,n),n};class Zo extends v{constructor(){super(...arguments);r(this,"isGizmo",!0);r(this,"control");r(this,"orbit");r(this,"changeEventListener");r(this,"windowKeyDownListener");r(this,"windowKeyUpListener")}awake(){this.isGizmo&&!Bi||!this.context.mainCamera||(this.control=new Dp(this.context.mainCamera,this.context.renderer.domElement),this.control.visible=!0,this.control.enabled=!0,this.control.getRaycaster().layers.set(2),this.control.size=.6,this.control.traverse(e=>{const t=e;if(t.layers.set(2),t){const s=t.material;s&&(s.opacity=.3)}}))}start(){var e;if(this.context.mainCamera){const t=(e=p.getComponentInParent(this.context.mainCamera,Qa))!=null?e:void 0;this.orbit=t}}onEnable(){var e;this.control&&(this.context.scene.add(this.control),this.control.attach(this.gameObject)),this.changeEventListener=this.onControlChangedEvent.bind(this),(e=this.control)==null||e.addEventListener("dragging-changed",this.changeEventListener),this.attachWindowEvents()}onDisable(){var e,t;(e=this.control)==null||e.removeFromParent(),this.changeEventListener&&((t=this.control)==null||t.removeEventListener("dragging-changed",this.changeEventListener))}onControlChangedEvent(e){const t=this.orbit;if(t&&(t.enabled=!e.value),e.value){const s=p.getComponentInParent(this.gameObject,_t);s&&s.requestOwnership()}}attachWindowEvents(){const e=this.control;!e||(this.windowKeyDownListener||(this.windowKeyDownListener=t=>{switch(t.keyCode){case 81:e.setSpace(e.space==="local"?"world":"local");break;case 16:e.setTranslationSnap(100),e.setRotationSnap(Mp.degToRad(15)),e.setScaleSnap(.25);break;case 87:e.setMode("translate");break;case 69:e.setMode("rotate");break;case 82:e.setMode("scale");break;case 187:case 107:e.setSize(e.size+.1);break;case 189:case 109:e.setSize(Math.max(e.size-.1,.1));break;case 88:e.showX=!e.showX;break;case 89:e.showY=!e.showY;break;case 90:e.showZ=!e.showZ;break;case 32:e.enabled=!e.enabled;break}}),this.windowKeyUpListener||(this.windowKeyUpListener=t=>{switch(t.keyCode){case 16:e.setTranslationSnap(null),e.setRotationSnap(null),e.setScaleSnap(null);break}}),window.addEventListener("keydown",this.windowKeyDownListener),window.addEventListener("keyup",this.windowKeyUpListener))}}Xb(Zo,"TransformGizmo");Yb([_()],Zo.prototype,"isGizmo",2);var Id=Object.defineProperty,Qb=Object.getOwnPropertyDescriptor,Gt=(i,e)=>Id(i,"name",{value:e,configurable:!0}),jd=(i,e,t,s)=>{for(var n=s>1?void 0:s?Qb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Id(e,t,n),n},Fd;(function(i){i[i.None=0]="None",i[i.Neutral=1]="Neutral",i[i.ACES=2]="ACES"})(Fd||(Fd={}));class Bd{constructor(){r(this,"overrideState",!1);r(this,"value",0)}}Gt(Bd,"VolumeParameter");class ui{constructor(){r(this,"active",!1);r(this,"parameters")}}Gt(ui,"VolumeComponent");class Hn extends ui{constructor(){super(...arguments);r(this,"mode")}get isToneMapping(){return!0}}Gt(Hn,"ToneMapping");class Gn extends ui{constructor(){super(...arguments);r(this,"postExposure")}}Gt(Gn,"ColorAdjustments");function Ud(i){return"mode"in i?Hn:"postExposure"in i?Gn:ui}Gt(Ud,"resolveComponentType");class Vn{constructor(){r(this,"components")}apply(e){var t,s,n,o,a;if(!!this.components){for(const l of this.components)if(l instanceof Hn){const c=l;if(!l.active){e.renderer.toneMapping=ll;continue}switch((s=(t=c.mode)==null?void 0:t.value)!=null?s:0){case 0:e.renderer.toneMapping=ll;break;case 1:e.renderer.toneMapping=jp;break;case 2:e.renderer.toneMapping=Ip;break}}else if(l instanceof Gn){const c=l;console.log(c.postExposure);const h=Math.pow(2,(o=(n=c.postExposure)==null?void 0:n.value)!=null?o:0);e.renderer.toneMappingExposure=((a=c.postExposure)==null?void 0:a.overrideState)?h:1}}}}Gt(Vn,"VolumeProfile");jd([_([i=>Ud(i),ui])],Vn.prototype,"components",2);class Ko extends v{constructor(){super(...arguments);r(this,"sharedProfile")}onEnable(){var e;(e=this.sharedProfile)==null||e.apply(this.context)}}Gt(Ko,"Volume");jd([_(Vn)],Ko.prototype,"sharedProfile",2);var Jb=Object.defineProperty,Nd=(i,e)=>Jb(i,"name",{value:e,configurable:!0}),St;(function(i){i.StartOrUpdate="xr-grab-visual-start-or-update",i.End="xr-grab-visual-end"})(St||(St={}));class ea{constructor(){r(this,"guid");r(this,"dontSave",!0);r(this,"userId");r(this,"point",{x:0,y:0,z:0});r(this,"source",{x:0,y:0,z:0});r(this,"target")}update(e,t,s,n=void 0){this.userId=e.connection.connectionId,this.point.x=t.x,this.point.y=t.y,this.point.z=t.z,this.source.x=s.x,this.source.y=s.y,this.source.z=s.z,this.target=n}}Nd(ea,"XRGrabModel");class zd extends v{constructor(){super(...arguments);r(this,"prefab",null);r(this,"_grabModels",[]);r(this,"_grabModelsUpdateTime",[]);r(this,"_addOrUpdateSub",null);r(this,"_endSub",null);r(this,"_freeSub",null);r(this,"_instances",{});r(this,"temp",new y)}awake(){this.prefab&&(this.prefab.visible=!1)}onEnable(){this._addOrUpdateSub=this.context.connection.beginListen(St.StartOrUpdate,this.onRemoteGrabStartOrUpdate.bind(this)),this._endSub=this.context.connection.beginListen(St.End,this.onRemoteGrabEnd.bind(this)),this._freeSub=Be.AddEventListener(wn.WillFree,this.onAttachedObjectFree.bind(this))}onDisable(){this.context.connection.stopListening(St.StartOrUpdate,this._addOrUpdateSub),this.context.connection.stopListening(St.End,this._endSub),Be.RemoveEventListener(wn.WillFree,this._freeSub)}addOrUpdateGrab(e){this.context.connection.send(St.StartOrUpdate,e,Fi.Queued)}endGrab(e){this.context.connection.send(St.End,e,Fi.Queued)}onRemoteGrabStartOrUpdate(e){if(!this.prefab)return;const t=this._instances[e.guid];if(!t){const s=p.instantiate(this.prefab);if(s.visible=!0,this._instances[e.guid]={instance:s,model:e},e.userId){const n=p.getComponentsInChildren(s,Ct);if((n==null?void 0:n.length)>0)for(const o of n)o.assignUserColor(e.userId)}return}t.model=e}onRemoteGrabEnd(e){if(!e)return;const t=e.guid;this._instances[t]&&(p.destroy(this._instances[t].instance),delete this._instances[t])}onAttachedObjectFree(e){if(this._grabModels.length<=0)return;const t=this._grabModels[0];this.updateModel(t,e),this.endGrab(t)}onBeforeRender(){if(this.updateRendering(),!!this.prefab&&(this.prefab.visible=!1,this.context.time.frameCount%10==0))for(let e=0;e<Be.Current.length;e++){const t=Be.Current[e];if(!t.controller||!t.selected)continue;this._grabModels.length<=e&&(this._grabModels.push(new ea),this._grabModelsUpdateTime.push(0)),this._grabModelsUpdateTime[e]=this.context.time.time;const s=this._grabModels[e];this.updateModel(s,t),this.addOrUpdateGrab(s)}}updateModel(e,t){if(!t.controller||!t.selected)return;e.guid=t.grabUUID;const s=t.selected.guid;e.update(this.context,t.grabPoint,t.controller.worldPosition,s)}updateRendering(){const e=this.context.time.deltaTime/.5;for(const t in this._instances){const{instance:s,model:n}=this._instances[t];if(!s||!n)continue;const{point:o}=n,a=C(s);this.temp.set(o.x,o.y,o.z),a.lerp(this.temp,e),D(s,a)}}}Nd(zd,"XRGrabRendering");var $d=Object.defineProperty,Zb=Object.getOwnPropertyDescriptor,Kb=(i,e)=>$d(i,"name",{value:e,configurable:!0}),qn=(i,e,t,s)=>{for(var n=s>1?void 0:s?Zb(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&$d(e,t,n),n};class fi extends v{constructor(){super(...arguments);r(this,"eyes",[]);r(this,"lastBlinkTime",0);r(this,"blinkLength",0);r(this,"eyesOpen",!0);r(this,"state",null)}awake(){this.state=p.getComponentInParent(this.gameObject,K)}update(){if(!this.gameObject||!this.gameObject.visible||!this.eyes||!Array.isArray(this.eyes)||this.eyes.length===0)return;if(this.context.time.time-this.lastBlinkTime>this.blinkLength){if(this.lastBlinkTime=this.context.time.time,this.state&&!this.state.isOn||!this.activeAndEnabled)return;if(this.eyesOpen=!this.eyesOpen,this.blinkLength=Math.random(),this.eyesOpen?(this.blinkLength*=3,this.blinkLength+=.5,Math.random()<.1&&(this.blinkLength=.1+Math.random()*.2)):(this.blinkLength*=Math.random()*.2,this.blinkLength+=.1),Math.random()<.1&&(this.blinkLength*=3),this.blinkLength=Math.max(.2,this.blinkLength),this.blinkLength=Math.min(3,this.blinkLength),this.eyes)for(const t of this.eyes)t&&(t.visible=this.eyesOpen)}}}Kb(fi,"AvatarBlink_Simple");qn([_(S)],fi.prototype,"eyes",2);qn([_()],fi.prototype,"lastBlinkTime",2);qn([_()],fi.prototype,"blinkLength",2);qn([_()],fi.prototype,"eyesOpen",2);var Wd=Object.defineProperty,ey=Object.getOwnPropertyDescriptor,ty=(i,e)=>Wd(i,"name",{value:e,configurable:!0}),ta=(i,e,t,s)=>{for(var n=s>1?void 0:s?ey(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Wd(e,t,n),n},$a;const Hd=($a=class extends v{constructor(){super(...arguments);r(this,"head",null);r(this,"eyes",null);r(this,"target",null);r(this,"brain",null);r(this,"vec",new y);r(this,"currentTargetPoint",new y)}awake(){this.brain||(this.brain=p.getComponentInParent(this.gameObject,bn)),this.brain||(console.log("No look at brain found, adding it now"),this.brain=p.addNewComponent(this.gameObject,bn)),this.brain&&this.target&&(this.brain.controlledTarget=this.target)}update(){const i=this.target;if(i&&this.head){const e=this.eyes;if(e){const t=C(i);this.currentTargetPoint.lerp(t,this.context.time.deltaTime/.1);const s=C(this.head),n=this.vec.copy(this.currentTargetPoint).sub(s).normalize();if(n.length()<.1)return;const o=Hd.forward;if(o.set(0,0,1),o.applyQuaternion(J(this.head)),o.dot(n)>.45)for(let l=0;l<e.length;l++)e[l].lookAt(this.currentTargetPoint)}}}},r($a,"forward",new y(0,0,1)),$a);let os=Hd;ty(os,"AvatarEyeLook_Rotation");ta([_(S)],os.prototype,"head",2);ta([_(S)],os.prototype,"eyes",2);ta([_(S)],os.prototype,"target",2);var Gd=Object.defineProperty,iy=Object.getOwnPropertyDescriptor,sy=(i,e)=>Gd(i,"name",{value:e,configurable:!0}),Vd=(i,e,t,s)=>{for(var n=s>1?void 0:s?iy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Gd(e,t,n),n};const ny=w("debugmouth");class Xn extends v{constructor(){super(...arguments);r(this,"idle",[]);r(this,"talking",[]);r(this,"marker",null);r(this,"voip",null);r(this,"lastMouthChangeTime",0);r(this,"mouthChangeLength",0)}awake(){this.voip=p.findObjectOfType(bt,this.context),console.log(this)}update(){var s,n;if(!this.voip||this.context.time.frameCount%10!=0)return;let e=(n=(s=this.marker)==null?void 0:s.connectionId)!=null?n:null;e||ny&&(e=null);const t=this.voip.getFrequency(e);t!=null&&this.updateLips(t)}updateLips(e){if(this.context.time.time-this.lastMouthChangeTime>this.mouthChangeLength){if(this.mouthChangeLength=.05+Math.random()*.1,this.talking&&this.talking.length>0&&e>50){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.talking.length);this.setMouthShapeActive(this.talking,t)}else if(this.idle.length>0&&this.context.time.time-this.lastMouthChangeTime>.5){this.lastMouthChangeTime=this.context.time.time;const t=Math.floor(Math.random()*this.idle.length);this.setMouthShapeActive(this.idle,t)}}}setMouthShapeActive(e,t){if(!!e){e!=this.idle?this.idle.map(s=>s.visible=!1):this.talking.map(s=>s.visible=!1);for(let s=0;s<e.length;s++){const n=e[s];n&&(n.visible=s===t,n.scale.set(1,1,1))}}}}sy(Xn,"Avatar_MouthShapes");Vd([_(S)],Xn.prototype,"idle",2);Vd([_(S)],Xn.prototype,"talking",2);var ry=Object.defineProperty,oy=(i,e)=>ry(i,"name",{value:e,configurable:!0});class qd extends v{constructor(){super(...arguments);r(this,"voip",null);r(this,"marker",null);r(this,"_startPosition",null)}awake(){this.voip=p.findObjectOfType(bt,this.context),this.marker=p.getComponentInParent(this.gameObject,ee)}update(){if(!this.voip||!this.marker||this.context.time.frameCount%10!=0)return;const e=this.marker.connectionId,t=this.voip.getFrequency(e);if(t==null)return;this._startPosition||(this._startPosition=this.gameObject.position.clone());let s=t/100;this.gameObject.position.y=this._startPosition.y+s*.07}}oy(qd,"Avatar_MustacheShake");var ay=Object.defineProperty,ly=(i,e)=>ay(i,"name",{value:e,configurable:!0});const cy=w("logstats");class Xd extends v{onEnable(){console.log(this),cy&&this.startCoroutine(this.run(),xe.OnAfterRender)}*run(){for(;this.enabled;){const e=this.context.renderer.info;console.log(e.memory,e.render,e.programs),yield}}}ly(Xd,"LogStats");var Yd=Object.defineProperty,hy=Object.getOwnPropertyDescriptor,ia=(i,e)=>Yd(i,"name",{value:e,configurable:!0}),dy=(i,e,t,s)=>{for(var n=s>1?void 0:s?hy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Yd(e,t,n),n};class sa{constructor(){r(this,"guid")}}ia(sa,"SignalAsset");class na{constructor(){r(this,"signal");r(this,"reaction");r(this,"$serializedTypes",{signal:sa,reaction:tt})}}ia(na,"SignalReceiverEvent");class Yn extends v{constructor(){super(...arguments);r(this,"events")}start(){console.log(this)}invoke(e){if(!this.events||!Array.isArray(this.events))return;let t=typeof e=="object"?e.guid:e;for(const s of this.events)if(s.signal.guid===t)try{if(s.reaction){if(!s.reaction.invoke){console.warn("Missing invoke - possibly a serialization error",s,this);continue}}else{console.warn("Missing reaction for signal",s,this);continue}s.reaction.invoke()}catch(n){console.error(n)}}}ia(Yn,"SignalReceiver");dy([_(na)],Yn.prototype,"events",2);var Te;(function(i){i.Activation="ActivationTrack",i.Animation="AnimationTrack",i.Audio="AudioTrack",i.Control="ControlTrack",i.Marker="MarkerTrack",i.Signal="SignalTrack"})(Te||(Te={}));var as;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(as||(as={}));var ra;(function(i){i.Signal="SignalEmitter"})(ra||(ra={}));var uy=Object.defineProperty,pi=(i,e)=>uy(i,"name",{value:e,configurable:!0});const Qn=w("debugtimeline");class ls{constructor(){r(this,"director");r(this,"track")}get muted(){return this.track.muted}set muted(e){var t;e!==this.track.muted&&(this.track.muted=e,(t=this.onMuteChanged)==null||t.call(this))}*forEachClip(e=!1){var t;if(!!((t=this.track)==null?void 0:t.clips))if(e)for(let s=this.track.clips.length-1;s>=0;s--)yield this.track.clips[s];else for(const s of this.track.clips)yield s}getClipTime(e,t){return t.clipIn+(e-t.start)*t.timeScale}getClipTimeNormalized(e,t){return(e-t.start)/t.duration}evaluateWeight(e,t,s,n=!0){if(t<0||t>=s.length)return 0;const o=s[t];if(n||e>=o.start&&e<=o.end){let a=1,l=!1;return o.easeInDuration>0&&(a*=Math.min((e-o.start)/o.easeInDuration,1)),o.easeOutDuration>0&&!l&&(a*=Math.min((o.end-e)/o.easeOutDuration,1)),a}return 0}}pi(ls,"TrackHandler");class Qd{constructor(e){r(this,"clip");r(this,"rootPositionOffset");r(this,"rootQuaternionOffset");r(this,"rootStartPosition");r(this,"rootEndPosition");r(this,"rootStartQuaternion");r(this,"rootEndQuaternion");const t=e.getClip();this.clip=t;const s=e.getRoot(),n=s.name+".position",o=s.name+".quaternion";Qn&&console.log(t.name,t.tracks,n);for(const a of t.tracks)if(!(a.times.length<=0)){if(a.name.endsWith(n))this.rootStartPosition=new y().fromArray(a.values,0),this.rootEndPosition=new y().fromArray(a.values,a.values.length-3),this.rootPositionOffset=this.rootEndPosition.clone().sub(this.rootStartPosition),Qn&&console.log(this.rootPositionOffset);else if(a.name.endsWith(o)&&(this.rootStartQuaternion=new O().fromArray(a.values,0),this.rootEndQuaternion=new O().fromArray(a.values,a.values.length-4),this.rootQuaternionOffset=this.rootEndQuaternion.clone().multiply(this.rootStartQuaternion),Qn)){const l=new Pe().setFromQuaternion(this.rootQuaternionOffset);console.log("ROT",l)}}}get hasOffsets(){return this.rootPositionOffset!==void 0||this.rootQuaternionOffset!==void 0}}pi(Qd,"AnimationClipOffsetData");class oa extends ls{constructor(){super(...arguments);r(this,"models",[]);r(this,"trackOffset");r(this,"target");r(this,"mixer");r(this,"clips",[]);r(this,"actions",[]);r(this,"_actionOffsets",[]);r(this,"_didBind",!1);r(this,"_useclipOffsets",!0);r(this,"_totalOffsetPosition",new y);r(this,"_totalOffsetRotation",new O);r(this,"_totalOffsetPosition2",new y);r(this,"_totalOffsetRotation2",new O);r(this,"_summedPos",new y);r(this,"_tempPos",new y);r(this,"_summedRot",new O);r(this,"_tempRot",new O)}createHooks(e){for(const t of e.tracks)t.name.endsWith(".position")?this.createPositionInterpolant(t):t.name.endsWith(".quaternion")&&this.createRotationInterpolant(t)}bind(){if(!this._didBind){this._didBind=!0,Qn&&console.log(this.models),this.mixer?this.target=this.mixer.getRoot():console.warn("No mixer was assigned to animation track");for(const e of this.actions){const t=new Qd(e);this._actionOffsets.push(t)}for(const e of this.models){const t=e.asset,s=t.position,n=t.rotation;s.x!==void 0&&(s.isVector3||(t.position=new y(s.x,s.y,s.z)),n.isQuaternion||(t.rotation=new O(n.x,n.y,n.z,n.w)))}this.ensureTrackOffsets()}}ensureTrackOffsets(){if(this.trackOffset){const e=this.trackOffset.position;e&&(e.isVector3||(this.trackOffset.position=new y(e.x,e.y,e.z)));const t=this.trackOffset.rotation;t&&(t.isQuaternion||(this.trackOffset.rotation=new O(t.x,t.y,t.z,t.w)))}}evaluate(e){if(this.track.muted||!this.mixer)return;this.bind(),this._totalOffsetPosition.set(0,0,0),this._totalOffsetRotation.set(0,0,0,1),this._totalOffsetPosition2.set(0,0,0),this._totalOffsetRotation2.set(0,0,0,1);let t=0,s=0,n=!1;for(let o=0;o<this.clips.length;o++){const a=this.models[o],l=this.actions[o],c=a.asset;l.weight=0;const h=e>=a.start&&e<=a.end,d=a.postExtrapolationMode;let u=h;if(!u&&!n&&a.end<e&&a.postExtrapolationMode!==as.None){const g=o<this.clips.length-1?this.models[o+1]:null;(!g||g.start>e)&&(u=!0,n=!0)}if(u){let g=1;g*=this.evaluateWeight(e,o,this.models,u);let b=this.getClipTime(e,a),x=0;const P=c.duration;if(h){if(c.loop)for(x+=Math.floor(b/P);b>P;)b-=P}else if(!h)switch(d){case as.Loop:b%=P;break;case as.PingPong:const ce=Math.floor(b/P)%2!=0;b%=P,ce&&(b=P-b);break}l.time=b,l.timeScale=0;const R=g*this.director.weight;if(l.weight=R,l.clampWhenFinished=!0,l.isRunning()||l.play(),this._useclipOffsets){const M=t==0?this._totalOffsetPosition:this._totalOffsetPosition2,ce=t==0?this._totalOffsetRotation:this._totalOffsetRotation2;t<1&&(s=1-g),t+=1;const B=this._summedPos.set(0,0,0),k=this._tempPos.set(0,0,0),U=this._summedRot.identity(),Cs=this._tempRot.identity(),Ss=c.rotation,at=new O;at.slerp(Ss,g);const Ri=this._actionOffsets[o];if(Ri.hasOffsets)for(let Ha=0;Ha<x;Ha++)Ri.rootPositionOffset?k.copy(Ri.rootPositionOffset):k.set(0,0,0),k.applyQuaternion(U).applyQuaternion(at),Ri.rootQuaternionOffset&&(Cs.copy(Ri.rootQuaternionOffset),U.multiply(Cs)),B.add(k);ce.multiply(at),ce.multiply(U),B.add(c.position),M.add(B)}}}this._useclipOffsets&&(this._totalOffsetPosition.lerp(this._totalOffsetPosition2,s),this._totalOffsetRotation.slerp(this._totalOffsetRotation2,s)),this.mixer.update(e)}createRotationInterpolant(e){var o;const t=e.createInterpolant.bind(e),s=new O;this.ensureTrackOffsets();const n=(o=this.trackOffset)==null?void 0:o.rotation;e.createInterpolant=()=>{const a=t(),l=a.evaluate.bind(a);return a.evaluate=c=>{const h=l(c);return s.set(h[0],h[1],h[2],h[3]),s.premultiply(this._totalOffsetRotation),n&&s.premultiply(n),h[0]=s.x,h[1]=s.y,h[2]=s.z,h[3]=s.w,h},a}}createPositionInterpolant(e){var a,l;const t=e.createInterpolant.bind(e),s=new y;this.ensureTrackOffsets();const n=(a=this.trackOffset)==null?void 0:a.rotation,o=(l=this.trackOffset)==null?void 0:l.position;e.createInterpolant=()=>{const c=t(),h=c.evaluate.bind(c);return c.evaluate=d=>{const u=h(d);return s.set(u[0],u[1],u[2]),s.applyQuaternion(this._totalOffsetRotation),s.add(this._totalOffsetPosition),n&&s.applyQuaternion(n),o&&(s.x-=o.x,s.y+=o.y,s.z+=o.z),u[0]=s.x,u[1]=s.y,u[2]=s.z,u},c}}}pi(oa,"AnimationTrackHandler");class aa extends ls{constructor(){super(...arguments);r(this,"models",[]);r(this,"listener");r(this,"audio",[]);r(this,"audioContextTimeOffset",[]);r(this,"lastTime",0)}getAudioFilePath(e){const t=this.director.sourceId;return wl(t,e)}onAllowAudioChanged(e){for(let t=0;t<this.models.length;t++){const s=this.models[t];this.audio[t].setVolume(e?s.asset.volume:0)}}addModel(e){const t=this.getAudioFilePath(e.asset.clip),s=new el(this.listener);s.setVolume(e.asset.volume);const n=new Tr;console.log(t,this.director.sourceId),n.load(t,o=>{s.setBuffer(o),s.loop=e.asset.loop,this.audio.push(s),this.models.push(e)})}onDisable(){for(const e of this.audio)e.isPlaying&&e.stop()}onMuteChanged(){if(this.muted)for(let e=0;e<this.audio.length;e++){const t=this.audio[e];(t==null?void 0:t.isPlaying)&&t.stop()}}evaluate(e){if(!this.track.muted){for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.audio[t];if(e>=s.start&&e<=s.end){if(this.director.isPaused&&(n.isPlaying&&n.stop(),this.lastTime===e))continue;n.isPlaying||(n.offset=s.clipIn+(e-s.start)*s.timeScale,n.play());let o=s.asset.volume;s.easeInDuration>0&&(o*=Math.min((e-s.start)/s.easeInDuration,1)),s.easeOutDuration>0&&(o*=Math.min((s.end-e)/s.easeOutDuration,1)),n.setVolume(o*this.director.weight)}else n.isPlaying&&n.stop()}this.lastTime=e}}}pi(aa,"AudioTrackHandler");class Jn extends ls{constructor(){super(...arguments);r(this,"models",[]);r(this,"didTrigger",[]);r(this,"receivers",[])}evaluate(e){if(!(this.receivers.length<=0)&&!this.track.muted)for(let t=0;t<this.models.length;t++){const s=this.models[t],n=this.didTrigger[t],o=s.time-e;if(s.retroActive?o<0:o<0&&Math.abs(o)<.1){if(!n){this.didTrigger[t]=!0;for(const l of this.receivers)!l||l.invoke(s.asset)}}else s.emitOnce||(this.didTrigger[t]=!1)}}}pi(Jn,"SignalTrackHandler");const Os=class extends ls{constructor(){super(...arguments);r(this,"models",[]);r(this,"timelines",[]);r(this,"_previousActiveModel",null)}resolveSourceObjects(e){for(let t=this.models.length-1;t>=0;t--){const n=this.models[t].asset;if(typeof n.sourceObject=="string"){const o=n.sourceObject;Os.resolved[o]?n.sourceObject=Os.resolved[o]:(n.sourceObject=p.findByGuid(o,e.scene),Os.resolved[o]=n.sourceObject)}if(n.sourceObject){const o=p.getComponent(n.sourceObject,hs);this.timelines.push(o),o&&n.updateDirector&&(o.playOnAwake=!1)}else{this.models.splice(t,1);continue}}}evaluate(e){var t;this._previousActiveModel=null;for(let s=0;s<this.models.length;s++){const n=this.models[s],o=n.asset;if(e>=n.start&&e<=n.end){this._previousActiveModel=n;const a=this.getClipTime(e,n);if(o.controlActivation){const l=o.sourceObject;l.visible=!0}if(o.updateDirector){const l=this.timelines[s];l&&(l.isPlaying&&l.pause(),l.time=a,l.evaluate())}}else{const a=(t=this._previousActiveModel)==null?void 0:t.asset;if(o.controlActivation){const l=o.sourceObject;(a==null?void 0:a.sourceObject)!==l&&(l.visible=!1)}}}}};let cs=Os;r(cs,"resolved",{});pi(cs,"ControlTrackHandler");var fy=Object.defineProperty,py=(i,e)=>fy(i,"name",{value:e,configurable:!0});const Jd=w("debugtimeline");var Zd;(function(i){i[i.Hold=0]="Hold",i[i.Loop=1]="Loop",i[i.None=2]="None"})(Zd||(Zd={}));var Kd;(function(i){i[i.None=0]="None",i[i.Hold=1]="Hold",i[i.Loop=2]="Loop",i[i.PingPong=3]="PingPong",i[i.Continue=4]="Continue"})(Kd||(Kd={}));const vr=class extends v{constructor(){super(...arguments);r(this,"playableAsset");r(this,"playOnAwake");r(this,"extrapolationMode",1);r(this,"_visibilityChangeEvt");r(this,"_clonedPlayableAsset",!1);r(this,"_guidsMap");r(this,"_isPlaying",!1);r(this,"_internalUpdateRoutine");r(this,"_isPaused",!1);r(this,"_time",0);r(this,"_duration",0);r(this,"_weight",1);r(this,"_animationTracks",[]);r(this,"_audioTracks",[]);r(this,"_signalTracks",[]);r(this,"_controlTracks",[]);r(this,"_customTracks",[]);r(this,"_allTracks",[this._animationTracks,this._audioTracks,this._signalTracks,this._controlTracks,this._customTracks])}static registerCreateTrack(e,t){this.createTrackFunctions[e]=t}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get time(){return this._time}set time(e){this._time=e}get duration(){return this._duration}set duration(e){this._duration=e}get weight(){return this._weight}set weight(e){this._weight=e}awake(){var e,t,s;Jd&&console.log(this,(e=this.playableAsset)==null?void 0:e.tracks),this.rebuildGraph(),this.playOnAwake?this.play():this.evaluate(),this.isValid()||console.warn("PlayableDirector is not valid",this.playableAsset,(t=this.playableAsset)==null?void 0:t.tracks,Array.isArray((s=this.playableAsset)==null?void 0:s.tracks),this)}onEnable(){var e,t;for(const s of this._audioTracks)(e=s.onEnable)==null||e.call(s);for(const s of this._customTracks)(t=s.onEnable)==null||t.call(s);this.playOnAwake&&this.play(),this._visibilityChangeEvt||(this._visibilityChangeEvt=()=>{switch(document.visibilityState){case"hidden":this.setAudioTracksAllowPlaying(!1);break;case"visible":this.setAudioTracksAllowPlaying(!0);break}}),window.addEventListener("visibilitychange",this._visibilityChangeEvt)}onDisable(){var e,t;this.stop();for(const s of this._audioTracks)(e=s.onDisable)==null||e.call(s);for(const s of this._customTracks)(t=s.onDisable)==null||t.call(s);this._visibilityChangeEvt&&window.removeEventListener("visibilitychange",this._visibilityChangeEvt)}onDestroy(){var e;for(const t of this._audioTracks)(e=t.onDestroy)==null||e.call(t)}rebuildGraph(){!this.isValid()||(this.resolveBindings(),this.updateTimelineDuration(),this.setupAndCreateTrackHandlers())}play(){!this.isValid()||(this._isPaused=!1,!this._isPlaying&&(this._isPlaying=!0,this._internalUpdateRoutine=this.startCoroutine(this.internalUpdate())))}pause(){this._isPaused=!0}stop(){this._isPlaying&&(this._time=0,this._isPlaying=!1,this._isPaused=!1,this.evaluate()),this._isPlaying=!1,this._isPaused=!1,this._internalUpdateRoutine&&this.stopCoroutine(this._internalUpdateRoutine),this._internalUpdateRoutine=null}evaluate(){if(!this.isValid())return;let e=this._time;switch(this.extrapolationMode){case 0:e=Math.min(e,this._duration);break;case 1:e%=this._duration;break;case 2:if(e>this._duration){this.stop();return}break}this.internalEvaluate(e)}isValid(){return this.playableAsset&&this.playableAsset.tracks&&Array.isArray(this.playableAsset.tracks)}*forEachTrack(){for(const e of this._allTracks)for(const t of e)yield t}get audioTracks(){return this._audioTracks}resolveGuids(e){this._guidsMap=e}*internalUpdate(){for(;this._isPlaying;)!this._isPaused&&this._isPlaying&&(this._time+=this.context.time.deltaTime,this.evaluate()),yield}internalEvaluate(e){for(const t of this.playableAsset.tracks)if(!t.muted)switch(t.type){case Te.Activation:for(let s=0;s<t.outputs.length;s++){const n=t.outputs[s];if(typeof n=="object"){let o=!1;for(const l of t.clips)l.start<=e&&e<=l.end&&(o=!0);const a=n;a.visible!==void 0&&(a.visible=o)}}break}for(const t of this._animationTracks)t.evaluate(e);for(const t of this._audioTracks)t.evaluate(e);for(const t of this._signalTracks)t.evaluate(e);for(const t of this._controlTracks)t.evaluate(e);for(const t of this._customTracks)t.evaluate(e)}resolveBindings(){if(this._clonedPlayableAsset||(this._clonedPlayableAsset=!0,this.playableAsset=ks(this.playableAsset)),!this.playableAsset||!this.playableAsset.tracks)return;const e=this.findRoot(this.gameObject);for(const t of this.playableAsset.tracks)for(let s=t.outputs.length-1;s>=0;s--){let n=t.outputs[s];if(typeof n=="string"){this._guidsMap&&this._guidsMap[n]&&(n=this._guidsMap[n]);const o=p.findByGuid(n,e);o===null||typeof o!="object"?(t.outputs.splice(s,1),console.warn("Failed to resolve binding",n,t.name,t.type)):(Jd&&console.log("Resolved binding",n,"to",o),t.outputs[s]=o)}else if(n===null){if(t.outputs.splice(s,1),vr.createTrackFunctions[t.type])continue;t.type!==Te.Audio&&t.type!==Te.Control&&t.type!==Te.Marker&&console.warn("Missing binding",n,t.name,t.type,this.name,this.playableAsset.name)}}}findRoot(e){return e.parent?this.findRoot(e.parent):e}updateTimelineDuration(){if(this._duration=0,!(!this.playableAsset||!this.playableAsset.tracks)){for(const e of this.playableAsset.tracks)if(e.muted!==!0)for(const t of e.clips)t.end>this._duration&&(this._duration=t.end)}}setupAndCreateTrackHandlers(){var t,s;if(this._animationTracks.length=0,this._audioTracks.length=0,this._signalTracks.length=0,!this.playableAsset)return;const e=[];for(const n of this.playableAsset.tracks){const o=n.type,a=vr.createTrackFunctions[o];if(a!=null){const l=a(this,n);if(typeof l.evaluate=="function"){l.director=this,l.track=n,this._customTracks.push(l);continue}}if(n.type===Te.Animation){if(n.clips.length<=0)continue;for(let l=n.outputs.length-1;l>=0;l--){const c=n.outputs[l];typeof c.enabled=="boolean"&&(c.enabled=!1);const h=(t=c==null?void 0:c.gameObject)==null?void 0:t.animations;if(h){const d=new oa;d.trackOffset=n.trackOffset,d.director=this,d.track=n;for(let u=0;u<n.clips.length;u++){const g=n.clips[u],b=g.asset;if(!b){console.error("MISSING anim model?","clip#"+u,g,n,this.playableAsset,this.name);continue}const x=b.clip;let P=x;if((typeof P=="string"||typeof P=="number")&&(P=h.find(M=>M.name===x)),!P){console.warn("Could not find animationClip for model",g,n.name,this.name,(s=this.playableAsset)==null?void 0:s.name);continue}d.mixer||(d.mixer=new Ar(c.gameObject)),d.clips.push(P),d.mixer.uncacheAction(P),d.createHooks(P);const R=d.mixer.clipAction(P);d.actions.push(R),d.models.push(g)}this._animationTracks.push(d)}}}else if(n.type===Te.Audio){if(n.clips.length<=0)continue;e.push(n)}else if(n.type===Te.Marker){const l=new Jn;l.director=this,l.track=n;for(const c of n.markers)switch(c.type){case ra.Signal:l.models.push(c),l.didTrigger.push(!1);break}if(l!==null&&l.models.length>0){const c=p.getComponent(this.gameObject,Yn);c&&(l.receivers.push(c),this._signalTracks.push(l))}}else if(n.type===Te.Signal){const l=new Jn;l.director=this,l.track=n;for(const c of n.markers)l.models.push(c),l.didTrigger.push(!1);for(const c of n.outputs)l.receivers.push(c);this._signalTracks.push(l)}else if(n.type===Te.Control){const l=new cs;l.director=this,l.track=n;for(const c of n.clips)l.models.push(c);l.resolveSourceObjects(this.context),this._controlTracks.push(l)}}re.registerWaitForAllowAudio(()=>{const n=p.findObjectOfType(Ni,this.context);if(!!n)for(const o of e){const a=new aa;a.director=this,a.track=o,a.listener=n.listener;for(let l=0;l<o.clips.length;l++){const c=o.clips[l];a.addModel(c)}this._audioTracks.push(a)}})}setAudioTracksAllowPlaying(e){for(const t of this._audioTracks)t.onAllowAudioChanged(e)}};let hs=vr;r(hs,"createTrackFunctions",{});py(hs,"PlayableDirector");var my=Object.defineProperty,gy=(i,e)=>my(i,"name",{value:e,configurable:!0});class mi{constructor(e){r(this,"used",!1);r(this,"inputSource");r(this,"object");r(this,"isDown");r(this,"isUp");r(this,"isPressed");r(this,"isClicked");r(this,"event");this.event=e}Use(){this.used=!0}StopPropagation(){var e;(e=this.event)==null||e.stopImmediatePropagation()}}gy(mi,"PointerEventData");var _y=Object.defineProperty,eu=(i,e)=>_y(i,"name",{value:e,configurable:!0});const by=w("debugeventsystem"),Ve=class extends v{constructor(){super();r(this,"orbitControl",null);r(this,"orbitControlWasEnabled",!1);r(this,"raycaster",[]);r(this,"lastPointerEvent",null);r(this,"objectsHoveredThisFrame",[]);r(this,"objectsHoveredLastFrame",[]);r(this,"raisedPointerDownEvents",[]);r(this,"_didMove",!1);r(this,"_tempComponentsArray",[]);r(this,"_sortedHits",[]);r(this,"_sortingBuffer",[]);r(this,"_noDepthTestingResults",[]);r(this,"handleEventsArray",[]);r(this,"currentActiveMeshUIComponents",[]);Ve.systems.push(this)}static createIfNoneExists(e){this.didSearchEventSystem||(this.didSearchEventSystem=!0,Ve.systems.length<=0&&Ve.systems.push(...p.findObjectsOfType(Ve,e)));for(const s of Ve.systems)if(s.context===e)return;const t=new S;p.addNewComponent(t,Ve),e.scene.add(t)}static ensureUpdateMeshUI(e,t){We.update(e,t)}static markUIDirty(e){We.markDirty()}static get instance(){return this.systems[0]}onDestroy(){Ve.systems.splice(Ve.systems.indexOf(this),1)}start(){}register(e){var t;e&&this.raycaster&&!this.raycaster.includes(e)&&((t=this.raycaster)==null||t.push(e))}unregister(e){var s,n;const t=(s=this.raycaster)==null?void 0:s.indexOf(e);t!==void 0&&t!==-1&&((n=this.raycaster)==null||n.splice(t,1))}onEnable(){F.addEventListener(me.SelectStart,(t,s)=>{if(!s.grab)return;We.resetLastSelected();const n=new mi;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=!1,s.grab&&!this.handleEvents(s.grab,n)&&(s.grab=null)});const e=new Me;F.addEventListener(me.SelectEnd,(t,s)=>{if(!s.grab)return;const n=new mi;n.inputSource=t,n.isDown=t.selectionDown,n.isUp=t.selectionUp,n.isPressed=t.selectionPressed,n.isClicked=t.selectionClick,this.handleEvents(s.grab,n)}),F.addEventListener(me.Update,t=>{e.ray=t.getRay();const s=this.performRaycast(e);if(!s)return;const n=new mi;n.inputSource=t,this.handleIntersections(s,n)}),this.context.pre_update_callbacks.push(this.onBeforeUpdate.bind(this)),this.context.input.addEventListener(zs.PointerDown,this.onPointerDown.bind(this))}onDisable(){}onPointerDown(){this.onBeforeUpdate()}onBeforeUpdate(){var n,o;if(this.objectsHoveredThisFrame.length=0,this.resetMeshUIStates(),T.IsInWebXR||this.context.input.isKeyPressed(Ye.ALT))return;if(!this._didMove){const a=this.context.input.getPointerPositionRC(0);if(a&&a.x===0&&a.y===0)return;this._didMove=!0}const e=this.performRaycast(null),t=new mi(this.context.input.getPointerEvent(0));if(t.inputSource=this.context.input,t.isClicked=this.context.input.mouseClick,t.isDown=this.context.input.mouseDown,t.isUp=this.context.input.mouseUp,t.isPressed=this.context.input.mousePressed,this.lastPointerEvent=t,!e)return;let s=null;this.context.input.mouseDown&&this.currentActiveMeshUIComponents.length>0&&this.context.mainCameraComponent&&(s=(n=p.getComponent(this.context.mainCameraComponent.gameObject,si))!=null?n:null,s&&(s.enabled,s.enabled=!1)),this.handleIntersections(e,t),s&&(this.orbitControl=s,((o=this.orbitControl)==null?void 0:o.enabled)?(this.orbitControlWasEnabled=this.orbitControl.enabled,this.orbitControl.enabled=!1):this.orbitControl&&!this.context.input.mousePressed&&(this.orbitControl.enabled=this.orbitControlWasEnabled,this.orbitControl=null))}onBeforeRender(){if(this.lastPointerEvent)this.lastPointerEvent.used=!1;else return;if(this.lastPointerEvent.isUp){for(const t of this.raisedPointerDownEvents)t.onPointerUp&&t.onPointerUp(this.lastPointerEvent);this.raisedPointerDownEvents.length=0}for(const t of this.objectsHoveredLastFrame)if(this.objectsHoveredThisFrame.indexOf(t)<0){this._tempComponentsArray.length=0;const s=p.getComponentsInParent(t,v,this._tempComponentsArray);this.lastPointerEvent.object=t;for(let n=0;n<s.length;n++){const o=s[n];if(!o.gameObject||o.destroyed)continue;const a=o;a.onPointerExit&&a.onPointerExit(this.lastPointerEvent)}}const e=this.objectsHoveredLastFrame;this.objectsHoveredLastFrame=this.objectsHoveredThisFrame,this.objectsHoveredThisFrame=e}performRaycast(e){if(!this.raycaster)return null;this._sortedHits.length=0;for(const t of this.raycaster){if(!t.activeAndEnabled)continue;const s=t.performRaycast(e);s&&s.length>0&&this._sortedHits.push(...s)}return this._sortedHits.sort((t,s)=>t.distance-s.distance),this._sortedHits}handleIntersections(e,t){if(!e||e.length<=0)return!1;e=this.sortCandidates(e);for(const s of e){const{object:n}=s;if(this.handleEvents(n,t))return!0}return!1}sortCandidates(e){this._sortingBuffer.length=0,this._noDepthTestingResults.length=0;for(let t=0;t<e.length;t++){const s=e[t],n=s.object;if(n.material&&n.material.depthTest===!1){this._noDepthTestingResults.push(s);continue}this._sortingBuffer.push(s)}for(const t of this._sortingBuffer)this._noDepthTestingResults.push(t);return this._noDepthTestingResults}handleEvents(e,t){var a,l;if(!this.testIsVisible(e))return t.isClicked&&by&&console.log("not allowed",e),!1;t.object=e,this.lastPointerEvent=t;const s=e.parent;let n=!1;(a=t.isClicked)!=null;let o=null;if(s&&s.isUI){const c=(l=t.isPressed||t.isClicked)!=null?l:!1;if(s.shadowComponentOwner){const h=s.shadowComponentOwner.gameObject;if(h){if(o=this.tryFindCanvasGroup(h),(o==null?void 0:o.blocksRaycasts)===!1)return!1;if((o==null?void 0:o.interactable)===!1)return!0;this.handleMeshUIIntersection(e,c),e=h,n=!0}}if(!n&&this.handleMeshUiObjectWithoutShadowDom(s,c))return!0}if(this.objectsHoveredThisFrame.push(e),o===null||o.interactable){const c=this.objectsHoveredLastFrame.indexOf(e)>=0;this.handleEventsArray.length=0;const h=p.getComponentsInParent(e,v,this.handleEventsArray);for(let d=0;d<h.length;d++){if(t.used)return!0;if(h[d].destroyed)continue;const u=h[d];u.interactable!==!1&&(u.onPointerEnter&&(c||u.onPointerEnter(t)),t.isDown&&u.onPointerDown&&!this.raisedPointerDownEvents.includes(u)&&(u.onPointerDown(t),this.raisedPointerDownEvents.push(u)),t.isUp&&u.onPointerUp&&u.onPointerUp(t),t.isClicked&&u.onPointerClick&&u.onPointerClick(t))}}return!0}handleMeshUiObjectWithoutShadowDom(e,t){return!e||!e.isUI?!0:this.handleMeshUIIntersection(e,t)}handleMeshUIIntersection(e,t){const s=We.updateState(e,t);return s&&this.currentActiveMeshUIComponents.push(s),s!==null}resetMeshUIStates(){if(this.context.input.getPointerPressedCount()>0&&We.resetLastSelected(),!(!this.currentActiveMeshUIComponents||this.currentActiveMeshUIComponents.length<=0)){for(let e=0;e<this.currentActiveMeshUIComponents.length;e++){const t=this.currentActiveMeshUIComponents[e];We.resetState(t)}this.currentActiveMeshUIComponents.length=0}}testIsVisible(e){return e?p.isActiveSelf(e)?this.testIsVisible(e.parent):!1:!0}tryFindCanvasGroup(e){if(!e)return null;const t=p.foreachComponent(e,s=>{const n=s;if(n.blocksRaycasts!==void 0&&n.interactable!==void 0)return n},!1);return t!==void 0?t:this.tryFindCanvasGroup(e.parent)}};let $e=Ve;r($e,"didSearchEventSystem",!1),r($e,"systems",[]);eu($e,"EventSystem");class We{static markDirty(){this.needsUpdate=!0}static update(e,t){for(const s of this.lastUpdateFrame)if(s.context===t){if(t.time.frameCount===s.frame)return;s.frame=t.time.frameCount,(this.needsUpdate||t.time.frameCount<30)&&(this.needsUpdate=!1,e.update());return}this.lastUpdateFrame=[{context:t,frame:t.time.frameCount}],e.update()}static updateState(e,t){let s=null;if(e&&(s=this.findBlockInParent(e),s&&s!==this.lastSelected)){if(s.interactable===!1)return null;t?(this.lastSelected=s,s.states.pressed&&s.setState("pressed")):s.states.hovered&&s.setState("hovered"),this.needsUpdate=!0}return s}static resetLastSelected(){const e=this.lastSelected;!e||(this.lastSelected=null,this.resetState(e))}static resetState(e){if(!e)return;e.interactable===!1?e.states.disabled&&e.setState("disabled"):e===this.lastSelected&&e.states.selected?e.setState("selected"):e.setState("normal"),this.needsUpdate=!0}static findBlockInParent(e){return e?e.isBlock&&Object.keys(e.states).length>0?e:this.findBlockInParent(e.parent):null}}r(We,"lastSelected",null),r(We,"lastUpdateFrame",[]),r(We,"needsUpdate",!1);eu(We,"MeshUIHelper");var tu=Object.defineProperty,yy=Object.getOwnPropertyDescriptor,la=(i,e)=>tu(i,"name",{value:e,configurable:!0}),Zn=(i,e,t,s)=>{for(var n=s>1?void 0:s?yy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&tu(e,t,n),n};class iu{constructor(){r(this,"width");r(this,"height")}}la(iu,"Size");class ca{constructor(){r(this,"x");r(this,"y");r(this,"width");r(this,"height")}}la(ca,"Rect");class Vt extends v{constructor(){super(...arguments);r(this,"rect");r(this,"sizeDelta");r(this,"anchoredPosition3D");r(this,"pivot")}get translation(){return this.gameObject.position}get rotation(){return this.gameObject.quaternion}get scale(){return this.gameObject.scale}get m_AnchoredPosition(){return this.gameObject.position}applyAnchoring(e){if(this.pivot&&this.sizeDelta){const t=this.pivot.x*2-1,s=this.pivot.y*2-1,n=this.sizeDelta.x*t,o=this.sizeDelta.y*s;e.x+=n*.5,e.y-=o*.5}}getBasicOptions(){const e={width:this.rect.width,height:this.rect.height,offset:.001,backgroundOpacity:0,borderWidth:0,borderRadius:0,borderOpacity:0};return this.ensureValidSize(e),e}ensureValidSize(e,t=100){return e.width<=0&&(e.width=t),e.height<=0&&(e.height=1e-7),e}createBlock(e){return e=lt(lt({},this.getBasicOptions()),e),new cl(e)}}la(Vt,"RectTransform");Zn([_(ca)],Vt.prototype,"rect",2);Zn([_(V)],Vt.prototype,"sizeDelta",2);Zn([_(y)],Vt.prototype,"anchoredPosition3D",2);Zn([_(V)],Vt.prototype,"pivot",2);var vy=Object.defineProperty,wy=(i,e)=>vy(i,"name",{value:e,configurable:!0});function Kn(i,e,t=!0){var s;if(!!i&&(((s=i.material)==null?void 0:s.isMaterial)===!0&&(i.material.depthTest=!e),t))for(const n of i.children)Kn(n,e,t)}wy(Kn,"setRenderOnTop");var xy=Object.defineProperty,su=(i,e)=>xy(i,"name",{value:e,configurable:!0});const qt="./include",Py=w("debugui");cl.prototype.interactable={get(){return this.interactive},set(i){this.interactable=i}};class Rt extends v{constructor(){super(...arguments);r(this,"shadowComponent",null);r(this,"_controlsChildLayout",!0);r(this,"_rect",null);r(this,"_root");r(this,"_renderOnTop",!1);r(this,"_parentComponent");r(this,"_lastMatrixWorld")}get controlsChildLayout(){return this._controlsChildLayout}set controlsChildLayout(e){this._controlsChildLayout=e,this.shadowComponent&&(this.shadowComponent.autoLayout=e)}get rect(){return this._rect||(this._rect=p.getComponent(this.gameObject,Vt)),this._rect}get Root(){return this._root===void 0&&(this._root=p.getComponentInParent(this.gameObject,er)),this._root}set renderOnTop(e){e!==this._renderOnTop&&(this._renderOnTop=e,this.startCoroutine(this.updateRenderOnTop(),xe.OnBeforeRender))}get renderOnTop(){return this._renderOnTop}get isNested(){return this.Root!==null&&this.Root.gameObject!==this.gameObject.parent}markDirty(){$e.markUIDirty(this.context)}addToShadowComponent(e){if(this.removeShadowComponent(),this._parentComponent=p.getComponentInParent(this.gameObject.parent,Rt),!this._parentComponent||!this._parentComponent.shadowComponent){console.warn("Component doesn't have a MeshUIBaseComponent parent anywhere. Do you have a UI element outside a Canvas?",this);return}e.name=this.gameObject.name+" (UI)",e.autoLayout=this._parentComponent.controlsChildLayout,e.shadowComponentOwner=this;const t=this.raycastTarget;e.traverse(s=>{s.shadowComponentOwner||(s.shadowComponentOwner=this),t===!1&&s.layers.set(2)}),this._parentComponent.shadowComponent.add(e),this.shadowComponent=e,this.applyTransform(),Bi&&e.add(new Ei(.5)),this.onAfterAddedToScene(),this.startCoroutine(this.updateRenderOnTop(),xe.OnBeforeRender)}removeShadowComponent(){this.shadowComponent&&this.shadowComponent.removeFromParent()}onAfterAddedToScene(){}*updateRenderOnTop(){yield,this.shadowComponent&&(this.onUpdateRenderOnTop(),Kn(this.shadowComponent,this._renderOnTop))}onUpdateRenderOnTop(){}applyTransform(){var n,o;const e=this.shadowComponent;if(!e)return;const t=(this==null?void 0:this.isRoot())===!0,s=((n=this._parentComponent)==null?void 0:n.isRoot())===!0;if(t){const a=s?1/(((o=this.Root)==null?void 0:o.gameObject.scale.x)||1):1,l=C(this.gameObject);l.multiplyScalar(a),e.position.set(l.x,l.y,l.z);const c=Il(this.gameObject);e.scale.copy(c).multiplyScalar(a)}else{const a=this.gameObject.position;e.position.set(-a.x,a.y,-a.z),e.scale.copy(this.gameObject.scale)}e.quaternion.copy(this.gameObject.quaternion),s&&e.rotateY(Math.PI),this.rect.applyAnchoring(e.position),this._lastMatrixWorld.copy(this.gameObject.matrixWorld)}awake(){this._lastMatrixWorld=new Oe}setInteractable(e){this.shadowComponent&&(this.shadowComponent.interactable=e)}onBeforeRender(){this._lastMatrixWorld.equals(this.gameObject.matrixWorld)===!1&&(Py&&console.log("updating",this.name),this.applyTransform()),$e.ensureUpdateMeshUI(Fp,this.context)}isRoot(){return!1}}su(Rt,"BaseUIComponent");class er extends Rt{isRoot(){return!0}}su(er,"UIRootComponent");var nu=Object.defineProperty,Oy=Object.getOwnPropertyDescriptor,ru=(i,e)=>nu(i,"name",{value:e,configurable:!0}),ou=(i,e,t,s)=>{for(var n=s>1?void 0:s?Oy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&nu(e,t,n),n};class Xt extends Rt{constructor(){super(...arguments);r(this,"raycastTarget",!0);r(this,"_container",null);r(this,"_color",null);r(this,"_currentlyCreatingPanel",!1)}get color(){return this._color}set color(e){const t=!0;this._color=e,this._container&&t&&this.onColorChanged(this._color)}onColorChanged(e){this.setOptions({backgroundColor:e,backgroundOpacity:e.alpha,borderOpacity:e.alpha})}get m_Color(){return this.color}onBeforeRender(){super.onBeforeRender(),this.color=this.m_Color}setState(e){this.makePanel(),this._container&&this._container.setState(e)}setupState(e){this.makePanel(),this._container&&this._container.setupState(e)}setOptions(e){var t;this.makePanel(),this._container&&(this._container.set(e),(e.backgroundColor!==void 0||e.backgroundOpacity!==void 0)&&((t=this._container.updateBackgroundMaterial)==null||t.call(this._container)))}awake(){super.awake(),this.makePanel()}onEnable(){this._container&&this.addToShadowComponent(this._container)}onDisable(){this._container&&this.removeShadowComponent()}makePanel(){if(this._container||this._currentlyCreatingPanel)return;this._currentlyCreatingPanel=!0;const e={backgroundColor:this.color,backgroundOpacity:this.color.alpha,offset:1};this.onBeforeCreate(e),this.onCreate(e),this.controlsChildLayout=!1,this._currentlyCreatingPanel=!1,this.onAfterCreated()}onBeforeCreate(e){}onCreate(e){this._container=this.rect.createBlock(e)}onAfterCreated(){}async setTexture(e){!e||(this.setOptions({backgroundOpacity:0}),e&&this.setOptions({backgroundTexture:e,borderRadius:0,backgroundOpacity:this.color.alpha}))}onAfterAddedToScene(){this.shadowComponent&&(this.shadowComponent.offset=this.shadowComponent.position.z)}}ru(Xt,"Graphic");ou([_(Re)],Xt.prototype,"color",1);ou([_()],Xt.prototype,"raycastTarget",2);class tr extends Xt{}ru(tr,"MaskableGraphic");var au=Object.defineProperty,Cy=Object.getOwnPropertyDescriptor,ha=(i,e)=>au(i,"name",{value:e,configurable:!0}),da=(i,e,t,s)=>{for(var n=s>1?void 0:s?Cy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&au(e,t,n),n};class ua{constructor(){r(this,"texture");r(this,"rect")}}ha(ua,"Sprite");da([_(Rs)],ua.prototype,"texture",2);class ir extends tr{constructor(){super(...arguments);r(this,"sprite")}onBeforeCreate(e){var t,s;((s=(t=this.sprite)==null?void 0:t.texture)==null?void 0:s.name)=="UISprite"&&(e.borderRadius=5,e.borderColor=new f(.4,.4,.4),e.borderOpacity=this.color.alpha,e.borderWidth=.3)}onAfterCreated(){var e,t,s;((t=(e=this.sprite)==null?void 0:e.texture)==null?void 0:t.name)!="UISprite"&&this.setTexture((s=this.sprite)==null?void 0:s.texture)}}ha(ir,"Image");da([_(ua)],ir.prototype,"sprite",2);class fa extends tr{constructor(){super(...arguments);r(this,"mainTexture")}async onAfterCreated(){this.setTexture(this.mainTexture)}}ha(fa,"RawImage");da([_(Rs)],fa.prototype,"mainTexture",2);var lu=Object.defineProperty,Sy=Object.getOwnPropertyDescriptor,Ry=(i,e)=>lu(i,"name",{value:e,configurable:!0}),gi=(i,e,t,s)=>{for(var n=s>1?void 0:s?Sy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&lu(e,t,n),n};const _i=w("debugbutton");var cu;(function(i){i[i.None=0]="None",i[i.ColorTint=1]="ColorTint",i[i.SpriteSwap=2]="SpriteSwap",i[i.Animation=3]="Animation"})(cu||(cu={}));class Et extends v{constructor(){super(...arguments);r(this,"onClick");r(this,"_isHovered",!1);r(this,"colors");r(this,"transition");r(this,"animationTriggers");r(this,"animator");r(this,"_interactable",!0);r(this,"_isInit",!1);r(this,"_image")}onPointerEnter(e){var t;_i&&console.log("Button Enter",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this._isHovered=!0,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.highlightedTrigger)}onPointerExit(){var e;_i&&console.log("Button Exit",(e=this.animationTriggers)==null?void 0:e.highlightedTrigger,this.animator),this._isHovered=!1,this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.normalTrigger)}onPointerDown(e){var t;_i&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this.animationTriggers.pressedTrigger)}onPointerUp(e){var t;_i&&console.log("Button Down",(t=this.animationTriggers)==null?void 0:t.highlightedTrigger,this.animator),this.transition==3&&this.animationTriggers&&this.animator&&this.animator.SetTrigger(this._isHovered?this.animationTriggers.highlightedTrigger:this.animationTriggers.normalTrigger)}onPointerClick(e){var t;_i&&console.trace("Button Click",this.onClick),(t=this.onClick)==null||t.invoke()}set interactable(e){this._interactable=e,this._image&&(this._image.setInteractable(e),e?this._image.setState("normal"):this._image.setState("disabled"))}get interactable(){return this._interactable}set_interactable(e){this.interactable=e}awake(){_i&&console.log(this),this.init()}start(){var e;(e=this._image)==null||e.setInteractable(this.interactable)}init(){this._isInit||(this._isInit=!0,this._image=p.getComponent(this.gameObject,ir),this._image&&(this.stateSetup(this._image),this.interactable?this._image.setState("normal"):this._image.setState("disabled")))}stateSetup(e){var g,b,x,P,R;e.setInteractable(this.interactable);const t=this.getFinalColor(e.color,(g=this.colors)==null?void 0:g.m_NormalColor),s={state:"normal",attributes:{backgroundColor:t,backgroundOpacity:t.alpha}};e.setupState(s);const n=this.getFinalColor(e.color,(b=this.colors)==null?void 0:b.m_HighlightedColor),o={state:"hovered",attributes:{backgroundColor:n,backgroundOpacity:n.alpha}};e.setupState(o);const a=this.getFinalColor(e.color,(x=this.colors)==null?void 0:x.m_PressedColor),l={state:"pressed",attributes:{backgroundColor:a,backgroundOpacity:a.alpha}};e.setupState(l);const c=this.getFinalColor(e.color,(P=this.colors)==null?void 0:P.m_SelectedColor),h={state:"selected",attributes:{backgroundColor:c,backgroundOpacity:c.alpha}};e.setupState(h);const d=this.getFinalColor(e.color,(R=this.colors)==null?void 0:R.m_DisabledColor),u={state:"disabled",attributes:{backgroundColor:d,backgroundOpacity:d.alpha}};e.setupState(u)}getFinalColor(e,t){return t?e.clone().multiply(t):e.clone()}}Ry(Et,"Button");gi([_(tt)],Et.prototype,"onClick",2);gi([_()],Et.prototype,"colors",2);gi([_()],Et.prototype,"transition",2);gi([_()],Et.prototype,"animationTriggers",2);gi([_(ft)],Et.prototype,"animator",2);gi([_()],Et.prototype,"interactable",1);var Ey=Object.defineProperty,Ay=(i,e)=>Ey(i,"name",{value:e,configurable:!0});class hu extends er{awake(){super.awake(),this.shadowComponent=this.gameObject}onUpdateRenderOnTop(){for(const e of this.gameObject.getComponentsInChildren(Rt))e.renderOnTop=this.renderOnTop}}Ay(hu,"Canvas");var Ty=Object.defineProperty,ky=(i,e)=>Ty(i,"name",{value:e,configurable:!0});class du extends v{constructor(){super(...arguments);r(this,"_alpha",1);r(this,"interactable",!0);r(this,"blocksRaycasts",!0);r(this,"_isDirty",!1);r(this,"_buffer",[])}get alpha(){return this._alpha}set alpha(e){e!==this._alpha&&(this._alpha=e,this.markDirty())}markDirty(){this._isDirty||(this._isDirty=!0,this.startCoroutine(this.applyChangesDelayed(),xe.OnBeforeRender))}*applyChangesDelayed(){this._isDirty=!1,this.applyChangesNow()}applyChangesNow(){for(const e of p.getComponentsInChildren(this.gameObject,Xt,this._buffer)){const t=e.color;t.alpha=this._alpha,e.color=t}}}ky(du,"CanvasGroup");var Ly=Object.defineProperty,Dy=(i,e)=>Ly(i,"name",{value:e,configurable:!0}),pa;(function(i){i[i.fr=0]="fr",i[i.ru=1]="ru",i[i.de=2]="de",i[i.es=3]="es",i[i.el=4]="el",i[i.nord=5]="nord",i[i.eng=6]="eng"})(pa||(pa={}));class uu extends Rt{constructor(){super(...arguments);r(this,"font");r(this,"text");r(this,"keymap");r(this,"padding");r(this,"margin");r(this,"fontSize");r(this,"borderRadius");r(this,"colors",{keyboardBack:8750469,panelBack:2500134,button:3552822,hovered:1842204,selected:1088605});r(this,"keyboard",null);r(this,"_lastKeyPressed");r(this,"_lastKeyPressedStartTime",0);r(this,"_lastKeyPressedTime",0)}awake(){super.awake();const e=pa[this.keymap||6];this.makeKeyboard(e)}onEnable(){this.addToShadowComponent(this.keyboard)}onDisable(){this.removeShadowComponent()}makeKeyboard(e){!e&&!navigator.language&&(e="en");const t=this.font?this.font:"arial",s=this.rect,n=Or(lt({},s.getBasicOptions()),{margin:this.margin||0,padding:this.padding||0,language:e,fontFamily:qt+"/"+t+"-msdf.json",fontTexture:qt+"/"+t+".png",fontSize:this.fontSize||6,backgroundColor:new f(this.colors.keyboardBack),backspaceTexture:qt+"/backspace.png",shiftTexture:qt+"/shift.png",enterTexture:qt+"/enter.png",borderRadius:this.borderRadius||0,autoLayout:!1}),o=this.gameObject.scale;n.width*=this.gameObject.scale.x,n.height*=this.gameObject.scale.y,n.fontSize*=Math.max(o.x,o.y),this.keyboard=new Bp(n),this.gameObject.scale.set(1,1,1),this.keyboard.keys.forEach(a=>{a.setupState({state:"normal",attributes:{offset:.003,backgroundColor:new f(this.colors.button),backgroundOpacity:1}}),a.setState("normal"),a.setupState({state:"hovered",attributes:{offset:.3,backgroundColor:new f(this.colors.hovered),backgroundOpacity:1}}),a.setupState({state:"pressed",attributes:{offset:.1,backgroundColor:new f(this.colors.selected),backgroundOpacity:1},onSet:()=>{var h,d,u;const l=a.info.input,c=a.info.command;if(this._lastKeyPressed!==l)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedTime>.05)this._lastKeyPressedStartTime=this.context.time.time;else if(this.context.time.time-this._lastKeyPressedStartTime<.5||c=="switch"||c=="shift"||c=="switch-set"){this._lastKeyPressedTime=this.context.time.time;return}if(this._lastKeyPressedTime=this.context.time.time,this._lastKeyPressed=l,c)switch(c){case"switch":this.keyboard.setNextPanel();break;case"switch-set":this.keyboard.setNextCharset();break;case"enter":this.tryAppend(`
`);break;case"space":this.tryAppend(" ");break;case"backspace":if(!((d=(h=this.text)==null?void 0:h.text)==null?void 0:d.length))break;((u=this.text)==null?void 0:u.text)&&(this.text.text=this.text.text.substring(0,this.text.text.length-1)||"");break;case"shift":this.keyboard.toggleCase();break}else a.info.input!==void 0&&this.tryAppend(a.info.input)}})})}tryAppend(e){this.text&&(this.text.text+=e,this.markDirty())}}Dy(uu,"Keyboard");var My=Object.defineProperty,sr=(i,e)=>My(i,"name",{value:e,configurable:!0});class ds extends v{constructor(){super(...arguments);r(this,"reverseArrangement",!1)}}sr(ds,"LayoutGroup");class fu extends ds{}sr(fu,"VerticalLayoutGroup");class pu extends ds{}sr(pu,"HorizontalLayoutGroup");class mu extends ds{}sr(mu,"GridLayoutGroup");var Iy=Object.defineProperty,ma=(i,e)=>Iy(i,"name",{value:e,configurable:!0});class ga extends v{awake(){$e.createIfNoneExists(this.context)}onEnable(){var e;(e=$e.instance)==null||e.register(this)}onDisable(){var e;(e=$e.instance)==null||e.unregister(this)}performRaycast(e=null){return null}}ma(ga,"Raycaster");class us extends ga{constructor(){super(...arguments);r(this,"targets",null);r(this,"raycastHits",[])}start(){this.targets=[this.gameObject]}performRaycast(e=null){return this.targets?(e!=null||(e=new Me),e.targets=this.targets,e.results=this.raycastHits,this.context.physics.raycast(e)):null}}ma(us,"ObjectRaycaster");class gu extends us{constructor(){super(...arguments);r(this,"eventCamera",null);r(this,"ignoreReversedGraphics",!1);r(this,"rootRaycaster",null)}}ma(gu,"GraphicRaycaster");var jy=Object.defineProperty,Fy=(i,e)=>jy(i,"name",{value:e,configurable:!0});class _u extends v{constructor(){super(...arguments);r(this,"id",null);r(this,"keepAspect",!1)}start(){if(!this.id||!this.context.mainCamera)return;const e=document.getElementById(this.id);if(!e){console.warn('Could not find element with id "'+this.id+'"');return}e.style.display="block",e.style.visibility="hidden";const t=new Up(this.context.renderer,this.context.mainCamera);this.gameObject.add(t);const s=new Np(e);t.add(s),s.visible=!1,console.log(s);const n=s.material;n.transparent=!0,setTimeout(()=>{s.visible=!0;const o=Vr(this.gameObject).clone();Ms(this.gameObject,0,0,0),this.gameObject.updateMatrixWorld();const a=new Jt;a.setFromObject(t),this.setWorldRotation(o.x,o.y,o.z);const l=a.max.x-a.min.x,c=a.max.y-a.min.y;if(this.keepAspect){const d=l/c;l>c?s.scale.set(1/l,1/c/d,1):s.scale.set(1/l*d,1/c,1)}else s.scale.set(1/l,1/c,1);const h=this.gameObject.scale;s.scale.multiply(h)},1)}}Fy(_u,"SpatialHtml");var bu=Object.defineProperty,By=Object.getOwnPropertyDescriptor,_a=(i,e)=>bu(i,"name",{value:e,configurable:!0}),He=(i,e,t,s)=>{for(var n=s>1?void 0:s?By(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&bu(e,t,n),n},yu;(function(i){i[i.UpperLeft=0]="UpperLeft",i[i.UpperCenter=1]="UpperCenter",i[i.UpperRight=2]="UpperRight",i[i.MiddleLeft=3]="MiddleLeft",i[i.MiddleCenter=4]="MiddleCenter",i[i.MiddleRight=5]="MiddleRight",i[i.LowerLeft=6]="LowerLeft",i[i.LowerCenter=7]="LowerCenter",i[i.LowerRight=8]="LowerRight"})(yu||(yu={}));var vu;(function(i){i[i.Truncate=0]="Truncate",i[i.Overflow=1]="Overflow"})(vu||(vu={}));var wu;(function(i){i[i.Wrap=0]="Wrap",i[i.Overflow=1]="Overflow"})(wu||(wu={}));var xu;(function(i){i[i.Normal=0]="Normal",i[i.Bold=1]="Bold",i[i.Italic=2]="Italic",i[i.BoldAndItalic=3]="BoldAndItalic"})(xu||(xu={}));class ve extends Xt{constructor(){super(...arguments);r(this,"canvas");r(this,"alignment",0);r(this,"verticalOverflow",0);r(this,"horizontalOverflow",0);r(this,"lineSpacing",1);r(this,"supportRichText",!1);r(this,"font");r(this,"fontStyle",0);r(this,"_isWaitingForRebuild",!1);r(this,"_text","");r(this,"_fontSize",12);r(this,"_textMeshUi",null);r(this,"_textContainer",null);r(this,"_didHandleTextRenderOnTop",!1)}get text(){return this._text}set text(e){if(this._text=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}set_text(e){this.text=e}get fontSize(){return this._fontSize}set fontSize(e){if(this._fontSize=e,this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({content:e}),this.markDirty()}}onColorChanged(e){if(this._textMeshUi){if(this._textMeshUi.length>1){this.requestRebuild();return}this._textMeshUi[0].set({fontColor:e,fontOpacity:e.alpha}),this.markDirty()}}requestRebuild(){this._isWaitingForRebuild||(this._isWaitingForRebuild=!0,this.startCoroutine(this.rebuildDelayedRoutine(),xe.EarlyUpdate))}*rebuildDelayedRoutine(){if(this._isWaitingForRebuild=!1,this._textMeshUi){for(const e of this._textMeshUi)e.removeFromParent();this._textMeshUi.length=0}this.createText(this.text,this.getTextOpts(),this.supportRichText),this.markDirty()}onCreate(e){const t=this.verticalOverflow==0&&this.horizontalOverflow==0;t&&(this.context.renderer.localClippingEnabled=!0);const s=this.rect;this._textContainer=this._container=this.createBlock(s,t,null,!0),this.createText(this.text,this.getTextOpts(),this.supportRichText),this._container,this._container=this.createBlock(s,t,this._container,!1)}onUpdateRenderOnTop(){super.onUpdateRenderOnTop(),this.handleTextRenderOnTop()}getTextOpts(){var t;const e={content:this.text,fontColor:this.color,fontOpacity:this.color.alpha,fontSize:this.fontSize,fontKerning:"normal"};return this.font=(t=this.font)==null?void 0:t.toLocaleLowerCase(),this.setFont(e,this.fontStyle),e}onEnable(){super.onEnable(),this._didHandleTextRenderOnTop=!1,this._container&&(this._container.onAfterUpdate=this.updateWidth.bind(this))}createBlock(e,t,s,n=!1){const o={};o.hiddenOverflow=t,o.interLine=(this.lineSpacing-1)*this.fontSize*1.333,this.getAlignment(o,n);const a=e.createBlock(o);return s&&(Array.isArray(s)?a.add(...s):a.add(s)),a}getAlignment(e,t=!1){switch(t||(e.contentDirection="row"),this.alignment){default:case 0:case 1:case 2:e.justifyContent="start";break;case 3:case 4:case 5:e.justifyContent="center";break;case 6:case 7:case 8:e.justifyContent="end";break}switch(this.alignment){case 0:case 3:case 6:e.alignContent=t?"left":"top";break;case 1:case 4:case 7:e.alignContent="center";break;case 2:case 5:case 8:e.alignContent=t?"right":"bottom";break}return e}updateWidth(){this.horizontalOverflow===1&&setTimeout(()=>{if(!this._textMeshUi)return;const e=this._textMeshUi[0].parent;if(!!e&&e.lines){let t=e.lines.reduce((s,n)=>s+n.width,0);t+=e.getFontSize()*3,t+=e.padding*2||0,e.set({width:t})}},1)}createText(e,t,s){if(!(!e||e.length<=0))if(this._textMeshUi||(this._textMeshUi=[]),s){let n=this.getNextTag(e);if(n)n.startIndex>0&&this.createText(e.substring(0,n.startIndex),t,!1);else return this.createText(e,t,!1);const o=[];for(;n;){const a=this.getNextTag(e,n.endIndex);if(a){const l=this.getText(e,n,a);this.handleTag(n,t,o),this.createText(l,t,!1)}else{const l=e.substring(n.endIndex);this.handleTag(n,t,o),this.createText(l,t,!1)}n=a}}else{const n=lt({},t);n.content=e;const o=new zp(n);this._textMeshUi.push(o),this._textContainer&&this._textContainer.add(o)}}handleTextRenderOnTop(){this._didHandleTextRenderOnTop||(this._didHandleTextRenderOnTop=!0,this.startCoroutine(this.renderOnTopCoroutine()))}*renderOnTopCoroutine(){const e=[];for(;;){let t=!1;if(this._textMeshUi)for(let s=0;s<this._textMeshUi.length;s++){if(e[s]===!0)continue;t=!0;const n=this._textMeshUi[s];!n.textContent||(Kn(n,this.renderOnTop,!0),e[s]=!0)}if(!t)break;yield}}handleTag(e,t,s){if(e.isEndTag){if(s.length>0){const n=s.pop();if(n)for(const o in n.previousValues){const a=n.previousValues[o];t[o]=a}}}else if(e.type.includes("color")){const n=new nr(e,{fontColor:t.fontColor});if(s.push(n),e.type.length>6){const o=e.type.substring(6);t.fontColor=Pu(o)}else t.fontColor=new f(1,1,1)}else if(e.type=="b"){const n=new nr(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,1)}else if(e.type=="i"){const n=new nr(e,{fontFamily:t.fontFamily,fontTexture:t.fontTexture});s.push(n),this.setFont(t,2)}}getText(e,t,s){return e.substring(t.endIndex,s.startIndex)}getNextTag(e,t=0){const s=e.indexOf("<",t),n=e.indexOf(">",s);if(s>=0&&n>=0){const o=e.substring(s+1,n);return{type:o,startIndex:s,endIndex:n+1,isEndTag:o.startsWith("/")}}return null}setFont(e,t){e.fontFamily=qt+"/"+this.getFontName(t)+"-msdf.json",e.fontTexture=qt+"/"+this.getFontName(t)+".png"}getFontName(e){if(!this.font)return null;switch(e){case 0:return this.font;case 1:return this.font+"-bold";case 2:return this.font+"-italic";case 3:return this.font+"-bold-italic"}return null}}_a(ve,"Text");He([_()],ve.prototype,"canvas",2);He([_()],ve.prototype,"alignment",2);He([_()],ve.prototype,"verticalOverflow",2);He([_()],ve.prototype,"horizontalOverflow",2);He([_()],ve.prototype,"lineSpacing",2);He([_()],ve.prototype,"supportRichText",2);He([_()],ve.prototype,"font",2);He([_()],ve.prototype,"fontStyle",2);He([_()],ve.prototype,"text",1);He([_()],ve.prototype,"fontSize",1);class nr{constructor(e,t){r(this,"tag");r(this,"previousValues");this.tag=e,this.previousValues=t}}_a(nr,"TagStackEntry");function Pu(i){if(i.startsWith("#")){const t=i.substring(1);var e=parseInt(t,16);const s=e>>16&255,n=e>>8&255,o=e&255;return new f(s/255,n/255,o/255)}switch(i){case"black":return new f(0,0,0);case"white":return new f(1,1,1);case"red":return new f(1,0,0);case"lime":return new f(0,1,0);case"blue":return new f(0,0,1);case"yellow":return new f(1,1,0);case"cyan":return new f(0,1,1);case"magenta":return new f(1,0,1);case"silver":return new f(.75,.75,.75);case"gray":return new f(.5,.5,.5);case"maroon":return new f(.5,0,0);case"olive":return new f(.5,.5,0);case"green":return new f(0,.5,0);case"purple":return new f(.5,0,.5);case"teal":return new f(0,.5,.5);case"navy":return new f(0,0,.5);case"darkred":return new f(.54,0,0);case"brown":return new f(.55,.27,0);case"firebrick":return new f(.69,.13,.13);case"crimson":return new f(.86,.08,.24);case"tomato":return new f(1,.39,.28);case"coral":return new f(1,.49,.31);case"indianred":return new f(.6,.31,.51);case"lightcoral":return new f(.94,.5,.5);case"darkorange":return new f(1,.55,0);case"orange":return new f(1,.65,0);case"gold":return new f(1,.84,0);case"darkgoldenrod":return new f(.72,.53,.04);case"goldenrod":return new f(.85,.65,.13);case"palegoldenrod":return new f(.93,.87,.67);case"darkkhaki":return new f(.74,.7,.42);case"khaki":return new f(.94,.9,.55);case"yellowgreen":return new f(.6,.8,.19);case"darkolivegreen":return new f(.33,.42,.18);case"olivedrab":return new f(.42,.56,.14);case"lawngreen":return new f(.49,.99,0);case"chartreuse":return new f(.5,1,0);case"greenyellow":return new f(.68,1,.18);case"darkgreen":return new f(0,.39,0);case"forestgreen":return new f(.13,.55,.13);case"limegreen":return new f(.19,.8,.19);case"lightgreen":return new f(.56,.93,.56);case"palegreen":return new f(.59,.98,.59);case"darkseagreen":return new f(.56,.74,.56);case"mediumspringgreen":return new f(0,.98,.6);case"springgreen":return new f(0,1,.5);case"seagreen":return new f(.18,.31,.31);case"mediumaquamarine":return new f(.4,.8,.66);case"mediumseagreen":return new f(.24,.7,.44);case"lightseagreen":return new f(.13,.7,.67);case"darkslategray":return new f(.18,.31,.31);case"darkcyan":return new f(0,.55,.55);case"aqua":return new f(0,1,1);case"lightcyan":return new f(.8,1,1);case"darkturquoise":return new f(0,.81,.82);case"turquoise":return new f(0,.82,.82);case"mediumturquoise":return new f(.28,.82,.8);case"paleturquoise":return new f(.68,1,.93);case"aquamarine":return new f(.5,1,.83);case"powderblue":return new f(.69,.88,.9);case"cadetblue":return new f(.37,.62,.63);case"steelblue":return new f(.27,.51,.71);case"cornflowerblue":return new f(.39,.58,.93);case"deepskyblue":return new f(0,.7,1);case"dodgerblue":return new f(.12,.56,1);case"lightblue":return new f(.68,.85,.9);case"skyblue":return new f(.53,.81,.92);case"lightskyblue":return new f(.53,.81,.98);case"midnightblue":return new f(.18,.18,.31);case"darkblue":return new f(0,0,.55);case"mediumblue":return new f(0,0,.82);case"royalblue":return new f(.25,.41,.88);case"blueviolet":return new f(.54,.17,.89);case"indigo":return new f(.29,0,.51);case"darkslateblue":return new f(.28,.24,.55);case"slateblue":return new f(.42,.35,.8);case"mediumslateblue":return new f(.48,.41,.9);case"mediumpurple":return new f(.58,.44,.86);case"darkmagenta":return new f(.55,0,.55);case"darkviolet":return new f(.58,0,.83);case"darkorchid":return new f(.6,.2,.8);case"mediumorchid":return new f(.73,.33,.83);case"thistle":return new f(.84,.75,.85);case"plum":return new f(.87,.63,.87);case"violet":return new f(.93,.51,.93);case"fuchsia":return new f(1,0,1);case"orchid":return new f(.85,.44,.84);case"mediumvioletred":return new f(.78,.08,.52);case"palevioletred":return new f(.86,.44,.58);case"hotpink":return new f(1,.4,.71);case"deeppink":return new f(1,.08,.58);case"lightpink":return new f(1,.71,.76);case"pink":return new f(1,.75,.78);case"antiquewhite":return new f(.98,.92,.84);case"beige":return new f(.96,.96,.86);case"bisque":return new f(1,.89,.77);case"blanchedalmond":return new f(1,.92,.82);case"wheat":return new f(.96,.87,.87);case"cornsilk":return new f(1,.97,.86);case"lemonchiffon":return new f(1,.98,.8);case"lightgoldenrodyellow":return new f(.98,.98,.82);case"lightyellow":return new f(1,1,.8);case"saddlebrown":return new f(.55,.27,.07);case"sienna":return new f(.63,.32,.18);case"chocolate":return new f(.82,.41,.12);case"peru":return new f(.82,.52,.25);case"sandybrown":return new f(.96,.64,.38);case"burlywood":return new f(.87,.72,.53);case"tan":return new f(.82,.71,.55);case"rosybrown":return new f(.74,.56,.56);case"moccasin":return new f(1,.89,.71);case"navajowhite":return new f(1,.87,.68);case"peachpuff":return new f(1,.85,.73);case"mistyrose":return new f(1,.89,.88);case"lavenderblush":return new f(1,.94,.93);case"linen":return new f(.98,.94,.9);case"oldlace":return new f(.99,.96,.9);case"papayawhip":return new f(1,.94,.84);case"seashell":return new f(1,.96,.93);case"mintcream":return new f(.98,1,.98);case"slategray":return new f(.44,.5,.56);case"lightslategray":return new f(.47,.53,.6);case"lightsteelblue":return new f(.69,.77,.87);case"lavender":return new f(.9,.9,.98);case"floralwhite":return new f(1,.98,.98);case"aliceblue":return new f(.94,.97,1);case"ghostwhite":return new f(.97,.97,1);case"honeydew":return new f(.94,1,.94);case"ivory":return new f(1,1,.94);case"azure":return new f(.94,1,1);case"snow":return new f(1,.98,.98);case"dimgray":return new f(.4,.4,.4);case"darkgray":return new f(.66,.66,.66);case"lightgray":return new f(.83,.83,.83);case"gainsboro":return new f(.86,.86,.86);case"whitesmoke":return new f(.96,.96,.96)}return new f(1,1,1)}_a(Pu,"getColorFromString");var Uy=Object.defineProperty,Ny=(i,e)=>Uy(i,"name",{value:e,configurable:!0});class Ou extends v{constructor(){super(...arguments);r(this,"toggleKey",Ye.KEY_P)}update(){this.context.input.isKeyDown(Ye.KEY_P)&&this.context.domElement.classList.toggle("presentation-mode")}}Ny(Ou,"PresentationMode");var zy=Object.defineProperty,Cu=(i,e)=>zy(i,"name",{value:e,configurable:!0});const Wa=class{constructor(e,t){r(this,"id",0);r(this,"points",[]);r(this,"line",new Dr.exports.MeshLine);r(this,"material");r(this,"mesh");r(this,"defaultLineMaterial",new Dr.exports.MeshLineMaterial({color:10066329,lineWidth:.01}));if(t&&(this.material=t.material),this.material||(this.material=this.defaultLineMaterial),t){const s=t.options;s&&Object.assign(this.material,s)}this.mesh=new kt(this.line,this.material),e.add(this.mesh)}appendPoint(e){var n;let t=Wa.wp;t.set(e.x,e.y,e.z);const s=(n=this.mesh)==null?void 0:n.parent;return s&&(t=s.worldToLocal(t),e.x=t.x,e.y=t.y,e.z=t.z),this.points.push(e.x,e.y,e.z),this.line.setPoints(this.points),e}};let fs=Wa;r(fs,"wp",new y);Cu(fs,"LineInstanceHandler");class rr extends v{constructor(){super(...arguments);r(this,"finished",[]);r(this,"inFlight",[]);r(this,"buffer",{});r(this,"freeBuffer",new Array)}startLine(e,t){const s=Math.random()*Number.MAX_SAFE_INTEGER;return this.internalStartLine(e,s,!0,t)}updateLine(e,t){const s=this.inFlight[e.id];if(!s)return;t.point&&(t.point=s.appendPoint(t.point));const n=this.buffer[e.id];n&&(t.point&&n.push(t.point.x,t.point.y,t.point.z),n.length>5&&(this.sendLineUpdate(s,!1,void 0,n),n.length=0))}endLine(e,t=!0){const s=this.inFlight[e.id];if(!s)return;this.finished.push(s),delete this.inFlight[e.id],t&&this.sendLineUpdate(s,!0,0);const n=this.buffer[e.id];if(n){delete this.buffer[e.id];const o=n;o.length=0,this.freeBuffer.push(o)}return s}getLine(e){return this.inFlight[e.id]}awake(){this.context.connection.beginListen("line-start",e=>{this.onEnsureLine(e.id,e.parentGuid)}),this.context.connection.beginListen("line-update",e=>{let t=this.onEnsureLine(e.guid,e.parentGuid);t&&e.points&&(e.startIndex<=0?t.points=e.points:e.startIndex>=t.points.length&&t.points.push(...e.points),t.line.setPoints(t.points),t.material.lineWidth=e.width,t.material.color.fromArray(e.color),e.finished===!0&&this.endLine({id:t.id},!1))})}onEnsureLine(e,t){if(this.inFlight[e])return this.inFlight[e];let s=p.findByGuid(t,this.context.scene);if(!!s)return this.internalStartLine(s,e,!1),this.inFlight[e]}internalStartLine(e,t,s=!0,n){const o=new fs(e!=null?e:this.context.scene,n);o.id=t,this.inFlight[t]=o,s&&this.sendLineStart(o);let a;return this.freeBuffer.length<=0?a=new Array:a=this.freeBuffer.pop(),this.buffer[t]=a,{id:t}}sendLineStart(e){const t=e.mesh.parent;this.context.connection.send("line-start",{id:e.id,parentGuid:t?t.guid:void 0})}sendLineUpdate(e,t,s,n){if(e){const o={parentGuid:e.mesh.parent.guid,guid:e.id,points:n?[...n]:e.points,width:e.material.lineWidth,color:e.material.color.toArray(),startIndex:s!==void 0?s:e.points.length,finished:t};this.context.connection.send("line-update",o)}}}Cu(rr,"LinesManager");var $y=Object.defineProperty,Su=(i,e)=>$y(i,"name",{value:e,configurable:!0});class ba{constructor(){r(this,"isDrawing");r(this,"lastHit");r(this,"currentHandle");r(this,"maxDistance");r(this,"prevDistance");r(this,"lastParent");this.isDrawing=!1,this.lastHit=new y,this.currentHandle=null,this.maxDistance=0,this.prevDistance=0,this.lastParent=null}}Su(ba,"LineState");const wr=class extends v{constructor(){super(...arguments);r(this,"lines");r(this,"colliders");r(this,"alignToSurface",!0);r(this,"addToPaintedObject",!0);r(this,"orbit");r(this,"_states",{});r(this,"_raycastOptions",new Me)}start(){var t;this.lines||(this.lines=p.getComponent(this.gameObject,rr),this.lines||(this.lines=p.addNewComponent(this.gameObject,rr))),this.orbit=(t=p.findObjectOfType(si,this.context))!=null?t:void 0,this._states.mouse=new ba;const e={};F.addEventListener(me.SelectStart,(s,n)=>{e[s.controller.uuid]=!0}),F.addEventListener(me.Update,(s,n)=>{if(e[s.controller.uuid]===!0){const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!1,!1)}}),F.addEventListener(me.SelectEnd,(s,n)=>{e[s.controller.uuid]=!1;const o=s.getRay();this.updateLine(s.controller.uuid,o,!0,!0,!1)})}update(){this.orbit&&this._states.mouse&&this.orbit&&(this.orbit.enabled=!this._states.mouse.isDrawing);const e=this.context.input.getPointerPressedCount()>1,t=this.context.input.getPointerPositionRC(0);wr._raycaster.setFromCamera(t,this.context.mainCamera);const s=wr._raycaster.ray;this.updateLine("mouse",s,this.context.input.getPointerPressed(0),this.context.input.getPointerUp(0),e||this.context.input.isKeyPressed(Ye.ALT))}updateLine(e,t,s,n,o=!1){var l;let a=this._states[e];if(a||(this._states[e]=new ba,a=this._states[e]),n)a.isDrawing=!1,a.currentHandle&&(this.lines.endLine(a.currentHandle),a.currentHandle=null);else if(s){if(o)return a;const c=this.getHit(t);let h=null,d=a.prevDistance;if(c)a.currentHandle||(a.maxDistance=c.distance),h=c.point,h.add(c.face.normal.multiplyScalar(.01)),a.prevDistance=c.distance;else if(a.maxDistance>0){if(a.maxDistance,!a.currentHandle&&a.lastHit){const u=C(this.context.mainCamera);a.lastHit.distanceTo(u)}h=t.origin.add(t.direction.multiplyScalar(a.maxDistance)),a.prevDistance=a.maxDistance}if(h){if(!a.currentHandle){let u=(l=a.lastParent)!=null?l:this.gameObject;this.addToPaintedObject&&c&&(u=c.object),a.lastParent=u,a.currentHandle=this.lines.startLine(u,{material:this.createRandomMaterial()})}if(this.alignToSurface&&(a.prevDistance>a.maxDistance||Math.abs(d-a.prevDistance)>.2)){const u=a.maxDistance;h=t.origin.add(t.direction.multiplyScalar(u)),a.prevDistance=u}if(a.lastHit&&a.lastHit.distanceTo(h)<a.prevDistance*.01)return a;this.lines.updateLine(a.currentHandle,{point:h}),a.lastHit.copy(h)}a.isDrawing=a.currentHandle!==null}return a}getHit(e){(!this.colliders||this.colliders.length===0)&&(this.colliders=[this.gameObject]),this._raycastOptions.targets=this.colliders,this._raycastOptions.ray=e;const t=this.context.physics.raycast(this._raycastOptions);if(t.length>0){for(const s of t)if(!!p.isActiveInHierarchy(s.object))return s}return null}createRandomMaterial(){let e;return this.context.connection.connectionId?e=Ct.colorFromHashCode(Ct.hashCode(this.context.connection.connectionId)):e=new f("hsl("+(Math.random()*100).toFixed(0)+", 80%, 30%)"),new Dr.exports.MeshLineMaterial({color:e,lineWidth:A.lerp(.005,.01,Math.random())})}};let or=wr;r(or,"_raycaster",new Sr);Su(or,"LinesDrawer");var Wy=Object.defineProperty,ps=(i,e)=>Wy(i,"name",{value:e,configurable:!0});const Ru=w("debugautosync");class Eu{constructor(){r(this,"_syncers",{})}getOrCreateSyncer(e){if(!e.guid)return null;if(this._syncers[e.guid])return this._syncers[e.guid];const t=new Tu(e);return this._syncers[e.guid]=t,t}}ps(Eu,"ComponentsSyncerManager");const Au=new Eu;class Tu{constructor(e){r(this,"comp");r(this,"hasChanges",!1);r(this,"changedProperties",{});r(this,"data",{});r(this,"_boundEvent");r(this,"_isReceiving",!1);r(this,"_isInit",!1);this.comp=e}get networkingKey(){return this.comp.constructor.name}init(e){if(this._isInit)return;this._isInit=!0,this.comp=e,this._boundEvent=this.onHandleSending.bind(this),this.comp.context.post_render_callbacks.push(this._boundEvent),this.comp.context.connection.beginListen(this.networkingKey,this.onHandleReceiving.bind(this));const t=this.comp.context.connection.tryGetState(this.comp.guid);t&&this.onHandleReceiving(t)}notifyChanged(e,t){this._isReceiving||(this.hasChanges=!0,this.changedProperties[e]=t)}onHandleSending(){if(!this.hasChanges)return;this.hasChanges=!1;const e=this.comp.context.connection;if(!e||!e.isConnected){for(const t in this.changedProperties)delete this.changedProperties[t];return}for(const t in this.data)delete this.data[t];this.data.guid=this.comp.guid;for(const t in this.changedProperties){const s=this.changedProperties[t];delete this.changedProperties[t],this.data[t]=s}e.send(this.networkingKey,this.data)}onHandleReceiving(e){if(!this._isInit||!this.comp)return;const t=e.guid;if(!(t&&t!==this.comp.guid)){Ru&&console.log("RECEIVED",this.comp.name,this.comp.guid,e);try{this._isReceiving=!0;for(const s in e){if(s==="guid")continue;const n=e[s];this.comp[s]=n}}catch(s){console.error(s)}finally{this._isReceiving=!1}}}}ps(Tu,"ComponentPropertiesSyncer");function ku(i,e){let t=e!==i;if(!t&&i&&e){if(Array.isArray(i)&&Array.isArray(e))t=!0;else if(typeof i=="object"&&typeof e=="object"){for(const s of Object.keys(i))if(i[s]!==e[s]){t=!0;break}}}return t}ps(ku,"testValueChanged");function Lu(i){if(i.__autoPropertySyncHandler)return i.__autoPropertySyncHandler;const e=Au.getOrCreateSyncer(i);return e==null||e.init(i),i.__autoPropertySyncHandler=e,e}ps(Lu,"getSyncer");const Hy=ps(function(i){return function(e,t){let s=null;const n=i?e[i]:void 0,o=e,a=o.__internalAwake;Ru&&console.log(t);const l=t+"k__BackingField";o.__internalAwake=function(){if(this[l]!==void 0)return;this[l]=this[t],a.call(this),s=Au.getOrCreateSyncer(this);const c=Object.getOwnPropertyDescriptor(this,t);(c==null?void 0:c.set)===void 0&&Object.defineProperty(this,t,{set:function(h){var u;const d=this[l];this[l]=h,ku(h,d)&&(n==null?void 0:n.call(this,h,d))!==!1&&((u=Lu(this))==null||u.notifyChanged(t,h))},get:function(){return this[l]},configurable:!0,enumerable:!0}),s==null||s.init(this)}}},"syncField");var Du=Object.defineProperty,Gy=Object.getOwnPropertyDescriptor,Mu=(i,e)=>Du(i,"name",{value:e,configurable:!0}),Iu=(i,e,t,s)=>{for(var n=s>1?void 0:s?Gy(e,t):e,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=(s?a(e,t,n):a(n))||n);return s&&n&&Du(e,t,n),n};class ya extends v{constructor(){super(...arguments);r(this,"asset");r(this,"joinedRoomFunction")}awake(){this.watchTabVisible(),this.joinedRoomFunction=this.onUserJoined.bind(this)}onEnable(){this.context.connection.beginListen(W.JoinedRoom,this.joinedRoomFunction)}onDisable(){this.context.connection.stopListening(W.JoinedRoom,this.joinedRoomFunction)}async onUserJoined(e){var s;const t=await((s=this.asset)==null?void 0:s.instantiateSynced({parent:this.gameObject},!0));if(t){let n=p.getComponent(t,bi);n&&(n.owner=this.context.connection.connectionId)}}watchTabVisible(){window.addEventListener("visibilitychange",e=>{if(document.visibilityState==="visible")for(let t=bi.all.length-1;t>=0;t--){const s=bi.all[t];(!s.owner||!this.context.connection.userIsInRoom(s.owner))&&s.doDestroy()}})}}Mu(ya,"PlayerSync");Iu([_(Ue)],ya.prototype,"asset",2);var xr;const ke=(xr=class extends v{constructor(){super(...arguments);r(this,"owner")}static get all(){return ke._all}static get local(){return ke._local}static isLocalPlayer(i){var e,t,s,n;return i instanceof S?(t=(e=p.getComponentInParent(i,ke))==null?void 0:e.isLocalPlayer)!=null?t:!1:i instanceof Se&&(n=(s=p.getComponentInParent(i.gameObject,ke))==null?void 0:s.isLocalPlayer)!=null?n:!1}get isLocalPlayer(){return this.owner===this.context.connection.connectionId}awake(){this.isLocalPlayer&&ke.local.push(this),ke.all.push(this),this.context.connection.beginListen(W.UserLeftRoom,i=>{if(i.userId===this.owner){this.doDestroy();return}})}start(){if(!this.owner||!this.context.connection.userIsInRoom(this.owner)){this.doDestroy();return}}doDestroy(){Bs(this.gameObject,this.context.connection)}onDestroy(){if(ke.all.splice(ke.all.indexOf(this),1),this.isLocalPlayer){const i=ke._local.indexOf(this);i>=0&&ke._local.splice(i,1)}}},r(xr,"_all",[]),r(xr,"_local",[]),xr);let bi=ke;Mu(bi,"PlayerState");Iu([Hy(),_()],bi.prototype,"owner",2);m.add("AlignmentConstraint",Wc);m.add("Animation",Nt);m.add("AnimationCurve",mo);m.add("Animator",ft);m.add("AnimatorController",ri);m.add("AudioListener",Ni);m.add("AudioSource",re);m.add("AvatarModel",vo);m.add("AvatarLoader",dn);m.add("AxesHelper",Gi);m.add("BasicIKConstraint",Zc);m.add("BoxCollider",Kc);m.add("BoxHelperComponent",Vi);m.add("Camera",N);m.add("InstantiateOptions",Ce);m.add("UnityObject",eh);m.add("DeleteBox",Po);m.add("Deletable",sh);m.add("DeviceFlag",Oo);m.add("DragControls",wt);m.add("DropListener",En);m.add("Duplicatable",li);m.add("CallInfo",Ki);m.add("EventList",tt);m.add("EventTrigger",Th);m.add("FlyControls",kh);m.add("BoxGizmo",Tn);m.add("GltfExportBox",Fh);m.add("GltfExport",Pt);m.add("GridHelper",es);m.add("Interactable",qi);m.add("UsageMarker",Xi);m.add("Light",Ot);m.add("LODModel",di);m.add("LODGroup",Mn);m.add("LookAtConstraint",Js);m.add("MeshCollider",Vh);m.add("NavMesh",Xh);m.add("NavMeshAgent",Yh);m.add("NestedGltf",Uo);m.add("Networking",Bt);m.add("OffsetConstraint",Jh);m.add("OrbitControls",si);m.add("ParticleSystemRenderer",$o);m.add("ParticleSystem",sd);m.add("MainModule",Zh);m.add("EmissionModule",Kh);m.add("ShapeModule",ed);m.add("PlayerColor",Ct);m.add("FieldWithDefault",sc);m.add("Renderer",se);m.add("MeshRenderer",Zr);m.add("SkinnedMeshRenderer",ac);m.add("InstancingUtil",de);m.add("RendererLightmap",$s);m.add("Rigidbody",is);m.add("SceneSettings",od);m.add("ScreenCapture",ud);m.add("ShadowCatcher",Ho);m.add("SmoothFollow",In);m.add("SpatialTriggerReceiver",ss);m.add("SpatialTrigger",Bn);m.add("SpatialTriggerEventArgs",Vo);m.add("SpectatorCamera",_d);m.add("SphereCollider",Un);m.add("SpringJoint",vd);m.add("Sprite",qo);m.add("SpriteRenderer",ns);m.add("SyncedCamera",Wn);m.add("SyncedRoom",Ht);m.add("SyncedTransform",_t);m.add("TestRunner",Ld);m.add("TestSimulateUserData",Dd);m.add("TransformGizmo",Zo);m.add("VideoPlayer",ze);m.add("Voip",bt);m.add("VolumeParameter",Bd);m.add("VolumeComponent",ui);m.add("ToneMapping",Hn);m.add("ColorAdjustments",Gn);m.add("VolumeProfile",Vn);m.add("Volume",Ko);m.add("WebARSessionRoot",xn);m.add("WebXR",T);m.add("WebAR",Ji);m.add("AvatarMarker",ee);m.add("WebXRAvatar",vt);m.add("TeleportTarget",Eo);m.add("WebXRController",F);m.add("AttachedObject",Be);m.add("XRGrabModel",ea);m.add("XRGrabRendering",zd);m.add("XRRig",Ao);m.add("VRUserState",et);m.add("WebXRSync",Sn);m.add("XRState",Ke);m.add("XRFlag",K);m.add("AvatarBlink_Simple",fi);m.add("AvatarEyeLook_Rotation",os);m.add("Avatar_POI",le);m.add("Avatar_Brain_LookAt",bn);m.add("Avatar_MouthShapes",Xn);m.add("Avatar_MustacheShake",qd);m.add("LogStats",Xd);m.add("RGBAColor",Re);m.add("PlayableDirector",hs);m.add("SignalAsset",sa);m.add("SignalReceiverEvent",na);m.add("SignalReceiver",Yn);m.add("AnimationTrackHandler",oa);m.add("AudioTrackHandler",aa);m.add("SignalTrackHandler",Jn);m.add("ControlTrackHandler",cs);m.add("BaseUIComponent",Rt);m.add("UIRootComponent",er);m.add("Button",Et);m.add("Canvas",hu);m.add("CanvasGroup",du);m.add("EventSystem",$e);m.add("Graphic",Xt);m.add("MaskableGraphic",tr);m.add("Image",ir);m.add("RawImage",fa);m.add("Keyboard",uu);m.add("LayoutGroup",ds);m.add("VerticalLayoutGroup",fu);m.add("HorizontalLayoutGroup",pu);m.add("GridLayoutGroup",mu);m.add("PointerEventData",mi);m.add("Raycaster",ga);m.add("ObjectRaycaster",us);m.add("GraphicRaycaster",gu);m.add("Size",iu);m.add("Rect",ca);m.add("RectTransform",Vt);m.add("SpatialHtml",_u);m.add("Text",ve);m.add("PresentationMode",Ou);m.add("LinesDrawer",or);m.add("LineInstanceHandler",fs);m.add("LinesManager",rr);m.add("PlayerSync",ya);m.add("PlayerState",bi);var Vy=Object.defineProperty,yi=(i,e)=>Vy(i,"name",{value:e,configurable:!0});class ju extends ni{constructor(){super([f,Re])}onDeserialize(e){if(e!=null)return e.a!==void 0?new Re(e.r,e.g,e.b,e.a):e.alpha!==void 0?new Re(e.r,e.g,e.b,e.alpha):new f(e.r,e.g,e.b)}onSerialize(e){if(e!=null)return e.a!==void 0?{r:e.r,g:e.g,b:e.b,a:e.a}:{r:e.r,g:e.g,b:e.b}}}yi(ju,"ColorSerializer");new ju;class Fu extends ni{constructor(){super(S)}onSerialize(e,t){if(t.objectToNode!==void 0&&e.uuid){const s=t.objectToNode[e.uuid];return fe&&console.log(s,e.name,e.uuid),{node:s}}}onDeserialize(e,t){var s;if(e){if(e.node!==void 0&&t.nodeToObject){const n=t.nodeToObject[e.node];return fe&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject),n||console.warn("Did not find node: "+e.node,t.nodeToObject,t.object),n}else if(e.guid){if(!t.context){console.error("Missing context");return}let n,o=(s=t.gltf)==null?void 0:s.scene;return o&&(n=p.findByGuid(e.guid,o)),n||(n=p.findByGuid(e.guid,t.context.scene)),n?fe&&console.log("Deserialized object reference?",e,n,t==null?void 0:t.nodeToObject):console.warn("could not resolve reference",e,t.target,t.path,t.context.scene),n}}}}yi(Fu,"ObjectSerializer");const qy=new Fu;class Bu extends ni{constructor(){super([Se,v])}onSerialize(e,t){if(e==null?void 0:e.guid)return{guid:e.guid}}onDeserialize(e,t){var s;if(e==null?void 0:e.guid){fe&&console.log(e.guid,t.root,t.object,t.target);const n=this.findObjectForGuid(e.guid,t.root);if(n)return n;if(t.context)return this.findObjectForGuid(e.guid,(s=t.context)==null?void 0:s.scene)}}findObjectForGuid(e,t){return p.foreachComponent(t,s=>{if(e===s.gameObject.guid)return s.gameObject;if(s.guid===e)return s})}}yi(Bu,"ComponentSerializer");const va=new Bu;class Uu extends ni{constructor(){super([tt])}onSerialize(e,t){console.log("TODO: SERIALIZE EVENT")}onDeserialize(e,t){var s,n,o,a;if(e&&e.type==="EventList"){fe&&console.log("DESERIALIZE EVENT",e);const l=new Array;for(const h of e.calls){fe&&console.log(h);let d=va.findObjectForGuid(h.target,t.root);!d&&((s=t.context)==null?void 0:s.scene)&&(d=va.findObjectForGuid(h.target,(n=t.context)==null?void 0:n.scene));const u=((o=h.method)==null?void 0:o.length)>0;if(d&&u){const P=yi(()=>console.warn(`Could not find method ${h.method} on object ${d.name}`,d,typeof d[h.method]),"printWarningMethodNotFound");if(typeof d[h.method]!="function"){let R=!1;h.method.startsWith("set_")&&h.method.length>4&&(h.method=h.method.substring(4),d[h.method]!==void 0&&(R=!0)),R||P()}}let g,b=h.argument;h.argument!==void 0?(typeof b=="object"&&(b=qy.onDeserialize(h.argument,t),b||(b=va.onDeserialize(h.argument,t))),g=new Ki(u?()=>x():void 0,h.enabled)):g=new Ki(u?()=>x():void 0,h.enabled);const x=yi(()=>{const P=d[h.method];typeof P=="function"?P==null||P.call(d,b):d[h.method]=b},"invokeFunction");if(g.method||(g.__debuginfo=(a=t.object)==null?void 0:a.name),!d||!g.method){const P=t.object?"Current object: "+t.object.name+", "+t.object.guid:null;d?console.warn('EventList method not found: "'+h.method+'" on',d):console.warn("EventList is missing target - will be ignored",h.target,P,e)}else l.push(g)}const c=new tt(l);return fe&&console.log(c),c}}}yi(Uu,"EventListSerializer");new Uu;var Xy=Object.defineProperty,ms=(i,e)=>Xy(i,"name",{value:e,configurable:!0});const Nu=fe;function zu(i,e){const s=Mc(i,e);return s!==void 0?s:null}ms(zu,"writeBuiltinComponentData");async function wa(i,e,t,s=null,n){if(!t)return;let o=s;typeof o=="number"&&(o=new ye(s));const a=new fo(t.scene);a.gltfId=e,a.context=i,a.gltf=t,a.nodeToObject=n==null?void 0:n.nodeToObjectMap;const l=[];if(t.scenes)for(const c of t.scenes)await lr(a,c,l);if(t.children)for(const c of t.children)await lr(a,c,l);i.new_scripts_pre_setup_callbacks.push(()=>{for(const c of l)$u(c,a);if(o){ar(t,o);for(const c of t.scenes)ar(c,o)}})}ms(wa,"createBuiltinComponents");function ar(i,e){if(e!==null&&!!i){if(i.guid=e.generateUUID(),i&&i.userData&&i.userData.components)for(const t of i.userData.components)t!==null&&(t.guid=e.generateUUID());if(i.children)for(const t of i.children)ar(t,e)}}ms(ar,"recursiveCreateGuids");const gs=[];async function lr(i,e,t,s){if(!e)return;const n=e.userData;if(n){const o=n.builtin_components;if(o&&o.length>0)for(const a of o)try{if(a===null)continue;const l=m.get(a.name);if(l!=null){const c=new l;c.sourceId=i.gltfId,ln(c,a),El(c,e,!1),t.push({instance:c,compData:a,obj:e})}else Nu&&console.debug("unknown component: "+a.name),gs.includes(a.name)||gs.push(a.name)}catch(l){console.error(a.name+" - "+l.message,l)}if(gs.length>0){const a=gs.join(", ");console.warn("unknown components: "+a),gs.length=0}}if(e.children)for(const o of e.children)await lr(i,o,t)}ms(lr,"onCreateBuiltinComponents");function $u(i,e){const{instance:t,compData:s,obj:n}=i;e.object=n,e.target=t,on(t,s,e),Nu&&console.debug("add "+s.name,s,t)}ms($u,"handleDeserialization");const Yy=new hl;async function Wu(i){return new Promise((e,t)=>{Yy.load(i,e,void 0,t)})}var Qy=Object.defineProperty,st=(i,e)=>Qy(i,"name",{value:e,configurable:!0});const _s=new Uint8Array(4);_s[0]=255;_s[1]=255;_s[2]=255;_s[3]=255;const Jy=new dl(_s,1,1,ul);function Hu(i){const e="alpha"in i,t=e?4:3,s=new Uint8Array(t);return s[0]=i.r,s[1]=i.g,s[2]=i.b,e&&(s[3]=i.alpha),new dl(s,1,1,ul)}st(Hu,"createFlatTexture");var Gu;(function(i){i[i.Vertex=0]="Vertex",i[i.Fragment=1]="Fragment"})(Gu||(Gu={}));class Vu{constructor(e,t){r(this,"stage");r(this,"code");this.stage=e,this.code=t}}st(Vu,"UnityShaderStage");class Zy{constructor(){r(this,"loaded",new Map)}async loadShader(e){const t=await Wu(e);return JSON.parse(t)}async load(e,t){if(this.loaded.has(t))return new Promise((o,a)=>{const l=this.loaded.get(t);l?o(l):a("Shader not found")});const s=await Wu(t),n=new Vu(e,s);return this.loaded.set(t,n),n}}st(Zy,"ShaderLib");function bs(i,e){const t=i.elements;e||(e=[]),e.length=0;for(let s=0;s<16;s+=4){const n=t[s],o=t[s+1],a=t[s+2],l=t[s+3],c=new j(n,o,a,l);e.push(c)}return e}st(bs,"ToUnityMatrixArray");const xa=[],qu=[];function Pa(i,e){if(xa.length===0)for(let t=0;t<27;t++)xa.push(0);e||(e=xa);for(let t=0;t<27;t++)qu[t]=e[t];e=qu,i.unity_SHAr={value:new j(e[9],e[3],e[6],e[0])},i.unity_SHBr={value:new j(e[12],e[15],e[18],e[21])},i.unity_SHAg={value:new j(e[10],e[4],e[7],e[1])},i.unity_SHBg={value:new j(e[13],e[16],e[19],e[22])},i.unity_SHAb={value:new j(e[11],e[5],e[8],e[2])},i.unity_SHBb={value:new j(e[14],e[17],e[20],e[23])},i.unity_SHC={value:new j(e[24],e[25],e[26],1)}}st(Pa,"SetUnitySphericalHarmonics");class Xu{constructor(e,t,s){r(this,"vertexShader");r(this,"fragmentShader");r(this,"technique");this.vertexShader=e,this.fragmentShader=t,this.technique=s}}st(Xu,"ShaderBundle");async function Yu(i,e){if(!i)return console.error("Can not find technique: no shader data"),null;const t=i.programs[e],s=t.vertexShader,n=t.fragmentShader;if(s!==void 0&&n!==void 0){const o=i.shaders[s],a=i.shaders[n];if(o.uri&&a.uri||o.code&&a.code){if(!o.code&&o.uri&&await Oa(o),!a.code&&a.uri&&await Oa(a),!o.code||!a.code)return null;const l=i.techniques[e];return new Xu(o.code,a.code,l)}}return console.error("Shader technique not found",e),null}st(Yu,"FindShaderTechniques");async function Oa(i){const e=i.uri;if(!!e)if(e.endsWith(".glsl")){const s=await new hl().loadAsync(e);i.code=s.toString()}else i.code=Qu(i.uri)}st(Oa,"loadShaderCode");function Qu(i){return decodeURIComponent(Array.prototype.map.call(atob(i),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}st(Qu,"b64DecodeUnicode");var Ky=Object.defineProperty,vi=(i,e)=>Ky(i,"name",{value:e,configurable:!0});class ev{constructor(){r(this,"programs",[]);r(this,"shaders",[]);r(this,"techniques",[])}}vi(ev,"ShaderData");class tv{constructor(){r(this,"vertexShader");r(this,"fragmentShader")}}vi(tv,"ShaderProgram");var Ju;(function(i){i[i.Fragment=35632]="Fragment",i[i.Vertex=35633]="Vertex"})(Ju||(Ju={}));class iv{constructor(){r(this,"name");r(this,"type");r(this,"uri");r(this,"code")}}vi(iv,"Shader");class sv{constructor(){r(this,"program");r(this,"attributes",new Map);r(this,"uniforms",new Map)}}vi(sv,"Technique");class nv{constructor(){r(this,"semantic")}}vi(nv,"ShaderAttribute");class rv{constructor(){r(this,"name","");r(this,"type");r(this,"semantic");r(this,"count",0);r(this,"node",0)}}vi(rv,"ShaderUniform");var Ca;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Ca||(Ca={}));var ov=Object.defineProperty,Sa=(i,e)=>ov(i,"name",{value:e,configurable:!0});const nt=w("debugshaders"),wi="NEEDLE_techniques_webgl";var Zu;(function(i){i[i.INT=5124]="INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_3D=35680]="SAMPLER_3D",i[i.SAMPLER_CUBE=35681]="SAMPLER_CUBE",i[i.UNKNOWN=0]="UNKNOWN"})(Zu||(Zu={}));class Ku{constructor(){r(this,"objectToWorldMatrix",new Oe);r(this,"worldToObjectMatrix",new Oe);r(this,"objectToWorld",new Array);r(this,"worldToObject",new Array)}updateFrom(e){this.objectToWorldMatrix.copy(e.matrixWorld),bs(this.objectToWorldMatrix,this.objectToWorld),this.worldToObjectMatrix.copy(e.matrixWorld.invert()),bs(this.worldToObjectMatrix,this.worldToObject)}}Sa(Ku,"ObjectRendererData");var ef;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(ef||(ef={}));const z=class extends $p{constructor(e,...t){super(...t);r(this,"identifier");r(this,"_sphericalHarmonicsName","unity_SpecCube0");r(this,"_objToWorldName","hlslcc_mtx4x4unity_ObjectToWorld");r(this,"_worldToObjectName","hlslcc_mtx4x4unity_WorldToObject");r(this,"_viewProjectionName","hlslcc_mtx4x4unity_MatrixVP");r(this,"_viewMatrixName","hlslcc_mtx4x4unity_MatrixV");r(this,"_rendererData",new Ku);r(this,"_lastFrame",-1);this.identifier=e,nt&&console.log(this),this.type="NEEDLE_CUSTOM_SHADER",this.uniforms[this._objToWorldName]||(this.uniforms[this._objToWorldName]={value:[]}),this.uniforms[this._worldToObjectName]||(this.uniforms[this._worldToObjectName]={value:[]}),this.uniforms[this._viewProjectionName]||(this.uniforms[this._viewProjectionName]={value:[]}),this.uniforms[this._sphericalHarmonicsName]&&this.waitForLighting()}async waitForLighting(){const e=E.Current;if(!e){console.error("Missing context");return}const t=await e.rendererData.getSceneLightingData(this.identifier);if(!t||!t.array){console.warn("Missing lighting data for custom shader, getSceneLightingData did not return anything");return}nt&&console.log(t);const s=t.array,n=t.texture;this.uniforms.unity_SpecCube0={value:n},Pa(this.uniforms,s);const o=Math.sqrt(Math.PI*.5);this.uniforms.unity_SpecCube0_HDR={value:new j(o,o,o,o)},nt&&console.log("Set environment lighting",this.uniforms)}onBeforeRender(e,t,s,n,o,a){n.attributes.tangent||n.computeTangents(),this.internalUpdateUniforms(s,o)}internalUpdateUniforms(e,t){const s=E.Current;if(s.time.frame==this._lastFrame)return;this._lastFrame=s.time.frame,this.uniforms._TimeParameters&&(this.uniforms._TimeParameters.value=s.rendererData.timeVec4);const n=s==null?void 0:s.mainLight;if(n){const o=n.getWorldPosition(z._mainLightPosition);this.uniforms._MainLightPosition={value:o.normalize()},z._mainLightColor.set(n.color.r,n.color.g,n.color.b,0),this.uniforms._MainLightColor={value:z._mainLightColor};const a=n.intensity;z._lightData.z=a,this.uniforms.unity_LightData={value:z._lightData}}if(e&&(z.viewProjection&&this.uniforms[this._viewProjectionName]&&(z.viewProjection.copy(e.projectionMatrix).multiply(e.matrixWorldInverse),this.uniforms[this._viewProjectionName].value=bs(z.viewProjection,z._viewProjectionValues)),z.viewMatrix&&this.uniforms[this._viewMatrixName]&&(z.viewMatrix.copy(e.matrixWorldInverse),this.uniforms[this._viewMatrixName].value=bs(z.viewMatrix,z._viewMatrixValues)),this.uniforms[z._worldSpaceCameraPosName]&&(z._worldSpaceCameraPos.setFromMatrixPosition(e.matrixWorld),this.uniforms[z._worldSpaceCameraPosName]={value:z._worldSpaceCameraPos})),t){const o=this._rendererData;o.updateFrom(t),this.uniforms[this._worldToObjectName].value=o.worldToObject,this.uniforms[this._objToWorldName].value=o.objectToWorld}this.uniformsNeedUpdate=!0}};let we=z;r(we,"viewProjection",new Oe),r(we,"_viewProjectionValues",[]),r(we,"viewMatrix",new Oe),r(we,"_viewMatrixValues",[]),r(we,"_worldSpaceCameraPosName","_WorldSpaceCameraPos"),r(we,"_worldSpaceCameraPos",new y),r(we,"_mainLightColor",new j),r(we,"_mainLightPosition",new y),r(we,"_lightData",new j);Sa(we,"CustomShader");class tf{constructor(e,t){r(this,"parser");r(this,"identifier");this.parser=e,this.identifier=t}get name(){return wi}loadMaterial(e){const t=this.parser.json.materials[e];if(!t)return nt&&console.log(e,this.parser.json.materials),null;if(!t.extensions||!t.extensions[wi])return nt&&console.log("material "+e+" does not use NEEDLE_techniques_webgl"),null;const s=t.extensions[wi].technique;if(s<0)return null;const n=this.parser.json.extensions[wi];if(!n)return null;nt&&console.log(n);const o=n.techniques[s];return o?new Promise(async(a,l)=>{var R,M,ce;const c=await Yu(n,o.program),h=c==null?void 0:c.fragmentShader,d=c==null?void 0:c.vertexShader;if(!h||!d)return l();nt&&console.log("loadMaterial",t,c);const u={},g=o.uniforms;for(const B in g){const k=B;switch(k){case"_TimeParameters":const U=new j;u[k]={value:U};break;case"hlslcc_mtx4x4unity_MatrixV":case"hlslcc_mtx4x4unity_MatrixVP":u[k]={value:[]};break;case"_MainLightPosition":case"_MainLightColor":case"_WorldSpaceCameraPos":u[k]={value:[0,0,0,1]};break;case"unity_OrthoParams":break;case"unity_SpecCube0":u[k]={value:null};break}}let b=!1;if(t.extensions&&t.extensions[wi]){const B=t.extensions[wi];if(B.technique===s){nt&&console.log(t.name,"Material Properties",B);for(const k in B.values){const U=B.values[k];if(typeof U=="string"){if(U.startsWith("textures/")){const Cs=U.substring(9),Ss=Number.parseInt(Cs);if(Ss>=0){const at=await this.parser.getDependency("texture",Ss);at&&(at.encoding=Wp,at.needsUpdate=!0),u[k]={value:at};continue}}switch(k){case"alphaMode":U==="BLEND"&&(b=!0);continue}}if(Array.isArray(U)&&U.length===4){u[k]={value:new j(U[0],U[1],U[2],U[3])};continue}u[k]={value:U}}}}const x=new we(this.identifier,{name:(R=t.name)!=null?R:"",uniforms:u,vertexShader:d,fragmentShader:h,lights:!1});switch((M=u._Cull)==null?void 0:M.value){case 0:x.side=al;break;case 1:x.side=Hp;break;case 2:x.side=fl;break;default:x.side=fl;break}x.transparent=b,b&&(x.depthWrite=!1),Pa(u),x.internalUpdateUniforms();for(const B in g){const k=B,U=g[B].type;if(((ce=u[k])==null?void 0:ce.value)===void 0)switch(U){case Ca.SAMPLER_2D:u[k]={value:Jy},console.warn("Missing/unassigned texture, fallback to white: "+k);break;default:console.warn("TODO: EXPECTED UNIFORM / fallback NOT SET: "+k,g[B]);break}}nt&&console.log(x.uuid,u),a(x)}):null}}Sa(tf,"NEEDLE_techniques_webgl");class av{constructor(e){this.parser=e,this.name="EXT_texture_exr"}loadTexture(e){const t=this.name,s=this.parser,o=s.json.textures[e];if(!o.extensions||!o.extensions[t])return null;const a=o.extensions[t];let l=new Gp(s.options.manager);return s.loadTextureImage(e,a.source,l)}}var lv=Object.defineProperty,cv=(i,e)=>lv(i,"name",{value:e,configurable:!0});const sf="NEEDLE_gameobject_data";class nf{constructor(e){r(this,"parser");this.parser=e}get name(){return sf}afterRoot(e){const t=[];for(let s=0;s<this.parser.json.nodes.length;s++){const n=this.parser.json.nodes[s];if(n&&n.extensions){const o=n.extensions[sf];if(o){const a=this.findAndApplyExtensionData(s,o);t.push(a)}}}return Promise.all(t).then(()=>{})}async findAndApplyExtensionData(e,t){const s=await this.parser.getDependency("node",e);s&&this.applyExtensionData(s,t)}applyExtensionData(e,t){e.userData.layer=t.layers,e.userData.tag=t.tag,e.userData.hideFlags=t.hideFlags,e.userData.static=t.static,e.visible=t.activeSelf,e.guid=t.guid}}cv(nf,"NEEDLE_gameobject_data");var hv=Object.defineProperty,dv=(i,e)=>hv(i,"name",{value:e,configurable:!0});const rf="NEEDLE_lightmaps",uv=w("debuglightmapsextension");var rt;(function(i){i[i.Lightmap=0]="Lightmap",i[i.Skybox=1]="Skybox",i[i.Reflection=2]="Reflection"})(rt||(rt={}));class of{constructor(e,t,s){r(this,"parser");r(this,"registry");r(this,"source");this.parser=e,this.registry=t,this.source=s}get name(){return rf}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[rf];if(s){const n=s.textures;return n.length?(uv&&console.log(s),new Promise(async(o,a)=>{const l=[];for(const c of n)if(c.pointer){const h=en(this.parser,c.pointer).then(d=>{const u=d;(u==null?void 0:u.isTexture)&&(this.registry?(c.type!==0&&(u.encoding=Zt),(u.type==Vp||u.type==qp)&&(u.flipY=!0),this.registry.registerTexture(this.source,c.type,u,c.index)):console.log(rt[c.type],c.pointer,u))});l.push(h)}await Promise.all(l),o()})):null}}return null}}dv(of,"NEEDLE_lightmaps");var fv=Object.defineProperty,af=(i,e)=>fv(i,"name",{value:e,configurable:!0}),cr;(function(i){i[i.Skybox=0]="Skybox",i[i.Trilight=1]="Trilight",i[i.Flat=3]="Flat",i[i.Custom=4]="Custom"})(cr||(cr={}));var hr;(function(i){i[i.Skybox=0]="Skybox",i[i.Custom=1]="Custom"})(hr||(hr={}));class lf{constructor(e){r(this,"context");r(this,"sceneLightSettings");r(this,"_timevec4",new j);r(this,"_waitPromise");r(this,"_lighting",{});this.context=e,this.context.pre_update_callbacks.push(this.preUpdate.bind(this))}preUpdate(){const e=this.context.time;this._timevec4.x=e.time,this._timevec4.y=Math.sin(e.time),this._timevec4.z=Math.cos(e.time),this._timevec4.w=e.deltaTime}get timeVec4(){return this._timevec4}registerSceneLightSettings(e){this.sceneLightSettings=e}registerReflection(e,t){const s=new cf(this.context,t,1);this._lighting[e]=s}getReflection(e){return this._lighting[e]}enableReflection(e){var s;switch((s=this.sceneLightSettings)==null?void 0:s.ambientMode){case 0:case 4:break;case 3:if(this.sceneLightSettings.ambientLight){const n=Hu(this.sceneLightSettings.ambientLight);this.context.scene.environment=n}return;default:return}const t=this.getReflection(e);if(t&&t.Source){const n=this.context.scene,o=t.Source;o.encoding=Zt,o.mapping=Er,n.environment=o}}async getSceneLightingData(e){return this._waitPromise?this._waitPromise:(this._waitPromise=new Promise((t,s)=>{let n=setInterval(async()=>{var a,l;const o=this.getReflection(e);o&&(clearInterval(n),t(o.getSphericalHarmonicsArray((l=(a=this.sceneLightSettings)==null?void 0:a.ambientIntensity)!=null?l:1)))},10)}),this._waitPromise)}}af(lf,"RendererData");class cf{constructor(e,t,s=1){r(this,"_context");r(this,"_source");r(this,"_sphericalHarmonics",null);r(this,"_sphericalHarmonicsArray");r(this,"_ambientScale",1);r(this,"_lightProbe");this._context=e,this._source=t,this._ambientScale=s,t.mapping=Er,t.encoding=Zt}get Source(){return this._source}get Array(){return this._sphericalHarmonicsArray}getSphericalHarmonicsArray(e=1){var t;if(((t=this._sphericalHarmonicsArray)==null?void 0:t.length)&&this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:this._lightProbe};try{const s=this._source;let n=null;if(s){const o=Math.min(s.image.width,512);n=new Xp(o).fromEquirectangularTexture(this._context.renderer,s),this._source=n.texture}if(this._sphericalHarmonicsArray=[],n){const o=Yp.fromCubeRenderTarget(this._context.renderer,n);this._lightProbe=o;const a=this._ambientScale*(e*e*Math.PI*.5)-1;this._sphericalHarmonics=o.sh,this._sphericalHarmonicsArray=this._sphericalHarmonics.toArray();const l=e/(Math.PI*.5);for(let c=0;c<this._sphericalHarmonicsArray.length;c++)this._sphericalHarmonicsArray[c]*=l;if(o.sh.scale(a),this._source)return{array:this._sphericalHarmonicsArray,texture:this._source,lightProbe:o}}}catch(s){console.error(s)}return null}}af(cf,"LightData");var pv=Object.defineProperty,hf=(i,e)=>pv(i,"name",{value:e,configurable:!0});const df="NEEDLE_lighting_settings",mv=w("debuglightingextensions");class uf{constructor(e,t,s){r(this,"parser");r(this,"sourceId");r(this,"context");this.parser=e,this.sourceId=t,this.context=s}get name(){return df}afterRoot(e){const t=this.parser.json.extensions;if(t){const s=t[df];if(s){mv&&console.log(s);const n=p.addNewComponent(e.scene,ff,!1);n.sourceId=this.sourceId,n.ambientIntensity=s.ambientIntensity,n.ambientLight=new f().fromArray(s.ambientLight),n.ambientMode=s.ambientMode,n.defaultReflectionMode=s.defaultReflectionMode,this.context&&this.context.rendererData.registerSceneLightSettings(n)}}return null}}hf(uf,"NEEDLE_lighting_settings");class ff extends v{constructor(){super(...arguments);r(this,"ambientMode",cr.Skybox);r(this,"ambientLight");r(this,"ambientIntensity",1);r(this,"defaultReflectionMode",hr.Skybox);r(this,"_hasReflection",!1);r(this,"_ambientLightObj");r(this,"_lightProbeObj")}awake(){if(this.sourceId){const e=this.defaultReflectionMode===hr.Skybox?rt.Skybox:rt.Reflection,t=this.context.lightmaps.tryGet(this.sourceId,e,0);this._hasReflection=t!=null,t&&this.context.rendererData.registerReflection(this.sourceId,t)}}onEnable(){this.ambientMode==cr.Flat?(this.ambientLight&&(this._ambientLightObj=new Qp(this.ambientLight,Math.PI*this.ambientIntensity)),this._ambientLightObj&&this.gameObject.add(this._ambientLightObj),this._lightProbeObj&&this._lightProbeObj.removeFromParent()):(this._ambientLightObj&&this._ambientLightObj.removeFromParent(),this._lightProbeObj?this.enabled&&this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj):this.sourceId&&this.context.rendererData.getSceneLightingData(this.sourceId).then(e=>{!e||(this._lightProbeObj=e.lightProbe,this.enabled&&!this.destroyed&&this._lightProbeObj&&this.scene.add(this._lightProbeObj))})),this.sourceId&&this._hasReflection&&this.context.rendererData.enableReflection(this.sourceId)}}hf(ff,"SceneLightSettings");var gv=Object.defineProperty,Ra=(i,e)=>gv(i,"name",{value:e,configurable:!0});function Ea(i){const e=new Mo;return i.register(t=>(e.parser=t,e)),e}Ra(Ea,"registerComponentExtension");class pf{resolvePath(e){return e.includes("/extensions/builtin_components/")&&(e=e.replace("/extensions/builtin_components/","/userData/components/")),e}}Ra(pf,"PointerResolver");function Aa(i,e,t){i.register(n=>new nf(n)),i.register(n=>new Lc(n)),i.register(n=>new of(n,e.lightmaps,t)),i.register(n=>new uf(n,t,e)),i.register(n=>new tf(n,t)),i.register(n=>new av(n));const s=i.setAnimationPointerResolver;typeof s=="function"&&s.bind(i)(new pf)}Ra(Aa,"registerExtensions");var _v=Object.defineProperty,_e=(i,e)=>_v(i,"name",{value:e,configurable:!0});const bv=w("printGltf");var Ta;(function(i){i[i.BeforeLoad=0]="BeforeLoad",i[i.AfterLoaded=1]="AfterLoaded",i[i.FinishedSetup=10]="FinishedSetup"})(Ta||(Ta={}));class At{constructor(e,t,s,n){r(this,"context");r(this,"loader");r(this,"path");r(this,"gltf");this.context=e,this.path=t,this.loader=s,this.gltf=n}}_e(At,"GltfLoadEvent");const Tt={};function mf(i,e){Tt[i]=Tt[i]||[],Tt[i].push(e)}_e(mf,"addGltfLoadEventListener");function gf(i,e){if(Tt[i]){const t=Tt[i].indexOf(e);t>=0&&Tt[i].splice(t,1)}}_e(gf,"removeGltfLoadEventListener");function Yt(i,e){if(Tt[i])for(const t of Tt[i])t(e)}_e(Yt,"invokeEvents");async function ka(i,e,t,s,n){bv&&console.log(t),await i.assets.registerGltf(t),await wa(i,e,t,s,n)}_e(ka,"handleLoadedGltf");function ys(i,e,t,s){typeof t!="string"&&console.warn("Parse gltf binary without path, this might lead to errors in resolving extensions. Please provide the source path of the gltf/glb file",t,typeof t);const n=new kr;Aa(n,i,t);const a=Ea(n);return new Promise((l,c)=>{try{hn(n,i),Yt(0,new At(i,t,n)),n.parse(e,t,async h=>{Yt(1,new At(i,t,n,h)),await ka(i,t,h,s,a),Yt(10,new At(i,t,n,h)),l(h)},h=>{console.error("failed loading "+t,h),l(void 0)})}catch(h){console.error(h),c(h)}})}_e(ys,"parseSync");function xi(i,e,t,s=!1,n){const o=new kr;Aa(o,i,e);const l=Ea(o);return new Promise((c,h)=>{try{hn(o,i),Yt(0,new At(i,e,o)),o.load(e,async d=>{Yt(1,new At(i,e,o,d)),await ka(i,e,d,t,l),Yt(10,new At(i,e,o,d)),c(d)},d=>{n==null||n.call(o,d)},d=>{console.error("failed loading "+e,d),c(void 0)})}catch(d){console.error(d),h(d)}})}_e(xi,"loadSync");function _f(i,e,t,s=!1){e&&e.animations&&e.animations.length>0&&t.push(()=>{La(e,s)})}_e(_f,"findAnimationsLate");function La(i,e=!1){var s;if(!i||!i.animations||!i.scene||!e&&!p.getComponentInChildren(i.scene,Nt))return;for(let n=0;n<i.animations.length;n++){const o=i.animations[n];if(!(!o.tracks||o.tracks.length<=0))for(const a in o.tracks){const l=o.tracks[a],c=(s=l.__objectName)!=null?s:l.name.substring(0,l.name.indexOf(".")),h=i.scene.getObjectByName(c);if(!h)continue;let d=t(h);if(!d)if(e)d=p.addNewComponent(i.scene,Nt);else{console.warn("Failed finding animator for",l.name,c);continue}const u=d.animations=d.animations||[];o.name_animator=d.name,u.indexOf(o)<0&&u.push(o)}}function t(n){var a;if(!n)return;const o=(a=n.userData)==null?void 0:a.components;if(o&&o.length>0)for(let l=0;l<o.length;l++){const c=o[l];if(c instanceof ft||c instanceof Nt)return n}return t(n.parent)}_e(t,"findAnimationGameObjectInParent")}_e(La,"findAnimations");function Da(i,e,t=!0){if(e.userData&&e.userData.name===i)return e;if(e.children&&e.children.length>0)for(let s=0;s<e.children.length;s++){const n=e.children[s],o=Da(i,n,t);if(o)return o}}_e(Da,"tryFindObjectByName");function bf(i,e,t=!0){return Mt(i,e,t)}_e(bf,"tryFindObject");function yf(i,e=null){const t=e!=null?e:E.Current.scripts;for(const s in t){const n=t[s];if(n&&n.guid===i)return n}return null}_e(yf,"tryFindScript");var yv=Object.freeze(Object.defineProperty({__proto__:null,get GltfLoadEventType(){return Ta},GltfLoadEvent:At,addGltfLoadEventListener:mf,removeGltfLoadEventListener:gf,parseSync:ys,loadSync:xi,findAnimationsLate:_f,findAnimations:La,tryFindObjectByName:Da,tryFindObject:bf,tryFindScript:yf},Symbol.toStringTag,{value:"Module"})),vv=Object.defineProperty,wv=(i,e)=>vv(i,"name",{value:e,configurable:!0});function dr(i,e){let t=p.getComponentInChildren(i,wt);if(t||(t=p.addNewComponent(i,wt,!1),t.guid=e.generateUUID()),t&&!p.getComponent(t.gameObject,_t)){const s=p.addNewComponent(t.gameObject,_t,!1);s.guid=e.generateUUID()}if(t&&!p.getComponentInParent(t.gameObject,us)){const s=p.addNewComponent(t.gameObject,us,!1);s.guid=e.generateUUID()}}wv(dr,"onDynamicObjectAdded");var xv=Object.defineProperty,Qt=(i,e)=>xv(i,"name",{value:e,configurable:!0}),ur;(function(i){i.File_Spawned="file-spawned"})(ur||(ur={}));class vf{constructor(e,t,s,n,o,a,l,c){r(this,"guid");r(this,"file_name");r(this,"file_hash");r(this,"file_size");r(this,"position");r(this,"seed");r(this,"sender");r(this,"serverUrl");r(this,"parentGuid");r(this,"boundsSize");this.seed=t,this.guid=s,this.file_name=n,this.file_hash=o,this.file_size=a,this.position=l,this.sender=e,this.serverUrl=c}}Qt(vf,"FileSpawnModel");async function wf(i,e,t){const s=i.name;return s.endsWith(".gltf")||s.endsWith(".glb")?new Promise((n,o)=>{const a=new FileReader;a.readAsDataURL(i),a.onloadend=async l=>{const c=a.result,h=Us(),d=new ye(h),u=await xi(e,c,d,!0);if(u&&u.scene){const g=u.scene;if(!g.guid){const b=new ye(h);g.guid=b.generateUUID()}t&&Of(e.connection,i,h,g,t),dr(g,d),n(g)}}}):(console.warn("Unsupported file type: "+s),console.log(i),null)}Qt(wf,"addFile");async function xf(i,e){return new Promise(async(t,s)=>{const n=Us(),o=new ye(n),a=await xi(e,i.toString(),o,!0);if(a&&a.scene){const l=a.scene;dr(l,o),t(l)}else console.warn("Unsupported file type: "+i.toString())})}Qt(xf,"addFileFromUrl");function Pf(i){i.connection.beginListen(ur.File_Spawned,async e=>{if(e.sender!==i.connection.connectionId){console.log("received file event",e),Cf(e,i);let t=null;try{t=await bo(e.file_name,e.file_hash,e.file_size,e.serverUrl)}finally{Sf(e)}if(t){const s=new ye(e.seed),n=await ys(i,t,null,s);if(n&&n.scene){const o=n.scene;if(dr(o,s),e.parentGuid){const a=p.findByGuid(e.parentGuid,i.scene);"add"in a&&a.add(o)}o.parent||i.scene.add(o),e.position!==null&&o.position.copy(e.position)}}else console.error("download didnt return file")}})}Qt(Pf,"beginListenFileSpawn");async function Of(i,e,t,s,n){var l;if(!i.connectionId){console.error("Can not upload file - no connection id");return}if(!s.guid){console.error("Can not upload file - no guid",s,s.guid);return}const o=await Yc(e,n);if(!o)return;if(!o.filename){console.error("Can not send upload event - no filename",e.name);return}if(!o.hash){console.error("Can not send upload event - no hash",e.name);return}const a=new vf(i.connectionId,t,s.guid,o.filename,o.hash,e.size,s.position,(l=o.url)!=null?l:n);s.parent&&(a.parentGuid=s.parent.guid),i.send(ur.File_Spawned,a)}Qt(Of,"handleUpload");const Ma={};function Cf(i,e){const t=new Ka,s=new kt(t,new Ai({color:65280})),n=new rl(s,5592405);if(Ma[i.guid]=n,e.scene.add(n),i.parentGuid){const o=p.findByGuid(i.parentGuid,e.scene);o&&o.add(n)}i.position&&n.position.copy(i.position)}Qt(Cf,"addPreview");function Sf(i,e){const t=i.guid,s=Ma[t];s&&(delete Ma[t],s.removeFromParent())}Qt(Sf,"removePreview");var Pv=Object.defineProperty,fr=(i,e)=>Pv(i,"name",{value:e,configurable:!0});w("debugassets");class Ov{constructor(){r(this,"name");r(this,"sampler");r(this,"source");r(this,"extras")}}fr(Ov,"TextureInfo");class Cv{constructor(){r(this,"bufferView");r(this,"mimeType");r(this,"extras")}}fr(Cv,"ImageInfo");class Sv{constructor(){r(this,"textures");r(this,"bufferViews")}}fr(Sv,"GltfJson");class Rf{constructor(){r(this,"texturesLoader",new Jp);r(this,"textures",{});r(this,"texturesLoading",{});r(this,"_materials",new Map);r(this,"_meshes",new Map);r(this,"_textures",new Map);window.addEventListener("unhandledrejection",e=>{var s;if(e.defaultPrevented)return;const t=(s=e==null?void 0:e.reason)==null?void 0:s.path;if(t){const n=t[0];n&&n.tagName==="IMG"&&(console.warn(`Could not load image:
`+n.src),e.preventDefault())}})}async loadTexture(e){if(this.textures[e])return this.textures[e];if(this.texturesLoading[e])return await this.texturesLoading[e];const t=this.texturesLoader.loadAsync(e);this.texturesLoading[e]=t;const s=await t;return delete this.texturesLoading[e],this.textures[e]=s,s}getTexture(e){return this._textures.get(e)||null}findTexture(e){for(const t of this._textures.values())if(t.name===e)return t;return null}findMesh(e){for(const t of this._meshes.values())if(t.name===e)return t;return null}findMaterial(e){for(const t of this._materials.values())if(t.name===e)return t;return null}async registerGltf(e){}registerAsset(e){}}fr(Rf,"AssetDatabase");var Rv=Object.defineProperty,Ev=(i,e)=>Rv(i,"name",{value:e,configurable:!0}),pr;(function(i){i.Visible="application-visible",i.Hidden="application-hidden"})(pr||(pr={}));class Ef extends EventTarget{constructor(e){super();r(this,"context");r(this,"_isVisible",!0);this.context=e,window.addEventListener("visibilitychange",this.onVisiblityChanged.bind(this),!1)}get hasFocus(){return document.hasFocus()}get isVisible(){return this._isVisible}onVisiblityChanged(e){switch(e.target.visibilityState){case"hidden":this._isVisible=!1,this.dispatchEvent(new Event(pr.Hidden));break;case"visible":this._isVisible=!0,this.dispatchEvent(new Event(pr.Visible));break}}}Ev(Ef,"Application");var Av=Object.defineProperty,Tv=(i,e)=>Av(i,"name",{value:e,configurable:!0});const Af=!!w("debuglightmaps");class Tf{constructor(e){r(this,"_context");r(this,"_lightmaps",new Map);this._context=e}registerTexture(e,t,s,n){var l;Af&&console.log("Registering lightmap",e,rt[t],s),this._lightmaps.has(e)||this._lightmaps.set(e,new Map);const o=this._lightmaps.get(e),a=(l=o==null?void 0:o.get(t))!=null?l:[];a.length<n&&(a.length=n+1),a[n]=s,o==null||o.set(t,a)}tryGetLightmap(e,t=0){return this.tryGet(e,rt.Lightmap,t)}tryGetSkybox(e){return this.tryGet(e,rt.Skybox,0)}tryGetReflection(e){return this.tryGet(e,rt.Reflection,0)}tryGet(e,t,s){var o,a;if(!e)return Af&&console.warn("Missing source id"),null;const n=(a=(o=this._lightmaps.get(e))==null?void 0:o.get(t))!=null?a:null;return!(n==null?void 0:n.length)||n.length<=s?null:n[s]}}Tv(Tf,"LightDataRegistry");ki.lights_fragment_maps=ki.lights_fragment_maps.replace("vec4 lightMapTexel = texture2D( lightMap, vUv2 );",`

    vec2 lUv = vUv2.xy * lightmapScaleOffset.xy + vec2(lightmapScaleOffset.z, (1. - (lightmapScaleOffset.y + lightmapScaleOffset.w)));
    vec4 lightMapTexel = texture2D( lightMap, lUv);
    // The range of RGBM lightmaps goes from 0 to 34.49 (5^2.2) in linear space, and from 0 to 5 in gamma space.
    lightMapTexel.rgb *= lightMapTexel.a * 8.; // no idea where that "8" comes from... heuristically derived
    lightMapTexel.a = 1.;
    lightMapTexel = conv_sRGBToLinear(lightMapTexel);
    `);ki.lightmap_pars_fragment=`
    #ifdef USE_LIGHTMAP
        uniform sampler2D lightMap;
        uniform float lightMapIntensity;
        uniform vec4 lightmapScaleOffset;
        
        // took from threejs 05fc79cd52b79e8c3e8dec1e7dca72c5c39983a4
        vec4 conv_sRGBToLinear( in vec4 value ) {
            return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
        }
    #endif
    `;ki.lights_fragment_begin=ki.lights_fragment_begin.replace("irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );",`
#if defined(USE_LIGHTMAP)
irradiance += 0.;
#else
irradiance += getLightProbeIrradiance( lightProbe, geometry.normal );
#endif`);Zp.lightmap.lightmapScaleOffset={value:new j(1,1,0,0)};var kv=Object.defineProperty,mr=(i,e)=>kv(i,"name",{value:e,configurable:!0});const Lv=w("debugSetup"),Dv=w("stats"),gr={};class kf{constructor(e){r(this,"name");r(this,"alias");r(this,"domElement");r(this,"renderer");this.domElement=e!=null?e:document.body}}mr(kf,"ContextArgs");var xe;(function(i){i[i.EarlyUpdate=0]="EarlyUpdate",i[i.Update=1]="Update",i[i.LateUpdate=2]="LateUpdate",i[i.OnBeforeRender=3]="OnBeforeRender",i[i.OnAfterRender=4]="OnAfterRender",i[i.PhysicsStep=10]="PhysicsStep"})(xe||(xe={}));const be=class{constructor(e){r(this,"name");r(this,"alias");r(this,"isManagedExternally",!1);r(this,"domElement");r(this,"scene");r(this,"renderer");r(this,"composer",null);r(this,"scripts",[]);r(this,"scripts_earlyUpdate",[]);r(this,"scripts_update",[]);r(this,"scripts_lateUpdate",[]);r(this,"scripts_onBeforeRender",[]);r(this,"scripts_onAfterRender",[]);r(this,"scripts_WithCorroutines",[]);r(this,"coroutines",{});r(this,"mainCameraComponent");r(this,"post_setup_callbacks",[]);r(this,"pre_update_callbacks",[]);r(this,"pre_render_callbacks",[]);r(this,"post_render_callbacks",[]);r(this,"new_scripts",[]);r(this,"new_script_start",[]);r(this,"new_scripts_pre_setup_callbacks",[]);r(this,"new_scripts_post_setup_callbacks",[]);r(this,"application");r(this,"time");r(this,"input");r(this,"physics");r(this,"connection");r(this,"assets");r(this,"mainLight",null);r(this,"rendererData");r(this,"addressables");r(this,"lightmaps");r(this,"_sizeChanged",!1);r(this,"_isCreated",!1);r(this,"_stats",Dv?Kp():null);r(this,"_cameraStack",[]);r(this,"_onBeforeRenderListeners",{});if(this.name=(e==null?void 0:e.name)||"",this.alias=e==null?void 0:e.alias,this.domElement=(e==null?void 0:e.domElement)||document.body,e==null?void 0:e.renderer)this.renderer=e.renderer,this.isManagedExternally=!0;else{const s=w("postfx");this.renderer=new Va({antialias:!0}),this.renderer.toneMappingExposure=1,this.renderer.toneMapping=em,this.renderer.setClearColor(new f("lightgrey"),0),this.renderer.antialias=!0,this.renderer.alpha=!1,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=tm,this.renderer.setSize(this.domWidth,this.domHeight),this.renderer.outputEncoding=Zt,this.renderer.physicallyCorrectLights=!0,this.composer=s?new im(this.renderer):null}this.scene=new qa,this.application=new Ef(this),this.time=new fc,this.input=new Kl(this),this.physics=new uc(this),this.connection=new yc(this),this.assets=new Rf,this.rendererData=new lf(this),this.addressables=new _h(this),this.lightmaps=new Tf(this),window.addEventListener("resize",this.updateSize.bind(this)),new ResizeObserver(s=>this._sizeChanged=!0).observe(this.domElement)}static get Current(){return this._current}static set Current(e){this._current=e}get domWidth(){return this.domElement.clientWidth}get domHeight(){return this.domElement.clientHeight}get domX(){return this.domElement.offsetLeft}get domY(){return this.domElement.offsetTop}get isInXR(){return this.renderer.xr.isPresenting}get mainCamera(){if(this.mainCameraComponent){const e=this.mainCameraComponent;return e.cam||e.buildCamera(),e.cam}return null}updateSize(){if(!this.isManagedExternally&&!this.renderer.xr.isPresenting){this._sizeChanged=!1;const e=this.domWidth,t=this.domHeight,s=this.mainCamera;this.updateAspect(s),this.renderer.setSize(e,t),this.renderer.setPixelRatio(window.devicePixelRatio),this.composer&&(this.composer.setSize(e,t),this.composer.setPixelRatio(window.devicePixelRatio))}}updateAspect(e){if(!e)return;const t=this.domWidth,s=this.domHeight,n=e.aspect;e.aspect=t/s,n!==e.aspect&&e.updateProjectionMatrix()}onCreate(e,t){return this._isCreated?(console.warn("Context already created"),null):(this._isCreated=!0,this.internalOnCreate(e,t))}onDestroy(){var e,t;!this._isCreated||(this._isCreated=!1,p.destroy(this.scene,!0),(e=this.renderer)==null||e.setAnimationLoop(null),this.isManagedExternally||(t=this.renderer)==null||t.dispose())}registerCoroutineUpdate(e,t,s){return this.coroutines[s]||(this.coroutines[s]=[]),this.coroutines[s].push({comp:e,main:t}),t}unregisterCoroutineUpdate(e,t){if(!this.coroutines[t])return;const s=this.coroutines[t].findIndex(n=>n.main===e);s>=0&&this.coroutines[t].splice(s,1)}stopAllCoroutinesFrom(e){for(const t in this.coroutines){const s=this.coroutines[t];for(let n=s.length-1;n>=0;n--)s[n].comp===e&&s.splice(n,1)}}setCurrentCamera(e){var n;if(!e)return;if(e.cam||e.buildCamera(),!e.cam){console.warn("Camera component is missing camera",e);return}const t=this._cameraStack.indexOf(e);t>=0&&this._cameraStack.splice(t,1),this._cameraStack.push(e),this.mainCameraComponent=e;const s=e.cam;s.isPerspectiveCamera&&this.updateAspect(s),(n=this.mainCameraComponent)==null||n.applyClearFlagsIfIsActiveCamera()}addBeforeRenderListener(e,t){if(!this._onBeforeRenderListeners[e.uuid]){this._onBeforeRenderListeners[e.uuid]=[];const s=mr((n,o,a,l,c,h)=>{const d=this._onBeforeRenderListeners[e.uuid];if(!!d)for(let u=0;u<d.length;u++)d[u](n,o,a,l,c,h)},"onBeforeRenderCallback");e.onBeforeRender=s}this._onBeforeRenderListeners[e.uuid].push(t)}removeBeforeRenderListener(e,t){if(this._onBeforeRenderListeners[e.uuid]){const s=this._onBeforeRenderListeners[e.uuid],n=s.indexOf(t);n>=0&&s.splice(n,1)}}async internalOnCreate(e,t){var o;let s=!0;try{be.Current=this,e&&await e(this,t)}catch(a){console.error(a),s=!1}if(!s)return;this.isManagedExternally||this.domElement.prepend(this.renderer.domElement),ql(this),Gl(this),Pf(this),be._current=this;for(let a=0;a<this.new_scripts.length;a++){const l=this.new_scripts[a];if(l.gameObject!==void 0&&l.gameObject!==null){l.gameObject.userData===void 0&&(l.gameObject.userData={}),l.gameObject.userData.components===void 0&&(l.gameObject.userData.components=[]);const c=l.gameObject.userData.components;c.includes(l)||c.push(l)}}if(this.post_setup_callbacks)for(let a=0;a<this.post_setup_callbacks.length;a++)be._current=this,await this.post_setup_callbacks[a](this);if(!this.mainCamera){be._current=this;const a=p.findObjectsOfType(N,this),l=(o=a.find(c=>c.tag=="MainCamera"))!=null?o:a.find(c=>!0);if(l)l.tag!=="MainCamera"&&console.warn('No mainCamera configured. Some components rely on a mainCamera object being present. When exporting your scene, make sure to set the mainCamera tag on your camera. Using "'+l.name+'" as mainCamera now.'),this.setCurrentCamera(l);else{console.error("No camera found");const c=Sc(this.scene);this.setCurrentCamera(c)}}be._current=this,ei(this),ao!==void 0&&Dt(ao,this);const n=this.mainCameraComponent;if(n&&n.applyClearFlagsIfIsActiveCamera(),!this.isManagedExternally&&this.composer&&this.mainCamera){const a=new sm(this.scene,this.mainCamera);this.renderer.setSize(this.domWidth,this.domHeight),this.composer.addPass(a),this.composer.setSize(this.domWidth,this.domHeight)}this._sizeChanged=!0,this._stats&&(this._stats.showPanel(1),this.domElement.appendChild(this._stats.dom)),this.renderer.setAnimationLoop(this.render.bind(this)),Lv&&Is(this.scene,!0)}render(e,t){var s,n;for((s=this._stats)==null||s.begin(),be._current=this,this.time.update(),ei(this),Cl(),Pl(this);this._cameraStack.length>0&&(!this.mainCameraComponent||this.mainCameraComponent.destroyed);){this._cameraStack.splice(this._cameraStack.length-1,1);const o=this._cameraStack[this._cameraStack.length-1];this.setCurrentCamera(o)}if(this.pre_update_callbacks)for(const o in this.pre_update_callbacks)this.pre_update_callbacks[o]();for(let o=0;o<this.scripts_earlyUpdate.length;o++){const a=this.scripts_earlyUpdate[o];!a.activeAndEnabled||a.earlyUpdate!==void 0&&(be._current=this,a.earlyUpdate())}this.executeCoroutines(0);for(let o=0;o<this.scripts_update.length;o++){const a=this.scripts_update[o];!a.activeAndEnabled||a.update!==void 0&&(be._current=this,a.update())}this.executeCoroutines(1);for(let o=0;o<this.scripts_lateUpdate.length;o++){const a=this.scripts_lateUpdate[o];!a.activeAndEnabled||a.lateUpdate!==void 0&&(be._current=this,a.lateUpdate())}this.mainLight=null,this.executeCoroutines(2);try{const o=2,a=this.time.deltaTime/o;for(let l=0;l<o;l++)this.physics.step(a),this.executeCoroutines(10)}catch(o){console.error(o)}this.physics.postStep();for(let o=0;o<this.scripts_onBeforeRender.length;o++){const a=this.scripts_onBeforeRender[o];!a.activeAndEnabled||a.onBeforeRender!==void 0&&(be._current=this,a.onBeforeRender(t))}if(this.executeCoroutines(3),this._sizeChanged&&this.updateSize(),this.pre_render_callbacks)for(const o in this.pre_render_callbacks)this.pre_render_callbacks[o]();this.isManagedExternally||(this.composer?this.composer.render():this.mainCamera&&this.renderer&&this.renderer.render(this.scene,this.mainCamera));for(let o=0;o<this.scripts_onAfterRender.length;o++){const a=this.scripts_onAfterRender[o];!a.activeAndEnabled||a.onAfterRender!==void 0&&(be._current=this,a.onAfterRender())}if(this.executeCoroutines(4),this.post_render_callbacks)for(const o in this.post_render_callbacks)this.post_render_callbacks[o]();this.connection.sendBufferedMessagesNow(),(n=this._stats)==null||n.end()}executeCoroutines(e){if(this.coroutines[e]){const s=this.coroutines[e];for(let n=0;n<s.length;n++){const o=s[n];if(!o.comp||o.comp.destroyed||!o.main){s.splice(n,1),--n;continue}const a=o.chained;if(a&&a.length>0){const d=a[a.length-1].next();if(d.done&&a.pop(),t(d)&&(o.chained||(o.chained=[]),o.chained.push(d.value)),!d.done)continue}const l=o.main.next();if(l.done===!0){s.splice(n,1),--n;continue}const c=l.value;if(t(c)){if(c.next().done)continue;o.chained||(o.chained=[]),o.chained.push(c)}}}function t(s){return!!(s&&s.next&&s.return)}mr(t,"isGenerator")}};let E=be;r(E,"_current");mr(E,"Context");var Mv=Object.freeze(Object.defineProperty({__proto__:null,build_scene_functions:gr,ContextArgs:kf,get FrameEvent(){return xe},Context:E},Symbol.toStringTag,{value:"Module"}));const Ia=Or(lt(lt({},Mv),yv),{RGBAColor:Re}),Iv=async function(i,e){const t=i.scene;i.new_scripts;const s=await Ia.loadSync(i,"assets/sceneRoot.glb",null,!1,o=>{var a;return(a=e==null?void 0:e.progress)==null?void 0:a.call(e,{name:"sceneRoot.glb",progress:o,index:0,count:2})});s&&t.add(s.scene);const n=await Ia.loadSync(i,"assets/syncCamera.glb",null,!1,o=>{var a;return(a=e==null?void 0:e.progress)==null?void 0:a.call(e,{name:"syncCamera.glb",progress:o,index:1,count:2})});n&&t.add(n.scene),i.scripts};Ia.build_scene_functions.loadScene=Iv;console.log("Made with \u2665 by \u{1F335} needle - https://needle.tools");var jv=Object.defineProperty,Fv=(i,e)=>jv(i,"name",{value:e,configurable:!0});const _r="ar",Bv="quit-ar";class Lf{constructor(){r(this,"arContainer",null);r(this,"closeARCallback");r(this,"currentSession",null);r(this,"registeredCloseEventElements",[]);r(this,"_createdAROnlyElements",[]);this.closeARCallback=this.onRequestedEndAR.bind(this)}requestEndAR(){this.onRequestedEndAR()}onBegin(e,t){if(this.currentSession=t,this.arContainer=e,!this.arContainer)return;const s=e.getElementsByClassName(Bv);if(!s||s.length<=0)console.warn("Missing quit AR elements"),this.createFallbackCloseARButton(this.arContainer);else for(let n=0;n<s.length;n++){const o=s[n];!o||(o.addEventListener("click",this.closeARCallback),this.registeredCloseEventElements.push(o))}}onEnd(){for(const e of this._createdAROnlyElements)e.remove&&e.remove()}findArContainer(e){if(e.classList.contains(_r))return e;if(e.children){for(const t of e.children)if(!(!t||!t.classList)&&t.classList.contains(_r))return t}return null}onRequestedEndAR(){if(!!this.currentSession){this.currentSession.end(),this.currentSession=null;for(const e of this.registeredCloseEventElements)e.removeEventListener("click",this.closeARCallback);this.registeredCloseEventElements.length=0}}createFallbackCloseARButton(e){var t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","38px"),t.setAttribute("height","38px"),t.style.position="absolute",t.style.right="20px",t.style.top="40px",t.style.zIndex="9999",t.style.pointerEvents="auto",t.addEventListener("click",this.closeARCallback),e.appendChild(t),this._createdAROnlyElements.push(t);var s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),s.setAttribute("stroke","#eee"),s.setAttribute("stroke-width","2px"),t.appendChild(s),this._createdAROnlyElements.push(s)}}Fv(Lf,"AROverlayHandler");var Uv=Object.defineProperty,ja=(i,e)=>Uv(i,"name",{value:e,configurable:!0});const Nv=w("debugloadingbar");class zv{constructor(){r(this,"className");r(this,"additionalClasses")}}ja(zv,"LoadingElementOptions");class Df{constructor(e,t){r(this,"loadingProgress",0);r(this,"container");r(this,"_progress",0);r(this,"_allowCustomLoadingElement",!1);r(this,"_loadingElement");r(this,"_loadingTextContainer",null);r(this,"_loadingBar",null);r(this,"_messageContainer",null);r(this,"_loadingElementOptions");r(this,"_progressLoop");this.container=e,this._loadingElementOptions=t}onLoadingBegin(e){if(!this._loadingElement){for(let t=0;t<this.container.children.length;t++){const s=this.container.children[t];if(s.classList.contains("loading")){if(!this._allowCustomLoadingElement){this.container.removeChild(s);continue}this._loadingElement=this.createLoadingElement();return}}this._loadingElement=this.createLoadingElement()}this._progress=0,this.loadingProgress=0,this._loadingElement.style.display="",this.container.appendChild(this._loadingElement),this.smoothProgressLoop(),this.setMessage(e!=null?e:"")}onLoadingUpdate(e,t){var n;((n=this._loadingElement)==null?void 0:n.parentElement)||this.onLoadingBegin(t);let s=0;typeof e=="number"?s=e:("index"in e&&(s=e.index/e.count+e.progress.loaded/e.progress.total/e.count),!t&&"name"in e&&this.setMessage(e.name)),this.loadingProgress=s,t&&this.setMessage(t),this.updateDisplay()}onLoadingFinished(e){this.loadingProgress=1,this.setMessage(e!=null?e:"")}setMessage(e){this._messageContainer&&(this._messageContainer.innerText=e)}smoothProgressLoop(){if(this._progressLoop)return;let e=1/12;Nv&&(e=.001);const t=1-.05;this._progressLoop=setInterval(()=>{if(this.loadingProgress>=1&&this._progress>=t){this._loadingElement&&(this._loadingElement.style.display="none",this._loadingElement.remove()),clearInterval(this._progressLoop),this._progressLoop=null;return}this._progress=A.lerp(this._progress,this.loadingProgress,e*this.loadingProgress),this.updateDisplay()},e)}updateDisplay(){const e=this._progress,t=(e*100).toFixed(0)+"%";this._loadingBar&&(this._loadingBar.style.width=e*100+"%"),this._loadingTextContainer&&(this._loadingTextContainer.textContent=t)}createLoadingElement(e){var l,c,h;this._loadingElement=e||document.createElement("div");const t=(c=(l=this._loadingElementOptions)==null?void 0:l.className)!=null?c:"loading";if(this._loadingElement.classList.add(t),(h=this._loadingElementOptions)==null?void 0:h.additionalClasses)for(const d of this._loadingElementOptions.additionalClasses)this._loadingElement.classList.add(d);e||(this._loadingElement.style.color="white",this._loadingElement.style.display="flex");const s=document.createElement("div"),n=20;s.style.display="flex",s.style.width=n+"%",s.style.height="2px",s.style.background="rgba(255,255,255,.1)",this._loadingElement.appendChild(s),this._loadingBar=document.createElement("div"),s.appendChild(this._loadingBar);const o=ja(function(d){return A.lerp(n*.5,100-n*.5,d)+"%"},"getGradientPos");this._loadingBar.style.background=`linear-gradient(90deg, #02022B ${o(0)}, #0BA398 ${o(.4)}, #99CC33 ${o(.5)}, #D7DB0A ${o(1)})`,this._loadingBar.style.backgroundAttachment="fixed",this._loadingBar.style.width="0%",this._loadingBar.style.height="100%",this._loadingTextContainer=document.createElement("div"),this._loadingTextContainer.style.display="flex",this._loadingTextContainer.style.justifyContent="center",this._loadingTextContainer.style.marginTop=".9em",this._loadingElement.appendChild(this._loadingTextContainer);const a=document.createElement("div");return this._messageContainer=a,a.style.display="flex",a.style.fontSize=".8em",a.style.paddingTop=".5em",a.style.color="rgba(255,255,255,.5)",this._loadingElement.appendChild(a),this._loadingElement}}ja(Df,"EngineLoadingView");var $v=Object.defineProperty,vs=(i,e)=>$v(i,"name",{value:e,configurable:!0});class Mf{constructor(e,t){r(this,"id");r(this,"context");r(this,"previouslyAdded");r(this,"previousSource");r(this,"networkEvent");this.id=e,this.context=t,this.networkEvent="needle-engine-source-changed",this.id&&(this.networkEvent+="-"+this.id),this.context.connection.beginListen(this.networkEvent,s=>{this.onSourceChanged(s,!0)})}async onSourceChanged(e,t=!1,s=!1){this.previouslyAdded&&(t&&e===this.previousSource||p.destroySynced(this.previouslyAdded)),this.previouslyAdded=null,t||this.context.connection.send(this.networkEvent,e),this.previousSource=e,E.Current=this.context;const n=await xi(this.context,e,this.getHashFromString(e));s||ei(this.context);const o=n==null?void 0:n.scene;o&&(this.previouslyAdded=o,this.context.scene.add(o))}getHashFromString(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);return t}}vs(Mf,"EngineElementSourceFileWatcher");const Wv="needle-engine",Hv="vr",Gv="desktop",Vv=[_r,Hv,Gv];class If extends HTMLElement{constructor(){super();r(this,"gameObject",p);r(this,"GameObject",p);r(this,"context",null);r(this,"overlay_ar");r(this,"_watcher");r(this,"_loadingView");this.overlay_ar=new Lf}get loadingProgress01(){var e,t;return(t=(e=this._loadingView)==null?void 0:e.loadingProgress)!=null?t:0}get loadingFinished(){return this.loadingProgress01>.999}getContext(){return new Promise((e,t)=>{if(this.context&&this.loadingFinished)e(this.context);else{const s=vs(()=>{this.removeEventListener("loading-finished",s),this.context&&this.loadingFinished&&e(this.context)},"cb");this.addEventListener("loading-finished",s)}})}async connectedCallback(){var a,l,c;this.onSetupDesktop();var e=new MutationObserver(this.onElementsChanged.bind(this));e.observe(this,{childList:!0});const t=vs(()=>{const h=this.getAttribute("src");return(h==null?void 0:h.endsWith(".glb"))||(h==null?void 0:h.endsWith(".gltf"))?h:null},"srcFile");let s="loadScene";const n=t();n&&(s=n);const o=this.getAttribute("alias");if(this.context=new E({name:s,domElement:this,alias:o}),this._watcher=new Mf((l=(a=this.getAttribute("id"))!=null?a:o)!=null?l:"",this.context),this._loadingView=new Df(this),s&&s.length>0){if(!n)for(;Object.keys(gr).length<=0;){if(!this.isConnected)return;await vl(10)}let h=(c=gr[s])!=null?c:window[s],d=null;if((!h||n)&&(n&&(s=n),h=vs(async u=>{const g=t();g&&this._watcher&&(d=g,await this._watcher.onSourceChanged(g,!0,!0))},"fn")),h){this.classList.add("loading"),console.log("Begin loading scene",s!=null?s:o),this._loadingView.onLoadingBegin("begin load"),await this.context.onCreate(h,{progress:this._loadingView.onLoadingUpdate.bind(this._loadingView)});const u=t();u&&u!==d&&await this._watcher.onSourceChanged(u,!0,!0),this._loadingView.onLoadingFinished("create scene"),this.classList.remove("loading"),this.classList.add("loading-finished"),console.log("Finished loading scene",o!=null?o:s),this.dispatchEvent(new Event("loading-finished")),this.onSetupDesktop()}else console.error('Could not find scene function named "'+s+'", it must be either in global scope or added to build_scene_functions',gr)}else console.error("Missing src attribute - please provide a function name",this)}disconnectedCallback(){this.context&&this.context.onDestroy()}static get observedAttributes(){return["src"]}attributeChangedCallback(e,t,s){var n;(n=this._watcher)==null||n.onSourceChanged(s)}getAROverlayContainer(){var t;return(t=this.overlay_ar)==null?void 0:t.findArContainer(this)}getVROverlayContainer(){for(let e=0;e<this.children.length;e++){const t=this.children[e];if(t.classList.contains("vr"))return t}return null}onEnterAR(e,t){this.onSetupAR(),this.overlay_ar.onBegin(t,e)}onExitAR(e){this.overlay_ar.onEnd(),this.onSetupDesktop()}onEnterVR(e){this.onSetupVR()}onExitVR(){this.onSetupDesktop()}onElementsChanged(){}onSetupAR(){this.classList.add("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,_r))}onSetupVR(){this.classList.remove("ar-session-active"),this.classList.remove("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"vr"))}onSetupDesktop(){this.classList.remove("ar-session-active"),this.classList.add("desktop-session-active"),this.foreachHtmlElement(e=>this.setupElementsForMode(e,"desktop"))}setupElementsForMode(e,t,s=null){var o;if(e===((o=this.context)==null?void 0:o.renderer.domElement)||e.id==="VRButton"||e.id==="ARButton")return;if(e.style.position="absolute",e.classList.contains(t))e.style.visibility="visible",e.style.display="block";else for(const a of Vv)e.classList.contains(a)&&(e.style.visibility="hidden",e.style.display="none")}foreachHtmlElement(e){for(let t=0;t<this.children.length;t++){const s=this.children[t];s.style&&e(s)}}}vs(If,"EngineElement");window.customElements.define(Wv,If);
